<apex:page sidebar="false" setup="true" controller="Loop.aboutLoop" id="aPage" title="About LOOP Document Services" showHeader="true" tabStyle="DDP_Admin__tab" action="{!onload}">
    <apex:stylesheet value="{!URLFOR($Resource.Loop__Styles, '/css/bootstrap-scoped-3.2.0/css/bootstrap.min.css')}" />
    <style type="text/css">
        div.pbBody div.innerDiv div { margin-top: 12px; }
        div.left {
            float: left;
            width: 20em;
        }
        
        .msg {
            font-weight: bold;
        }
        #authRptFrame, #authSandFrame {
            height: 1.3em;
            width: 100%;
        }
        .bPageBlock .pbTitle {
            width: 50%;
        }
        fieldset li {
            margin-bottom: 1em;
        }
        fieldset ul {
            margin: 0;
        }
        .resultMsg {
            font-family: Arial, Helvetica, sans-serif;
            font-weight: bold;
            margin: 0;
            color: #333333;
        }
        span.pbSubExtra { display: none; }
        span.newFlag { vertical-align: middle; }
        .editPage .btn {
            margin-top: 4px;
        }
        .authorizeReports .btn {
            margin-right: 10px;
        }
        
        table.fullwidth { width: 100%; display: block; }
        td.halfwidth { width: 50%; }
        ul.contact { white-space: nowrap; }
        ul.contact li { padding: 1px 0; }
        
        .oRight a.bluebtn, input.bluebtn {
            background: linear-gradient(to bottom, #008cd1 0%,#01a5f8 100%);
            padding: 4px 10px;
            border: 1px solid #008dd4;
            border-radius: 3px;
            color: #fff;
            font-weight: bold;
            text-decoration: none;
            vertical-align: middle;
            font-size: 11px;
            cursor: pointer;
        }
        .oRight a.bluebtn:hover { color: #fff; }
        .oRight input.bluebtn { margin-right: 3px; }
        
        .oRight input.bluebtn:hover { text-decoration: underline; }
        
        .oRight input.bluebtn.btnDisabled {
            border: 1px solid #c4c4c4;
            background: #e8e8e9 url('/img/alohaSkin/btn_sprite.png') repeat-x right top;
            color: #909090;
            cursor: default;
        }
        .oRight input.bluebtn.btnDisabled:hover { text-decoration: none; }
        
        #setupItems {
            margin: 14px;
            padding: 0;
            border-collapse: collapse;
        }
        
        #setupItems input.bluebtn { width: 170px; }
        
        #setupItems td.left div { padding-right: 10px; }
        
        td.selectCell select { min-width: 100px; }
        
        #setupItems > tbody > tr > td {
            padding: 6px 0;
            border-bottom: 1px solid #DEDEDE;
        }
        #setupItems > tbody > tr.first > td, #setupItems > tbody > tr.last > td {
            border: none;
        }
        
        span.statusContainer span.status { vertical-align: sub; }
        
        img.sectionImage {
            height: 84px;
            width: 84px;
        }
        
        .gs-links .gsbutton, .gs-links .gsbutton:visited {
            background: url("/img/forcecom/btn_sprite1.png") repeat-x scroll right top #65a612;
            font-weight: bold;
            margin: 1px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            background-position: right -120px;
            padding: 4px 40px;
            border: 2px solid #fff;
            color: #fff;
            text-decoration: none;
            white-space: nowrap;
        }
        
        table.fullwidth {
            width: 100%;
            display: block;
        }
        table.fullwidth td.halfwidth {
            border-radius: 5px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border: 1px solid #ccc;
            padding: 0;
        }
        td.halfwidth div.pageBlock {
            overflow: hidden;
            background: #fff;
            position: relative;
            padding: 0;
            border-radius: 4px 4px 5px 5px;
            -moz-border-radius-topleft: 4px;
            -moz-border-radius-topright: 4px;
            -moz-border-radius-bottomright: 5px;
            -moz-border-radius-bottomleft: 5px;
            -webkit-border-radius: 4px 4px 5px 5px;
        }
        div.pageBlock div.top-line {
            padding-bottom: 12px;
            background-color: #dedede;
        }
        div.top-line div.panelHeader {
            position: relative;
            margin-bottom: 0;
            font-weight: bold;
            color: #222;
            font-size: 1.1em;
        }
        div.top-line div.panelHeader h2 {
            font-size: 1.083em;
            font-weight: bold;
            position: relative;
            top: 8px;
            left: 10px;
        }
        div.pageBlock div.panelContent {
            min-width: 650px;
        }
        div.panelContent table.gs-links {
            padding: 12px;
            margin: 0;
        }
        div.panelContent table.gs-links tr {
            padding-top: 0;
            padding-bottom: 5px;
        }
        div.panelContent table.gs-links tr td {
            padding: 0 12px;
            height: 100%;
        }
        td div.steps-header {
            font-weight: bold;
            color: #333;
            padding-top: 2px;
            padding-right: 0;
            padding-bottom: 0;
            padding-left: 2px;
            font-size: 1.15em;
        }
        td div.steps-text {
            color: #555;
            line-height: 18px;
            padding-top: 5px;
            padding-right: 0;
            padding-bottom: 15px;
            padding-left: 0;
        }
        a.support-site, a.support-site:visited {
            border: none;
            background: url("/img/forcecom/btn_sprite1.png") repeat-x scroll right top #65a612;
            font-weight: bold;
            margin: 1px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            background-position: right -120px;
            padding: 4px 40px;
            border: 2px solid #fff;
            color: #fff;
            text-decoration: none;
            white-space: nowrap;
        }
        table.gs-links tr td.gs-icons {
            border-left: 1px solid #ccc;
        }
        td.gs-icons div.steps-header-hilite {
            color: #707070;
            padding-top: 2px;
            padding-right: 0;
            padding-bottom: 0;
            padding-left: 2px;
            font-size: 1.15em;
        }
        td.gs-icons ul.gs-learn-more {
            padding: 0;
            margin-left: 15px;
            margin-top: 4px;
        }
        .oRight a {
            color: #015ba7;
            text-decoration: none;
        }
        .siteCollectionRowParent {
            font-weight: bold;
            word-wrap: break-word;
        }
        .siteCollectionRowChild {
            padding-left: 15px;
            word-wrap: break-word;
        }
        .alert {
            word-wrap: break-word;
        }
        .editDeleteLinks {
            text-align: center;
        }
        .fixedTable {
            table-layout: fixed;
        }
        .sitePaths {
            display: flex;
        }
        .oRight a:hover { text-decoration: underline; }
        .drawloop-bootstrap .panel-primary { margin-top: 50%; }
        .drawloop-bootstrap .type-form-group { position: relative; }
        .drawloop-bootstrap .btn { margin-left: 10px; }
    </style>
    <script src="{!URLFOR($Resource.Scripts, 'jquery-1.9.1.min.js')}"></script>
    <script src="{!URLFOR($Resource.Scripts, 'jquery.drawloop.js')}"></script>
    <script src="{!URLFOR($Resource.Scripts, 'json2.min.js')}"></script>
    <script type="text/javascript" src="/soap/ajax/25.0/connection.js"></script>
    <script type="text/javascript">
        $(function() {
            if ("{!JSENCODE($Request.sfdc.tabName)}" == "")
                $("#AppBodyHeader").css('display', 'none');
            else {
                jQuery('li.zen-active,li.phm.active').removeClass('zen-active primaryPalette active');
                jQuery('li[id="{!JSENCODE($Request.sfdc.tabName)}_Tab"]').addClass('zen-active primaryPalette active');
            }
            $('.hidden').hide();
            
            jQuery('input.bluebtn').removeClass('btn');
            
            setDisabled('div.authorizeReports .bluebtn', true);
            $.authorize({
                accessToken: '{!JSENCODE(sessionId)}',
                userId: '{!$User.Id}',
                sandbox: {!isSandbox},
                //promptLogin: true,
                promptConsent: true,
                verifySuccess: function(data) {
                    setDisabled('div.authorizeReports .bluebtn', false);
                },
                verifyError: function(data) {
                    var msg;
                    if (!data.Response) {
                        msg = 'An unexpected response was received attempting to verify authorization.';
                    } else if (data.Response.toLowerCase() == 'error') {
                        msg = data.Error;
                    }
                    setAuthFlowMessage(msg);
                },
                authFlowComplete: function(result) {
                    if (result.status == 'success') {
                        setAuthFlowMessage('');
                        $('div.authorizeReports .bluebtn').click();
                    } else {
                        setAuthFlowMessage('You need to authorize LOOP Document Services to run Scheduled / Mass DDPs.');
                    }
                }
            });
            $.notifie({
                allowCompatibilityView: false,
                requiredVersion: 8,
                containerSelector: '#ieMsgs',
                compatibilityViewMessage: '{!JSENCODE($Label.IE_Compatibility_View_Warning)}',
                versionMessage: '{!JSENCODE($Label.IE_Higher_Version_Required)}'
            });
        });
    </script>
    <script type="text/javascript">
        function setFocusOnLoad() {
            // do nothing. We don't want to focus on the first available element here.
        }
        
        var num = 1;
        function getIp(cb, p) {
            appendScript('https://apps.drawloop.com/IP.aspx?callback='+cb+'&process='+p);
        }
        function appendScript(str) {
            var ss = document.createElement('script');
            ss.setAttribute('type', 'text/javascript');
            ss.src = str;
            $(function() {
                $("body").append(ss);
            });
        }
        function displayIp(result) {
            $("#iprange").text(result);
        }
        function authorizeip(result) {
            window.top.location="/05G/e?Description=LOOP+Document+Services&" + result + "&retURL={!JSENCODE(URLENCODE($Page.aboutloop))}%3Fsfdc.tabName={!JSENCODE($Request.sfdc.tabName)}&saveURL={!JSENCODE(URLENCODE($Page.aboutloop))}%3Fsfdc.tabName={!JSENCODE($Request.sfdc.tabName)}";
        }
        function authorizeLogin() {
            if ($.authorize('getStatus').requiresAuthorization) {
                $.authorize('launchAuthorizationFlow');
                return false;
            }
            setAuthFlowMessage('');
            return true;
        }
        
        function func(result) {
            $(".hidden").hide();
            $("#"+result).show();
            $("input").removeAttr("disabled");
        }
        
        function rep(result) {
            $(".hidden").hide();
            $("#rep"+result).show();
            $("input").removeAttr("disabled");
        }
        function modSubs() {
            $("#next").val('/ddps/149/1?no=true&dsa={!dsAccount}&dse={!dsEnvironment}');
            $("#auto").val('false');
            $("#authRptForm").removeAttr('target').submit();
            return false;
        }
        function handleSearchEnter(event) {
            if (event.keyCode == 13) {
                $('[id$=":searchBtn"]').click();
                return false;
            }
        }
        function setFocusOnLoad() {
            // do nothing. We don't want to focus on the first available element here.
        }
        function setDisabled(selector, disabled) {
            if (disabled) {
                $(selector).addClass('btnDisabled').attr('disabled', true);
            } else {
                $(selector).removeClass('btnDisabled').removeAttr('disabled');
            }
        };
        function setAuthFlowMessage(msg) {
            var $msg = $('.authFlowResponse');
            if (!$msg.length) $msg = $('[id$=":reportResPanel"]').append($('<span class="authFlowResponse resultMsg" />'));
            $msg.text(msg);
            if (msg) $msg.show();
            else $msg.hide();
        };
        function showIntegrationInfoModal() {
             $('#integrationInfoModal')
                .modal('show')
                .on('hide.bs.modal', function(e) {
                    $('#modalFade').remove();
                })
                .before('<div id="modalFade" class="modal-backdrop fade in" style="z-index: 100;"></div>');
        }
        function closeIntegrationInfoModal() {
            $('#integrationInfoModal').modal('hide');
        }
        function showStatusLoader() {
            $('[id$=":integrationInfoTypeStatus"]').css({
                position: 'absolute',
                top: '27px',
                right: '-22px'
            });
            $('[id$=":typeGroup"]').css('margin-right', '20px');
        }
    </script>
    <apex:outputPanel id="authorizeIntegrationInfoScript">
        <script>
            function authorizeIntegrationInfo(iiType, iiData) {
                if (iiType == 'Office 365') {
                    var name = $('[id$=":name"]')[0].value;
                    var otherExistingOffice365Names = JSON.parse('{!JSENCODE(office365Names)}');
                    var indexOfSelectedSiteCollectionName = otherExistingOffice365Names.indexOf(iiData['name']);
                    if (indexOfSelectedSiteCollectionName > -1) {
                        otherExistingOffice365Names.splice(indexOfSelectedSiteCollectionName, 1);
                    }
                    if (otherExistingOffice365Names.map(function(name) {return name.toLowerCase();}).indexOf(name.toLowerCase()) > -1) {
                        alert('This {!$ObjectType.Loop__Integration_Info__c.fields.Name.label} already exists.');
                        return false;
                    }

                    var endpoint = $('[id$=":baseUrl"]')[0].value;
                    if(!endpoint) {
                        alert('Site URL is required.');
                        return false;
                    }
                    var a = document.createElement('a');
                    a.href = endpoint;
                    endpoint = a.protocol + '//' + a.host;

                    var otherExistingOffice365SiteUrls = JSON.parse('{!JSENCODE(office365SiteUrls)}');
                    var indexOfSelectedSiteCollectionUrls = otherExistingOffice365SiteUrls.indexOf(iiData['baseUrl']);
                    if (indexOfSelectedSiteCollectionUrls > -1) {
                        otherExistingOffice365SiteUrls.splice(indexOfSelectedSiteCollectionUrls, 1);
                    }
                    if (otherExistingOffice365SiteUrls.map(function(url) {return url.toLowerCase();}).indexOf(endpoint.toLowerCase()) > -1) {
                        alert('This Site URL already exists.');
                        return false;
                    }
                    
                    if(!name) {
                        alert('{!$ObjectType.Loop__Integration_Info__c.fields.Name.label} is required.');
                        return false;
                    }
                    
                    var sitePaths = $('[id$=":sitePath"]').map(function(i, e) {return e.value;});
                    if (sitePaths.length < 1) {
                        alert('At least one site path is required.');
                        return false;
                    }
                    else if (sitePaths.filter(function(i, e) {return !e;}).length > 0) {
                        alert('Site paths can not be blank.');
                        return false;
                    }
                    else if (sitePaths.filter(function(i, e) {return !e.startsWith('/')}).length > 0) {
                        alert('Site paths must start with \'/\'');
                        return false;
                    }
                    
                    var sessionId = '{!sessionId}';
                    var location = '{!partnerServerUrl}';
                    var next = 'https://' + window.location.hostname + '{!$Page.landingPage}';
                    var authorizationUrl = '{!office365AuthorizationUrl}' + 
                        '?sessionid=' + encodeURIComponent(sessionId) + 
                        '&location=' + encodeURIComponent(location) + 
                        '&endpoint=' + encodeURIComponent(endpoint) + 
                        '&next=' + encodeURIComponent(next);
                    window.open(authorizationUrl, 'Authorize Office 365', 'height=500,width=500,location=0,status=0,titlebar=0');
                    return false;
                }
                return true;
            }
        </script>
    </apex:outputPanel>
    <script src="{!URLFOR($Resource.Scripts, '/bootstrap-3.2.0/bootstrap.min.js')}"></script>
    <apex:sectionHeader title="LOOP Document Services from Drawloop Technologies" help="http://support.drawloop.com/lds/" />
    <div id="ieMsgs" />
    <apex:form id="aForm">
        <apex:actionFunction action="{!handleOAuthResult}" name="handleOAuthResult" rerender="integrationInfoPanel,authorizeIntegrationInfoScript" >
            <apex:param name="success" value="" />
            <apex:param name="errorCode" value="" />
            <apex:param name="errorId" value="" />
        </apex:actionFunction>
        <table class="fullwidth">
            <tbody>
                <tr>
                    <td class="halfwidth">
                        <div class="pageBlock">
                            <div class="top-line">
                                <div class="panelHeader"><h2>Support</h2></div>
                            </div>
                            <div class="panelContent firstrow">
                                <table class="gs-links">
                                    <tbody>
                                        <tr>
                                            <td>
                                                <img src="{!URLFOR($Resource.Styles, 'images/ddp.png')}" class="sectionImage" />
                                            </td>
                                            <td class="gs-middle">
                                                <div class="steps-header">Build Your First DDP</div>
                                                <div class="steps-text">Create a basic DDP in minutes. Our online support site offers text and video training.</div>
                                                <a class="gsbutton" href="http://support.drawloop.com/lds/" target="_blank">Support Site</a>
                                            </td>
                                            <td class="gs-icons">
                                                <div class="steps-header-hilite">Contact Us</div>
                                                <ul class="gs-learn-more contact">
                                                    <li>Email: <a href="mailto:loopsupport@drawloop.com">loopsupport@drawloop.com</a></li>
                                                    <li>Support Hours: M-F, 6am - 5pm PT</li>
                                                    <li>Phone (US): 949.242.0455 opt 2</li>
                                                    <li>Phone (UK): +44 203 318 3234 opt 2</li>
                                                    <li>Phone (AU): +61 28 417 2058 opt 2</li>
                                                    <li>Extended hours available on request</li>
                                                </ul>
                                            </td>
                                        </tr>
                                        <tr><td></td><td colspan="2">
                                            <div class="steps-header">Need help?</div>
                                            <div class="steps-text">
                                                Support engineers are available by email or phone.<br />
                                                You may need to provide your Org Id to support: {!$Organization.Id}.
                                            </div>
                                            <div style="width: 250px;">
                                                <a class="bluebtn" href="mailto:loopsupport@drawloop.com?subject=SUPPORT REQUEST&body={!URLENCODE(caseBody)}" target="_blank">Log a Case</a>
                                                <a class="bluebtn" href="/partnerbt/grantLoginAccess.apexp" target="_blank">Grant Login Access</a>
                                            </div>
                                        </td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                    <td class="halfwidth">
                        <div class="pageBlock">
                            <div class="top-line">
                                <div class="panelHeader"><h2>Subscription</h2></div>
                            </div>
                            <div class="panelContent firstrow">
                                <table class="gs-links">
                                    <tbody>
                                        <tr>
                                            <td>
                                                <img src="{!URLFOR($Resource.Styles, 'images/subscriptions.png')}" class="sectionImage" />
                                            </td>
                                            <td class="gs-middle">
                                                <div class="steps-header">Manage Your Subscription</div>
                                                <div class="steps-text">
                                                    By default, your install comes with the Standard edition. Use the modify button below to upgrade to the Business edition or add on Report Scheduling.
                                                    Note: upgrades and add-ons have additional charges. See our
                                                    <a href="http://www.drawloop.com/products/pricing/loop-document-services/" target="_blank">pricing page</a> for more information.
                                                </div>
                                                <div style="width: 475px;">
                                                    <apex:commandButton styleClass="bluebtn" value="Modify Subscription Services" action="{!modifySubscriptions}" />
                                                    <apex:commandButton styleClass="bluebtn" value="Subscribe / Add On" action="{!subscribe}" />
                                                    <apex:commandButton styleClass="bluebtn" value="Request Proposal / Quote" action="{!requestQuote}" />
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>&nbsp;</td>
                                            <td class="gs-middle">
                                                <div class="steps-header" style="padding-top: 20px;">Your Current Subscription</div>
                                                <apex:outputPanel id="subscriptionPanel" styleclass="steps-text">
                                                    Service Level: {!ldsLevel}
                                                    <apex:actionStatus stopText="" id="serviceLevelStatus">
                                                           <apex:facet name="start">
                                                               <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                           </apex:facet>
                                                       </apex:actionStatus>
                                                    <br />
                                                    Add-Ons: {!addOns}
                                                </apex:outputPanel>
                                                <apex:pageMessages id="subscriptionMessages" />
                                                <apex:actionFunction name="loadSubscription" action="{!loadSubscription}" status="serviceLevelStatus" rerender="subscriptionMessages,subscriptionPanel">
                                                       <apex:param name="serverUrl" assignTo="{!serverUrl}" value="{!$Api.Partner_Server_URL_300}" />
                                                </apex:actionFunction>
                                                <script>setTimeout(loadSubscription, 500);</script>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="halfwidth">
                        <div class="pageBlock">
                            <div class="top-line">
                                <div class="panelHeader"><h2>Setup</h2></div>
                            </div>
                            <div class="panelContent secondrow">
                                <table class="gs-links setupItems" id="setupItems">
                                    <tbody>
                                        <tr class="first">
                                            <td>
                                                <img src="{!URLFOR($Resource.Styles, 'images/setup.png')}" class="sectionImage" />
                                            </td>
                                            <td class="gs-middle">
                                                <div class="steps-header">Configure and Deploy LOOP Document Services</div>
                                                <div class="steps-text">Use the options below to configure and deploy LOOP to enable DDPs for your users.</div>
                                            </td>
                                        </tr>
                                        <apex:outputPanel rendered="{!NOT(isProductionOrg)}">
                                            <tr>
                                                <td colspan="2" class="left">
                                                    <div>
                                                        If this is a sandbox organization and users are unable to run DDPs, you may need to click this button to enable this sandbox. (Did this accidentally? Click&nbsp;
                                                        <apex:commandLink value="here" action="{!notSandbox}" rerender="sbResPanel" status="sandboxStatus" />.)
                                                    </div>
                                                </td>
                                                <td>
                                                    <div style="width: 200px;">
                                                        <apex:commandButton styleClass="bluebtn" value="Authorize Sandbox Account" action="{!authorizeSandbox}" rerender="sbResPanel" status="sandboxStatus" />
                                                        <apex:actionStatus stopText="" id="sandboxStatus">
                                                            <apex:facet name="start">
                                                                <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                            </apex:facet>
                                                        </apex:actionStatus>
                                                    </div>
                                                    <apex:outputPanel id="sbResPanel" styleClass="resultMsg" layout="block">
                                                        {!sandboxResult}
                                                    </apex:outputPanel>
                                                </td>
                                            </tr>
                                        </apex:outputPanel>
                                        <tr>
                                            <td colspan="3" class="left">
                                                <div>
                                                    Use the links below to add the standard LOOP buttons to your page layouts:
                                                    <table><tbody>
                                                        <tr>
                                                            <td><a href="/ui/setup/layout/PageLayouts?type=Lead&setupid=LeadLayouts" target="_top">Lead Page Layouts</a></td>
                                                            <td><a href="/ui/setup/layout/PageLayouts?type=Account&setupid=AccountLayouts" target="_top">Account Page Layouts</a></td>
                                                            <td><a href="/ui/setup/layout/PageLayouts?type=Contract&setupid=ContractLayouts" target="_top">Contract Page Layouts</a></td>
                                                        </tr>
                                                        <tr>
                                                            <td><a href="/ui/setup/layout/PageLayouts?type=Contact&setupid=ContactLayouts" target="_top">Contact Page Layouts</a></td>
                                                            <td><a href="/ui/setup/layout/PageLayouts?type=Opportunity&setupid=OpportunityLayouts" target="_top">Opportunity Page Layouts</a></td>
                                                            <td><a href="/ui/setup/layout/PageLayouts?type=Case&setupid=CaseLayouts" target="_top">Case Page Layouts</a></td>
                                                        </tr>
                                                    </tbody></table>
                                                </div>
                                            </td>
                                            <td>&nbsp;</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="left">
                                                <div>To create your own custom DDP button / link / tab, use our point-and-click deployment wizard.</div>
                                            </td>
                                            <td>
                                                <apex:commandButton styleClass="bluebtn" action="{!ddpButtonWizard}" value="DDP Deployment Wizard" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="left">
                                                <div>If your organization runs automated DDPs (Mass, Apex, Outbound Messages), you can view the status of the job queue here.</div>
                                            </td>
                                            <td>
                                                <apex:commandButton styleClass="bluebtn" action="{!URLFOR($Page.JobQueueStatus)}" value="Job Queue" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="left">
                                                <div>
                                                    To migrate DDPs (using the <a href="http://support.drawloop.com/lds#!/lds/getting-started/migrate-ddps#Documentation" target="_blank">DDP Migration Tool</a>)
                                                    to this org without using a security token, authorize the Drawloop IP range: <span style="display: inline;" id="iprange"></span>.
                                                </div>
                                            </td>
                                            <td>
                                                <apex:commandButton styleClass="bluebtn" value="Authorize IP Ranges" onclick="getIp('authorizeip', 'url'); return false;" />
                                                <script>getIp('displayIp', 'string');</script>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="left">
                                                <div>
                                                    To use Report Scheduling (scheduled DDPs) or Mass DDPs, you will need to authorize LOOP Services. This button will authorize LOOP Services to run as your user.
                                                    If you wish to authorize this as a different user, you can <a href="{!authorizeLoginUrl}">click here</a> to login and authorize as that user.
                                                </div>
                                            </td>
                                            <td>
                                                <div style="width: 200px;" class="authorizeReports">
                                                    <apex:commandButton styleClass="bluebtn" value="Authorize LOOP Services" action="{!authorizeReports}" rerender="msg,reportResPanel,configureIntegrationPanel" onclick="if (!authorizeLogin()) return false;" status="loopReportsStatus" />
                                                    <apex:actionStatus stopText="" id="loopReportsStatus">
                                                        <apex:facet name="start">
                                                            <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                        </apex:facet>
                                                    </apex:actionStatus>
                                                </div>
                                                <apex:outputPanel id="reportResPanel" styleClass="resultMsg" layout="block">
                                                    {!loopReportsResult}
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="left">
                                                <div>
                                                    The Mass via Reports feature allows users to run a DDP in mass for records in a Salesforce report instead of from a list view.
                                                    To use this feature, click this button to enable the LOOP Visualforce domain as a Remote Site.
                                                </div>
                                            </td>
                                            <td>
                                                <apex:commandButton styleClass="bluebtn" value="Configure Mass via Reports" action="{!addSfForLoopRemoteSite}" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="left">
                                                <div>
                                                    Configure an integration by populating the necessary fields. A user must have Customize Application permission enabled in order to configure an integration.
                                                </div>
                                            </td>
                                            <td>
                                                <apex:outputPanel layout="block" id="configureIntegrationPanel" >
                                                    <div style="width: 200px;" >
                                                        <apex:commandButton styleClass="bluebtn" value="Configure Integration" action="{!listSiteCollections}" onClick="showIntegrationInfoModal();" disabled="{!NOT(userCanCustomizeApplication)}" rerender="msg" status="configureIntegrationStatus" />
                                                        <apex:actionStatus id="configureIntegrationStatus">
                                                            <apex:facet name="start">
                                                                <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                            </apex:facet>
                                                        </apex:actionStatus>
                                                    </div>
                                                    <apex:outputPanel styleClass="resultMsg" layout="block">
                                                        {!configureIntegrationResult}
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                        <tr class="last">
                                            <td colspan="2" class="left">
                                                <div>
                                                    LOOP Document Services supports Salesforce authorization and authentication via
                                                    <a href="http://www.drawloop.com/blog/2013/11/26/connected-apps-what-enterprise-orgs-want/" target="_blank">Connected Apps</a>.
                                                    Connected Apps add additional levels of control, allowing administrators explicit control over who can use the application,
                                                    and various security policies to be enforced by the application.
                                                </div>
                                            </td>
                                            <td>
                                                <apex:outputPanel id="connectedAppPanel">
                                                    <div style="width: 200px;">
                                                        <apex:commandButton styleClass="bluebtn" value="{!IF(connectedAppEnabled, 'Disable', 'Enable')} Connected App" action="{!toggleConnectedApp}" rerender="msg,connectedAppPanel" status="connectedAppStatus" />
                                                        <apex:actionStatus stopText="" id="connectedAppStatus">
                                                            <apex:facet name="start">
                                                                <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                            </apex:facet>
                                                        </apex:actionStatus>
                                                    </div>
                                                    <apex:outputText value="{!toggleConnectedAppMessage}" />
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                        <tr class="{!IF(ISBLANK(drawloopSubdomain),'last','')}">
                                            <td colspan="3" class="left">
                                                <apex:pageMessages id="msg" />
                                            </td>
                                        </tr>
                                        
                                        <apex:outputPanel rendered="{!NOT(ISBLANK(drawloopSubdomain))}">
                                            <tr class="last">
                                                <td colspan="2" class="left">
                                                    <div>Specify the subdomain to be used with your Drawloop service endpoint.</div>
                                                </td>
                                                <td>
                                                    <apex:selectList value="{!drawloopSubdomain}" size="1" style="margin-right: 10px; vertical-align: middle;">
                                                        <apex:selectOption itemValue="apps" itemLabel="Default" />
                                                        <apex:selectOption itemValue="na1" itemLabel="NA1" />
                                                        <apex:selectOption itemValue="na2" itemLabel="NA2" />
                                                        <apex:selectOption itemValue="previous" itemLabel="Previous" rendered="{!drawloopSubdomain='previous'}" />
                                                    </apex:selectList>
                                                    <apex:commandButton styleClass="bluebtn" style="width: 50px; vertical-align: initial;" value="Save" action="{!saveSubdomain}" rerender="saveResponsePanel" status="subdomainStatus" />
                                                    <apex:actionStatus stopText="" id="subdomainStatus">
                                                        <apex:facet name="start">
                                                            <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                        </apex:facet>
                                                    </apex:actionStatus>
                                                    <apex:outputPanel layout="block" id="saveResponsePanel">
                                                        <apex:outputText value="{!saveResponse}" />
                                                    </apex:outputPanel>
                                                </td>
                                            </tr>
                                        </apex:outputPanel>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <apex:commandLink action="{!resetDdpFilesUpdate}" value="reset" style="display: none;" />
                    </td>
                    <td class="halfwidth">
                        <div class="pageBlock">
                            <div class="top-line">
                                <div class="panelHeader"><h2>Testing</h2></div>
                            </div>
                            <div class="panelContent secondrow">
                                <table class="gs-links">
                                    <tbody>
                                        <tr>
                                            <td>
                                                <img src="{!URLFOR($Resource.Styles, 'images/users.png')}" class="sectionImage" />
                                            </td>
                                            <td class="gs-middle">
                                                <div class="steps-header">Enable Test Users</div>
                                                <div class="steps-text">
                                                    This section determines which users can use the Run Test button when the
                                                    <a href="http://support.drawloop.com/lds#!/lds/ddp-help/test-ddps-on-preview#Documentation" target="_blank">DDP preview service</a>
                                                    is available.
                                                </div>
                                                <apex:outputLabel value="Search:" for="searchFilter" />
                                                <apex:outputPanel >
                                                    <apex:inputText value="{!searchFilter}" id="searchFilter" onkeypress="return handleSearchEnter(event);" style="margin: 0 5px;" />
                                                    <apex:commandButton id="searchBtn" value="Find" action="{!resetUserList}" status="secSearchStatus" rerender="pageMessages,duel" />
                                                    <apex:actionStatus stopText="" id="secSearchStatus" styleClass="nowrap">
                                                        <apex:facet name="start">
                                                            <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                        </apex:facet>
                                                    </apex:actionStatus>
                                                </apex:outputPanel>
                                                <apex:outputPanel id="duel" styleClass="duelingListBox">
                                                    <apex:outputText id="resultsErrMsg" styleClass="errorMsg" value="{!resultsErrMsg}" />
                                                    <table class="layout">
                                                        <tr>
                                                            <td class="selectCell">
                                                                <div class="selectTitle">
                                                                    <apex:outputLabel value="Available Users" for="secIds" styleClass="selectTitle" />
                                                                </div>
                                                                <apex:selectList size="14" multiselect="true" id="secIds" value="{!selectedAvailableIds}">
                                                                    <apex:selectOptions value="{!availableUsers}" />
                                                                </apex:selectList>
                                                                <script type="text/javascript">
                                                                    jQuery(function() {
                                                                        var errMsg = '{!resultsErrMsg}';
                                                                        if (errMsg) jQuery('[id$=":resultsErrMsg"]').text(errMsg);
                                                                    });
                                                                </script>
                                                            </td>
                                                            <td class="buttonCell">
                                                                <div class="text">
                                                                    Add
                                                                    <apex:actionStatus startText=". . ." stopText="" id="addStatus" styleClass="nowrap">
                                                                        <apex:facet name="start">
                                                                            <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                                        </apex:facet>
                                                                    </apex:actionStatus>
                                                                </div>
                                                                <div class="text">
                                                                    <apex:commandLink action="{!addTestingUser}" status="addStatus" rerender="pageMessages,duel">
                                                                        <apex:image title="Add" styleClass="rightArrowIcon" alt="Add" value="/s.gif" />
                                                                    </apex:commandLink>
                                                                </div>
                                                                <div class="text">
                                                                    <apex:commandLink action="{!removeTestingUser}" status="remStatus" rerender="pageMessages,duel">
                                                                        <apex:image title="Remove" styleClass="leftArrowIcon" alt="Remove" value="/s.gif" />
                                                                    </apex:commandLink>
                                                                </div>
                                                                <div class="duelingText">
                                                                    Remove
                                                                    <apex:actionStatus startText=". . ." stopText="" id="remStatus" styleClass="nowrap">
                                                                        <apex:facet name="start">
                                                                            <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                                                        </apex:facet>
                                                                    </apex:actionStatus>
                                                                </div>
                                                            </td>
                                                            <td class="selectCell">
                                                                <div class="selectTitle">
                                                                    <apex:outputLabel value="DDP Testers" for="selectedSecIds" styleClass="selectTitle" />
                                                                </div>
                                                                <apex:selectList size="14" multiselect="true" id="selectedSecIds" value="{!selectedSelectedIds}">
                                                                    <apex:selectOptions value="{!selectedUsers}" />
                                                                    <apex:actionSupport event="ondblclick" onsubmit="if (event.target.nodeName=='OPTION') window.open('/'+event.target.value); return false;" />
                                                                </apex:selectList>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><apex:pageMessages id="pageMessages" /></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <apex:outputPanel layout="block" styleClass="drawloop-bootstrap" >
            <div class="modal fade" id="integrationInfoModal" tabindex="-1" >
                <apex:outputPanel layout="block" styleClass="modal-dialog modal-sm" id="integrationInfoPanel" >
                    <apex:outputPanel layout="block" styleClass="panel panel-primary" >
                        <apex:outputPanel layout="block" styleClass="panel-heading">
                            <h4 class="modal-title" id="myModalLabel">{!IF(mode == 'CREATE', 'New ', IF(mode == 'EDIT', 'Edit ', ''))}{!$ObjectType.Loop__Integration_Info__c.label}</h4>
                            <apex:commandLink styleClass="close" action="{!closeDialog}" onClick="closeIntegrationInfoModal();" rerender="integrationInfoPanel" >&times;</apex:commandLink>
                        </apex:outputPanel>
                        <apex:outputPanel layout="block" styleClass="panel-body" rendered="{!AND(mode == 'VIEW', NOT(ISBLANK(integrationInfoAlerts)))}" >
                            <apex:repeat value="{!integrationInfoAlerts}" var="iia" >
                                <apex:outputPanel styleClass="{!iia.styleClass}" layout="block" >
                                    <strong>{!iia.title}</strong> {!iia.message}
                                </apex:outputPanel>
                            </apex:repeat>  
                        </apex:outputPanel>
                        <apex:dataTable styleClass="table table-hover fixedTable" value="{!siteCollectionRows}" var="sc" rendered="{!mode == 'VIEW'}" >
                            <apex:column colspan="{!IF(sc.isHeader, '2', '1')}">
                                <apex:outputText value="{!sc.Name}" styleClass="{!IF(OR(sc.isHeader, sc.isIndividual),'siteCollectionRowParent','siteCollectionRowChild')}"/>
                            </apex:column>
                            <apex:column rendered="{!!sc.isHeader}" styleClass="editDeleteLinks" >
                                <apex:commandLink value="edit" action="{!editSiteCollection}" rerender="integrationInfoPanel" >
                                    <apex:param name="scName" value="{!sc.Name}" assignTo="{!selectedSiteCollectionName}" />
                                </apex:commandLink>
                                &nbsp;|&nbsp;
                                <apex:commandLink value="delete" action="{!deleteSiteCollection}" onClick="if (!confirm('Are you sure?')) {return false;}" rerender="integrationInfoPanel" >
                                    <apex:param name="scName" value="{!sc.Name}" assignTo="{!selectedSiteCollectionName}" />
                                </apex:commandLink>
                            </apex:column>
                        </apex:dataTable>
                        <apex:outputPanel layout="block" id="newIntegrationInfo" styleClass="panel-body" rendered="{!OR(mode == 'CREATE', mode == 'EDIT')}" >
                            <apex:repeat value="{!integrationInfoAlerts}" var="iia" rendered="{!NOT(ISBLANK(integrationInfoAlerts))}" >
                                <apex:outputPanel styleClass="{!iia.styleClass}" layout="block" >
                                    <strong>{!iia.title}</strong> {!iia.message}
                                </apex:outputPanel>
                            </apex:repeat>
                            <apex:outputPanel id="typeGroup" layout="block" styleClass="form-group type-form-group" rendered="{!mode == 'CREATE'}" >
                                <apex:outputLabel for="integrationInfoType" styleClass="control-label" value="Type" />
                                <apex:selectList id="integrationInfoType" styleClass="form-control" value="{!selectedSiteCollection.collectionType}" size="1" >
                                    <apex:actionSupport event="onchange" rerender="newIntegrationInfo,integrationInfoButtons" status="integrationInfoTypeStatus" />
                                    <apex:selectOptions value="{!availableSiteCollectionOptions}" />
                                </apex:selectList>
                                <apex:actionStatus id="integrationInfoTypeStatus" onstart="showStatusLoader();">
                                    <apex:facet name="start" >
                                        <span class="statusContainer"><span class="status"><img src="/img/loading.gif" alt="Processing..." width="16" height="16" title="Processing..." /></span></span>
                                    </apex:facet>
                                </apex:actionStatus>
                            </apex:outputPanel>
                            <apex:outputPanel layout="block" styleclass="form-group" rendered="{!mode == 'EDIT'}" >
                                <apex:outputLabel for="integrationInfoType2" styleClass="control-label" value="Type" />
                                <apex:outputText id="integrationInfoType2" styleClass="form-control" value="{!selectedSiteCollection.collectionType}" html-disabled=""/>
                            </apex:outputPanel>
                            <apex:outputPanel layout="block" styleClass="form-group" rendered="{!selectedSiteCollection.collectionType == 'Office 365'}" >
                                <apex:outputLabel for="name" styleClass="control-label" value="{!$ObjectType.Loop__Integration_Info__c.fields.Name.label}" />
                                <apex:inputText id="name" styleClass="form-control" value="{!selectedSiteCollection.name}" />
                            </apex:outputPanel>
                            <apex:outputPanel layout="block" styleClass="form-group" rendered="{!OR(selectedSiteCollection.collectionType == 'e-SignLive', selectedSiteCollection.collectionType == 'Lob')}" >
                                <apex:outputLabel for="apiKey" styleClass="control-label" value="{!$ObjectType.Loop__Integration_Info__c.fields.Loop__API_Key__c.label}" />
                                <apex:inputText id="apiKey" styleClass="form-control" value="{!selectedSiteCollection.apiKey}" />
                            </apex:outputPanel>
                            <apex:outputPanel layout="block" styleClass="form-group" rendered="{!OR(selectedSiteCollection.collectionType == 'e-SignLive', selectedSiteCollection.collectionType == 'Lob', selectedSiteCollection.collectionType == 'DDP API', selectedSiteCollection.collectionType == 'Office 365')}" >
                                <apex:outputLabel for="baseUrl" styleClass="control-label" value="{!IF(selectedSiteCollection.collectionType == 'Office 365', 'Site URL', $ObjectType.Loop__Integration_Info__c.fields.Loop__Base_URL__c.label)}" />
                                <apex:inputText id="baseUrl" styleClass="form-control" value="{!selectedSiteCollection.siteUrl}" html-placeholder="{!IF(selectedSiteCollection.collectionType == 'Office 365', 'https://[sitename].sharepoint.com', '')}" />
                            </apex:outputPanel>
                            <apex:outputPanel layout="block" styleClass="form-group" rendered="{!selectedSiteCollection.collectionType == 'DDP API'}" >
                                <apex:outputLabel for="tagSourceUrl" styleClass="control-label" value="{!$ObjectType.Loop__Integration_Info__c.fields.Loop__Tag_Source_URL__c.label}" />
                                <apex:inputText id="tagSourceUrl" styleClass="form-control" value="{!selectedSiteCollection.tagSourceUrl}" />
                            </apex:outputPanel>
                            <apex:outputPanel layout="block" id="sitePathsPanel" styleClass="form-group" rendered="{!selectedSiteCollection.collectionType == 'Office 365'}">
                                <apex:outputPanel layout="block">
                                    <apex:outputLabel for="sitePaths" styleClass="control-label" value="Site Paths" />
                                    <apex:outputPanel style="margin-left: 4px;" styleClass="glyphicon glyphicon-info-sign" html-data-toggle="sitepath-tooltip" html-data-placement="right" title="Use '/' for the Root directory."/>
                                </apex:outputPanel>
                                <script>
                                    // initialize tooltip
                                    $('[data-toggle="sitepath-tooltip"]').tooltip();
                                </script>
                                <apex:variable value="{!0}" var="rowNumber" />
                                <apex:repeat value="{!selectedSiteCollection.sitePaths}" var="path" >
                                    <apex:outputPanel layout="block" styleClass="sitePaths" style="margin-bottom: 5px;">
                                        <apex:inputText id="sitePath" value="{!path.url}" styleClass="form-control" html-placeholder="/site/[collectionname]"/>
                                        <!-- <input type="text" value="{!selectedSiteCollection.sitePaths[rowNumber]}" class="form-control" placeholder="/site/[collectionname]"/> -->
                                        <apex:commandLink action="{!selectedSiteCollection.removeSitePath}" rerender="sitePathsPanel" styleClass="glyphicon glyphicon-minus" style="margin-left: 10px;margin-top: 10px;text-decoration:none;" html-data-toggle="remove-tooltips" html-data-placement="top" title="Remove">
                                            <apex:param name="p1" value="{!rowNumber}" assignTo="{!selectedSiteCollection.sitePathIndexToRemove}" />
                                        </apex:commandLink>
                                    </apex:outputPanel>
                                    <apex:variable var="rowNumber" value="{!rowNumber + 1}" />
                                </apex:repeat>
                                <script>
                                    // initialize tooltips
                                    $('[data-toggle="remove-tooltips"]').tooltip();
                                </script>
                                <apex:outputPanel layout="block">
                                    <apex:commandLink value="+ add site path" action="{!selectedSiteCollection.createSitePath}" rerender="sitePathsPanel" />
                                </apex:outputPanel>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <apex:outputPanel layout="block" styleClass="panel-footer text-right" id="integrationInfoButtons" >
                            <apex:commandButton styleClass="btn btn-primary" value="New" action="{!createSiteCollection}" rerender="integrationInfoPanel" rendered="{!mode == 'VIEW'}" />
                            <apex:commandButton styleClass="btn btn-default text-left" value="Cancel" action="{!listSiteCollections}" rerender="integrationInfoPanel" rendered="{!OR(mode == 'CREATE', mode == 'EDIT')}" />
                            <apex:commandButton id="authSaveButton" styleClass="btn btn-primary" value="{!IF(selectedSiteCollection.collectionType == 'Office 365', 'Authorize', 'Save')}" onclick="if (!authorizeIntegrationInfo('{!selectedSiteCollection.collectionType}', { mode: '{!mode}', name: '{!JSENCODE(selectedSiteCollection.name)}', baseUrl: '{!JSENCODE(selectedSiteCollection.siteUrl)}'})) {return false;}" action="{!saveSiteCollection}" style="margin-left:10px;" rerender="integrationInfoPanel" rendered="{!AND(OR(mode == 'CREATE', mode == 'EDIT'), NOT(ISBLANK(selectedSiteCollection.collectionType)))}" />
                            <script>
                                var authSaveButton = $('[id$=authSaveButton]')
                                if (authSaveButton) {
                                    $(document).keypress(function(e) {
                                        if (e.which == 13) {
                                            authSaveButton.click();
                                            return false;
                                        }
                                    });
                                }
                            </script>
                        </apex:outputPanel>
                    </apex:outputPanel>
                </apex:outputPanel>
            </div>
        </apex:outputPanel>
    </apex:form>
    <apex:outputPanel id="authRptPanel">
        <form method="POST" id="authRptForm" style="height: 0;" action="{!actionUrl}">
            <input type="hidden" name="sessionid" value="{!sessionId}" />
            <input type="hidden" name="location" value="{!$Api.Partner_Server_URL_300}" />
            <input type="hidden" name="auto" value="true" id="auto" />
            <input type="hidden" name="next" value="" id="next" />
        </form>
    </apex:outputPanel>
</apex:page>