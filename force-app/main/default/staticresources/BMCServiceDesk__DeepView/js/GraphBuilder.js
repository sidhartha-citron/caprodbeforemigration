var Diagram=MindFusion.Diagramming.Diagram;var DiagramLink=MindFusion.Diagramming.DiagramLink;var Events=MindFusion.Diagramming.Events;var ShapeNode=MindFusion.Diagramming.ShapeNode;var TableNode=MindFusion.Diagramming.TableNode;var SvgContent=MindFusion.Diagramming.SvgContent;var AutoResize=MindFusion.Diagramming.AutoResize;var Behavior=MindFusion.Diagramming.Behavior;var ColumnStyle=MindFusion.Diagramming.ColumnStyle;var Alignment=MindFusion.Diagramming.Alignment;var ImageAlign=MindFusion.Diagramming.ImageAlign;var Font=MindFusion.Drawing.Font;var Rect=MindFusion.Drawing.Rect;var Text=MindFusion.Drawing.Text;var CellFrameStyle=MindFusion.Diagramming.CellFrameStyle;var TreeLayout=MindFusion.Graphs.TreeLayout;var TreeLayoutLinkType=MindFusion.Graphs.TreeLayoutLinkType;var fontStyle=new Font("Salesforce Sans",3.8);var SimpleShape=MindFusion.Diagramming.SimpleShape;var Thickness=MindFusion.Drawing.Thickness;var ExpandButton=MindFusion.Diagramming.ExpandButton;var updateCanvasElementsOriginal=TableNode.prototype.updateCanvasElements;var EF="Ñ„";TableNode.prototype.updateCanvasElements=function(){updateCanvasElementsOriginal.apply(this);var c=this.graphicsContainer.content;var a=-1;for(var b=0;b<c.length;b++){var f=c[b];if(MindFusion.AbstractionLayer.isInstanceOfType(MindFusion.Drawing.Line,f)){a=b;break}}if(a>-1){c.splice(a,1)}var e=this.getCell(0,0).image;var d=1;if(e!=undefined){e.bounds.y+=d;e.bounds.height-=d}};var nodeMap={};var nodeConfiguration={rootNode:{backgroundColor:"#CEF6F5",borderColor:"#30a9c0",borderRadius:"1",radius:32},junctionNode:{backgroundColor:"#CEF6F5",borderColor:"#30a9c0",borderRadius:"1",radius:5},link:{headShape:"Triangle",headBrush:"#999",stroke:"#999"}};var approvalStatus;var approvalNode;var clickEventApprovalFired=false;$(document).ready(function(){if(showSidebarOnly!==true){$("#graphicalView").draggable({opacity:0.5,snap:true});createDiagramCanvas();setEventListeners();updatePrototype()}});function createDiagramCanvas(){diagram=Diagram.create($("#diagram")[0]);diagram.setLicenseLocation(licenseLocation);diagram.setAutoResize(AutoResize.AllDirections);diagram.setBehavior(Behavior.SelectOnly);diagram.setAdjustmentHandlesSize(0.4);diagram.ContainerMargin=500;diagram.setShapeBrush("White");diagram.setLinkHeadShapeSize(2);diagram.setShadowsStyle(MindFusion.Diagramming.ShadowsStyle.None)}function setlefttozero(){if($("#graphicalView")!=undefined&&parseFloat($("#graphicalView").css("left"))<0){document.getElementById("graphicalView").style.left="0px";document.getElementById("graphicalView").style.top="0px"}}function setEventListeners(){diagram.addEventListener(Events.treeCollapsed,rearrangeTree);diagram.addEventListener(Events.treeExpanded,rearrangeTree);diagram.addEventListener(Events.nodeSelected,nodeSelectedEvent);diagram.addEventListener(Events.nodeDeselected,nodeDeselectedEvent);diagram.addEventListener(Events.nodeClicked,nodeClickedEvent);diagram.addEventListener(Events.treeCollapsed,setlefttozero)}function updatePrototype(){var a=MindFusion.Diagramming.SelectOnlyBehavior;a.prototype.setMouseCursor=function(c){var d=this.diagram.getNodeAt(c);return d?"pointer":"default"};ShapeNode.prototype.onUpdateVisuals=function(){var c=this.getBounds().clone();if(this.image){c.y+=4;c.height=12;c.width=12;c.x+=9;this.image.setBounds(c)}this.text.setBounds(Rect.fromLTRB(c.x,this.image?this.image.bounds.bottom():1,c.right(),this.getBounds().bottom()-1))};var b=MindFusion.Controls.ZoomControl.create($("#zoomWidget")[0]);b.setTarget(diagram);b.setZoomFactor(70)}function initiateDiagram(b,d,f,h){var i=h?ObjectLabels.singular["Service_Request__c"]:ObjectLabels.singular[(b.attributes.type).replace(namespacePrefix,"")];var h=b[namespacePrefix+"isServiceRequest__c"];var c;if(h){c="Service_Request__c"}else{c=b.attributes.type.replace(namespacePrefix,"")}var a=b[namespacePrefix+"FKStatus__r"][namespacePrefix+"state__c"];var e=buildShapeNode(rootNodePrefix[c]+b.Name,imgIcons[c][a?"open":"closed"],nodeConfiguration.rootNode);e.setId(rootNodeID);nodeMap[rootNodeID]=e;var g=buildShapeNode("","",nodeConfiguration.junctionNode);buildLink(e,g);buildNodeElements(DeepViewconfiguration.objects[c],c,b,d,f,g)}function buildShapeNode(c,e,d){var a=d.radius;var b=diagram.getFactory().createShapeNode(a,a,a,a);b.setShape("Circle");b.setBrush(d.backgroundColor);b.setStroke(d.borderColor);b.setStrokeThickness(d.borderRadius);b.setFont(fontStyle);b.setText(c);b.setTextColor("black");b.setTextAlignment(Alignment.Center);b.setTag(pageLoadData.nodeID);b.setTag(pageLoadData.APIName);b.setImageLocation(e);b.setImageAlign(ImageAlign.TopCenter);return b}function buildHeaderTableNode(e,g,d,h){var i=diagram.getFactory().createTableNode(10,30,40,18);i.setCellFrameStyle("transparent");i.setFont(fontStyle);i.setTextColor("black");i.setBrush("white");i.setStroke("#999999");i.setTag("transparent");i.redimTable(5,5);i.columnStyle=ColumnStyle.AutoWidth;i.setCaptionHeight(0);i.setShape(SimpleShape.RoundedRectangle);i.setStrokeThickness(1);i.setTooltip(htmlEscape(h));var c=i.getCell(0,0);c.rowSpan=2;c.colSpan=1;c.setImageLocation(d);var f=i.getCell(1,0);f.setText(g);f.setColumnSpan(3);var b=diagram.measureString(f.getText(),i.getEffectiveFont());var a=i.getBounds();a.width=b.width+2+18;i.setBounds(a);i.getColumn(1).width=a.width-14;i.getColumn(0).width=14;return i}function buildLink(c,a){var b=diagram.getFactory().createDiagramLink(c,a);b.setStroke(nodeConfiguration.link.stroke);b.setHeadShape(nodeConfiguration.link.headShape);b.setHeadBrush(nodeConfiguration.link.headBrush)}function printPage(){window.print()}function buildChildTableNode(f,g,e,j,h,c){var i=diagram.getFactory().createTableNode(20,30,25,25);i.setFont(fontStyle);i.setText(g);i.setTextColor("black");i.setBrush("white");i.setStroke("transparent");i.redimTable(5,5);i.columnStyle=ColumnStyle.AutoWidth;i.setCaptionHeight(0);i.setId(f);i.setTag(j);i.setTooltip(htmlEscape(h));var d=i.getCell(0,1);d.rowSpan=2;d.colSpan=1;d.setImageLocation(e);var b=diagram.measureString(i.getText(),i.getEffectiveFont());var a=i.getBounds();a.width=b.width+2+3;i.setBounds(a);i.getColumn(0).width=a.width;return i}function buildNodeElements(k,h,a,y,u,z){var m=DeepViewconfiguration.objects[h]["relatedObjects"];if(u!=undefined&&u.length>0){var e=ObjectLabels.plural["Task__c"];var j=0;for(var w=0;w<u.length;w++){if(u[w].parentElement.indexOf("CR")<0){j++}}var v;if(j>0){v=buildHeaderTableNode(e.length+45,e+" ["+j+"]",imgIcons.Task__c["none"],e);buildLink(z,v);var f=buildTasKNodeElements(u,v);if(v.getOutgoingLinks().length>0){v.setExpandable(true)}var n=v.getCell(0,2);n.setColumnSpan(2);n.setImageLocation(f)}}for(var w=0;w<y.length;w++){approvalStatus=y[w].Status;var o=diagram.getFactory().createTableNode(20,30,25,20);o.setFont(fontStyle);o.setText(_Labels.modal.Approvals);o.setTextColor("black");o.setBrush("white");o.setTooltip(_Labels.modal.Approvals);o.setStroke("transparent");if(h=="Service_Request__c"){o.setTag("Approvals"+EF+namespacePrefix+"Incident__c")}else{o.setTag("Approvals"+EF+namespacePrefix+h)}o.redimTable(1,3);o.columnStyle=ColumnStyle.AutoWidth;o.setCaptionHeight(0);o.setId(y[w].TargetObjectId);var q=diagram.measureString(o.getText(),o.getEffectiveFont());var s=o.getBounds();s.width=q.width+2+3;o.setBounds(s);o.getColumn(0).width=s.width;var c=o.getCell(0,1);c.rowSpan=2;c.colSpan=1;if(approvalStatus=="Approved"){c.setImageLocation(imgIcons.Approval["Approved"])}else{if(approvalStatus=="Pending"){c.setImageLocation(imgIcons.Approval["Pending"])}else{if(approvalStatus=="Rejected"){c.setImageLocation(imgIcons.Approval["Rejected"])}else{if(approvalStatus=="Removed"){c.setImageLocation(imgIcons.Approval["Recalled"])}}}}buildLink(z,o);if(y[w]!=undefined&&y[w]["Workitems"]!=undefined){approvalMap[o]=y[w]["Workitems"]["records"]}}var p=0;if(h=="Incident__c"||h=="Service_Request__c"){if(a[namespacePrefix+"FKBusinessService__r"]!=undefined){var B={};B.attributes={type:namespacePrefix+"Incident_CI_Link__c"};B[namespacePrefix+"FKConfiguration_Item__c"]=a[namespacePrefix+"FKBusinessService__c"];B[namespacePrefix+"FKConfiguration_Item__r"]={Id:a[namespacePrefix+"FKBusinessService__c"],Name:a[namespacePrefix+"FKBusinessService__r"].Name,attributes:{type:namespacePrefix+"BMC_BaseElement__c"}};B[namespacePrefix+"FKConfiguration_Item__r"][namespacePrefix+"ClassName__c"]="BMC_BusinessService";if(a[namespacePrefix+"Incident_CI_Links__r"]!=undefined){a[namespacePrefix+"Incident_CI_Links__r"]["records"].push(B)}else{a[namespacePrefix+"Incident_CI_Links__r"]={};a[namespacePrefix+"Incident_CI_Links__r"]["records"]=[];a[namespacePrefix+"Incident_CI_Links__r"]["records"].push(B)}p++}if(a[namespacePrefix+"FKServiceOffering__r"]!=undefined){var A={};A.attributes={type:namespacePrefix+"Incident_CI_Link__c"};A[namespacePrefix+"FKConfiguration_Item__c"]=a[namespacePrefix+"FKServiceOffering__c"];A[namespacePrefix+"FKConfiguration_Item__r"]={Id:a[namespacePrefix+"FKServiceOffering__c"],Name:a[namespacePrefix+"FKServiceOffering__r"].Name,attributes:{type:namespacePrefix+"BMC_BaseElement__c"}};A[namespacePrefix+"FKConfiguration_Item__r"][namespacePrefix+"ClassName__c"]="BMC_BusinessService";if(a[namespacePrefix+"Incident_CI_Links__r"]!=undefined){a[namespacePrefix+"Incident_CI_Links__r"]["records"].push(A)}else{a[namespacePrefix+"Incident_CI_Links__r"]={};a[namespacePrefix+"Incident_CI_Links__r"]["records"]=[];a[namespacePrefix+"Incident_CI_Links__r"]["records"].push(A)}p++}if(a[namespacePrefix+"FKBMC_BaseElement__r"]!=undefined){var A={};var d=namespacePrefix+"ClassName__c";A.attributes={type:namespacePrefix+"Incident_CI_Link__c"};A[namespacePrefix+"FKConfiguration_Item__c"]=a[namespacePrefix+"FKBMC_BaseElement__c"];A[namespacePrefix+"FKConfiguration_Item__r"]={Id:a[namespacePrefix+"FKBMC_BaseElement__c"],Name:a[namespacePrefix+"FKBMC_BaseElement__r"].Name,attributes:{type:namespacePrefix+"BMC_BaseElement__c"}};if(a[namespacePrefix+"Incident_CI_Links__r"]!=undefined){a[namespacePrefix+"Incident_CI_Links__r"]["records"].push(A)}else{a[namespacePrefix+"Incident_CI_Links__r"]={};a[namespacePrefix+"Incident_CI_Links__r"]["records"]=[];a[namespacePrefix+"Incident_CI_Links__r"]["records"].push(A)}p++}}for(key in m){var l=namespacePrefix+key;var t=DeepViewconfiguration.objects[h]["relatedObjects"][key].Type;if(a[l]==undefined||t==undefined){continue}var b=a[l].totalSize!=undefined?a[l].totalSize:0;if(key=="Incident_CI_Links__r"){b+=p}var C=ObjectLabels.plural[t]+" ["+b+"]";var g=buildHeaderTableNode(C.length+40,C,imgIcons[t]["none"],ObjectLabels.plural[t]);buildLink(z,g);var x=buildChildNodeElements(k,t,a[l],g);if(g.getOutgoingLinks().length>0){g.setExpandable(true)}var n=g.getCell(0,2);n.setColumnSpan(2);n.setImageLocation(x);if(h!="BMC_BaseElement__c"){g.collapse()}}rearrangeTree();diagram.resizeToFitItems(7)}function buildChildNodeElements(l,h,m,k){var r=m.records;var j=r[0]["attributes"].type;j=j.replace(namespacePrefix,"");var n=l.relatedObjects[j.replace("__c","s__r")].ID;var g=namespacePrefix+n.replace("__c","__r");var s=namespacePrefix+"FKStatus__r";var p=namespacePrefix+"state__c";var d=0;var e=false;for(var q=0;q<r.length;q++){var b=null;var o;var f=r[q][g].Name;if(r[q][g][s]!=undefined){b=r[q][g][s][p];o=r[q][g][s]["Name"];f+="\r\n"+_Labels.modal.status+": "+o;if(!b){d++}e=true}var a;if(h=="BMC_BaseElement__c"){if(r[q][g][namespacePrefix+"ClassName__c"]=="BMC_BusinessService"){a=imgIcons[h]["SERVICE"]}else{a=imgIcons[h]["CI"]}}else{a=imgIcons[h][b?"open":"closed"]}var c=buildChildTableNode(r[q][g].Id,r[q][g].Name,a,r[q][g]["attributes"].type,f,b);buildLink(k,c)}if(k.getOutgoingLinks().length>0){k.setExpandable(true)}rearrangeTree();diagram.resizeToFitItems(7);if(e){return getProgressStatusImg(r.length,d)}}function buildTasKNodeElements(c,f){var l=0;var d=0;for(var e=0;e<c.length;e++){if(c[e].parentElement.indexOf("CR")>=0){continue}d++;var n=diagram.getFactory().createTableNode(20,30,25,25);n.setFont(fontStyle);n.setText(c[e].parentElement);n.setTextColor("black");n.setBrush("white");if(c[e].assignedTo==null){c[e].assignedTo=""}n.setTooltip("Assigned To: "+htmlEscape(c[e].assignedTo)+"<br/>Status: "+htmlEscape(c[e].status));n.setStroke("transparent");if(c[e].status=="Pending Creation"){n.setTag("manifest")}else{n.setTag("Task__c")}n.setId(c[e].parentElementId);n.redimTable(5,5);n.columnStyle=ColumnStyle.AutoWidth;n.setCaptionHeight(0);var h;if(c[e].status=="Pending Creation"){h=imgIcons.Task__c["not_created"]}else{if(c[e].state==false){0;l++;h=imgIcons.Task__c["closed"]}else{h=imgIcons.Task__c["open"]}}var b=diagram.measureString(n.getText(),n.getEffectiveFont());var a=n.getBounds();a.width=b.width+2+3;n.setBounds(a);n.getColumn(0).width=a.width;var m=n.getCell(0,1);m.rowSpan=2;m.colSpan=1;m.setImageLocation(h);var k=diagram.getFactory().createDiagramLink(f,n);k.setStroke("#999");k.setHeadShape("Triangle");k.setHeadBrush("#999");if(c[e].status=="Pending Creation"){k.setStrokeDashStyle(MindFusion.Drawing.DashStyle.Dash)}}if(f.getOutgoingLinks().length>0){f.setExpandable(true)}var j=(l/(d))*100;var g;if(j==0){g=statusProgress["0"]}if(j>0&&j<=30){g=statusProgress["25"]}if(j>30&&j<=60){g=statusProgress["50"]}if(j>60&&j<100){g=statusProgress["75"]}if(j==100){g=statusProgress["100"]}return g}function rearrangeTree(){var c=new TreeLayout();c.linkType=TreeLayoutLinkType.Default;c.levelDistance=20;c.nodeDistance=15;diagram.arrange(c);var d=10;var a=diagram.getContentBounds();var b=diagram.getBounds();if(a.bottom()>b.bottom()||a.right()>b.right()){diagram.setBounds(b.union(a.inflate(d)))}}function nodeDeselectedEvent(b,a){disableExpandNodeBtn()}function enableExpandNodeBtn(){$(".node-expand").removeClass("disabled")}function disableExpandNodeBtn(){$(".node-expand").addClass("disabled")}function toggleDiagramOverlay(b){var c=document.getElementById("graphicalView");var a=document.getElementById("waitingHolderId");if(c!=undefined&&a!=undefined){if(b=="show"){c.setAttribute("class","waitingHolderShow");a.setAttribute("class","waitingHolder loaderLoadingCls")}else{c.setAttribute("class","waitingHolderHide");a.setAttribute("class","waitingHolder")}}}function nodeSelectedEvent(g,i){prevSelectedNodeAPI=selectedNodeAPI;var e=i.getNode();var h=angular.element($("#quickDetailsPanel")).scope();var b=e.getTag();var a=b.replace(namespacePrefix,"");var c=DeepViewconfiguration.objects[a];var d=angular.element($("#smartViewsSidebarTemplate")).scope();d.cleanEmailSettings();disableExpandNodeBtn();if(b=="manifest"||b==namespacePrefix+"BMC_BaseElement__c"){return}if((e.getText()=="Approvals")&&clickEventApprovalFired){clickEventApprovalFired=false;approvalNode=e;if(b.indexOf(EF)>0){selectedNodeID=e.getId();selectedNodeAPI=b.split(EF)[1]}h.loadApprovals(approvalMap[e],e.getId());h.checkApprovalPermissions(e.getId());h.initApproverLookup();var f=nodeMap[selectedNodeID];f.setSelected(true)}if(e.getId()!=undefined&&e.getText()!="Approvals"){selectedNodeID=e.getId();selectedNodeAPI=b.replace("BMCServiceDesk__","");if(nodeMap[selectedNodeID]!=undefined){var f=nodeMap[selectedNodeID];f.setSelected(true)}}if(e.getId()!=undefined&&e.getText()!="Approvals"){toggleOverlay();if(b!=namespacePrefix+"Task__c"&&b!="Task__c"){enableExpandNodeBtn()}if(queriedElementIDs.indexOf(e.getId())<0){toggleDiagramOverlay("show");Visualforce.remoting.Manager.invokeAction(_RemotingActions.queryAllData,e.getId(),JSON.stringify(c),namespacePrefix,function(j,n){if(n.status){var m=JSON.parse(j);var l=m.nodeData[0];var o=m.approvalData;var p=m.manifest;var q=m.objectMetaData;var k=q.isWritable;console.log("***+++*** isWritable : "+k);h.newObjectMetaDataMap.set(e.getId(),k);buildNodeElements(c,a,l,o,p,e);if(nodeMap[e.getId()]==undefined){nodeMap[e.getId()]=e}}toggleOverlay();toggleDiagramOverlay("hide")},{escape:false});queriedElementIDs.push(e.getId())}selectedNodeID=e.getId();selectedNodeAPI=b;if(!$(".quick-details-panel").hasClass("hide")){h.showQuickDetails()}}}function nodeClickedEvent(b,a){var d=a.getNode();var e=d.getTag();var c=angular.element($("#quickDetailsPanel")).scope();if(d.getText()==_Labels.modal.Approvals){clickEventApprovalFired=true;approvalNode=d;if(e.indexOf(EF)>0){selectedNodeID=d.getId();selectedNodeAPI=e.split(EF)[1]}c.loadApprovals(null,d.getId());c.checkApprovalPermissions(d.getId());c.initApproverLookup()}}function getProgressStatusImg(a,b){var c=(b/a)*100;if(c==0){return statusProgress["0"]}if(c>0&&c<=30){return statusProgress["25"]}if(c>30&&c<=60){return statusProgress["50"]}if(c>60&&c<100){return statusProgress["75"]}if(c==100){return statusProgress["100"]}}function htmlEscape(a){if(typeof(a)!="undefined"&&a!=null&&a!=""){a=a.replace(/&/g,"&amp;");a=a.replace(/"/g,"&quot;");a=a.replace(/'/g,"&#39;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a}else{return""}};