$(document).ready(function(){$("#accordion").dplAccordion()});$(document).on("click",function(b){var a=$(".bar-option-wrapper");if(a!==b.target&&!a.has(b.target).length){$(".bar-option").removeClass("show")}});var module=angular.module("DeepView",["rfmodal","ngSanitize","sidebarModule","ui.bootstrap"]).config(["rfModalProvider",function(a){if(showSidebarOnly!==true){a.setDefaults({})}}]);module.factory("progressBar",["$q",function(a){return{getStatusStage:function(){var b=a.defer();if(showSidebarOnly!==true){Visualforce.remoting.Manager.invokeAction(_RemotingActions.getAllStatusesAndStages,selectedNodeID,getStandardCallback(b))}return b.promise}}}]);module.controller("DeepViewController",["$rootScope","$scope","$templateRequest","$sce","$compile","$timeout","$window","rfModal","progressBar","rootNodeDataFactory","$filter",function(i,l,j,h,c,b,a,g,d,k,e){if(pageLoadData==undefined){l.displayAccessError();return}l.displayAccessError=function(){g.openInfoMessage(l,"error",_Labels.message.RecordDeletedOrAccessDenied);$(".container").css("display","none")};var f=c(autoCompleteHTML)(l);l.allStatusStage;l.showSidebarOnly=showSidebarOnly;l.selectedNodeID=selectedNodeID;l.recordDetailsClicked=true;l.comments={data:""};l.isTemplateEnabled=isTemplateEnabled;l.showApproveRejectButtonsBottom=false;l.showReassignButtonBottom=false;l.showRecallButtonBottom=false;l.enableApproveRejectButton=false;l.enableRecallButton=false;l.ObjectLabels=ObjectLabels;l._Labels=_Labels;l.DeepViewconfiguration=DeepViewconfiguration;l.serviceTargetFields=serviceTargetFields;selectedNodeAPI=pageLoadData.APIName;l.selectedNodeAPI=selectedNodeAPI;l.namespacePrefix=namespacePrefix;l.dataTypeSFDCtoHTML={BOOLEAN:"checkbox",DATETIME:"date",REFERENCE:"text"};l.disableEditButton=false;l.newObjectMetaDataMap=new Map();if(isEmbeddedMode==true&&a.parent.isRecordLock!=""&&a.parent.isRecordLock.indexOf("true")>-1){l.disableEditButton=true}l.serviceTargetImg=serviceTargetImg;l.OwnerRefFieldVal="";l.userLocale=userLocale;l.dateValueMap={};l.enableQuickEdit=false;l.childScope={};l.userLocaleDateFormat=userLocaleDateFormat;l.isSelectedRecordSR=false;var m=d.getStatusStage();if(l.showSidebarOnly!==true){m.then(function(n){l.allStatusStage=n;l.generateStageHTML()})}l.DeepViewController=function(){if(l.showSidebarOnly!==true){l.queryNodeData(rootNodeID,rootNodeAPI);l.showQuickDetails();l.getBroadcastMessages();queriedElementIDs.push(rootNodeID);l.newObjectMetaDataMap.set(selectedNodeID,pageLoadData.isUpdateable)}else{selectedNodeAPI=selectedNodeAPI.replace(namespacePrefix,"");Visualforce.remoting.Manager.invokeAction(_RemotingActions.queryRecord,selectedNodeID,selectedNodeAPI,DeepViewconfiguration.objects[selectedNodeAPI.replace(namespacePrefix,"")]["historyObject"],namespacePrefix,l.showQuickDetailsCallBack,{escape:false})}};l.refreshOnChange={};l.refreshRequiredOnChange=[namespacePrefix+"FKOpenBy__c",namespacePrefix+"FKStaff__c","OwnerId",namespacePrefix+"FKStatus__c","Id"];l.getBroadcastMessages=function(){Visualforce.remoting.Manager.invokeAction(_RemotingActions.getBroadcastMsgs,function(n,o){if(o.status){l.createTickerSConsole(n,o)}else{g.openInfoMessage(l,"error",o.message)}},{escape:false})};l.broadcastMode="";l.broadCastList={};l.messageInterval;l.totalBrodcasts;l.currentBroadcastNumber;l.broadcastScrollStarted=false;l.broadcastMessage="";l.currentIndex;l.isIE11=window.location.hash=!!window.MSInputMethodContext;l.createTickerSConsole=function(n,o){if(n.ScrollType=="MESSAGE"){l.broadcastMode="MESSAGE";l.broadCastList=JSON.parse(n.BroadcastList);l.messageInterval=n.BroadcastInterval!=null?n.BroadcastInterval:"10";l.totalBrodcasts=l.broadCastList.length;if(!l.broadcastScrollStarted||!l.totalBrodcasts){l.broadcastScrollStarted=true;l.startMessageScroll();var p=document.getElementById("BroadcastMessage");if(p){p.addEventListener("transitionend",l.animationEndFunc);p.addEventListener("webkitTransitionEnd",l.animationEndFunc);p.addEventListener("oTransitionEnd",l.animationEndFunc);p.addEventListener("MSTransitionEnd",l.animationEndFunc)}}}else{l.broadcastMode="TEXT";l.message=decodeURIComponent(n.BroadcastMessage);l.broadcast=n;l.$apply()}};l.startMessageScroll=function(){if(l.totalBrodcasts>0){l.currentIndex=-1;l.showNextMessage()}};l.showNextMessage=function(){l.currentIndex++;if(l.currentIndex>l.totalBrodcasts-1){l.currentIndex=0}l.currentBroadcastNumber=(l.currentIndex+1);l.broadcastMessage=l.broadCastList[l.currentIndex];l.$apply();var n=document.getElementById("BroadcastMessage");if(l.totalBrodcasts!=1&&!l.isIE11){setTimeout(function(){if(n){n.classList.remove("fadein");n.classList.add("fadeout")}},l.messageInterval*1000)}else{setTimeout(function(){l.showNextMessage()},l.messageInterval*1000)}};l.animationEndFunc=function(){var n=document.getElementById("BroadcastMessage");if(n&&n.classList.contains("fadeout")){n.classList.remove("fadeout");n.classList.add("fadein");l.showNextMessage()}};l.showApproveRejectBottomButtons=function(){l.showApproveRejectButtonsBottom=true;l.showReassignButtonBottom=false;l.showRecallButtonBottom=false;$("#approval-comments").removeClass("hide");$("#approval-buttons").addClass("hide")};l.showRecallBottomButton=function(){l.showRecallButtonBottom=true;l.showApproveRejectButtonsBottom=false;l.showReassignButtonBottom=false;$("#approval-comments").removeClass("hide");$("#approval-buttons").addClass("hide")};l.callCancelRecord=function(){l.comments.data="";l.showRecallButtonBottom=false;l.showApproveRejectButtonsBottom=false;l.showReassignButtonBottom=false;$("#approval-comments").addClass("hide");$("#approval-buttons").removeClass("hide")};l.showReassignBottomButton=function(){l.showReassignButtonBottom=true;l.showApproveRejectButtonsBottom=false;l.showRecallButtonBottom=false;$("#approval-comments").removeClass("hide");$("#approval-buttons").addClass("hide")};l.callApproveRecord=function(){$("#approval-comments").addClass("hide");l.showApproveRejectButtonsBottom=false;$("#approval-buttons").addClass("hide");Visualforce.remoting.Manager.invokeAction(_RemotingActions.callApproveRejectRecall,approvalNode.id,"Approve",l.comments.data,function(n,o){if(o.status){l.comments.data="";l.enableApproveRejectButton=false;l.enableRecallButton=false;l.loadApprovals(null,approvalNode.id);l.checkApprovalPermissions(approvalNode.id);l.$apply()}else{if(o.type=="exception"){$("#approval-buttons").removeClass("hide");g.openInfoMessage(l,"error",o.message)}else{g.openInfoMessage(l,"error",o.message)}}},{escape:false})};l.callRejectRecord=function(){$("#approval-comments").addClass("hide");l.showApproveRejectButtonsBottom=false;$("#approval-buttons").addClass("hide");Visualforce.remoting.Manager.invokeAction(_RemotingActions.callApproveRejectRecall,approvalNode.id,"Reject",l.comments.data,function(n,o){if(o.status){l.comments.data="";l.enableApproveRejectButton=false;l.enableRecallButton=false;l.loadApprovals(null,approvalNode.id);l.checkApprovalPermissions(approvalNode.id);l.$apply()}else{if(o.type=="exception"){$("#approval-buttons").removeClass("hide");g.openInfoMessage(l,"error",o.message)}else{g.openInfoMessage(l,"error",o.message)}}},{escape:false})};l.callRecallRecord=function(){$("#approval-comments").addClass("hide");l.showRecallButtonBottom=false;$("#approval-buttons").addClass("hide");Visualforce.remoting.Manager.invokeAction(_RemotingActions.callApproveRejectRecall,approvalNode.id,"Removed",l.comments.data,function(n,o){if(o.status){l.comments.data="";l.enableApproveRejectButton=false;l.enableRecallButton=false;l.loadApprovals(null,approvalNode.id);l.checkApprovalPermissions(approvalNode.id);l.$apply()}else{if(o.type=="exception"){$("#approval-buttons").removeClass("hide");g.openInfoMessage(l,"error",o.message)}else{g.openInfoMessage(l,"error",o.message)}}},{escape:false})};l.callReassignRecord=function(){if(l.OwnerRefFieldVal.OwnerId["fvalue"]==undefined||l.OwnerRefFieldVal.OwnerId["fvalue"]==""){g.openInfoMessage(l,"error",_Labels.message.fldsRequired);return}Visualforce.remoting.Manager.invokeAction(_RemotingActions.callReassign,approvalNode.id,l.OwnerRefFieldVal.OwnerId["fvalue"],function(n,o){if(o.status){l.comments.data="";l.enableApproveRejectButton=false;l.showReassignButtonBottom=false;l.loadApprovals(null,approvalNode.id);l.checkAdminPermissions(approvalNode.id);l.$apply()}else{if(o.type=="exception"){$("#approval-buttons").removeClass("hide");g.openInfoMessage(l,"error",o.message)}else{g.openInfoMessage(l,"error",o.message)}}},{escape:false})};l.showHideRecordDetails=function(){l.recordDetailsClicked=!l.recordDetailsClicked};l.hideQuickDetails=function(){$(".quick-details-panel").addClass("hide");$(".quick-detail-header").addClass("hide");$(".record-details").removeClass("hide");$(".header-btn-panel").removeClass("details");$(".menu-option").removeClass("details");$(".bar-option").removeClass("details");$(".header-btn-wrapper").removeClass("details");$(".bar-option.separator").removeClass("details");$("#stageProgressBar").addClass("stagedivCollapse");$("#stageProgressBar").removeClass("stagedivExpandDetailOn");$("#divMiniTimeline").addClass("miniTimelineAreaCollapse");$("#divMiniTimeline").removeClass("miniTimelineAreaExpand");$(".status-wrapper").removeClass("details");$(".record-detail-header").removeClass("details");$(".ownerLabel").removeClass("details");$(".header-wrapper-row-small-screen").removeClass("details");$(".record-detail-header").css("width","auto");$("#spanRightPanel").addClass("rightPanelExpand");resizeGraph()};l.showQuickDetails=function(){selectedNodeAPI=selectedNodeAPI.replace(namespacePrefix,"");l.selectedNodeAPI=selectedNodeAPI;l.selectedNodeID=selectedNodeID;Visualforce.remoting.Manager.invokeAction(_RemotingActions.queryRecord,selectedNodeID,selectedNodeAPI,DeepViewconfiguration.objects[selectedNodeAPI]["historyObject"],namespacePrefix,l.showQuickDetailsCallBack,{escape:false});$(".quick-details-panel").removeClass("hide");$(".quick-detail-header").removeClass("hide");$(".record-details").addClass("hide");$(".header-btn-panel").addClass("details");$(".menu-option").addClass("details");$(".bar-option").addClass("details");$(".header-btn-wrapper").addClass("details");$(".bar-option .separator").addClass("details");$("#stageProgressBar").addClass("stagedivExpandDetailOn");$("#stageProgressBar").removeClass("stagedivCollapse");$("#divMiniTimeline").addClass("miniTimelineAreaExpand");$("#divMiniTimeline").removeClass("miniTimelineAreaCollapse");$("#spanRightPanel").removeClass("rightPanelExpand");$(".status-wrapper").addClass("details");$(".record-detail-header").addClass("details");$(".header-wrapper-row-small-screen").addClass("details");$(".ownerLabel").addClass("details");$(".header-wrapper-row-small-screen.details").css("width","63%!important");resizeGraph();if(l.showSidebarOnly!==true){l.queryServiceTargets(true,false)}};l.hideShowEffect=function(n){if(n==""){$("#btnStage").addClass("stageHoverOff");$("#btnStage").removeClass("stageHoverOn")}else{if(n=="hover"){$("#btnStage").addClass("stageHoverOn");$("#btnStage").removeClass("stageHoverOff")}}};l.hideProgressBar=function(){l.showStages=false;$("#btnStage").removeClass("btnStageHide");$("#stageProgressBar").empty()};l.generateStageHTML=function(u){var p=l.parentNodeData[namespacePrefix+"FKStatus__r"][namespacePrefix+"FKSYSStage__r"][namespacePrefix+"Order__c"];if(!l.stageProgressHTML){var B=false;var n="",A="",t="",s="",o="",y="";l.stageProgressHTML=angular.element('<div id="stageDiv" class="stageInnerDiv"><span class="closeStage"><img width="18px" height="18px" src="'+imagePath+'/close_btn.png" style="cursor:pointer;" ng-click="hideProgressBar();" /></span></div>');var w="";for(var z in l.allStatusStage.defaultStages){if(z=="remove"){break}if(p==l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]){B=true;n=p=="1"?imagePath+"/yellowStartStep.png":p=="4"?imagePath+"/stepGreen_last.png":imagePath+"/yellowMiddleStep.png";y=p=="1"?"18px":p=="4"?"18px":"15px";A=p=="1"?imagePath+"/empty_between.png":p=="4"?"":imagePath+"/empty_between.png"}else{if((B)||(p=="")){n=l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="4"?imagePath+"/stepEmpty_last.png":imagePath+"/stepEmpty_mid.png";y=l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="4"?"18px":"15px";A=l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="4"?"":imagePath+"/empty_between.png"}else{n=l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="1"?imagePath+"/stepGreen_first.png":l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="4"?imagePath+"/stepGreen_last.png":imagePath+"/stepFill_mid.png";y=l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="1"?"18px":l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="4"?"18px":"15px";A=l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="1"?imagePath+"/fill_between.png":l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="4"?"":imagePath+"/fill_between.png"}}var x="";var r="";var v="";if(l.allStatusStage.defaultStages[z].Name.toUpperCase()==("Opened").toLowerCase()){x=_Labels.pageHeader.opened;r=x;v="OpenStage"}else{if(l.allStatusStage.defaultStages[z].Name.toUpperCase()==("Acknowledged").toLowerCase()){x=_Labels.pageHeader.acknowledged;r=x;v="AckStage"}else{if(l.allStatusStage.defaultStages[z].Name.toUpperCase()==("In Process").toLowerCase()){x=_Labels.pageHeader.inprocess;r=x;v="ProcessStage"}else{if(l.allStatusStage.defaultStages[z].Name.toUpperCase()==("Closed").toLowerCase()){x=_Labels.pageHeader.closed;r=x;v="CloseStage"}}}}var q=l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="1"?'style="padding:0px 0px 0px 40px;"':l.allStatusStage.defaultStages[z][namespacePrefix+"Order__c"]=="4"?'style="padding:0px 30px 0px 0px;"':'style="padding:0px"';w+="<td "+q+'><img width="'+y+'" height="21px" src="'+n+'"/>';if(A!=""){w+='<img height="21px" style="float:none;width:8.8em;    " src="'+A+'"/>'}w+="</td>"}w='<table border="0" id="stageBar" cellpadding="0" cellspacing="0" style="valign:top;"><tr>'+w+"</tr></table>";w+='<table cellspacing="0" cellpadding="0" class="stageFont"><tr><td style="padding-left:35px;width:9.7em;">'+_Labels.pageHeader.opened+'</td><td style="width:9.7em;">'+_Labels.pageHeader.acknowledged+'</td><td style="width:9.7em;">'+_Labels.pageHeader.inprocess+'</td><td style="width:9.7em;">'+_Labels.pageHeader.closed+"</td></tr></table>";l.stageProgressHTML.append(w)}};l.showStageHTML=function(n){$("#stageProgressBar").append(l.stageProgressHTML);c(l.stageProgressHTML)(l);l.showStages=true;$("#btnStage").addClass("btnStageHide")};l.htmlUnescape=function(n){if(n&&typeof(n)!="undefined"){n=n.replace(/&quot;/g,'"');n=n.replace(/&#39;/g,"'");n=n.replace(/&lt;/g,"<");n=n.replace(/&gt;/g,">");n=n.replace(/&amp;/g,"&");n=n.replace(/%2F/g,"/");return n}else{return""}};l.showQuickDetailsCallBack=function(n,p){if(p.status){var o=JSON.parse(n);if(o.recordNotFound!=undefined&&o.recordNotFound==true){l.displayAccessError();return}l.rootData=o.root[0];i.data=l.rootData;k.setRootNodeData(l.rootData);l.$broadcast("loadDataForUpdatedNode");var q=["FKRequestDefinition__c"];if(showSidebarOnly!=true){if(rootNodeID==l.rootData.Id&&l.refreshOnChange.Id==l.rootData.Id){angular.forEach(l.refreshRequiredOnChange,function(r){if(l.refreshOnChange[r]&&l.refreshOnChange[r]!=l.rootData[r]){location.reload()}})}angular.forEach(l.refreshRequiredOnChange,function(r){l.refreshOnChange[r]=l.rootData[r]});l.fieldMetaData=o.fieldMetaData;l.nodeKeys=o.fields;l.isSelectedRecordSR=l.rootData[namespacePrefix+"isServiceRequest__c"];if(l.isSelectedRecordSR){l.objectMetaData.fldLabel=ObjectLabels.singular["Service_Request__c"];l.objectMetaData.APIName="Service_Request__c"}else{l.objectMetaData.APIName=selectedNodeAPI}if(pageLoadData.isQueueAndUserAssignmentEnabled!=undefined&&pageLoadData.isQueueAndUserAssignmentEnabled==true&&l.rootData.Owner!=undefined&&l.rootData.Owner["Id"].indexOf("00G")!=0){if(l.rootData[namespacePrefix+"FKOpenBy__r"]!=undefined){l.rootData[namespacePrefix+"FKOpenBy__r"]["Name"]=l.rootData.Owner["Name"];l.rootData[namespacePrefix+"FKOpenBy__r"]["Id"]=l.rootData.Owner["Id"]}else{if(l.rootData[namespacePrefix+"FKStaff__r"]!=undefined){l.rootData[namespacePrefix+"FKStaff__r"]["Name"]=l.rootData.Owner["Name"];l.rootData[namespacePrefix+"FKStaff__r"]["Id"]=l.rootData.Owner["Id"]}}l.rootData.Owner["Name"]="";l.rootData.Owner["Id"]=""}angular.forEach(l.nodeKeys,function(s){if(l.fieldMetaData[s]!=undefined&&l.fieldMetaData[s]["fieldType"]=="DATETIME"&&l.rootData[s]!=undefined){var r=new Date(moment(l.rootData[s],"YYYY-MM-DD HH:mm:ss"));l.dateValueMap[s]={yy:r.getFullYear(),MM:r.getMonth()+1,dd:r.getDate(),HH:r.getHours(),mm:r.getSeconds()}}if(l.fieldMetaData[s]!=undefined&&l.fieldMetaData[s]["fieldType"]=="DATE"&&l.rootData[s]!=undefined){var r=new Date(moment(l.rootData[s],"YYYY-MM-DD"));l.dateValueMap[s]={yy:r.getFullYear(),MM:r.getMonth()+1,dd:r.getDate()}}if(l.fieldMetaData[s]!=undefined&&l.fieldMetaData[s]["fieldType"]=="TEXTAREA"&&l.rootData[s]!=undefined){l.rootData[s]=l.htmlUnescape(unescape(l.rootData[s]))}if(q.indexOf(s.replace(namespacePrefix,""))>-1){l.fieldMetaData[s].isWritable=false}if(s.indexOf("RF_Attachments__c")>-1){l.rootData[s]=h.trustAsHtml(l.rootData[s])}});if(l.parentNodeData.Id==l.rootData.Id){l.parentNodeData.Owner.Name=l.rootData.Owner!=undefined?l.rootData.Owner.Name:l.parentNodeData.Owner.Name;if(l.parentNodeData[namespacePrefix+"FKOpenBy__r"]!=undefined){l.parentNodeData[namespacePrefix+"FKOpenBy__r"]["Name"]=l.rootData[namespacePrefix+"FKOpenBy__r"]!=undefined?l.rootData[namespacePrefix+"FKOpenBy__r"].Name:undefined}if(l.parentNodeData[namespacePrefix+"FKStaff__r"]!=undefined){l.parentNodeData[namespacePrefix+"FKStaff__r"]["Name"]=l.rootData[namespacePrefix+"FKStaff__r"]!=undefined?l.rootData[namespacePrefix+"FKStaff__r"].Name:undefined}}}l.$apply()}else{selectedNodeAPI=prevSelectedNodeAPI;l.selectedNodeAPI=prevSelectedNodeAPI;g.openInfoMessage(l,"error",p.message)}};l.parseDate=function(n){return e("date")(n,userLocale)};l.parseDateOnly=function(n){return e("date")(n,userLocaleDateFormat)};l.enableEdit=function(){var n=l.newObjectMetaDataMap.get(selectedNodeID);if(n==true){l.enableQuickEdit=true;l.recordDetailsClicked=true;l.bufferedData=l.rootData;$("#maskHeader").css("display","block");$(".menu-option").addClass("disable-click")}};l.cancelEdit=function(){l.enableQuickEdit=false;l.rootData=l.bufferedData;if(l.childScope.showSendEmail==false&&l.childScope.showAddNote==false&&l.childScope.newAttachment.length==0){$("#maskHeader").css("display","none");$(".menu-option").removeClass("disable-click")}};l.ExportChart=function(){var n=deepViewResourceURL+"/templates/modal/SaveAs.html";j(n).then(function(o){c($("#modalContent").html(o).contents())(l);l.printCanvas()},function(){})};l.loadApprovals=function(n,p){var o=deepViewResourceURL+"/templates/modal/Approvals.html";l.showApprovals=true;l.nodeApprovals=n;Visualforce.remoting.Manager.invokeAction(_RemotingActions.getApprovals,p,function(r,s){if(s.status){l.nodeApprovals=r;if(approvalStatus!=l.nodeApprovals[0].Status){approvalStatus=l.nodeApprovals[0].Status;var q=approvalNode.getCell(0,1);q.rowSpan=2;q.colSpan=1;if(approvalStatus=="Approved"){q.setImageLocation(imgIcons.Approval["Approved"])}else{if(approvalStatus=="Pending"){q.setImageLocation(imgIcons.Approval["Pending"])}else{if(approvalStatus=="Rejected"){q.setImageLocation(imgIcons.Approval["Rejected"])}else{if(approvalStatus=="Removed"){q.setImageLocation(imgIcons.Approval["Recalled"])}}}}}j(o).then(function(t){l.hideProgressBar();c($("#modalContent").html(t).contents())(l);b(function(){var u=document.getElementById("diagram_tooltip");if((u!==undefined)&&(u!==null)){u.remove()}})},function(){})}else{g.openInfoMessage(l,"error",s.message)}},{escape:false})};l.queryNodeData=function(n,o){Visualforce.remoting.Manager.invokeAction(_RemotingActions.queryAllData,n,JSON.stringify(DeepViewconfiguration.objects[selectedNodeAPI.replace(namespacePrefix,"")]),namespacePrefix,l.allDataCallBack,{escape:false})};l.showStatus=function(){l.showStatusData=!l.showStatusData};l.showStaff=function(){l.showStaffData=!l.showStaffData};l.refreshConsoleForm=function(){if((showSidebarOnly==true||isEmbeddedMode==true)&&a.parent!=undefined){if(typeof a.parent.refreshIncidentFormTimeOut=="function"){a.parent.isNeedToRefreshIncident=true;a.parent.refreshIncidentFormTimeOut()}else{if(typeof a.parent.refreshChangeFormTimeOut=="function"){a.parent.isNeedToRefreshChange=true;a.parent.refreshChangeFormTimeOut()}else{if(typeof a.parent.refreshProblemFormTimeOut=="function"){a.parent.isNeedToRefreshProblem=true;a.parent.refreshProblemFormTimeOut()}else{if(typeof a.parent.refreshReleaseFormTimeOut=="function"){a.parent.isNeedToRefreshRelease=true;a.parent.refreshReleaseFormTimeOut()}else{if(typeof a.parent.refreshTaskFormTimeOut=="function"){a.parent.isNeedToRefreshForm=true;a.parent.refreshTaskFormTimeOut()}}}}}}};l.saveRecord=function(){if(!checkMandatoryFields()){g.openInfoMessage(l,"error",_Labels.message.fldsRequired);return}if(!checkEmailFormat()){g.openInfoMessage(l,"error",_Labels.message.invalidEmailAddress);return}$("#sideBarloader").css("display","block");$("#sideBarActionMask").css("display","block");var n=["REF-PICKLIST","PICKLIST","REFERENCE","DATETIME","BOOLEAN","TEXTAREA","STRING","DOUBLE","EMAIL","DATE"];var o={};angular.forEach(l.nodeKeys,function(p){if(l.fieldMetaData[p]!=undefined&&l.fieldMetaData[p]["fieldType"]!=undefined&&n.indexOf(l.fieldMetaData[p]["fieldType"])>-1){o[p]=l.fieldMetaData[p]}});Visualforce.remoting.Manager.invokeAction(_RemotingActions.saveRecord,selectedNodeID,selectedNodeAPI,JSON.stringify(o),namespacePrefix,function(p,q){if(q.status){Visualforce.remoting.Manager.invokeAction(_RemotingActions.queryRecord,selectedNodeID,selectedNodeAPI.replace(namespacePrefix,""),DeepViewconfiguration.objects[selectedNodeAPI.replace(namespacePrefix,"")]["historyObject"],namespacePrefix,l.showQuickDetailsCallBack,{escape:false});l.enableQuickEdit=!l.enableQuickEdit;l.refreshConsoleForm();if((l.childScope.showSendEmail==undefined)||(l.childScope.showSendEmail==false&&l.childScope.showAddNote==false&&l.childScope.newAttachment.length==0)){$("#maskHeader").css("display","none");$(".menu-option").removeClass("disable-click")}g.openInfoMessage(l,"success",_Labels.message.RecordSavedSuccessfuly)}else{g.openInfoMessage(l,"error",q.message)}$("#sideBarloader").css("display","none");$("#sideBarActionMask").css("display","none")},{escape:false})};l.clearStaff=function(){if(l.fieldMetaData.OwnerId&&l.fieldMetaData.OwnerId.fvalue!=""){if(l.fieldMetaData[namespacePrefix+"FKOpenBy__c"]!=undefined){l.rootData[namespacePrefix+"FKOpenBy__c"]="";l.fieldMetaData[namespacePrefix+"FKOpenBy__c"]["fvalue"]="";l.fieldMetaData[namespacePrefix+"FKOpenBy__c"]["fRefFieldVal"]=""}else{if(l.fieldMetaData[namespacePrefix+"FKStaff__c"]!=undefined){l.rootData[namespacePrefix+"FKStaff__c"]="";l.fieldMetaData[namespacePrefix+"FKStaff__c"]["fvalue"]="";l.fieldMetaData[namespacePrefix+"FKStaff__c"]["fRefFieldVal"]=""}}}};l.$watch("fieldMetaData['OwnerId'].fvalue",function(o,n){if(pageLoadData.isQueueAndUserAssignmentEnabled!=undefined&&pageLoadData.isQueueAndUserAssignmentEnabled==true){if(o!=undefined&&o!=""&&((o!=l.rootData.OwnerId&&n=="")||(n!=""))){l.clearStaff()}}});l.hidePanels=function(){l.showAttachFile=false;l.showAddNote=false;l.showSendEmail=false;l.showServiceTarget=false;l.saveImage=false;l.showApprovals=false};l.queryServiceTargets=function(n,p){if(!n){return}if(p){l.showServiceTarget=true;var o=deepViewResourceURL+"/templates/modal/ServiceRequest.html";j(o).then(function(q){c($("#modalContent").html(q).contents())(l)},function(){})}else{Visualforce.remoting.Manager.invokeAction(_RemotingActions.getServiceTarget,l.DeepViewconfiguration.objects[selectedNodeAPI.replace(namespacePrefix,"")]["serviceTargetObject"],"All",l.selectedNodeID,"",function(q,r){if(r.status){l.serviceTargets=q;l.isServiceEnabled=q!=undefined&&q.Records!=undefined&&q.Records.length>0;l.serviceTargetStatus="";if(l.isServiceEnabled==true){l.serviceTargetStatus=l.getServiceTargetStatus(q.Records)}l.serviceTargetIcon=l.setServiceTargetIcon(l.serviceTargetStatus);l.$apply()}else{g.openInfoMessage(l,"error",r.message)}},{escape:false})}};l.setServiceTargetIcon=function(o){var n="serviceTargetsDisable";if(o==_Labels.serviceTargetStatus.OK){n="serviceTargetsEnable"}else{if(o==_Labels.serviceTargetStatus.Missed){n="serviceTargetsMissed"}else{if(o==_Labels.serviceTargetStatus.Warning){n="serviceTargetsWarning"}}}return n};l.getServiceTargetStatus=function(o){var n;if(o==undefined||o.length==0){n=""}else{n=_Labels.serviceTargetStatus.OK;angular.forEach(o,function(p){if(n!=_Labels.serviceTargetStatus.Missed){if(p[namespacePrefix.toLowerCase()+"status__c"]==_Labels.serviceTargetStatus.Missed){n=_Labels.serviceTargetStatus.Missed}else{if(p[namespacePrefix.toLowerCase()+"status__c"]==_Labels.serviceTargetStatus.Warning){n=_Labels.serviceTargetStatus.Warning}}}})}return n};l.searchUser=function(s,o){var p=l[o.split(".")[0]][o.split(".")[1]];p=p.lastIndexOf(";")>=0?p.substring(p.lastIndexOf(";")+1,p.length):p;var q=event.target.offsetWidth;var n=event.target.getBoundingClientRect();if(p==undefined||p==""){l.showUserAutoSuggestion=false;return}Visualforce.remoting.Manager.invokeAction(_RemotingActions.searchUser,p,l.userSearchCallback,{escape:false});l.searchField=s;var r=angular.element(event.target);r.after(f)};l.userSearchCallback=function(n,o){if(o.status){l.userSuggestions=JSON.parse(n);if(l.userSuggestions!=undefined&&l.userSuggestions.length>0){l.showUserAutoSuggestion=true}l.$apply()}else{g.openInfoMessage(l,"error",o.message)}};l.printCanvas=function(){var n=document.getElementById("diagram");l.imgDataURL=n.toDataURL("image/png");l.saveImageFileName=l.objectMetaData.fldLabel+"_"+l.parentNodeData.Name+".png";l.saveImage=true;$("#download").attr("href",l.imgDataURL)};l.download=function(){if(navigator.msSaveBlob){var n=document.getElementById("diagram"),o=n.msToBlob();navigator.msSaveBlob(new Blob([o],{type:"image/png"}),l.saveImageFileName)}};l.saveImageData=function(){var n=document.getElementById("canvasPrint");window.location.href=n.src.replace("image/png","image/octet-stream")};l.recordSavedCallBack=function(n,o){if(o.status){l.data=JSON.parse(n);l.objectMetaData=l.data.objectMetaData;l.$apply()}else{g.openInfoMessage(l,"error",o.message)}};l.allDataCallBack=function(n,p){$(".load-wrap").css({display:"none"});l.pageLoaded=true;if(p.status){l.data=JSON.parse(n);if(l.data.recordNotFound!=undefined&&l.data.recordNotFound==true){l.displayAccessError();return}l.objectMetaData=l.data.objectMetaData;var o=l.data.nodeData[0][namespacePrefix+"isServiceRequest__c"];if(o){l.objectMetaData.fldLabel=ObjectLabels.singular["Service_Request__c"];l.objectMetaData.APIName="Service_Request__c"}l.parentNodeData=l.data.nodeData[0];l.showStages=false;switch(l.parentNodeData[namespacePrefix+"FKStatus__r"][namespacePrefix+"FKSYSStage__r"]["Name"]){case"Opened":$("#miniTimeline").addClass("miniTimeLineStart");break;case"Acknowledged":$("#miniTimeline").addClass("miniTimeLineBetween");break;case"In Process":$("#miniTimeline").addClass("miniTimeLineBetween");break;case"Closed":$("#miniTimeline").addClass("miniTimeLineEnd");break}if(l.allStatusStage){l.generateStageHTML()}setTimeout(function(){l.$apply()},1000);if(l.showSidebarOnly!==true){initiateDiagram(l.parentNodeData,l.data.approvalData,l.data.manifest,o)}l.$apply()}else{g.openInfoMessage(l,"error",p.message)}};l.inputWrapper={};l.OnBehalfOf={fvalue:"",fRefFieldVal:"",fadditionalInfo:"User"+String.fromCharCode(172)+" User WHERE IsStaffUser__c=TRUE"};l.getlookup=function(p,o){o=o.replace("(","").replace(")","");o=o=="Group"?"Queue":o;l.fieldMetaData[p]["fadditionalInfo"]=o+String.fromCharCode(172)+l.fieldMetaData[p].fldLabel;var n="";if(pageLoadData.isQueueAndUserAssignmentEnabled!=undefined&&pageLoadData.isQueueAndUserAssignmentEnabled==true){if((p.indexOf("FKOpenBy__c")>0||p.indexOf("FKStaff__c")>0)&&(l.fieldMetaData.OwnerId!=undefined&&l.fieldMetaData.OwnerId.fvalue!=undefined&&l.fieldMetaData.OwnerId.fvalue.indexOf("00G")==0)){n=l.fieldMetaData.OwnerId.fvalue}}g.openLookup({scope:l,fielddata:l.fieldMetaData[p],fieldAPI:p,queueId:n})};l.initApproverLookup=function(){selectedNodeAPI=selectedNodeAPI.replace(namespacePrefix,"");l.selectedNodeAPI=selectedNodeAPI;Visualforce.remoting.Manager.invokeAction(_RemotingActions.getReassignApprover,function(n,o){if(o.status){l.OwnerRefFieldVal=n}else{if(o.type=="exception"){g.openInfoMessage(l,"error",o.message)}else{g.openInfoMessage(l,"error",o.message)}}},{escape:false})};l.checkApprovalPermissions=function(n){l.showApproveRejectButtonsBottom=false;l.showReassignButtonBottom=false;l.showRecallButtonBottom=false;Visualforce.remoting.Manager.invokeAction(_RemotingActions.checkApprovalPermission,n,function(o,p){if(p.status){l.enableApproveRejectButton=o.Approval;l.enableRecallButton=o.Recall}else{if(p.type=="exception"){g.openInfoMessage(l,"error",p.message)}else{g.openInfoMessage(l,"error",p.message)}}},{escape:false})};l.checkAdminPermissions=function(n){Visualforce.remoting.Manager.invokeAction(_RemotingActions.checkAdminPermission,n,function(o,p){if(p.status){l.enableApproveRejectButton=o}else{if(p.type=="exception"){g.openInfoMessage(l,"error",p.message)}else{g.openInfoMessage(l,"error",p.message)}}},{escape:false})};l.getApproverLookup=function(o,n){l.OwnerRefFieldVal[o]["fadditionalInfo"]="Owner"+String.fromCharCode(172)+"Owner";g.openLookup({scope:l,title:_Labels.modal.approver,fielddata:l.OwnerRefFieldVal[o],fieldAPI:o})}}]);module.factory("SSLocalDataStore",["$q",function(a){var b={};return{setAppMetadata:function(c,d){b[c]=d},getAppMetadata:function(c){if(c){return b[c]}else{return appMetada}}}}]);module.factory("dataServices",["$rootScope","$q",function(a,b){return{getLookupresult:function(d){var c=b.defer();var e=String.fromCharCode(172);d.objectName=selectedNodeAPI.replace("BMCServiceDesk__","");d.nsPrefix=namespacePrefix;d.formLayoutId="";if(typeof(a.data[namespacePrefix+"RF_FKLayout__r"])!="undefined"){d.formLayoutId=a.data[namespacePrefix+"RF_FKLayout__r"][namespacePrefix+"LayoutKey__c"]+e+a.data[namespacePrefix+"RF_FKLayout__r"]["Id"]}Visualforce.remoting.Manager.invokeAction(_RemotingActions.getLookUpData,d,getStandardCallback(c));return c.promise}}}]);module.factory("confirmationDialogService",["$modal","$rootScope",function(c,a){var b={};b.showDialog=function(d){return c.open({templateUrl:resourceUrl+"templates/confirmation-dialog.html",controller:["$scope","$modalInstance",function(e,f){e.title=d.title;e.titleI18nKey=d.titleI18nKey;e.text=d.text;e.textI18nKey=d.textI18nKey;e.confirmationYes=_Labels.modal.yes;e.confirmationNo=_Labels.modal.no;e.confirm=function(){if(d.callBackFn){d.callBackFn()}f.close()};e.dismiss=function(){f.dismiss()}}]})};return b}]);module.directive("panelHeader",function(){return{scope:{headertext:"@",action:"&"},template:'<header class="panel-heading"><h3 class="panel-title">{{headertext}}</h3><span class="x-close" ng-click="action()"></span></header>'}});var getStandardCallback=function(a){var b=function(c,d){if(d.status){a.resolve(c)}else{a.reject(d.message);rfModal.openInfoMessage($scope,"error",d.message)}};return b};function toggleOverlay(){}function displayFileName(a,c){var b=c.split("\\");var e=b[b.length-1];var d=document.getElementById(a);while(d.firstChild){d.removeChild(d.firstChild)}d.appendChild(document.createTextNode(e))}function checkMandatoryFields(){var a=true;$('input[reqd="true"]').each(function(){if($(this).val()==undefined||$(this).val().trim()==""){a=false}});$('textarea[reqd="true"]').each(function(){if($(this).val()==undefined||$(this).val().trim()==""){a=false}});$('select[reqd="true"]').each(function(){if($(this).val()==undefined||$(this).val().trim()==""||$(this).val()=="?"||$(this).val()=="? undefined:undefined ?"){a=false}});return a}function checkEmailFormat(){var a=true;$('input[type="email"]').each(function(b,c){if(c.className.indexOf("ng-invalid-email")>-1){a=false}});return a}function getRichComponent(b){var e;var d=b.contentWindow.rtfId;dociFrame=b.contentDocument;if(typeof(dociFrame)!="undefined"&&dociFrame!=null){var c=dociFrame.getElementsByTagName("iframe");var a=c[0];if(typeof(a)!="undefined"&&a!=null){doc=a.contentDocument;win=a.contentWindow;e=doc.getElementById(d+":textAreaDelegate_RichTextNote__c_rta_body");if(typeof(e)=="undefined"||e==null){e=doc.getElementById(d+":textAreaDelegate_"+namespacePrefix+"RichTextNote__c_rta_body")}}}return e}function handleExpand(a){if(selectedNodeID==undefined||selectedNodeID==""||$(a).hasClass("disabled")){return}if(sforce.one){if(isEmbeddedMode){sforce.one.navigateToURL("../apex/"+namespacePrefix+"DeepView?id="+selectedNodeID+"&isEmbeddedMode=true")}else{sforce.one.navigateToURL("../apex/"+namespacePrefix+"DeepView?id="+selectedNodeID)}}else{if(isEmbeddedMode){window.open("../apex/DeepView?id="+selectedNodeID+"&isEmbeddedMode=true","_self")}else{window.open("../apex/DeepView?id="+selectedNodeID,"_self")}}}module.factory("rootNodeDataFactory",function(){var a={};return{setRootNodeData:function(b){a=b},getRootNodeData:function(){return a}}});