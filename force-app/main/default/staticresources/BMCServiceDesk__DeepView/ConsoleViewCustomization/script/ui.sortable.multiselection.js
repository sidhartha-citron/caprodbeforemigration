angular.module("ui.sortable.multiselection",[]).constant("uiSortableMultiSelectionClass","ui-sortable-selected").directive("uiSortableSelectable",["uiSortableMultiSelectionClass",function(a){return{link:function(c,b){b.on("click",function(j){var k=angular.element(this);var g=k.parent();var l=g.sortable("option","disabled");if(l){return}var f=g.sortable("option","cancel");var n=g.sortable("option","handle");if(f!==undefined&&k.is(f)){return}if(n){var m=false;g.find(n).find("*").addBack().each(function(){if(this===j.target){m=true}});if(!m){return}}var d=g.data("uiSortableMultiSelectionState")||{};var h=d.lastIndex;var i=k.index();if(j.ctrlKey||j.metaKey){k.toggleClass(a)}else{if(j.shiftKey&&h!==undefined&&h>=0){if(i>h){g.children().slice(h,i+1).addClass(a)}else{if(i<h){g.children().slice(i,h).addClass(a)}}}else{g.children("."+a).not(k).removeClass(a);k.toggleClass(a)}}d.lastIndex=i;g.data("uiSortableMultiSelectionState",d);g.trigger("ui-sortable-selectionschanged")});b.parent().on("$destroy",function(){console.log("destroy");b.parent().removeData("uiSortableMultiSelectionState")})}}}]).factory("uiSortableMultiSelectionMethods",["uiSortableMultiSelectionClass",function(g){var f;function e(j,i,h){if(j<h&&(i===undefined||(j<i&&h<=i))){return h-1}else{if(h<j&&i!==undefined&&i<j&&i<=h){return h+1}}return h}function b(k,n,m){var j=[],o=[];for(var l=0;l<k.length;l++){var h=k[l];if(h<n){j.push(e(n,m,h))}else{if(n<h){o.push(e(n,m,h))}}}return{above:j,below:o}}function c(l,j){var h=[];for(var k=j.length-1;k>=0;k--){h.push(l.splice(j[k],1)[0])}h.reverse();return h}function d(j,i,h){var k={below:c(j,h),above:c(j,i)};return k}function a(i,h){if(h&&(typeof h==="function")){return function(){i.apply(this,arguments);h.apply(this,arguments)}}return i}return{extendOptions:function(i){i=i||{};var h=angular.extend({},this,i);for(var j in i){if(i.hasOwnProperty(j)){if(this[j]){if(j==="helper"){h.helper=this.helper}else{h[j]=a(this[j],i[j])}}}}f=h["ui-selection-count"];return h},helper:function(m,p){if(!p.hasClass(g)){p.addClass(g).siblings().removeClass(g)}var k=p.parent().children("."+g);var o=p.siblings("."+g);var n=angular.element.map(k,function(r){return angular.element(r).index()});var l=angular.element.map(o,function(r){return angular.element(r).index()});p.sortableMultiSelect={indexes:l,selectedIndexes:n};var q=n?n.length:0;var h=k.clone();o.hide();var j=p[0].tagName;var i=angular.element("<"+j+"/>");if(f&&q>1){i.addClass("ui-selection-count").attr("data-ui-selection-count",q)}return i.append(h)},start:function(o,p){p.item.sortableMultiSelect.sourceElement=p.item.parent();var k=p.item.sortable.sourceModel;var l=p.item.sortableMultiSelect.indexes;var q=p.item.sortableMultiSelect.selectedIndexes;var h=[];var r=[];for(var j=0,n=q.length;j<n;j++){var m=q[j];r.push(k[m]);if(l.indexOf(m)>=0){h.push(k[m])}}p.item.sortableMultiSelect.models=h;p.item.sortableMultiSelect.selectedModels=r},update:function(j,i){if(i.item.sortable.received){if(!i.item.sortable.isCanceled()){var k=i.item.sortable.droptargetModel,h=i.item.sortable.dropindex,l=i.item.sortableMultiSelect.moved;Array.prototype.splice.apply(k,[h+1,0].concat(l.below));Array.prototype.splice.apply(k,[h,0].concat(l.above))}else{i.item.sortableMultiSelect.sourceElement.find("> ."+g).show()}}},remove:function(k,j){if(!j.item.sortable.isCanceled()){var l=j.item.sortable.sourceModel,i=j.item.sortable.index;var h=b(j.item.sortableMultiSelect.indexes,i);j.item.sortableMultiSelect.moved=d(l,h.above,h.below)}else{j.item.sortableMultiSelect.sourceElement.find("> ."+g).show()}},stop:function(o,p){var i=p.item.sortableMultiSelect.sourceElement||p.item.parent();if(!p.item.sortable.received&&!p.item.sortable.isCanceled()){var m=p.item.sortable.sourceModel,q=p.item.sortable.index,k=p.item.sortable.dropindex;var l=p.item.sortableMultiSelect.indexes;if(!l.length){return}if(k===undefined){k=q}var n=b(l,q,k);var j=m[k];var h=d(m,n.above,n.below);Array.prototype.splice.apply(m,[m.indexOf(j)+1,0].concat(h.below));Array.prototype.splice.apply(m,[m.indexOf(j),0].concat(h.above));p.item.parent().find("> ."+g).removeClass(""+g).show()}else{if(p.item.sortable.isCanceled()){i.find("> ."+g).show()}}}}}]);