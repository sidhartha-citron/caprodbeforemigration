"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString(),n=(("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>n.length)&&(t=n.length),t-=e.length,n.lastIndexOf(e,t));return-1!==n&&n===t}),!function(){var e=angular.module("serviceExpert",["uiGmapgoogle-maps","angularMoment","ui.bootstrap","chart.js","MstResolver"]);e.run(["amMoment",function(e){e.changeLocale(userLocale)}]),e.config(["$sceDelegateProvider","$compileProvider","MstResolverProvider",function(e,t,n){var i=null,s=_.debounce(window.scheduler.updateView,100).bind(window.scheduler);window.updateViewDebounced=function(){i||0!==document.body.clientWidth?0!==document.body.clientWidth&&(i&&(clearInterval(i),i=null),s()):i=setInterval(window.updateViewDebounced,1e3)},debugMode||t.debugInfoEnabled(!1),n.setConfig({fslOperationRemoteAction:RemoteActions.getFslOperation,getAsyncApexJobRemoteAction:RemoteActions.getAsyncApexJob,apiVersion:"41.0",fieldNames:fieldNames.FslOperation,autoConnect:!1}),e.resourceUrlWhitelist(["self","https://**.force.com"])}])}(),angular.module("serviceExpert").controller("ctrlGantt",["$scope","$rootScope","$q","BundleService","BundleActions","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","DeltaService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","RegisterService","OptimizationRequestsService","GanttPalettesService",function(g,s,N,v,f,a,S,y,G,n,r,B,c,d,b,H,U,l,i,o,u,V,p,m,z,j,w,W,q,Z,h,K,Y,e,T,L){var A="",C="",D={},I=!0,k=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),R=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});function t(){g.currentViewOptions.numOfMonths<=2?(scheduler.matrix.LongView.x_unit="day",scheduler.matrix.LongView.x_length=7,scheduler.matrix.LongView.x_size=30*g.currentViewOptions.numOfMonths):(scheduler.matrix.LongView.x_unit="week",scheduler.matrix.LongView.x_size=Math.ceil(4.5*g.currentViewOptions.numOfMonths),scheduler.matrix.LongView.x_length=1)}k.setOverflowHeight(15),R.setOverflowHeight(15),g.selectedGanttServices={},g.resourceFilterHelper=r,g.StateService=b,g.resources=[],g.searchEmployee="",g.resourceFieldToSortyBy="Name",g.successfullyScheduled=0,g.currentSchedulingIndex=0,g.timelineName="",g.nowTimespans=[],g.selectedSkills={},g.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),g.hasCustomPermission=y.hasCustomPermission,g.crewViewActive=!1,g.crewsFilter=y.crewsFilter,g.useResourceSkillFilter=useResourceSkillFilter,g.numberOfDaysInUtilizationView=14,g.skillsLogicOperator=n.GetUserSettingsProperty("Skills_Logic_Operator__c")||"and",g.locations=n.GetUserSettingsProperty("locations")||[],g.editPalette=y.hasCustomPermission("Gantt_Palettes_Edit"),g.viewPalette=y.hasCustomPermission("Gantt_Palettes_View"),scheduler.attachEvent("onTemplatesReady",function(){scheduler.matrix.MonthlyView&&(scheduler.matrix.MonthlyView.x_size=n.GetUserSettingsProperty("DaysInUtilizationView__c")||14,g.numberOfDaysInUtilizationView=scheduler.matrix.MonthlyView.x_size),t()}),__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker?g.ganttLocked=n.GetUserSettingsProperty("Lock_Gantt__c")||!1:(g.ganttLocked=!0,scheduler.config.readonly=!0),scheduler.config.readonly=g.ganttLocked,g.currentViewOptions={highlightWeekeneds:n.GetUserSettingsProperty("Highlight_Weekeneds__c")||!1,minServiceDuration:void 0===n.GetUserSettingsProperty("Longterm_Min_Service_Duration__c")?8:n.GetUserSettingsProperty("Longterm_Min_Service_Duration__c"),minNaDuration:void 0===n.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c")?8:n.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c"),numOfMonths:n.GetUserSettingsProperty("Longterm_Num_Of_Months__c")||1,showMdt:n.GetUserSettingsProperty("Show_Only_MDT_In_Longterm__c")||!1},window.__currentViewOptions=g.currentViewOptions,g.saveMdtFilterSa=_.debounce(function(){n.SetUserSettingsProperty("Show_Only_MDT_In_Longterm__c",g.currentViewOptions.showMdt),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.saveHighlightWeekends=_.debounce(function(){n.SetUserSettingsProperty("Highlight_Weekeneds__c",g.currentViewOptions.highlightWeekeneds),updateViewDebounced()},400),g.saveMinimumLongtermServiceDuration=_.debounce(function(){n.SetUserSettingsProperty("Longterm_Min_Service_Duration__c",g.currentViewOptions.minServiceDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.saveMinimumLongtermAbsenceDuration=_.debounce(function(){n.SetUserSettingsProperty("Longterm_Min_Absence_Duration__c",g.currentViewOptions.minNaDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.handleLongTermViewSizeChange=_.debounce(function(){var e=n.GetUserSettingsProperty("Longterm_Num_Of_Months__c");g.currentViewOptions.numOfMonths||(g.currentViewOptions.numOfMonths=1),n.SetUserSettingsProperty("Longterm_Num_Of_Months__c",g.currentViewOptions.numOfMonths),t(),"LongView"===scheduler._mode&&scheduler.setCurrentView(),e<g.currentViewOptions.numOfMonths&&g.getTimePhasedObjects()},200),g.shouldShowSkill=function(e,t){return e.toUpperCase().includes(t.toUpperCase())},g.saveUserPropSkillsLogic=function(){n.SetUserSettingsProperty("Skills_Logic_Operator__c",g.skillsLogicOperator)},g.paletteViewActive=!1,g.showPaletteView=function(){window.paletteViewActive=!0,g.paletteViewActive=!0,updateViewDebounced()},g.hidePaletteView=function(){window.paletteViewActive=!1,g.paletteViewActive=!1,updateViewDebounced()},g.$watch("StateService.isLoadingNewLocations",function(e,t){void 0!==t&&!1!==t||1!=e||(g.paletteViewActive=!1)}),s.statusTranslations=y.statusTranslations,s.$on("moveToCrewView",function(){s.crewViewActive=!0,g.crewViewActive=!0,d.isCrewViewActive=!0}),g.$watch("resourceFilterHelper",function(e,t){$("#resourceExplainCrap").html(g.resourceFilterHelper.generateFilterExplanation(g.resourceFilters.showWorkingResource)),angular.equals(e,t)||n.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:g.resourceFilterHelper.resourceFieldToSortyBy,asc:g.resourceFilterHelper.descending,showWorkingResource:g.resourceFilters.showWorkingResource,booleanFields:g.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:g.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:g.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:g.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:g.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:g.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),g.absencesTypeLoaded=!1,g.defaultDragNa={selectedNaDuration:JSON.parse(n.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:n.GetUserSettingsProperty("Drag_Na_Type__c"),selectedNaLabel:n.GetUserSettingsProperty("Drag_Na_Label__c")},g.getEmployeeAbsenceTypes=function(){g.absencesTypeLoaded||l.getEmployeeAbsenceTypes().then(function(e){g.absencesTypeLoaded=!0,g.nonAvailabilityTypes=e,g.defaultDragNa.selectedNaType=n.GetUserSettingsProperty("Drag_Na_Type__c")||g.nonAvailabilityTypes[Object.keys(g.nonAvailabilityTypes)[0]]})},g.businessHoursRange={start:y.ganttSettings.startHour,end:y.ganttSettings.finishHour,includeWeekends:n.GetUserSettingsProperty("Include_Weekends__c")},g.resourceFilters={showWorkingResource:!!JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c"))&&JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource,resourcesWorkingInRange:{}},g.isInConsole=b.isInConsole,g.openConsoleTab=y.openConsoleTab,g.capacityFields=B.capacityCalculationFields,Object.defineProperty(g.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e,t=[];for(e in this)this[e]&&t.push(e);return t}}),g.isGanttFilterApplied=function(){return y.crewsFilter||g.skillsFilter||r.isResourceFilterApplied()||g.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var F=!0;function J(){var e;F?F=!1:(setHoursToDisplay(g.businessHoursRange.start,g.businessHoursRange.end,g.businessHoursRange.includeWeekends),scheduler.setCurrentView(),y.ganttSettings.startHour=g.businessHoursRange.start,y.ganttSettings.finishHour=g.businessHoursRange.end,(e={}).Gantt_View_Start_Hour__c=y.ganttSettings.startHour,e.Gantt_View_Finish_Hour__c=y.ganttSettings.finishHour,e.Include_Weekends__c=g.businessHoursRange.includeWeekends,n.SetUserSettingProperties(e))}function M(e,t){null!==(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)&&(""===t?alert(customLabels.no_empty_msg_to_chatter):(1===e.length&&(S.recentlyUsed[e[0]]=!0),S.postToChatter(e,t).then(function(e){})))}g.$watchCollection("businessHoursRange",J),c.promises.resources().then(function(){g.resources=c.getResources}),g.saveDragNaDefaults=function(e){switch(e){case"duration":n.SetUserSettingsProperty("Drag_Na_Duration__c",g.defaultDragNa.selectedNaDuration);break;case"type":n.SetUserSettingsProperty("Drag_Na_Type__c",g.defaultDragNa.selectedNaType);break;case"label":n.SetUserSettingsProperty("Drag_Na_Label__c",g.defaultDragNa.selectedNaLabel)}},g.getTimePhasedObjects=function(e){var t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=864e5;return"LongView"===scheduler._mode&&(i*=scheduler.matrix.LongView.x_length),"left"===e?(t.setTime(t.getTime()-i),n.setTime(n.getTime()-i)):"right"===e&&(t.setTime(t.getTime()+i),n.setTime(n.getTime()+i)),d.getTimePhasedObjects(t,n).then(function(e){var t;s.$broadcast("ganttFinishedLoadingServices"),updateViewDebounced(),I&&("Always"!==window.__gantt.checkRulesMode&&m.calculateKpis(),I=!1,updateViewDebounced(),t=null,-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){y.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service))})},g.changeDatesByArrows=function(e){updateViewDebounced(),g.getTimePhasedObjects(e)},scheduler.attachEvent("onDblClick",function(e,t){y.safeApply(g,function(){"service"===scheduler.getEvent(e).type?(S.recentlyUsed[e]=!0,p.open(e)):("contractorcapacity"===scheduler.getEvent(e).type?H:u).open(e)})}),scheduler.attachEvent("onBeforeFolderToggle",function(e,t){return folderJustToggled=!0,y.safeApply(g,function(){b.ganttOpenedTerritories[e.key]=t,X()}),!0});var X=_.debounce(function(){n.SetUserSettingsProperty("Toggled_Territories__c",JSON.stringify(b.ganttOpenedTerritories))},800);function x(){for(var e in g.selectedGanttServices)delete g.selectedGanttServices[e]}scheduler.attachEvent("onBeforeViewChange",function(e,t,n,i){return"MonthlyView"===e&&"MonthlyView"!==n&&"__Utilization__"===r.resourceFieldToSortyBy&&(r.resourceFieldToSortyBy="Name"),!0}),scheduler.attachEvent("onViewChange",function(e,t){removeAllHolidayPopovers(),y.safeApply(g,function(){switch(scheduler._mode){case"ZoomLevel2":g.timelineName=customLabels.In_Day;break;case"ZoomLevel3":g.timelineName=customLabels.Daily;break;case"ZoomLevel4":g.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":g.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":g.timelineName=customLabels.Weekly;break;case"ZoomLevel7":g.timelineName=customLabels.TwoWeeks;break;case"MonthlyView":g.timelineName=customLabels.Utilization;break;case"MTDView":g.timelineName=customLabels.MDTVIEW;break;case"LongView":g.timelineName=customLabels.LongView}$("#MonthlyLocationViewTooltip").remove(),E(),updateViewDebounced(),scheduler._old.mode===e&&scheduler._old.date===t||m.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(e,t,n){if(!e||!scheduler._events[e].isDummy&&!window.__lockedServicesIds[e]){var i=void 0,n=n.ctrlKey||n.metaKey;if(!e||"create"===t){if(!n)for(i in g.selectedGanttServices)g.selectedGanttServices[i]=!1,scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);return!1}if(e&&"service"===scheduler.getEvent(e).type){if(n)return R.hide(),g.selectedGanttServices[e]?g.selectedGanttServices[e]=!1:g.selectedGanttServices[e]=!0,scheduler.updateEvent(e),!1;for(i in g.selectedGanttServices[e]=!0,g.selectedGanttServices)i!==e&&(g.selectedGanttServices[i]=!1,scheduler.getEvent(i)&&scheduler.getSection(scheduler.getEvent(i).resourceId)&&scheduler.updateEvent(i))}else if(!n&&1<=g.selectedGanttServices.getSelected().length)for(i in g.selectedGanttServices)g.selectedGanttServices[i]=!1,scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);if((window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||!scheduler._events[e])&&!("service"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type||e&&"service"===scheduler.getEvent(e).type&&scheduler.getEvent(e).pinned&&preventUpdateOfPinned))return!0}}),g.$watchCollection("selectedGanttServices",function(e,t){globalSelectedGanttServices=g.selectedGanttServices}),g.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(e,t){scheduler.setCurrentView(e),scheduler.destroyCalendar(),g.changeDatesByArrows()}})};var O=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});O.setOverflowHeight(15),O.addNewChild(O.topId,0,"details",y.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),O.attachEvent("onClick",function(e,t,n){switch(e){case"details":y.safeApply(g,function(){u.open(C)});break;case"delete":y.safeApply(g,function(){confirm(customLabels.naDeleteConfirm)&&l.deleteAbsence(C).then(function(e){e?scheduler.deleteEvent(C):alert(customLabels.Failed_To_Delete_Break)})});break;default:if(0===e.indexOf("custom_")){var i=scheduler._events[C].type,s=parseInt(e.split("_")[1]),r=y.getCustomActions(i)[s];if(r.visualforce){var s=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),o=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();h.open(r.name,r.visualforce+"?id="+C+"&type="+i+"&start="+s+"&end="+o);break}a.callRemoteAction(RemoteActions.runCustomAbsenceAction,r.className,C,i,scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(r.name,e,null,null)}).catch(function(e){return y.addNotification(r.name,e.message,null,null)});break}}}),k.addNewChild(k.topId,0,"details",y.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),k.addNewChild(k.topId,3,"reschedule",y.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&k.addNewChild(k.topId,12,"validate",y.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,4,"candidates",y.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),k.addNewChild(k.topId,10,"reshuffle",y.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),k.addNewChild(k.topId,11,"groupNearby",y.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),k.addNewChild(k.topId,6,"map",y.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,8,"unschedule",y.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(k.addNewChild(k.topId,7,"chatter",y.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),k.addNewChild("chatter",0,"chatter_welldone",y.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),k.addNewChild("chatter",1,"chatter_hurryup",y.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),k.addNewChild("chatter",2,"chatter_requestupdate",y.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),k.addNewChild("chatter",3,"chatter_custom",y.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1)),y.customActionsPromise.then(function(){y.getCustomActions("gantt").forEach(function(e,t){e.icon?k.addNewChild(k.topId,12+t,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):k.addNewChild(k.topId,12+t,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&y.hasCustomPermission("Bundle_Unbundle")&&(k.addNewChild(k.topId,41,"bundler",y.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),k.addNewChild(k.topId,42,"unbundler",y.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1));var P={};function Q(e){for(var t in g.selectedGanttServices)g.selectedGanttServices[t]&&(S.flagged[t]=e);updateViewDebounced()}function ee(e){var e=0<arguments.length&&void 0!==e?e:1,t=Math.abs(scheduler._max_date.getTime()-scheduler._min_date.getTime()),t=Math.ceil(t/864e5)*e,e=new Date(scheduler._min_date);e.setDate(e.getDate()+t),scheduler.setCurrentView(e,scheduler._mode)}function E(){if(scheduler._is_initialized()&&g.datalessMethods){for(var e=0;e<g.nowTimespans.length;e++)scheduler.deleteMarkedTimespan(g.nowTimespans[e]);g.nowTimespans.length=0;for(var t=scheduler.serverList("resources"),n=getMinAndMaxHoursToDisplay(),i=0;i<t.length;i++){var s=new Date,s=new Date(s.valueOf()+6e4*s.getTimezoneOffset());if(useLocationTimezone?s.setMinutes(s.getMinutes()+y.getLocationOffset(s,t[i].key)):s=y.convertDateBetweenTimeZones(s,"GMT",userTimeZone),n.min<=s.getHours()&&s.getHours()<n.max&&!g.datalessMethods.isDateInsideWeekend(s)&&"MonthlyView"!==scheduler._mode){var r={};r[scheduler.getState().mode]=[];for(var o=0;o<t[i].children.length;o++)r[scheduler.getState().mode].push(t[i].children[o].key);g.nowTimespans.push(scheduler.addMarkedTimespan({start_date:s,end_date:scheduler.date.add(s,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:r}))}}}}scheduler.attachEvent("onContextMenu",function(e,t){if(scheduler.config.readonly)return!0;if(e&&"service"!==scheduler.getEvent(e).type&&"break"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type)return!1;var n;if(v.isActive()&&(i=g.selectedGanttServices.getSelected(),n=[],i.map(function(e){n.push(scheduler._events[e])}),y.hasCustomPermission("Bulk_Bundle")&&(R.hideItem("bundler"),f.Bundle.canInvoke(n)&&R.showItem("bundler")),y.hasCustomPermission("Bulk_Unundle")&&(R.hideItem("unbundler"),f.Unbundle.canInvoke(n)&&R.showItem("unbundler"))),e){k.hide(),R.hide(),O.hide(),scheduler.dhtmlXTooltip.hide();var i=0,s=0;if(t.pageX||t.pageY?(i=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(i=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),g.selectedGanttServices.getSelected().length<2){if("break"===scheduler._events[e].type)return O.removeItem("delete"),y.getCustomActions("na").forEach(function(e,t){O.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){O.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){O.addNewChild(k.topId,t+10,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),O.showContextMenu(i,s),C=e,!1;if("na"===scheduler._events[e].type)return O.removeItem("delete"),O.addNewChild(O.topId,1,"delete",y.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete,!1),y.getCustomActions("na").forEach(function(e,t){O.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){O.removeItem("custom_"+t)}),y.getCustomActions("na").forEach(function(e,t){O.addNewChild(k.topId,12+t,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),O.showContextMenu(i,s),C=e,!1;for(var r=e,o=!1,a=0;a<g.pinnedStatusesSF.length;a++)scheduler._events[r].status===g.pinnedStatusesSF[a]&&(o=!0);if(v.isActive()&&y.hasCustomPermission("Bundle_Unbundle")&&(f.Bundle.canInvoke([scheduler._events[r]])?k.showItem("bundler"):k.hideItem("bundler"),f.Unbundle.canInvoke([scheduler._events[r]])?k.showItem("unbundler"):k.hideItem("unbundler")),scheduler._events[r].pinned||o?(k.hideItem("reschedule"),k.hideItem("candidates"),k.hideItem("unschedule"),k.hideItem("status"),k.hideItem("reshuffle"),k.hideItem("groupNearby")):(k.showItem("reschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("candidates"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("unschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("status"),k.showItem("reshuffle"),k.showItem("groupNearby")),scheduler._events[r].pinned?k.hideItem("status"):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("status"),scheduler._events[r].latitude&&scheduler._events[r].longitude&&y.hasCustomPermission("Group_Nearby")?k.showItem("groupNearby"):k.hideItem("groupNearby"),y.hasCustomPermission("Schedule")?scheduler._events[r].relatedService1&&scheduler._events[r].isImmidietlyFollow?(k.hideItem("reschedule"),k.hideItem("candidates")):scheduler._events[r].isImmidietlyFollow||k.showItem("reschedule"):k.hideItem("reschedule"),y.hasCustomPermission("Reshuffle")?k.showItem("reshuffle"):k.hideItem("reshuffle"),k.removeItem("showRelated"),(scheduler._events[r].isServiceInChain||scheduler._events[r].relatedTo||scheduler._events[r].relatedFather)&&k.addNewChild(k.topId,5,"showRelated",y.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),b.isMapEnabled()&&null!==scheduler._events[r].latitude?k.showItem("map"):k.hideItem("map"),k.removeItem("flag"),S.flagged[r]?k.addNewChild(k.topId,1,"flag","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Unflag,!1):k.addNewChild(k.topId,1,"flag","<span class='fullFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Flag,!1),k.removeItem("pin"),scheduler._events[r].pinned?(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,9,"pin","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.unpin)+"</span> "+customLabels.Unpin,!1):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,9,"pin","<span class='fullFlag'>"+y.getSVGIconHTML(lsdIcons.pin)+"</span> "+customLabels.Pin,!1),k.removeItem("consoleTab"),g.isInConsole()&&k.addNewChild(k.topId,1,"consoleTab",y.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1),!scheduler.getEvent(e).pinned){var l=scheduler.getEvent(e).status,c=void 0,d=0;if(_.isEmpty(y.statusFlow)){if(k.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)for(var u in k.addNewChild(k.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),y.statuses)c="ContextMenu_"+y.statusTranslations[y.statuses[u]].split(" ").join(""),k.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+y.getCSSClassForContext(y.statusTranslations[y.statuses[u]],w)+"'></span>"+y.statusTranslations[y.statuses[u]],!1),P["status_change_"+d++]=y.statuses[u]}else if(y.statusFlow[l]&&0<y.statusFlow[l].length)for(k.removeItem("status"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),P={},d=0;d<y.statusFlow[l].length;d++)c="ContextMenu_"+y.statusFlow[l][d].split(" ").join(""),k.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+y.getCSSClassForContext(y.statusFlow[l][d],w)+"'></span>"+y.statusTranslations[y.statusFlow[l][d]],!1),P["status_change_"+d]=y.statusFlow[l][d];else k.removeItem("status")}return k.showContextMenu(i,s),A=e,!1}if(R.removeItem("selectedNumber"),R.addNewChild(R.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(g.selectedGanttServices.getSelected().length),!0),R.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226){R.addNewChild(R.topId,4,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),P={};var p,m=0;for(p in y.statuses){var h="ContextMenu_"+y.statusTranslations[y.statuses[p]].split(" ").join("");R.addNewChild("status",m,"status_change_"+m,"<span class='StatusColorChanger "+h+" "+y.getCSSClassForContext(y.statusTranslations[y.statuses[p]],w)+"'></span>"+y.statusTranslations[y.statuses[p]],!1),P["status_change_"+m++]=y.statuses[p]}}return R.showContextMenu(i,s),!1}return!(C=A="")}),k.attachEvent("onShow",function(e){contextShown=!0}),k.attachEvent("onHide",function(e){contextShown=!1}),O.attachEvent("onShow",function(e){contextShown=!0}),O.attachEvent("onHide",function(e){contextShown=!1}),k.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"bundler":f.Bundle.invoke([scheduler._events[A]],b.selectedPolicyId).then(function(e){x()},function(e){});break;case"unbundler":f.Unbundle.invoke([scheduler._events[A]],b.selectedPolicyId).then(function(){x()},function(){x()});break;case"details":y.safeApply(g,function(){p.open(A)});break;case"consoleTab":g.openConsoleTab(null,A);break;case"flag":g.$evalAsync(function(){S.flagged[A]=!S.flagged[A],scheduler.updateEvent(A)});break;case"pin":S.changePin([scheduler._events[A].id],!scheduler._events[A].pinned).then(function(){return updateViewDebounced()});break;case"reschedule":g.$evalAsync(function(){S.autoScheduleService(A).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),S.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){var t=d.serviceAppointments()[A].name;y.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){p.open(A)})})});break;case"reshuffle":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runReshuffle,A,b.selectedPolicyId).then(function(e){o.updateOptimizationRequest(e)},function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"groupNearby":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runGroupNearby,A,b.selectedPolicyId).then(function(e){o.updateOptimizationRequest(e)},function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"candidates":q.get(A);break;case"chatter_welldone":M([A],customLabels.Well_done_mate);break;case"chatter_hurryup":M([A],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":M([A],customLabels.please_update_service);break;case"chatter_custom":M([A],"");break;case"unschedule":g.$evalAsync(function(){ne([A])});break;case"map":g.showOnMap(A);break;case"showRelated":if(usingNewMstModel)return void h.open(customLabels.ComplexRelatedServicesForGanttLB+" "+scheduler._events[A].name,mstPage+"?ingantt=true&id="+A);if(scheduler._events[scheduler._events[A].relatedFather])return void y.showOnGantt(scheduler._events[A].relatedFather);if(scheduler._events[scheduler._events[A].relatedTo])return void y.showOnGantt(scheduler._events[A].relatedTo);scheduler._events[A].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[A].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[A].relatedTo].name));break;case"validate":S.checkRules([A]).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=[A],n=y.getCustomActions("gantt")[e];if(n.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();h.open(n.name,n.visualforce+"?id="+A+"&start="+e+"&end="+i);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,t,scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(n.name,e,null,null)}).catch(function(e){return y.addNotification(n.name,e.message,null,null)});break}g.$evalAsync(function(){ie([A],P[s])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),R.addNewChild(R.topId,1,"flag",y.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),R.addNewChild(R.topId,2,"unflag","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),R.addNewChild(R.topId,3,"reschedule",y.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&R.addNewChild(R.topId,12,"validate",y.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&R.addNewChild(R.topId,5,"unschedule",y.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),(!window.customPermissions.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.customPermissions.ignoreReadonlyGantt226)&&(R.addNewChild(R.topId,7,"pin",y.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),R.addNewChild(R.topId,8,"unpin","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1)),y.customActionsPromise.then(function(){y.getCustomActions("gantt").forEach(function(e,t){e.icon?R.addNewChild(R.topId,t+12,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):R.addNewChild(R.topId,t+12,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&(y.hasCustomPermission("Bulk_Bundle")&&R.addNewChild(R.topId,41,"bundler",y.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),y.hasCustomPermission("Bulk_Unbundle")&&R.addNewChild(R.topId,42,"unbundler",y.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1)),R.attachEvent("onShow",function(e){contextShown=!0}),R.attachEvent("onHide",function(e){contextShown=!1}),R.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"flag":y.safeApply(g,function(){Q(!0)});break;case"unflag":y.safeApply(g,function(){Q(!1)});break;case"bundler":var e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Bundle.invoke(e,b.selectedPolicyId).then(function(e){x()},function(e){});break;case"unbundler":e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Unbundle.invoke(e,b.selectedPolicyId).then(function(e){x()},function(e){});break;case"reschedule":Z.schedule(g.selectedGanttServices.getSelected());break;case"pin":S.changePin(g.selectedGanttServices.getSelected(),!0).then(function(){return updateViewDebounced()});break;case"unpin":S.changePin(g.selectedGanttServices.getSelected(),!1).then(function(){return updateViewDebounced()});break;case"unschedule":ne(g.selectedGanttServices.getSelected());break;case"validate":S.checkRules(g.selectedGanttServices.getSelected()).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=g.selectedGanttServices.getSelected(),n=y.getCustomActions("gantt")[e];if(n.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();h.open(n.name,n.visualforce+"?services="+t.join(",")+"&start="+e+"&end="+i);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,g.selectedGanttServices.getSelected(),scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(n.name,e,null,null)}).catch(function(e){return y.addNotification(n.name,e.message,null,null)});break}ie(g.selectedGanttServices.getSelected(),P[s])}})}),g.lockGanttToggle=function(){(window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker)&&(scheduler.config.readonly=!scheduler.config.readonly,g.ganttLocked=scheduler.config.readonly,n.SetUserSettingsProperty("Lock_Gantt__c",g.ganttLocked))},g.unSelecteAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!1},g.selectAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!0},g.getSkills=i.getSkills,scheduler.attachEvent("onYScaleClick",function(e,t,n){n.stopPropagation(),n.preventDefault(),window.__lastResourceClicked=t;for(var i=["resourceMenuBtn","resourceMenuIcon"],s=0;s<i.length;s++)if(n.target.classList&&n.target.classList.contains(i[s])||n.target.parentNode&&n.target.parentNode.classList.contains(i[s]))return void U.open(t.resourceId,t.key,n.target);t.children||V.open(t.resourceId,t.key)}),scheduler.attachEvent("onBeforeTooltip",function(e){return setTimeout(function(){var e=$(".dhtmlXTooltip");0!==e.length&&(e.position().top<0?e.css("height",e.height()+e.position().top-15+"px"):15<e.position().top&&e.css("height","initial"))},400),!0}),g.$on("keypress",function(e,t){if($("#MonthlyViewTooltip").remove(),!b.isLightboxOpened()&&!$("*:focus").is("textarea, input"))switch(t.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.recentlyUsed[scheduler._selected_id]=!0,p.open(scheduler._select_id));break;case 37:t.shiftKey?(ee(-1),g.changeDatesByArrows()):$(".dhx_cal_prev_button").click();break;case 38:var n=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(n-30);break;case 39:t.shiftKey?(ee(),g.changeDatesByArrows()):$(".dhx_cal_next_button").click();break;case 40:n=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(n+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):y.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&!scheduler.getEvent(scheduler._select_id).isDummy&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):y.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:g.jumpToToday();break;case 70:1===g.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.flagged[scheduler._select_id]?S.flagged[scheduler._select_id]=!1:S.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id));break;case 48:case 96:g.changeTimeline(0);break;case 49:case 97:g.changeTimeline(1);break;case 50:case 98:g.changeTimeline(2);break;case 51:case 99:g.changeTimeline(3);break;case 55:g.changeTimeline(7);break;case 77:y.hasCustomPermission("MDT_View")&&!y.hasCustomPermission("Longterm_View")&&g.changeTimeline(35);break;case 85:y.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&g.changeTimeline(30);break;case 103:g.changeTimeline(7)}}),g.changeTimeline=function(e){var t=scheduler._min_date,n=scheduler._max_date,i=void 0;switch(e){case 0:if((i="ZoomLevel2")===scheduler._mode)return;g.timelineName=customLabels.In_Day;break;case 1:if((i="ZoomLevel3")===scheduler._mode)return;g.timelineName=customLabels.Daily;break;case 2:if((i="ZoomLevel4")===scheduler._mode)return;g.timelineName=customLabels.X2_Days;break;case 3:if((i="ZoomLevel5")===scheduler._mode)return;g.timelineName=customLabels.X3_Days;break;case 7:if((i="ZoomLevel6")===scheduler._mode)return;g.timelineName=customLabels.Weekly;break;case 14:if((i="ZoomLevel7")===scheduler._mode)return;g.timelineName=customLabels.TwoWeeks;break;case 30:if((i="MonthlyView")===scheduler._mode)return;g.timelineName=customLabels.Utilization;break;case 35:if((i="MTDView")===scheduler._mode)return;g.timelineName=customLabels.MDTVIEW;break;case 180:if((i="LongView")===scheduler._mode)return;g.timelineName=customLabels.LongView}scheduler.setCurrentView(t,i),g.changeDatesByArrows(n)},setInterval(E,6e5),g.jumpToToday=function(){var e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),scheduler.setCurrentView(e),g.changeDatesByArrows()},s.$on("afterShowEvent",function(){setTimeout(function(){g.changeDatesByArrows(),E(),updateViewDebounced()},800)}),g.showOnMap=function(e){s.$broadcast("showServiceOnMap",e),y.safeApply(g)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,n,i){var s=e.resourceId.split("_"),s=T.isTerritoryHasInDayOptimizationInProgress(e.start_date,e.end_date,s[1]);if(s){if(!1===confirm(customLabels.In_Day_Optimization_In_Progress_Confirm))return!1;"Rollback"===y.getSchedulingPolicyObject(s.policy)[fieldNames.SchedulingPolicy.Commit_Mode__c]&&T.updateProgressStatus(s.id,"Aborted")}var r,o,a;if(t.ctrlKey&&!e.isImmidietlyFollow&&S.handleSnap(e,t),e.resourceId===i.resourceId){if(s=e.start_date.getTime(),r=e.end_date.getTime(),o=i.start_date.getTime(),a=i.end_date.getTime(),Math.abs((s-o)/1e3/60)<minDragMinutes||Math.abs((r-a)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"===e.type)return!1;if(b.areContractorsSupported()&&"service"===e.type&&c.getResources()[e.getGanttResource()].isCapacityBased){for(var l in d.resourceCapacities()){l=d.resourceCapacities()[l];if(l.resource===c.getResources()[e.getGanttResource()].id&&(e.start.getTime()>=l.start_date.getTime()&&e.start.getTime()<=l.end_date.getTime()))return e.resourceBeforeDrag=i.resourceId,e.eventBeforeDrag=i,se(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return D=GanttService.copy(i),snapTo=t.ctrlKey,se(e),e.resourceBeforeDrag=i.resourceId,e.eventBeforeDrag=i,!0}),g.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&updateViewDebounced(),te()};var te=_.debounce(function(){n.SetUserSettingsProperty("Utilization_Properties__c",JSON.stringify(g.capacityFields))},800);function ne(e){var t,n;confirm(customLabels.are_you_sure_unschedule)&&(t=[],n=[],e.forEach(function(e){n.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.unscheduleServices(e,b.selectedPolicyId).then(function(e){x(),S.drawServicesAndAbsences(e.services,e.absences),m.calculateKpis()}).catch(function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function ie(e,t){var n,i;t===w.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel)||(n=[],i=[],e.forEach(function(e){i.push(d.serviceAppointments()[e]),n.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.changeStatus(e,t).then(function(e){x(),S.drawServicesAndAbsences(e.services)}).catch(function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function se(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,n="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,i=t%serviceJumpsOnGantt,t=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!=i&&(e.start_date=t<i?new Date(e.start_date.getTime()+60*t*1e3):new Date(e.start_date.getTime()-60*i*1e3),e.end_date=new Date(e.start_date.getTime()+n+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}g.cancelCrewView=function(){s.crewViewActive=!1,g.crewViewActive=!1,d.isCrewViewActive=!1},s.$on("gotNewTimePhasedObjects",function(e,t){S.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities)}),s.$on("timePhasedObjectsCheckRules",function(e,t){S.checkRules(t).then(S.drawViolationsOnGantt)}),a.callRemoteAction(RemoteActions.isStreamingShouldBeActive).then(function(e){"true"===e?b.setStreamingActiveState(!0):(b.setStreamingActiveState(!1),"false"!==e&&y.addNotification(customLabels.GanttLiveRefreshNotSupported,e,null,null)),K.initStreaming()}),e.register("services",function(e){S.drawServicesAndAbsences(e.updated||[],[],e.deleted||[])}),e.register("absences",function(e){S.drawServicesAndAbsences([],e.updated||[],e.deleted||[])}),e.register("capacities",function(e){S.drawServicesAndAbsences([],[],e.deleted||[],e.updated||[])}),e.register("rules",function(e,t){t&&S.checkRules(e).then(S.drawViolationsOnGantt)}),scheduler.attachEvent("onEventChanged",function(e,t){"service"!==t.type&&"na"!==t.type||y.safeApply(g,function(){"na"===t.type?l.saveChangesToAbsence(D,t,b.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e[0].message?y.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].message):y.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):S.saveChangesToServiceAppointment(D,t).then(function(e){scheduler._select_id=t.id}).catch(function(e){console.warn("Couldn't update service. "+e[2]),y.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json"),d.serviceAppointments()[e[1].id]=e[1]})})}),g.$on("JumpToDate",function(e,t){scheduler.setCurrentView(t),g.changeDatesByArrows()}),g.$on("GotSlots",function(e,t){var n=getMinAndMaxHoursToDisplay();(t.minDateOfCandidate.getHours()<n.min||t.minDateOfCandidate.getHours()>=n.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(t.minDateOfCandidate.getHours()<n.min?g.businessHoursRange.start=t.minDateOfCandidate.getHours():g.businessHoursRange.end=24,J())}),g.changeUtilizaionDays=function(e){-1===e&&1===g.numberOfDaysInUtilizationView||1===e&&30===g.numberOfDaysInUtilizationView||(g.numberOfDaysInUtilizationView+=e,g.daysInUtilizationChanged())},g.daysInUtilizationChanged=function(){scheduler.matrix.MonthlyView.x_size=g.numberOfDaysInUtilizationView,n.SetUserSettingsProperty("DaysInUtilizationView__c",g.numberOfDaysInUtilizationView),"MonthlyView"===scheduler._mode&&(scheduler.updateView(),g.getTimePhasedObjects())},g.getRowSizeClass=function(){return y.ganttSettings.resourceRowHeight+"-css"},g.filterVisibility={hours:!0,resources:!1,skills:!1,utilization:!1,palettes:!1},g.needToLoadSkills=!0,g.needToLoadPalettes=!0,g.werePalettesLoaded=L.werePalettesLoaded,g.changeGanttFilterTab=function(e){for(var t in"skills"===e&&g.needToLoadSkills&&i.getSkillsFromSfdc().then(function(){return g.needToLoadSkills=!1}),"palettes"===e&&g.needToLoadPalettes&&!L.werePalettesLoaded()&&L.getGanttPalettes(!0).then(function(){return g.needToLoadPalettes=!1}),g.filterVisibility)g.filterVisibility[t]=t===e},scheduler.attachEvent("onAfterEventDisplay",function(e){setTimeout(function(){e.showEventPopupEffect=!1,m.calculateKpis(),s.$broadcast("afterShowEvent")},2500)}),g.updateWorkingReosourcesFilter=_.debounce(function(){g.resourceFilterHelper.showWorkingResource=g.resourceFilters.showWorkingResource},300),s.$on("flagService",function(e,t){S.flagged[t]?S.flagged[t]=!S.flagged[t]:S.flagged[t]=!0,scheduler.updateEvent(t)}),scheduler.attachEvent("onBeforeLightbox",function(e){scheduler.updateEvent(e);e=$("#timesDragFix");return e&&e.hide(),!1})}]),angular.module("serviceExpert").controller("ctrlIframeMap",["$scope","sfdcService","$rootScope","MapService","servicesService","TimePhasedDataService",function(n,e,t,i,s,r){n.filter=s.filter,n.$on("showServiceOnMap",function(e,t){i.showServiceOnMap(t,n.floatingMapOn,n.workingState)}),n.$on("gotNewResources",function(e,t){i.initializeGanttMap(!0)}),n.$watch("filter",function(e,t){"map"!==n.workingState&&!n.floatingMapOn||i.updateGanttMapFilter()},!0),n.$watch("floatingMapOn",function(e){e&&i.updateGanttMapFilter()}),n.$watch("workingState",function(e){"map"!==e&&!n.floatingMapOn||i.updateGanttMapFilter()}),t.$on("paletteUpdated",function(){i.updateGanttMapServices(r.serviceAppointments(),{})}),t.$on("updateTimePhaseData",function(e,t){i.updateGanttMapServices(t,{})}),t.$on("deleteTimePhaseData",function(e,t){i.updateGanttMapServices({},t)}),t.$on("gotNewTimePhasedObjects",function(e,t){i.initializeGanttMap(!1),i.updateGanttMapServices(t.serviceAppointments,[],!0),i.updateGanttMapView()}),scheduler.attachEvent("onViewChange",function(){"map"!==n.workingState&&!n.floatingMapOn||(i.updateGanttMapView(),i.updateGanttMapServices(s.filteredServices.servicesArray,[]))})}]),angular.module("serviceExpert").controller("mainController",["$scope","StateService",function(e,t){e.isOSX=t.isOSX,e.lang=t.lang,e.isRtlDirection=t.isRtlDirection(),e.isUserIdle=t.isUserIdle,e.refreshPage=function(){location.reload()},e.focusOnInactiveButton=function(){document.getElementById("ReloadButtonFsl").focus()}}]),angular.module("serviceExpert").controller("ctrlMap",["$scope","sfdcService","$rootScope","$q","userSettingsManager","servicesService","bulkScheduleService","$timeout","$filter","utils","ServiceAppointmentLightboxService","ResourceLightboxService","TimePhasedDataService","FieldSetFieldsService","ResourcesAndTerritoriesService","LastKnownPositionService","DeltaService","SERVICE_STATUS","SERVICE_CATEGORY","DRAWING_STATES","StreamingAPIService","RegisterService","GeneralLightbox",function(A,o,n,d,r,a,l,s,N,C,c,u,D,e,I,k,G,p,i,m,B,t,h){A.SERVICE_STATUS=p,A.invokedActions={},A.allMarkersArray=[],A.reports={},A.reportsData={},A.map=null,A.markersControl={},A.territoriesMarkers=[],A.firstMapShow=!0,A.trafficLayerEnabled=!1,A.mapControl={center:{latitude:0,longitude:0},zoom:19},A.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}};var g=JSON.parse(r.GetUserSettingsProperty("Map_Object_Markers__c"))||{services:!0,resources:!0,positions:!0,territories:!0};function v(e){if(A.allMarkersArray=[],A.showResources){var t,n=scheduler.getState().min_date,i=scheduler.getState().max_date,s=D.resourcesByPrimariesAndRelocations();for(t in s){var r,o=s[t];for(r in o){var a=o[r];isIntersect(n,i,a.effectiveStartDate,a.effectiveEndDate)&&!function(e){var t;!e.latitude||(t=I.getResources()[e.serviceResource])&&(A.isEmpty(A.filteredResources)||A.filteredResources[t.id])&&(e={id:e.id,icon:staticResources.homebase_png,type:"resource",resourceId:t.id,serviceTerritory:e.serviceTerritory,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})},A.allMarkersArray.push(e))}(a)}}}if(A.showServices){for(var l=A.filteredServices.servicesArray,c=0;c<l.length;c++){var d=l[c];d.id!=A.currentShowOnMapServiceId&&R(d)}A.currentShowOnMapServiceId&&R(D.serviceAppointments()[A.currentShowOnMapServiceId])}if(A.showLivePositions){var u,p=scheduler.getState().min_date,m=scheduler.getState().max_date,h=D.resourcesAndTerritories(),g=k.lastKnownPositions();for(u in g){var v,f=h[u];for(v in f){var S=f[v];if(isIntersect(p,m,S.effectiveStartDate,S.effectiveEndDate)){!function(e){var t=I.getResources()[e.id];(A.isEmpty(A.filteredResources)||A.filteredResources[t.id])&&((e={id:e.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})}).item.lastModifiedDate=C.convertDateBetweenTimeZones(e.item.lastModifiedDate,"UTC",userTimeZone),A.allMarkersArray.push(e))}(g[u]);break}}}}A.showTerritories&&F();var y,b=e,_=maxReportMarkers;for(y in A.reportsData){var w=A.reportsData[y];if(w.show)for(var T=w.displayCount=0;T<w.data.length;T++){var L=w.data[T];if(0==_){b&&(A.showTooManyReportsAlert=!0);break}(function(e,t){var n;if(e.latitude)return n=staticResources.report,"ServiceAppointment"===e.sObjectType?n=staticResources.service_png:void 0!==staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]&&(n=staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]),t={id:t,icon:n,type:"report",coords:{latitude:e.latitude,longitude:e.longitude},item:e},A.allMarkersArray.push(t),!0})(L,y+w.displayCount)&&(w.displayCount++,_--)}}}function f(e,t){for(var n=new google.maps.LatLngBounds,i=0;i<e.length;i++){var s=(t?e[i].coords:e[i]).latitude,r=(t?e[i].coords:e[i]).longitude;s&&r&&(s=new google.maps.LatLng(s,r),n.extend(s))}return n}function R(e){var t;e.latitude&&A.showServices&&(t=e.getGanttResource(),(A.isEmpty(A.filteredResources)||null!=t&&A.filteredResources[t])&&(t=staticResources.service_png,e.statusCategory==i.COMPLETED&&(t=staticResources.service_completed_png),t={id:e.id,icon:t,type:"service",animation:2,coords:{latitude:e.latitude,longitude:e.longitude},item:e},A.allMarkersArray.push(t)))}function F(){var e,t=I.territories();for(e in t)t[e].latitude&&A.allMarkersArray.push({id:e,icon:staticResources.territory_map_icon,type:"territory",animation:2,coords:{latitude:t[e].latitude,longitude:t[e].longitude},item:t[e]})}function S(e,t){if(A.polygons[e])A.polygons[e].polygon.setVisible(t),y(e,t);else if(I.territories()[e]||"NoTerritoryPolygon"==e){y(e);for(var n=A.myTreeView.getSubItems(e),i=0;i<n.length;i++)s=n[i],t?A.myTreeView.checkItem(s):A.myTreeView.uncheckItem(s)}var s;r.SetUserSettingsProperty("Invisible_Polygons__c",JSON.stringify(A.InvisiblePolygons))}function y(e,t){for(var n=0;n<A.InvisiblePolygons.length;n++)if(A.InvisiblePolygons[n]==e)return void A.InvisiblePolygons.splice(n,1);t||A.InvisiblePolygons.push(e)}function b(){A.selectedShape&&("marker"!==A.selectedShape.type&&A.selectedShape.setEditable(!1),A.selectedShape.set("strokeWeight",1),A.selectedShape=null,A.currentEditPolygon=null,A.polygonName="",A.polygonTerritory="null"),A.drawState=A.drawState==m.DRAW?m.EDIT:m.NONE}function w(e){if(this&&(e=this),A.drawState==m.INTERSECT)return A.currentIntersectingId==e.id?void 0:(A.selectedIntersectingPolygons[e.id]?delete A.selectedIntersectingPolygons[e.id]:A.selectedIntersectingPolygons[e.id]=!0,void A.$apply());"marker"!==e.type&&(b(),A.selectedColor=A.selectedShapeColor=e.get("fillColor"),A.drawState!=m.EDIT&&(A.drawState=m.SELECTED)),A.polygonName=e.name,A.polygonTerritory=e.territory||"null",A.selectedShape=e,A.selectedShape&&A.selectedShape.set("strokeWeight",3),e.id!=A.myTreeView.getSelectedId()&&(A.shouldBound=!1,A.myTreeView.selectItem(e.id)),A.$apply()}function T(e){A.geoXmlParser.parseKmlString(e[fieldNames.Polygon.KML__c]);for(var t=A.geoXmlParser.docs.length-1,n=0;n<A.geoXmlParser.docs[t].placemarks.length;n++)A.geoXmlParser.docs[t].placemarks[n].id=e.Id,A.geoXmlParser.docs[t].placemarks[n].polygon.id=e.Id,A.geoXmlParser.docs[t].placemarks[n].polygon.name=e.Name,A.geoXmlParser.docs[t].placemarks[n].polygon.territory=e[fieldNames.Polygon.Service_Territory__c],A.geoXmlParser.docs[t].placemarks[n].polygon.addListener("click",function(){A.shouldBound=!1,x.hide(),w(this)}),A.geoXmlParser.docs[t].placemarks[n].polygon.addListener("rightclick",P),A.polygons[e.Id]=e,A.polygons[e.Id].polygon=A.geoXmlParser.docs[t].placemarks[n].polygon}A.showServices=g.services,A.showResources=g.resources,A.showLivePositions=g.positions,A.showTerritories=g.territories,A.showOnMap=!1,A.setMapMarkerUserSettings=function(){r.SetUserSettingsProperty("Map_Object_Markers__c",JSON.stringify({services:A.showServices,resources:A.showResources,positions:A.showLivePositions,territories:A.showTerritories}))},A.showTooManyReportsAlert=!1,A.resourcesFilterList=[],A.filterResourceInputValue="",A.filteredResources={},A.selectedReport="null",A.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},report:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},A.serviceInfoWindow={show:!1,control:{}},A.resourceInfoWindow={show:!1,control:{}},A.territoryInfoWindow={show:!1,control:{}},A.reportInfoWindow={show:!1,control:{}},A.livePosInfoWindow={show:!1,control:{}},A.filteredServices=a.filteredServices,A.filter=a.filter,A.currentShowOnMapServiceId=null,A.drawingStates=m,A.drawState=m.NONE,A.selectedShape=null,A.selectedShapeColor=A.selectedColor,A.drawingManager,A.setSelectedShapeColor=function(e){A.selectedShape&&(A.selectedShape.set("fillColor",e),A.selectedShapeColor=e);A.selectedColor=e},A.polygons={},A.polygonName="",A.polygonTerritory="null",A.territories={},A.selectedIntersectingPolygons={},A.shouldBound=!0,A.cancelDrawingShape=!1,A.InvisiblePolygons=null==r.GetUserSettingsProperty("Invisible_Polygons__c")?[]:JSON.parse(r.GetUserSettingsProperty("Invisible_Polygons__c")),A.hasCustomPermission=C.hasCustomPermission,A.getServiceInfoRowClass=C.getServiceInfoRowClass,A.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,A.getReportsError=function(){return A.reportsError},C.getReports().then(function(e){if(e)for(var t=0;t<e.length;t++)A.reports[e[t].Id]=e[t]}).catch(function(e){A.reportsError=!0}),k.getLastKnownPositions(),A.redrawAllMarkers=v,A.$watch("workingState",function(e){"map"==e?(A.map=A.mapControl.getGMap(),s(function(){A.resourcesFilterList=[];var e,t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=D.resourcesAndTerritories(),s=I.getResources();for(e in s){var r,o=i[e],a=s[e];for(r in o){var l=o[r];if(isIntersect(t,n,l.effectiveStartDate,l.effectiveEndDate)){A.resourcesFilterList.push({label:a.name,value:a.id});break}}}if(v(),google.maps.event.trigger(A.mapControl.getGMap(),"resize"),A.firstMapShow){if(!A.showOnMap){var c=new google.maps.LatLng(37.794024,-122.394837),d=f(A.filteredServices.servicesArray);(d=d.isEmpty()?f(_.values(D.serviceAppointments())):d).isEmpty()?A.map.setCenter(c):A.map.fitBounds(d)}var c=A.map.getStreetView(),d={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}},u=(c.setOptions(d),{fillOpacity:.5,strokeWeight:1,editable:!0,draggable:!0,fillColor:A.selectedColor});if(A.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,drawingModes:["polygon"]},polygonOptions:u,rectangleOptions:u}),A.drawingManager.setMap(A.map),google.maps.event.addListener(A.drawingManager,"overlaycomplete",function(e){var n=e.overlay;if(A.cancelDrawingShape)return A.cancelDrawingShape=!1,void n.setMap(null);n.type=e.type,n.set("fillColor",A.selectedColor),n.set("name",A.polygonName),n.set("territory",A.polygonTerritory),A.drawingManager.setDrawingMode(null),google.maps.event.addListener(n,"click",function(e){var t;void 0!==e.vertex&&n.type===google.maps.drawing.OverlayType.POLYGON&&((t=n.getPaths().getAt(e.path)).removeAt(e.vertex),t.length<3&&n.setMap(null)),w(n)}),w(n)}),"function"!=typeof google.maps.Polygon.prototype.ToWKT&&(google.maps.Polygon.prototype.ToWKT=function(){for(var e="POLYGON(",t=this.getPaths(),n=0;n<t.getLength();n++){var i=t.getAt(n);e+="(";for(var s=0;s<i.getLength();s++)e+=i.getAt(s).lng().toString()+" "+i.getAt(s).lat().toString()+",";e+=i.getAt(0).lng().toString()+" "+i.getAt(0).lat().toString()+"),"}return e=e.substring(0,e.length-1)+")"}),A.geoXmlParser=new geoXML3.parser({map:A.map,suppressInfoWindows:!0,zoom:!1}),!A.isEmpty(A.polygons)){var p=0;try{for(var m in A.polygons){A.geoXmlParser.parseKmlString(A.polygons[m][fieldNames.Polygon.KML__c]);for(var h,g=0;g<A.geoXmlParser.docs[p].placemarks.length;g++)A.geoXmlParser.docs[p].placemarks[g].polygon&&(A.geoXmlParser.docs[p].placemarks[g].id=A.polygons[m].Id,A.geoXmlParser.docs[p].placemarks[g].polygon.id=A.polygons[m].Id,A.geoXmlParser.docs[p].placemarks[g].polygon.name=A.polygons[m].Name,A.geoXmlParser.docs[p].placemarks[g].polygon.territory=A.polygons[m][fieldNames.Polygon.Service_Territory__c],h=-1==A.InvisiblePolygons.indexOf(m),A.geoXmlParser.docs[p].placemarks[g].polygon.setVisible(h),A.geoXmlParser.docs[p].placemarks[g].polygon.addListener("click",function(){A.shouldBound=!1,x.hide(),w(this)}),A.geoXmlParser.docs[p].placemarks[g].polygon.addListener("rightclick",P),A.polygons[m].polygon=A.geoXmlParser.docs[p].placemarks[g].polygon);p++}}catch(e){alert("Problem parsing KML string"),console.error(e)}}google.maps.event.addListener(A.map,"click",function(){A.map.setOptions({draggableCursor:"grab"}),x.hide()}),x=new O(A.map,L),A.firstMapShow=!1,A.showOnMap=!1}},0)):A.currentShowOnMapServiceId=null}),A.$on("resizeMap",function(e,t){google.maps.event.trigger(A.mapControl.getGMap(),"resize")}),A.$on("showServiceOnMap",function(e,t){A.currentShowOnMapServiceId=t,n.$broadcast("changeWorkingState","map"),A.map=A.mapControl.getGMap(),A.showOnMap=!0,s(function(){google.maps.event.trigger(A.mapControl.getGMap(),"resize");var e=D.serviceAppointments()[t],e=new google.maps.LatLng(e.latitude,e.longitude);A.map.setCenter(e),A.map.setZoom(20),s(function(){A.markersControl.getPlurals().get(t)&&A.markersControl.getPlurals().get(t).gObject.setAnimation(google.maps.Animation.BOUNCE),s(function(){var e=A.markersControl.getPlurals().get(t);e&&e.gObject.setAnimation(null)},3500)},150)},0)}),e.fieldsSetFields().then(function(e){A.serviceFields=e.MapInfo}),A.isEmpty=function(e){return!e||_.isEmpty(e)},A.markerCloseClicked=function(){A.serviceInfoWindow.show=!1,A.resourceInfoWindow.show=!1,A.territoryInfoWindow.show=!1,A.reportInfoWindow.show=!1,A.livePosInfoWindow.show=!1,A.$apply()},A.openLink=function(e,t){"Resource__r"==t.APIName?A.openLightbox(e.resourceId,"resource"):C.openLink(e,t)},A.openReportLink=function(e){e.isReference&&("ServiceResource"==e.APIName?A.openLightbox(e.Value,"resource"):"ServiceAppointment"==e.APIName?A.openLightbox(e.Value,"service"):C.openConsoleTab(null,e.Value)||window.open("../"+e.Value,"_blank"))},A.markerClicked=function(e,t,n){var i=n,n=i.type;switch(A.serviceInfoWindow.show=!1,A.resourceInfoWindow.show=!1,A.territoryInfoWindow.show=!1,A.reportInfoWindow.show=!1,A.livePosInfoWindow.show=!1,A.currentMarker=i,n){case"service":A.serviceInfoWindow.show=!0,A.currentMarker.item=D.serviceAppointments()[i.id];break;case"lastKnownPosition":A.livePosInfoWindow.show=!0;break;case"resource":A.resourceInfoWindow.show=!0;break;case"territory":A.territoryInfoWindow.show=!0;break;case"report":A.reportFields=[],A.reportFields.push.apply(A.reportFields,i.item.otherProperties),A.reportInfoWindow.show=!0}s(function(){A.$apply(),C.setMapCloseButtonPosition()},0)},A.openLightbox=function(e,t,n){var i=null;switch(n&&(i=C.generateResourceId(e,n)),t){case"service":a.recentlyUsed[e]=!0,c.open(e);break;case"resource":u.open(e,i);break;case"homeBase":A.$emit("showResourceLightbox",A.resources[e])}},A.$watch("filter",function(e,t){"map"===A.workingState&&v()},!0),A.clearResource=function(e){delete A.filteredResources[e],v()},A.clearAllResources=function(){A.filteredResources={},v()},A.addResourceToFilterList=function(){var e=I.getResources();""!=A.filterResourceInputValue&&e[A.filterResourceInputValue.value]&&(A.filteredResources[A.filterResourceInputValue.value]=e[A.filterResourceInputValue.value],A.filterResourceInputValue="",v())},A.toggleReportMarkers=function(e){e=A.reportsData[e];e.show=!e.show,v()},A.removeReportFromMap=function(e){delete A.reportsData[e],v()},A.removeAllReportsFromMap=function(){A.reportsData={},v()},A.showReportOnMap=function(){"null"!=A.selectedReport&&o.callRemoteAction(RemoteActions.getReportRowsForMap,A.selectedReport).then(function(e){A.reportsData[A.selectedReport]={show:!0,data:e,displayCount:0};v(!0)})},t.register("positions",function(e){v()}),A.isPinnedStatus=function(){if(A.currentMarker){for(var e=A.pinnedStatusesSF.split(","),t=0;t<e.length;t++)if(A.currentMarker.item.status===e[t])return!0;return!1}},A.needToShowScheduleButton=function(){return A.currentMarker&&"service"==A.currentMarker.type&&!A.currentMarker.item.pinned&&!A.isPinnedStatus()&&A.hasCustomPermission("Schedule")},A.needToShowDispatchButton=function(){return A.currentMarker&&"service"==A.currentMarker.type&&A.currentMarker.item.statusCategory!=i.DISPATCHED&&A.currentMarker.item.statusCategory==i.SCHEDULED},A.isServiceCurrentlyDispatching=function(){return A.currentMarker&&"dispatched"==A.invokedActions[A.currentMarker.id]},A.changeStatusToDispatch=function(e){A.invokedActions[e]?alert(customLabels.another_operation_running):(A.invokedActions[A.currentMarker.id]="dispatched",a.changeStatus([e],p.DISPATCHED).then(function(e){0<e.services.length&&(A.currentMarker.item=e.services[0])}).finally(function(){delete A.invokedActions[A.currentMarker.id]}))},A.isServiceCurrentlyScheduling=function(){return A.currentMarker&&"schedule"==A.invokedActions[A.currentMarker.id]},A.autoScheduleService=function(t){t=A.currentMarker.id;A.invokedActions[t]?alert(customLabels.another_operation_running):(a.recentlyUsed[t]=!0,A.invokedActions[t]="schedule",a.autoScheduleService(t).then(function(e){a.drawServicesAndAbsences(e.services,e.absences),delete A.invokedActions[t]}))},A.myTreeView={},A.lastSelectedLeafId=null,d.all([C.getPolygons(),I.promises.territories()]).then(function(e){var t,n=e[0];if(n)for(var i=0;i<n.length;i++)n[i][fieldNames.Polygon.KML__c]&&(A.polygons[n[i].Id]=n[i]);for(t in I.territories())-1!=C.getFilteredLocations().indexOf(t)&&(A.territories[t]=I.territories()[t]);F(),function(){var e,t,n,i=d.defer(),s=I.territories(),r={},o=[],a=(C.getFilteredLocations(),{NoTerritoryPolygon:{id:"NoTerritoryPolygon"}});for(e in A.polygons)r[e]={id:e,parent:A.polygons[e][fieldNames.Polygon.Service_Territory__c]?s[A.polygons[e][fieldNames.Polygon.Service_Territory__c]]:a.NoTerritoryPolygon,text:A.polygons[e].Name,icons:{file:"fa-square"},icon_color:A.polygons[e][fieldNames.Polygon.Color__c],checked:-1==A.InvisiblePolygons.indexOf(e)?1:0,items:[]};for(t in s)r[t]={id:t,parent:I.territories()[t].parentTerritory?I.territories()[t].parentTerritory:0,text:I.territories()[t].name,icons:{file:"fa-building-o"},checked:-1==A.InvisiblePolygons.indexOf(t)?1:0,items:[]};for(n in r.NoTerritoryPolygon={id:"NoTerritoryPolygon",parent:0,text:customLabels.Polygons_without_Service_Territory,icons:{file:"fa-building-o"},checked:-1==A.InvisiblePolygons.indexOf("NoTerritoryPolygon")?1:0,items:[]},r){var l=r[n],c=function e(t){if(!t.id||!t.parent)return;{var n;return r[t.parent.id]?t.parent:(n={},I.allTerritories[t.parent.id]&&(n={id:I.allTerritories[t.parent.id].id,parent:I.allTerritories[t.parent.id].parentTerritory||0}),e(n))}}(l);(0!==l.parent&&c?r[c.id].items:o).push(l)}return i.resolve(o),i.promise}().then(function(e){A.locationsTree=e,A.myTreeView=new dhtmlXTreeView({parent:"polygonsByTerritoriesTree",iconset:"font_awesome",checkboxes:!0,items:A.locationsTree}),A.myTreeView.attachEvent("onSelect",function(e,t){if(A.drawState!=m.NONE&&A.drawState!=m.SELECTED)return!1;A.lastSelectedLeafId||(A.lastSelectedLeafId=e),!A.polygons[e]||null==A.lastSelectedLeafId||A.lastSelectedLeafId==e&&null==A.polygons[e]?b():(t&&(w(A.polygons[e].polygon),A.shouldBound&&A.selectedShape.getVisible()&&A.map.fitBounds(A.selectedShape.bounds),A.shouldBound=!0),A.lastSelectedLeafId=A.polygons[e].Id)}),A.myTreeView.attachEvent("onCheck",S)})}),A.toggleDrawMode=function(){var e,t;A.drawState!=m.INTERSECT&&(A.drawingManager.setDrawingMode("polygon"),b(),e=A.selectedColor,(t=A.drawingManager.get("polygonOptions")).fillColor=e,A.drawingManager.set("polygonOptions",t),A.drawState=m.DRAW)},A.cancelPolygon=function(){null!=A.drawingManager.getDrawingMode()&&(A.cancelDrawingShape=!0,A.drawingManager.setDrawingMode(null)),A.drawState==m.EDIT&&A.selectedShape&&(A.selectedShape.setMap(null),s(function(){A.currentEditPolygon&&T(A.currentEditPolygon),A.polygonName="",A.polygonTerritory="null"},0)),A.drawState=m.NONE,A.selectedIntersectingPolygons={}},A.editPolygon=function(){A.drawState==m.SELECTED&&A.selectedShape.getVisible()&&(A.currentEditPolygon=A.polygons[A.selectedShape.id],A.drawState=m.EDIT,A.selectedShape.setEditable(!0),A.selectedShape.setDraggable(!0))},A.savePolygon=function(){var n,i,e,t,s,r;A.selectedShape&&(n=[],A.selectedShape.getPath().forEach(function(e,t){n.push({lat:e.lat(),lng:e.lng()})}),i=A.selectedShape.id||null,e="null"!=A.polygonTerritory?A.polygonTerritory:null,A.polygonName?(o.callRemoteAction(RemoteActions.savePolygon,(t=n,s=A.selectedShapeColor,'<?xml version="1.0" encoding="UTF-8"?> \n                            <kml xmlns="http://www.opengis.net/kml/2.2">\n                                <Style id="'+(r=A.polygonName).replace(" ","")+'Style"> \n                                    <LineStyle> \n                                        <width>1</width> \n                                    </LineStyle> \n                                    <PolyStyle> \n                                        <color>'+function(e,t){return t+e.substring(5,7)+e.substring(3,5)+e.substring(1,3)}(s,80)+"</color> \n                                    </PolyStyle> \n                                </Style> \n                                <Placemark> \n                                    <name>"+r.replace(" ","")+"</name> \n                                    <styleUrl>#"+r.replace(" ","")+"Style</styleUrl> \n                                    <Polygon> \n                                        <outerBoundaryIs> \n                                            <LinearRing>\n                                                <coordinates>"+function(e){for(var t="",n=0;n<e.length;n++)t+=e[n].lng+","+e[n].lat+",0\n";return t+=e[0].lng+","+e[0].lat+",0"}(t)+"</coordinates> \n                                            </LinearRing> \n                                        </outerBoundaryIs> \n                                    </Polygon> \n                                </Placemark> \n                            </kml>"),A.polygonName,A.selectedShapeColor,e,i).then(function(e){A.selectedShape.setMap(null),T(e);var t=e,n=i;n&&A.myTreeView.deleteItem(n),n=t[fieldNames.Polygon.Service_Territory__c]||"NoTerritoryPolygon",A.myTreeView.addItem(t.Id,t.Name,n),A.myTreeView.checkItem(t.Id),A.myTreeView.setItemIcons(t.Id,{file:"fa-square"}),A.myTreeView.setIconColor(t.Id,t[fieldNames.Polygon.Color__c]),A.selectedShape=A.polygons[e.Id].polygon}),A.drawState=m.NONE):alert(customLabels.Polygon_name_field_is_empty))},A.deletePolygon=function(){var t;A.selectedShape?confirm(customLabels.This_will_delete_the_selected_polygon.replaceAll(A.selectedShape.name))&&(t=A.selectedShape.id||null,o.callRemoteAction(RemoteActions.deletePolygon,t).then(function(e){A.selectedShape.setMap(null),A.myTreeView.deleteItem(t),b()}),A.drawState=m.NONE):A.drawState=m.NONE};var L={},M=[],x=void 0;function O(e,t){t=t||{},this.setMap(e),this.mapDiv=e.getDiv(),this.menuItems=t.menuItems||{},this.isVisible=!1}function P(e){x.hide(),w(this.clickedPolygon_=this);e=x.getProjection().fromLatLngToDivPixel(e.latLng);x.show(e),A.map.setOptions({draggableCursor:"pointer"})}function E(e){for(var t=[],n=0;n<A.filteredServices.servicesArray.length;n++){var i,s=A.filteredServices.servicesArray[n];null!=s.latitude&&null!=s.longitude&&(i=new google.maps.LatLng(s.latitude,s.longitude),google.maps.geometry.poly.containsLocation(i,e)&&t.push(s.id))}return t}(O.prototype=new google.maps.OverlayView).onAdd=function(){$("<div id='cMenu' class='context-menu-polygon'></div>").appendTo($("#map"));for(var e=$("#cMenu").get(0),t=0;t<this.menuItems.length;t++){var n=this.menuItems[t];$('<div id="'+n.id+'" class="truncate context-menu-polygon-item" title="'+n.name+'">'+n.label+"</div>").appendTo(e)}this.div_=e;this.getPanes().overlayMouseTarget.appendChild(this.div_);for(var r=this,t=0;t<this.menuItems.length;t++){n=this.menuItems[t];google.maps.event.addDomListener($("#"+n.id).get(0),"click",$.proxy(function(){r.clickedItem=this.id,google.maps.event.trigger(r,"click")},n))}google.maps.event.addListener(r,"click",function(){var e=r.clickedItem;switch(e){case"menu-edit-polygon":A.mapOptionsToggle=!0,$(".polygonsTab").click(),A.editPolygon();break;case"menu-intersect-polygon":A.mapOptionsToggle=!0,$(".polygonsTab").click(),A.currentIntersectingId=angular.copy(A.selectedShape.id),A.drawState=m.INTERSECT,A.$apply();break;case"menu-delete-polygon":A.deletePolygon();break;case"menu-schedule-polygon":l.schedule(E(A.selectedShape)),A.$apply();break;case"menu-unschedule-polygon":a.unscheduleServices(E(A.selectedShape));break;case"menu-dispatch-polygon":a.changeStatus(E(A.selectedShape),p.DISPATCHED).then(function(e){a.drawServicesAndAbsences(e.services)}).catch(function(e){C.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)});break;case"menu-joepardy-polygon":a.setInJeopardy(E(A.selectedShape));break;default:if(0===e.indexOf("custom_")){var t=parseInt(e.split("_")[1]),n=E(A.selectedShape),i=C.getCustomActions("map")[t];if(i.visualforce){var t=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),s=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===n.length?h.open(i.name,i.visualforce+"?id="+n[0]+"&start="+t+"&end="+s):h.open(i.name,i.visualforce+"?services="+n.join(",")+"&start="+t+"&end="+s);break}o.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,E(A.selectedShape),scheduler._min_date,scheduler._max_date).then(function(e){e&&C.addNotification(i.name,e,null,null)}).catch(function(e){return C.addNotification(i.name,e.message,null,null)});break}}event.stopPropagation(),x.hide()})},O.prototype.draw=function(){},O.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},O.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},O.prototype.show=function(e){var t;this.div_&&((t=this.div_).style.left=e.x+5+"px",t.style.top=e.y+10+"px",this.div_.style.visibility="visible")},A.hasCustomPermission("Polygons_create_update")&&M.push({id:"menu-intersect-polygon",className:"context_menu_item",eventName:"intersect",label:C.getSVGIconHTML(lsdIcons.cut)+customLabels.Cut_Intersections,name:customLabels.Cut_Intersections}),A.hasCustomPermission("Bulk_Schedule")&&M.push({id:"menu-schedule-polygon",className:"context_menu_item",eventName:"schedule",label:C.getSVGIconHTML(lsdIcons.calendar)+customLabels.Schedule,name:customLabels.Schedule}),A.hasCustomPermission("Bulk_Unschedule")&&M.push({id:"menu-unschedule-polygon",className:"context_menu_item",eventName:"unschedule",label:C.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,name:customLabels.Unschedule}),A.hasCustomPermission("Bulk_Dispatch")&&M.push({id:"menu-dispatch-polygon",className:"context_menu_item",eventName:"dispatch",label:C.getSVGIconHTML(lsdIcons.dispatch)+customLabels.Dispatch,name:customLabels.Dispatch}),M.push({id:"menu-joepardy-polygon",className:"context_menu_item",eventName:"joepardy",label:C.getSVGIconHTML(lsdIcons.jeopardy)+customLabels.In_Jeopardy,name:customLabels.In_Jeopardy}),A.hasCustomPermission("Polygons_create_update")&&M.push({id:"menu-delete-polygon",className:"context_menu_item",eventName:"delete",label:C.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete_polygon,name:customLabels.Delete_polygon}),L.menuItems=M,C.customActionsPromise.then(function(){C.getCustomActions("map").forEach(function(e,t){M.push({id:"custom_"+t,className:"context_menu_item",eventName:"custom_"+t,label:e.icon?C.getSVGIconHTML(e.icon)+e.name:e.name,name:e.name})})}),A.getIntersectionsForPolygons=function(){if(!A.isEmpty(A.selectedIntersectingPolygons))try{var e,t=new jsts.io.WKTReader,n=t.read(A.selectedShape.ToWKT());for(e in A.selectedIntersectingPolygons)var i=t.read(A.polygons[e].polygon.ToWKT()),n=n.difference(i);for(var s=(new jsts.io.WKTWriter).write(n),r=s.slice(9,s.length-2).split(","),o=[],a=0;a<r.length;a++){var l=r[a].split(" ");o.push(new google.maps.LatLng({lat:parseFloat(l[1]),lng:parseFloat(l[0])}))}A.selectedShape.setPath(o),A.savePolygon(),A.selectedIntersectingPolygons={}}catch(e){alert("Problem finding intersections in given polygons."),console.error(e)}}}]),angular.module("serviceExpert").controller("ctrlRightSide",["$q","$scope","$rootScope","$filter","$sce","sfdcService","MapService","utils","servicesService","kpiCalculationsService","StateService","DeltaService","TimePhasedDataService","StreamingAPIService","RegisterService","OptimizationRequestsService","LeftSideLocationFilteringService","FieldSetFieldsService",function(e,n,t,i,s,r,o,a,l,c,d,u,p,m,h,g,v,f){var S={opacity:1,left:null,top:null,height:400,width:600};n.isMapEnabled=d.isMapEnabled(),n.startLoadMap=!0,n.servicesObjects=l.servicesObjects,n.servicesScheduledToCapacity={},n.notifications=a.butlerNotifications,n.unreadNotifications=0,n.showServiceList=a.showServiceList,n.workingState="gantt",n.openConsoleTab=a.openConsoleTab,n.openSObjectLink=a.openSObjectLink,n.activeRequests=r.activeRequests,n.activeRuleCheckRequests=r.activeRuleCheckRequests,n.kpi=c.kpis,n.marginLeftForBox=0,n.mapAvailable=mapMode,n.optimizationRequests=g.optimizationRequests,n.floatingMapOn=!1,n.optRequestPercentage=0,n.OptimizationRequestsProgressStatus=g.OptimizationRequestsProgressStatus,n.generateRequestResultText=g.generateRequestResultText,n.canAbortOR=g.canAbortOR,n.abortOptRequest=g.abortOptRequest,n.isUseEdge=a.isUseEdge,n.isNoTerritoryLoadded=v.isNoTerritoryLoadded,n.reachedMaxRows=p.reachedMaxRows,n.maxResourceRowsOnGantt=window.__gantt.maxResourceRowsOnGantt,n.$watch("workingState",function(e){"gantt"===e&&setTimeout(function(){scheduler._is_initialized()&&updateViewDebounced()},0)}),f.fieldsSetFields().then(function(e){n.serviceFields=e.MapInfo}),n.getServiceInfoRowClass=a.getServiceInfoRowClass,n.openLink=a.openLink,n.order=function(e,t){n.orderByField=e,n.reverse=t},n.$on("changeWorkingState",function(e,t){"gantt"===(n.workingState=t)?setTimeout(function(){updateViewDebounced()},100):$(".dhtmlXTooltip").remove()}),n.showNotifications=function(){n.unreadNotifications=0,a.butlerNotifications().forEach(function(e){return e.unread=!1})},n.calcUnreadNotifications=function(){return n.unreadNotifications=0,a.butlerNotifications().forEach(function(e){e.unread&&n.unreadNotifications++}),n.unreadNotifications},n.numOfNotifications=function(){var t=0;return a.butlerNotifications().forEach(function(e){e.show&&t++}),t},n.formatTravel=function(e){var t=Math.floor(e/60/60),e=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+e+customLabels.kpi_m},n.toggleServiceList=function(){n.showServiceList.show=!0,setTimeout(function(){updateViewDebounced(),t.$broadcast("resizeMap",{})},830)},n.isEmpty=function(e){return Object.keys(e).length},n.getRequestCss=function(e){switch(e){case"Hold":case"Post Processing":case"In Progress":return"smart_in_progress";case"Completed":return"smart_completed";case"Completed First Optimization Day":return"smart_completed_first_day";case"Failed":return"smart_failed";case"Open":return"smart_open";case"Queued":return"smart_queued";case"Aborting":return"smart_in_progress";case"Aborted":return"smart_failed"}},n.moveLocalDtToUserTimezoneDt=function(e){e=new Date(e);return a.convertDateBetweenTimeZones(e,"GMT",userTimeZone)},n.getNumOfRunningRequests=function(){return g.getNumOfActiveOptimizationRequests()},n.openSomethingBox=function(e,t){n.marginLeftForBox="smart"===t?e.target.offsetLeft-227:e.target.offsetLeft-200},n.shouldShowLongTermError=function(){return"LongView"===scheduler._mode&&"gantt"===n.workingState&&(window.__gantt.reachedMaxNumberOfServicesInLongView||window.__gantt.reachedMaxNumberOfAbsencesInLongView)},window.__gantt.shouldShowLongTermError=n.shouldShowLongTermError,n.showFloatingMap=function(e){e.stopPropagation(),n.floatingMapOn=!0;e=$("#MapContainer");e.css("opacity",S.opacity),e.css("height",S.height+"px"),e.css("width",S.width+"px"),S.left&&(e.css("left",S.left+"px"),e.css("top",S.top+"px"),e.css("bottom","auto"))},n.changeWorkingState=function(e){e!==n.workingState&&(n.workingState=e,n.floatingMapOn=!1,"map"===e?$("#MapContainer").removeAttr("style").resizable("disable"):$("#MapContainer").removeAttr("style").resizable("enable"))},n.closeFloatingMap=function(){n.floatingMapOn=!1,$("#MapContainer").removeAttr("style").resizable("disable")},setTimeout(function(){$("#MapContainer").draggable({handle:"#FloatingMapControls",containment:"document",start:function(){},stop:function(e,t){S.left=t.position.left,S.top=t.position.top}}).resizable({maxHeight:window.innerHeight-75,maxWidth:window.innerWidth-75,minHeight:300,minWidth:450,handles:"all",containment:"document",distance:10,start:function(){},stop:function(e,t){S.width=t.size.width,S.height=t.size.height,S.left=t.position.left,S.top=t.position.top}}),$("#FloatingMapOpacity").slider({range:"min",min:40,max:100,value:100,slide:function(e,t){$("#MapContainer").css("opacity",t.value/100),S.opacity=t.value/100}})},2e3)}]),angular.module("serviceExpert").controller("serviceListCtrl",["$scope","$compile","$rootScope","$filter","utils","$timeout","$sce","servicesService","sfdcService","ResourcesAndTerritoriesService","GetSlotsService","userSettingsManager","StateService","TimePhasedDataService","LoadServiceListService","FieldSetFieldsService","ServiceAppointmentLightboxService","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","RegisterService","GanttFilterService","GeneralLightbox","LeftSideLocationFilteringService","$q","BundleService","BundleActions","listQuickActionsService",function(r,N,s,i,o,d,G,a,l,c,t,u,p,e,m,B,H,n,h,g,v,f,S,y,b,U,w,T,V){r.bundleService=w,r.bundlerActions=T,r.isRtlDir=p.isRtlDirection(),r.tooltipDirection=r.isRtlDir?"left-bottom":"right";var L=!0;function A(e){delete r.filtersMap[e];for(var t=-1,n=0;n<r.filterOptions.length;n++)if(r.filterOptions[n].Id===e){t=n;break}-1!==t&&r.filterOptions.splice(t,1),r.filter.selectedFilter="All",u.GetUserSettingsProperty("Selected_List_View__c")!==r.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",r.filter.selectedFilter)}angular.element(document).ready(function(){var l=!1,c=r.isRtlDir;function e(){var e,t,n=u.GetUserSettingsProperty("Left_Panel_Width_Percentage__c"),i=400,s=$("#contentWrapper"),r=u.GetUserSettingsProperty("Services_List_Height_Percentage__c"),o=250,a=$("#SmartPanelContainer");0===s.length&&(s=$(window)),0===a.length&&(a=$(window)),0!=!s.width()||l||(l=!0,n=(i=(i=null!=n&&0<n&&n<100?s.width()*n*.01:i)<400?400:i)+3,c?(e=document.getElementById("LeftSideContainer"),t=document.getElementById("RightSideContainer"),e.before(t),$("#LeftSideContainer").width("calc(100% - "+n+"px)"),Split(["#RightSideContainer","#LeftSideContainer"],{sizes:[i+"px"],minSize:[700,400],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$(c?"#RightSideContainer":"#LeftSideContainer").width()/s.width();u.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e*=100)}})):($("#RightSideContainer").width("calc(100% - "+n+"px)"),Split(["#LeftSideContainer","#RightSideContainer"],{sizes:[i+"px"],minSize:[400,700],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$(c?"#RightSideContainer":"#LeftSideContainer").width()/s.width();u.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e*=100)}}))),d(function(){var e,t;100!==a.height()&&(e=(o=250<(o=null!=r&&0<r&&r<100?a.height()*r*.01:o)?250:o)+5,$("#ServiceListBottomContainer").height("calc(100% - "+e+"px"),e=a.height()-250,(t=a.find(".gutter-vertical")).length&&t.remove(),Split(["#ServiceListTopContainer","#ServiceListBottomContainer"],{direction:"vertical",sizes:[o+"px"],minSize:[5,e],snapOffset:10,gutterSize:5,onDragEnd:function(){var e=$("#ServiceListTopContainer").height()/a.height();u.SetUserSettingsProperty("Services_List_Height_Percentage__c",e*=100)}}))},0)}e(),$(window).bind("resize",e)}),"territories"===u.GetUserSettingsProperty("DefaultLeftPanel__c")&&u.GetUserSettingsProperty("locations").length&&b.open(),useNewFilters&&S.filtersPromise.then(function(e){var i=[];r.filterOptions.forEach(function(e){var t,n={};for(t in e)n[t]=e[t];n.Name=e.name,n.old=!0,n.Id=e.value,i.push(n)}),r.filterOptions=[].concat(i,_toConsumableArray(e)),r.filtersMap={},r.filterOptions.forEach(function(e){return r.filtersMap[e.Id]=e})}).finally(function(){r.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0}),S.setFilterMap(r.filtersMap)}),window.__closeFilterLightbox=function(t){o.safeApply(r,function(){var e=y.closeLightboxFromOutside();e&&e(),t&&S.getFilterFromSalesforce(t).then(function(e){if(r.filtersMap[e.Id]){for(var t=0;t<r.filterOptions.length;t++)if(r.filterOptions[t].Id===e.Id){r.filterOptions[t]=e;break}}else r.filterOptions.push(e),r.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0});r.filtersMap[e.Id]=e})})},r.openGanttFilterLightbox=function(e){var t=r.filtersMap[r.filter.selectedFilter];switch(e){case"new":y.open(customLabels.FilterEditor,filterEditorPage);break;case"edit":y.open(customLabels.FilterEditor,filterEditorPage+"?&id="+t.Id);break;case"delete":if(!confirm(customLabels.ConfirmFilterDelete))return;S.deleteFilter(t.Id).then(A);break;case"hide":if(!confirm(customLabels.ConfirmFilterHide))return;S.hideFilter(t.Id).then(A)}},r.showNewFilterButton=function(){return customPermissions.Create_custom_Gantt_filters},r.showEditFilterButton=function(){if(!r.filtersMap)return!1;var e=r.filtersMap[r.filter.selectedFilter];return!(!e||e.old)&&(!(!customPermissions.Create_custom_Gantt_filters||customPermissions.Publish_custom_Gantt_filters||e.CreatedById!==userId)||!!customPermissions.Publish_custom_Gantt_filters)},r.showDeleteFilterButton=function(){if(!r.filtersMap)return!1;var e=r.filtersMap[r.filter.selectedFilter];return!(!e||e.old)&&(customPermissions.Create_custom_Gantt_filters&&e.CreatedById===userId)},r.showHideFilterButton=function(){if(!r.filtersMap)return!1;var e=r.filtersMap[r.filter.selectedFilter];return!(!e||e.old)&&(customPermissions.Publish_custom_Gantt_filters&&customPermissions.Create_custom_Gantt_filters)},r.newFilterChanged=function(){if("SearchOnServer"!==r.filterOptions[r.filterOptions.length-1].Id)if("SearchOnServer"!==r.filter.selectedFilter.Id&&"SearchOnServer"===r.filterOptions[r.filterOptions.length-1].Id&&r.filterOptions.pop(),useNewFilters){if(!r.filtersMap)return!1;var e,t,n=r.filtersMap[r.filter.selectedFilter]||r.filtersMap.All;r.filtersMap[r.filter.selectedFilter]||(r.filter.selectedFilter="All",n.selectedFilter="All"),u.GetUserSettingsProperty("Selected_List_View__c")!==r.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",r.filter.selectedFilter),!n||n.old?r.loadServiceAppointmentsToList():r.filtersMap&&(n=r.filtersMap[r.filter.selectedFilter])&&!n.old&&(e=new Date(r.filter.endDate),t=new Date(r.filter.endDate),"Invalid Date"===r.filter.endDate.toString()&&(e=new Date(scheduler._max_date),t=new Date(scheduler._max_date)),n.List_only_appointments_on_the_gantt?(e=scheduler._min_date,t=scheduler._max_date):(e.setDate(e.getDate()-n.Days_before_horizon-1),t.setDate(t.getDate()+n.Days_after_horizon)),I(t,Math.ceil((t-e)/1e3/60/60/24),[]))}else r.loadServiceAppointmentsToList()},r.fieldsTypes=o.fieldsTypes,r.openConsoleTab=o.openConsoleTab,r.useNewFilters=window.useNewFilters,r.isMapEnabled=p.isMapEnabled(),r.contractorSupport=p.areContractorsSupported(),r.statuses=h,r.statusCategory=g,r.statusTranslations=o.statusTranslations,r.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,r.ganttSettings=o.ganttSettings,r.showServiceList=o.showServiceList,r.hasCustomPermission=o.hasCustomPermission,r.isLightning=o.isLightning,r.loadingServicesToList=0,r.isServicePreviewAvailable=!1,r.isOptimizationEnabled=isOptimizationEnabled,r.bulkActionsOrder=bulkActionsOrder,r.isInConsole=p.isInConsole,r.matchGantt=u.GetUserSettingsProperty("Match_Gantt_Dates__c"),r.fullScreen=!1,window.location.search.match(/[&?]fullScreen=(\d)/)&&(r.fullScreen="1"===window.location.search.match(/[&?]fullScreen=(\d)/)[1]?"0":"1"),r.servicesObjects=e.serviceAppointments,r.selectedServiceId=null,r.lastSelectedServiceId=null,r.servicesListVisitedDays={},r.servicesListInited=!1;var C={},D=[];function I(t,n,i){var e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;if(null===e&&(I.loadedSoFar=0),I.loadedSoFar>=maxNumberOfServicesToLoad)return o.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List),void(I.loadedSoFar=0);r.loadingServicesToList++,m.loadServicesInBulk(r.servicesObjects(),r.servicesListVisitedDays,t,n,e).then(function(e){e.totalFetched===numberOfServicesToLoadInEachBulk?(I.loadedSoFar+=e.totalFetched,i.push.apply(i,_toConsumableArray(e.needToCheckRules)),I(t,n,i,e.lastFetchedId)):e.scheduledServices&&(i.push.apply(i,_toConsumableArray(e.needToCheckRules)),0<i.length&&"Always"===window.__gantt.checkRulesMode&&a.checkRules(i).then(a.drawViolationsOnGantt)),window.splunkLoggingFinestFlagEnabled&&L&&(e=I.loadedSoFar+e.totalFetched,L=!1,l.callRemoteAction(RemoteActions.sendDataToSplunk,"serviceListCount",null,null,null,e,null))}).catch(function(e){console.warn("loadServiceAppointmentsToList failed "+e)}).finally(function(){return r.loadingServicesToList--})}function k(){var e=scheduler.getState().max_date;return 0===e.getHours()&&0===e.getMinutes()?e=new Date(e.getTime()-6e4):(e.setHours(23),e.setMinutes(59),e.setSeconds(0)),e}r.flagged=a.flagged,r.loadedTerritories=[],r.selectorService=n,r.servicesSelection=r.selectorService.SelectedServices,r.selectedPolicy=null,r.policyOptions=[],r.showGanttSettings=!1,r.ganttSettingDraft=null,r.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],r.reallyHideList=!1,r.showAdvancedFilter=!1,r.invokedAction={},r.invokedActionFor={},r.showCustomFilterDropdown=!1,r.storageFilters=null,r.prevEndDate=null,r.sortingColumn="start",r.sortingColumnName={start:customLabels.Start_time,finish:customLabels.Finish_time,accountName:customLabels.Account,serviceTypeName:customLabels.Service_type,priority:customLabels.Priority,resourceName:customLabels.Resource,earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,locationName:customLabels.Location},r.selectedDates={earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,appStart:customLabels.Appointment_start,appEnd:customLabels.Appointment_finish,start_date:customLabels.Start,end_date:customLabels.Finish},r.filter=a.filter,r.orderByField=a.filter.orderByField,r.reverse=a.filter.reverse,r.filteredServices=a.filteredServices,r.filterOptions=[],o.hasCustomPermission("Service_List_Todo")&&r.filterOptions.push({name:customLabels.Todo,value:"Todo"}),r.filterOptions.push({name:customLabels.AllServices,value:"All"}),r.filterOptions.push({name:customLabels.Recently_used,value:"Recent"}),o.hasCustomPermission("Service_List_Flagged")&&r.filterOptions.push({name:customLabels.Flagged,value:"Flagged"}),o.hasCustomPermission("Service_List_Selected")&&r.filterOptions.push({name:customLabels.Selected_Capital,value:"Selected"}),o.hasCustomPermission("Service_List_Unscheduled")&&r.filterOptions.push({name:customLabels.UnscheduledCapital,value:"Unscheduled"}),o.hasCustomPermission("Service_List_Scheuled")&&r.filterOptions.push({name:customLabels.Scheduled,value:"Scheduled"}),o.hasCustomPermission("Service_List_In_Jeopardy")&&r.filterOptions.push({name:customLabels.In_Jeopardy,value:"inJeopardy"}),o.hasCustomPermission("Service_List_Rule_Violating")&&r.filterOptions.push({name:customLabels.Rules_violating,value:"Violating"}),o.hasCustomPermission("Service_List_Gantt")&&r.filterOptions.push({name:customLabels.Gantt,value:"Gantt filter"}),o.hasCustomPermission("Service_List_Canceled")&&r.filterOptions.push({name:customLabels.Cancelled,value:"Cancelled filter"}),p.areContractorsSupported()&&o.hasCustomPermission("Service_List_Contractors")&&r.filterOptions.push({name:customLabels.Contractors,value:"Contractors filter"}),p.areCrewsSupported()&&o.hasCustomPermission("Service_List_Crews")&&r.filterOptions.push({name:customLabels.crews,value:"Crews filter"}),w.isActive()&&o.hasCustomPermission("Service_List_Exclude_Bundle_Members")&&r.filterOptions.push({name:customLabels.Exclude_Bundle_Members_Filter,value:"Exclude Bundle Members"}),B.fieldsSetFields().then(function(e){for(var t in C=e,Array.isArray(e.servicePreview)&&0<e.servicePreview.length&&(r.isServicePreviewAvailable=!0),e)e[t].forEach(function(e){D[e.FullAPIName]=e});r.clickedServiceFieldPairs=[];for(var n=0;n<e.ListExpanded.length;){for(var i=n+2,s=[];n<e.ListExpanded.length&&n<i;n++)s.push(e.ListExpanded[n]);r.clickedServiceFieldPairs.push(s)}}),r.getColumnsToDisplay=function(){var t,e=S.getFilterById(r.filter.selectedFilter);return e&&e.Displayed_Fields&&0<e.Displayed_Fields.length?(t=[],e.Displayed_Fields.forEach(function(e){D[e]&&t.push(D[e])}),t):C.ListColumns},r.getSingleTaskColumnClass=function(e){var t={SingleTaskColumn:!0,truncate:!0};return t["Field-"+e.Type]=!0,t},r.getHeaderTaskColumnClass=function(e){var t={SortingTasksListColumn:!0};return t["Field-"+e.Type]=!0,t},r.loadServiceAppointmentsToList=function(){I(r.endDate,o.ganttSettings.backHorizon,[])},r.formatServiceField=function(e,t){var n=e[t.APIName];switch(t.Type){case o.fieldsTypes.DateTime:n=i("amDateFormat")(n,"lll");break;case o.fieldsTypes.Date:n=i("amDateFormat")(n,"L")}return n},r.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},r.isFieldEmpty=function(e,t){return void 0===i("displayFieldSetField")(e,t)},r.openCalendarAdvanceFilterStart=function(){r.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(r.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){e>new Date(r.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):r.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},r.openCalendarAdvanceFilterFinish=function(){r.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMax",date:new Date(r.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){e<new Date(r.filter.advancedFilter.minDate)?alert(customLabels.startBeforeEnd):r.filter.advancedFilter.maxDate=e}),scheduler.destroyCalendar()}}))},r.openCalendarAdvanceFilterStart=function(){r.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(r.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){e>new Date(r.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):r.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},p.promises.policies().then(function(e){r.policyOptions=e;for(var t=!1,n=u.GetUserSettingsProperty("Gantt_Policy__c"),i=0;i<e.length;i++)if(n){if(e[i].Id===n){r.selectedPolicy=e[i],t=!0;break}}else if(e[i].Id===defaultPolicy){r.selectedPolicy=e[i],t=!0;break}t||(r.selectedPolicy=r.policyOptions[0]),p.selectedPolicyId=r.selectedPolicy.Id}).catch(function(e){console.warn(e),cantLoadGantt(customLabels.no_policy_found)}),r.showGlobalCheckRules=function(){return window.customPermissions.Enable_Check_Rules_For_All_Services},r.checkRulesForAllServices=function(){if("Always"!==window.__gantt.checkRulesMode){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&a.checkRules(t).then(a.drawViolationsOnGantt)}},r.changePolicy=function(){if(p.selectedPolicyId=r.selectedPolicy.Id,u.SetUserSettingsProperty("Gantt_Policy__c",r.selectedPolicy.Id),"Always"===window.__gantt.checkRulesMode){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&a.checkRules(t).then(a.drawViolationsOnGantt)}},r.policySelectorDisabled=function(){return!window.__gantt.ignoreReadonlyGantt226&&!window.customPermissions.Enable_Gantt_Policy_Picker||0===r.policyOptions.length},r.order=function(e,t){r.filter.orderByField=e,r.filter.reverse=t},r.selectService=function(e){e===r.selectedServiceId?(r.selectedServiceId=null,r.lastSelectedServiceId=e):(r.lastSelectedServiceId=r.selectedServiceId,r.selectedServiceId=e)},r.violationsTooltip=function(e){if(!e.violations&&!e.jeopardy){if(w.isBundleMember(e))return customLabels.BundleMemberToolTip;if(w.isBundle(e))return customLabels.BundleToolTip;if(e.isMDT)return customLabels.Multi_Day_Service}if(e.violations||e.jeopardy){if(e.jeopardy&&e.jeopardyReason)return e.jeopardyReason;if(e.violations){for(var t="",n=0;n<e.violations.length;n++)t+=e.violations[n].RuleName+"\n";return t=t&&t.substring(0,t.length-1)}}},r.getStatusClass=function(e){return o.getCSSClassForContext(e.statusCategory,g)},r.$on("initCompleted",function(e){r.initEndDate();var t=u.GetUserSettingsProperty("locations");r.territories=[];for(var n=0;n<t.length;n++)void 0!==c.territories()[t[n]]&&r.territories.push(c.territories()[t[n]]);if(!useNewFilters){r.storageFilters=F();for(var i=0;i<r.storageFilters.length;i++)r.filterOptions.push({name:r.storageFilters[i].name,value:r.storageFilters[i].name});0<r.storageFilters.length?x(r.storageFilters[0].name):x(null)}}),r.initEndDate=function(){r.endDate=k(),r.matchGantt||(r.endDate=o.addDaysToDate(r.endDate,1)),r.prevEndDate=r.endDate,r.filter.endDate=r.endDate,r.horizonDateChanged()},r.horizonDateChanged=function(){var e;moment(r.filter.endDate).isValid()&&(e=o.addDaysToDate(r.filter.endDate,-o.ganttSettings.backHorizon),p.setDeltaDates(e,r.filter.endDate))},r.$on("ganttFinishedLoadingServices",function(){!r.matchGantt&&!1!==r.servicesListInited||(r.servicesListInited||null!==r.endDate&&!isNaN(r.endDate.getTime())||r.initEndDate(),r.servicesListInited=!0,r.newFilterChanged())}),scheduler.attachEvent("onBeforeViewChange",function(e,t){return scheduler._old={mode:e,date:t},!0});var R=!0;function F(){return u.GetUserSettingsProperty("Filters__c")?JSON.parse(u.GetUserSettingsProperty("Filters__c")):[]}function M(){u.SetUserSettingsProperty("Filters__c",JSON.stringify(r.storageFilters))}function x(e){if(r.lastSelectedFilter=e){for(var t=0;t<r.storageFilters.length;t++)r.storageFilters[t].name===e&&(r.filter.advancedFilter=angular.copy(r.storageFilters[t].filter));r.customFilterName=e,r.DisplayComboBowArrow=!0,r.IsCustomFilterReadonly=!0,r.displayNew=!0,r.displayEdit=!0,r.displayDelete=!0}else r.filter.advancedFilter=O(),r.customFilterName="",r.DisplayComboBowArrow=!1,r.IsCustomFilterReadonly=!0,r.displayNew=!0,r.displayEdit=!1,r.displayDelete=!1}function O(){var t={statusCheckboxs:{},minDate:new Date,maxDate:new Date,servicePriority:10,unScheduled:!0,violations:!0,jeopardies:!0,noLocation:!0,locationsCheckboxs:{}};if(0<Object.keys(r.statusTranslations).length)for(var e in r.statusTranslations)t.statusCheckboxs[r.statusTranslations[e]]=!0;else s.$on("gotStatuses",function(){for(var e in r.statusTranslations)t.statusCheckboxs[r.statusTranslations[e]]=!0});for(var n=0;n<r.territories.length;n++){var i=r.territories[n];t.locationsCheckboxs[i.name]=!0}return t}scheduler.attachEvent("onViewChange",function(e,t){scheduler._old.mode===e&&t===scheduler._old.date&&"LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||p.isLoadingNewLocations||(p.setDeltaDates(scheduler.getState().min_date,k()),o.safeApply(r,function(){var e;r.matchGantt&&(e=k(),r.filter.endDate=e,r.endDate=e,r.matchGantt&&!R?r.newFilterChanged():R=!1)}))}),r.matchGanttClicked=function(){var e;r.matchGantt?("Invalid Date"===(e=r.prevEndDate).toString()&&(e=scheduler._min_date),r.filter.endDate=e,r.endDate=e,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!1)):(r.prevEndDate=r.endDate,r.filter.endDate=k(),r.endDate=r.filter.endDate,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!0)),r.newFilterChanged()},r.openLightBox=function(e){a.recentlyUsed[e]=!0,H.open(e)},r.flagging=function(e){if(!a.flagged[e])return a.flagged[e]=!0,void scheduler.updateEvent(e);a.flagged[e]&&(a.flagged[e]=!a.flagged[e],scheduler.updateEvent(e))},r.showOnGantt=function(e){var t=!(a.recentlyUsed[e.id]=!0);e&&((e=w.verifyShowSaOnGantt(e))?a.recentlyUsed[e.id]=!0:t=!0),t||!scheduler._events[e.id]?alert(customLabels.location_not_loaded):"none"===$("#GanttMapContainer").css("display")?(s.$broadcast("changeWorkingState","gantt"),d(function(){updateViewDebounced()},20),d(function(){o.showOnGantt(e.id)},120)):o.showOnGantt(e.id)},r.changeStatusToDispatch=function(t){r.invokedActionFor[t]||p.schedulingRunningFor[t]?alert(customLabels.another_operation_running):(a.recentlyUsed[t]=!0,r.invokedAction[t]="dispatch",r.invokedActionFor[t]=!0,a.changeStatus([t],h.DISPATCHED).then(function(e){a.drawServicesAndAbsences(e.services),r.invokedAction[t]=null,r.invokedActionFor[t]=!1}).catch(function(e){o.addNotification(customLabels.Service_Appointment_Update_ErrorMsgTitle,e.message)}).finally(function(){r.invokedAction[t]=null,r.invokedActionFor[t]=!1}))},r.showOnMap=function(e){s.$broadcast("showServiceOnMap",e)},r.shouldShowQuickActionBtn=function(e,t){return V.shouldShowQuickActionBtn(e,t)},r.bundleSA=function(e){T.Bundle.canInvoke([e])&&(r.invokedActionFor[e.id]?alert(customLabels.another_operation_running):(a.recentlyUsed[e.id]=!0,r.invokedAction[e.id]="bundle",r.invokedActionFor[e.id]=!0,T.Bundle.invoke([e]).then(function(){}).catch(function(e){}).finally(function(){r.invokedAction[e.id]=null,r.invokedActionFor[e.id]=!1})))},r.unbundleSA=function(e){T.Unbundle.canInvoke([e])&&(r.invokedActionFor[e.id]?alert(customLabels.another_operation_running):(a.recentlyUsed[e.id]=!0,r.invokedAction[e.id]="unbundle",r.invokedActionFor[e.id]=!0,T.Unbundle.invoke([e]).then(function(){}).catch(function(e){}).finally(function(){r.invokedAction[e.id]=null,r.invokedActionFor[e.id]=!1})))},r.openDateEndCalendar=function(){r.matchGantt||"Recent"==r.filter.selectedFilter||"Flagged"==r.filter.selectedFilter||"Selected"==r.filter.selectedFilter||"Gantt Filter"==r.filter.selectedFilter||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"DateStart",date:new Date(r.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){r.endDate=e,r.endDate.setHours(23),r.endDate.setMinutes(59),r.endDate.setSeconds(0),r.filter.endDate=r.endDate,r.horizonDateChanged(),r.newFilterChanged()}),scheduler.destroyCalendar()}}))},r.openFullScreen=function(){var e=window.location.search.match(/[&?]fullScreen=(\d)/);e?(e="1"===e[1]?"0":"1",window.location.search=window.location.search.replace(/[&?]fullScreen=\d/,"&fullScreen="+e)):window.location.search+="&fullScreen=1"},r.getSlots=function(e){a.recentlyUsed[e]=!0,"none"===$("#GanttMapContainer").css("display")&&(s.$broadcast("changeWorkingState","gantt"),setTimeout(function(){updateViewDebounced()},20)),r.invokedActionFor[e]||p.schedulingRunningFor[e]?alert(customLabels.another_operation_running):t.get(e)},r.scheduleAndReshuffle=function(i){r.invokedActionFor[i]?alert(customLabels.another_operation_running):(a.recentlyUsed[i]=!0,r.invokedAction[i]="reshuffle",r.invokedActionFor[i]=!0,l.callRemoteAction(RemoteActions.runReshuffle,i,p.selectedPolicyId).then(function(n){v.updateOptimizationRequest(n),f.register("optimizationRequests",function t(e){e.forEach(function(e){e=new OptimizationRequest(e);e.id!==n.Id||"Completed"!==e.status&&"Failed"!==e.status||(r.invokedAction[i]=null,r.invokedActionFor[i]=!1,f.unRegister("optimizationRequests",t))})})},function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message),r.invokedAction[i]=null,r.invokedActionFor[i]=!1}))},r.groupNearby=function(i){r.invokedActionFor[i]?alert(customLabels.another_operation_running):(a.recentlyUsed[i]=!0,r.invokedAction[i]="groupNearby",r.invokedActionFor[i]=!0,l.callRemoteAction(RemoteActions.runGroupNearby,i,p.selectedPolicyId).then(function(n){v.updateOptimizationRequest(n),f.register("optimizationRequests",function t(e){e.forEach(function(e){e=new OptimizationRequest(e);e.id!==n.Id||"Completed"!==e.status&&"Failed"!==e.status||(r.invokedAction[i]=null,r.invokedActionFor[i]=!1,f.unRegister("optimizationRequests",t))})})},function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message),r.invokedAction[i]=null,r.invokedActionFor[i]=!1}))},r.autoScheduleService=function(e){r.invokedActionFor[e]||p.schedulingRunningFor[e]?alert(customLabels.another_operation_running):(a.recentlyUsed[e]=!0,r.invokedAction[e]="schedule",r.invokedActionFor[e]=!0,a.autoScheduleService(e).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),e.mst||a.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){r.invokedAction[e]=null,r.invokedActionFor[e]=!1}))},r.$on("autoScheduleServiceFinished",function(e,t){r.invokedAction[t]=null,r.invokedActionFor[t]=!1}),r.openGanttSettings=function(){r.showGanttSettings=!0,o.ganttSettings?r.ganttSettings=o.ganttSettings:(r.ganttSettings.filterCandidates=!0,r.ganttSettings.servicesPerPage=200,r.ganttSettings.backHorizon=14,r.ganttSettings.capacityDuration="Day"),r.ganttSettingDraft=angular.copy(r.ganttSettings),setTimeout(function(){$("#ganttSettingsLightbox").draggable({containment:"document",handle:"#ganttSettingsLightboxHeader"}),$("#ganttSettingsLightbox").children().find("input[type=checkbox]").first().focus()},500)},r.closeSettingsLightbox=function(){r.showGanttSettings=!1,$("#ganttSettingsLightbox").attr("style",""),r.ganttSettingDraft=angular.copy(r.ganttSettings)},r.parseGanttSettingsToUserSetting=function(e){var t={};return t.Gantt_View_Start_Hour__c=e.startHour,t.Gantt_View_Finish_Hour__c=e.finishHour,t.Filter_Candidates__c=e.filterCandidates,t.Services_Per_Page__c=e.servicesPerPage,t.Resource_Row_Height__c=e.resourceRowHeight,t.Scheduling_horizon_limit__c=e.backHorizon,t.View_Capacity_Type__c=e.capacityDuration,t.Load_On_Today__c=e.loadOnToday,t.DefaultLeftPanel__c=e.leftPanel,t.ServiceListColoring__c=e.serviceColoring,t},r.saveGanttSettings=function(){void 0===r.ganttSettingDraft.backHorizon?alert(customLabels.backHorizonInvalid):(schedulerConfig.setRowHeights(r.ganttSettingDraft.resourceRowHeight,!0),setCapacityFilter(r.ganttSettingDraft.capacityDuration,!0),r.ganttSettings=angular.copy(r.ganttSettingDraft),o.ganttSettings=angular.copy(r.ganttSettingDraft),r.filter.servicesPerPage=parseInt(r.ganttSettings.servicesPerPage),u.SetUserSettingProperties(r.parseGanttSettingsToUserSetting(r.ganttSettings)).then(function(){r.loadServiceAppointmentsToList()}),r.showGanttSettings=!1)},r.$on("keypress",function(e,t){27===t.which&&r.closeSettingsLightbox()}),r.createArray=function(e,t){if("number"!=typeof e||isNaN(e))return[];if("number"!=typeof t||isNaN(t))return[];var n=Math.floor(e/t);return 0<e%t&&n++,new Array(n)},r.changePage=function(e){switch(e){case"right":r.filter.totalPages!=r.filter.currentPage&&(r.filter.currentPage=parseInt(r.filter.currentPage)+1,r.filter.currentPage=r.filter.currentPage.toString());break;case"left":1<r.filter.currentPage&&(r.filter.currentPage=parseInt(r.filter.currentPage)-1,r.filter.currentPage=r.filter.currentPage.toString());break;case"first":1<r.filter.currentPage&&(r.filter.currentPage="1");break;case"last":r.filter.totalPages!=r.filter.currentPage&&(r.filter.currentPage=r.filter.totalPages.toString())}},r.hideServiceList=function(){r.showServiceList.show=!1,r.reallyHideList=!0,d(function(){updateViewDebounced(),s.$broadcast("resizeMap",{})},0)},r.$watch("showServiceList.show",function(e,t){e&&(r.reallyHideList=!1)}),r.isDraggable=function(e){if(!window.__gantt.ignoreReadonlyGantt226&&!window.customPermissions.Enable_Drag_And_Drop)return!1;e=r.servicesObjects()[e];return!!e&&(!scheduler._events[e.id+"_dummy"]&&(!e.resourceId&&e.statusCategory===g.NONE&&(!e.pinned||e.pinned&&!preventUpdateOfPinned)&&(!w.isActive()||!w.isBundleMember(e))))},r.isBeingSavedNow=function(e){return!!scheduler._events[e+"_dummy"]},r.showAdvancedFilterFunc=function(){$("#AdvancedFilteringOptions").css("display","block"),d(function(){$("#SmartPanelContainer").find(".gutter-vertical").hide(),r.showAdvancedFilter=!0},100)},r.hideAdvancedFilterFunc=function(){r.showAdvancedFilter=!1,setTimeout(function(){$("#SmartPanelContainer").find(".gutter-vertical").show(),$("#AdvancedFilteringOptions").css("display","none")},700)},r.removeSpaces=function(e){return e?e.split(" ").join("+"):""},r.filterChanged=function(){var e=F(),e=function(e,t){for(var n=0;n<t.length;n++)if(t[n].name==e)return t[n].filter;return!1}(r.filter.selectedFilter,e);e?(r.filter.advancedFilter=e,r.customFilterSelected=!0,r.customFilterName=r.filter.selectedFilter):r.customFilterSelected=!1,u.GetUserSettingsProperty("Selected_List_View__c")!==r.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",r.filter.selectedFilter)},r.$on("gotNewResources",function(e,t){r.territories=[];for(var n=t.show,i=0;i<n.length;i++)void 0!==c.territories()[n[i]]&&r.territories.push(c.territories()[n[i]]);r.servicesListVisitedDays={},r.newFilterChanged()}),r.createCustomFilter=function(){r.isEditMode=!1,r.customFilterName="",r.displayCancel=!0,r.IsCustomFilterReadonly=!1,r.DisplayComboBowArrow=!1,r.displayNew=!1,r.displayEdit=!1,r.displaySave=!0,r.displayDelete=!1,r.filter.advancedFilter=O()},r.CancelSaveOrEditCustomFilter=function(){r.displayNew=!0,r.displayEdit=!0,r.DisplayComboBowArrow=!0,r.displaySave=!1,r.displayDelete=!0,r.displayCancel=!1,r.IsCustomFilterReadonly=!0,x(r.lastSelectedFilter)},r.saveCustomFilter=function(){if(0===r.customFilterName.length)alert(customLabels.Please_give_a_name_to_the_custom_filter);else{for(var e=0;e<r.filterOptions.length;e++)if(!r.isEditMode&&r.filterOptions[e].name===r.customFilterName||r.isEditMode&&r.filterOptions[e].name===r.customFilterName&&r.filterOptions[e].name!==r.lastSelectedFilter)return void alert("Please select another name");if(r.displayNew=!0,r.displayEdit=!0,r.DisplayComboBowArrow=!0,r.displaySave=!1,r.displayDelete=!0,r.displayCancel=!1,r.IsCustomFilterReadonly=!0,r.isEditMode){for(var t=0;t<r.storageFilters.length;t++)if(r.storageFilters[t].name===r.lastSelectedFilter){r.storageFilters[t].filter=r.filter.advancedFilter,r.storageFilters[t].name=r.customFilterName,M();for(var n=0;n<r.filterOptions.length;n++)if(r.filterOptions[n].name===r.lastSelectedFilter){r.filterOptions[n].name=r.customFilterName,r.filterOptions[n].value=r.customFilterName;break}r.filter.selectedFilter===r.lastSelectedFilter&&(r.filter.selectedFilter=r.customFilterName);break}}else r.storageFilters.push({name:angular.copy(r.customFilterName),filter:angular.copy(r.filter.advancedFilter)}),r.filterOptions.push({name:angular.copy(r.customFilterName),value:angular.copy(r.customFilterName)}),M(),r.customFilterSelected=!0,r.filter.selectedFilter=r.customFilterName;r.lastSelectedFilter=r.customFilterName}},r.EditCustomFilter=function(){r.isEditMode=!0,r.displayCancel=!0,r.DisplayComboBowArrow=!1,r.displayNew=!1,r.displayEdit=!1,r.displaySave=!0,r.displayDelete=!1,r.IsCustomFilterReadonly=!1,r.DisplayComboBowArrow=!1,r.filter.advancedFilter=angular.copy(r.filter.advancedFilter)},r.deleteCustomFilter=function(){r.IsCustomFilterReadonly=!0,r.DisplayComboBowArrow=!0,r.displayNew=!0,r.displayEdit=!0,r.displaySave=!1,r.displayDelete=!0;for(var e=0;e<r.storageFilters.length;e++)if(r.storageFilters[e].name===r.customFilterName){r.storageFilters.splice(e,1);break}for(var t=r.customFilterName,n=0;n<r.filterOptions.length;n++)r.filterOptions[n].name===t&&r.filterOptions.splice(n,1);M(),r.filter.selectedFilter===r.customFilterName&&(r.filter.selectedFilter=customPermissions.Service_List_Todo?"Todo":"All"),0<r.storageFilters.length?x(r.storageFilters[0].name):x(null)},r.customFilterChanged=function(e){r.customFilterName=e,x(e)},r.showDropdownCustomFilters=function(e){e.stopPropagation(),0<r.storageFilters.length&&(r.showCustomFilterDropdown=!r.showCustomFilterDropdown)},r.toggleStatus=function(e,t){r.IsCustomFilterReadonly||(r.filter.advancedFilter.statusCheckboxs[t]=!r.filter.advancedFilter.statusCheckboxs[t])},r.toggleLocation=function(e){r.IsCustomFilterReadonly||(e?r.filter.advancedFilter.locationsCheckboxs[e]=!r.filter.advancedFilter.locationsCheckboxs[e]:r.filter.advancedFilter.noLocation=!r.filter.advancedFilter.noLocation)},r.clearRecentlyViewed=function(){for(var e in a.recentlyUsed)delete a.recentlyUsed[e]},r.openLocationFiltering=function(){LeftLocationFilteringService.open()},r.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}};var P=null,z=_.debounce(function(){var e=i("servicesListFilter"),t=i("pagination"),n=e(r.servicesObjects(),r.filter,r.getColumnsToDisplay(),r.filtersMap);P===n.checksum&&!__gantt.inday.isInDayRunning||(P=n.checksum,o.safeApply(r,function(){r.filteredServices.servicesArray=t(n,r.filter.currentPage,r.filter.servicesPerPage)}))},400,{maxWait:2e3}),j=(r.getServiceListFilter=function(){return z(),r.filteredServices.servicesArray},r.searchServiceByIdOrName=function(e){r.notFoundOnServer=!1,a.searchServiceByIdOrName(e).then(function(e){e?("Always"===window.__gantt.checkRulesMode&&a.checkRules([e]).then(a.drawViolationsOnGantt),r.filter.searchOnServer=e,r.filterOptions.find(function(e){return"SearchOnServer"===e.Id})||r.filterOptions.push({Name:customLabels.searchOnServer,name:customLabels.searchOnServer,old:!0,Id:"SearchOnServer",value:"SearchOnServer"}),r.filter.lastSelectedFilter=r.filter.selectedFilter,r.filter.selectedFilter="SearchOnServer"):r.notFoundOnServer=!0}).catch(function(e){console.warn(e)})},r.resetSearchText=function(){r.notFoundOnServer=null,r.filter.SearchText="","SearchOnServer"===r.filter.selectedFilter&&(r.filter.selectedFilter=r.filter.lastSelectedFilter,"SearchOnServer"===r.filterOptions[r.filterOptions.length-1].Id&&r.filterOptions.pop())},r.saveSettingsOfHorizonDates=function(){j()},_.debounce(function(){u.SetUserSettingsProperty("Date_Horizon_Properties__c",JSON.stringify(r.filter.selectedFiled))},800));function E(e){switch(e){case g.NONE:return"#a5e2d6";case g.SCHEDULED:return"#F9D058";case g.DISPATCHED:return"#8DD8FA";case g.IN_PROGRESS:return"#D68EF9";case g.COMPLETED:return"#95d155";case g.COULD_NOT_COMPLETE:return"#f58556";case g.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}r.customActions=[],o.customActionsPromise.then(function(){var e,t=o.getCustomActions("list");(e=r.customActions).push.apply(e,_toConsumableArray(t))}),r.runCustomServiceAction=function(e,t){var n,e=parseInt($(e.currentTarget).attr("actionId")),t=[t],i=o.getCustomActions("list")[e];i.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===t.length?y.open(i.name,i.visualforce+"?id="+t[0]+"&start="+e+"&end="+n):y.open(i.name,i.visualforce+"?services="+t.join(",")+"&start="+e+"&end="+n)):l.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,t,scheduler._min_date,scheduler._max_date).then(function(e){e&&o.addNotification(i.name,e,null,null)}).catch(function(e){return o.addNotification(i.name,e.message,null,null)})},r.showTerritoriesFiltering=function(){b.open()},r.getStyleForServiceItem=function(e){var t,n={};return e.violations||e.jeopardy||("gradient"===r.ganttSettings.serviceColoring&&(window.paletteViewActive&&e.ganttPaletteColor?n.background="linear-gradient(to right, "+e.ganttPaletteColor.color+" -85%,#ffffff 65%)":e.ganttColor?n.background="linear-gradient(to right, "+e.ganttColor+" -85%,#ffffff 65%)":(t=E(e.statusCategory),n.background="linear-gradient(to right, "+t+" -85%,#ffffff 65%)")),"full"===r.ganttSettings.serviceColoring&&"full"===r.ganttSettings.serviceColoring&&(window.paletteViewActive&&e.ganttPaletteColor?n.background=e.ganttPaletteColor.color+"70":e.ganttColor?n.background=e.ganttColor+"70":(t=E(e.statusCategory),n.background=t+"70"))),n},r.highlightOnGantt=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];window.__servicesInFilter={applied:e},e&&i("servicesListFilter")(r.servicesObjects(),r.filter,r.getColumnsToDisplay(),r.filtersMap).forEach(function(e){return window.__servicesInFilter[e.id]=!0}),updateViewDebounced()},r.shouldShowClearHighlight=function(){return!!window.__servicesInFilter&&window.__servicesInFilter.applied},r.changeToSelectedServiceList=function(){r.selectorService.countSelectedServices()&&o.hasCustomPermission("Service_List_Selected")&&(r.filter.selectedFilter="Selected")},r.getSelectedClickableClass=function(){return r.selectorService.countSelectedServices()&&o.hasCustomPermission("Service_List_Selected")?"list-selected-blue":""},r.clearSelectedServices=function(){n.unselectAll()},r.openLightboxLabel=function(){return window.__gantt.editOnServiceAppointment?customLabels.Edit:customLabels.Details},r.openLightboxIcon=function(){return window.__gantt.editOnServiceAppointment?lsdIcons.edit:lsdIcons.info},r.searchTermChanges=function(){r.notFoundOnServer=null,"SearchOnServer"===r.filter.selectedFilter&&""===r.filter.SearchText&&r.resetSearchText()}}]),angular.module("serviceExpert").controller("serviceExpertToastCtrl",["$scope","$timeout",function(n,e){n.modes=["SUCCESS","ERROR","INFO"];n.showTast=!1,n.message,n.mode="SUCCESS",n.data={},n.data.renderToast=!1,n.getStatusCssClass=function(){switch(n.mode){case"SUCCESS":return"slds-theme_success";case"ERROR":return"slds-theme_error";case"INFO":return"slds-theme_info"}return"slds-theme_info"},n.startAnimation=function(){e(function(){n.showTast=!0},10)},n.stopAnimation=function(){e(function(){n.showTast=!1},3e3)},n.removeToast=function(){e(function(){n.data.renderToast=!1},4e3)},n.render=function(){n.data.renderToast=!0,n.startAnimation(),n.stopAnimation(),n.removeToast()},n.calFunc=function(){e(function(){n.f&&n.p&&(n.f(n.p),n.f=null)},1500)},n.$on("showServiceExpertToast",function(e,t){n.message=t&&t.message?t.message:"",n.mode=t.status&&-1!=n.modes.indexOf(t.status)?t.status:"INFO",n.f=t.f||!1,n.p=t.p||!1,n.render()})}]),angular.module("serviceExpert").filter("ampmOr24",function(){return function(e,t,n){var i=parseInt(e),n=n?":00":"";return"ampm"==t?12===e?"12PM":0===e||24===e?"12AM":12<i?i-12+"PM":i+"AM":"24"==t?i<10?"0"+i+n:i+n:e}}),angular.module("serviceExpert").filter("displayFieldSetField",["utils","$filter",function(i,s){return function(e,t){if(e&&t){var n=e[t.APIName];if(n)if("Status"===t.APIName)n=i.statusTranslations[e.status]||e.status;else switch(t.Type){case i.fieldsTypes.DateTime:n=s("amDateFormat")(n,"l LT");break;case i.fieldsTypes.Date:n=s("amDateFormat")(n,"L");break;case i.fieldsTypes.Currency:n=s("currency")(n,defaultCurrency);break;case i.fieldsTypes.Picklist:n=e.fields[t.TranslatedToLabel]||n}return n=null==n?void 0:n}}}]).filter("displayReportField",["utils","$filter",function(e,n){return function(e){if(e){var t=e.Label;switch(e.Type){case"DATETIME_DATA":t=n("amDateFormat")(t,"l LT");break;case"DATE_DATA":t=n("amDateFormat")(t,"L")}return t=null==t?void 0:t}}}]),angular.module("serviceExpert").filter("orderObjectBy",function(){return function(e,n,t){var i=[];return angular.forEach(e,function(e){i.push(e)}),i.sort(function(e,t){return e[n]>t[n]?1:-1}),t&&i.reverse(),i}}),angular.module("serviceExpert").filter("pagination",["servicesService",function(r){return function(e,t,n){r.filter.totalServices=e.length,(null==r.filter.currentPage||parseInt(r.filter.currentPage)>r.filter.totalPages)&&(r.filter.currentPage="1",t=1);var i=[],s=(t-1)*n,t=(t-1)*n+n,i=e.length<=n?e:e.slice(s,t);return e.length==r.filter.servicesPerPage?r.filter.totalPages=1:(r.filter.totalPages=Math.floor(e.length/r.filter.servicesPerPage),0<e.length%r.filter.servicesPerPage&&r.filter.totalPages++),r.filter.firstVisibleService=1+s,r.filter.lastVisibleService=t,(e.length<=n||t>e.length)&&(r.filter.lastVisibleService=e.length),i}}]),angular.module("serviceExpert").filter("replaceLabels",function(){return function(e){for(var t=e,n=arguments.length,i=Array(1<n?n-1:0),s=1;s<n;s++)i[s-1]=arguments[s];for(var r=0;r<i.length;r++)t=t.replace("$"+r,i[r]);return t}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}angular.module("serviceExpert").filter("servicesListFilter",["utils","$filter","servicesService","userSettingsManager","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY","BundleService",function(w,T,L,A,C,e,D,I){return function(e,t,n,i){var s,r=function(e,t){var n,i,s,r,o=Object.keys(e).length.toString();for(n in t)"object"!==_typeof(t[n])&&("boolean"==typeof t[n]?o+=t[n]?"1":"0":o+=t[n].toString());for(i in o+=t.endDate.getTime(),t.selectedFiled)o+=t.selectedFiled[i]?"1":"0";for(s in t.advancedFilter.selectedFiled)o+=t.advancedFilter.selectedFiled[s]?"1":"0";for(r in t.advancedFilter.statusCheckboxs)o+=t.advancedFilter.statusCheckboxs[r]?"1":"0";return o=(o=(o=(o=(o=(o+=t.advancedFilter.minDate.toString())+t.advancedFilter.maxDate.toString())+t.advancedFilter.servicePriority)+(t.advancedFilter.jeopardies?"1":"0"))+(t.advancedFilter.unScheduled?"1":"0"))+(t.advancedFilter.violations?"1":"0")}(e,t);if("SearchOnServer"===t.selectedFilter)return o=e[t.searchOnServer]?[e[t.searchOnServer]]:[],s=0,o.forEach(function(e){return s+=e.totalModifiedTimes}),o.checksum+=s.toString(),o;var o=i&&i[t.selectedFilter]&&i[t.selectedFilter].old;if(useNewFilters&&!o)return(i=T("servicesListFilterNew")(e,t,n)).checksum=r+i.totalChecksum.toString(),i;var a,l=[],c=new Date(t.endDate),d=w.addDaysToDate(c,-w.ganttSettings.backHorizon),u=scheduler.getState().min_date,p=scheduler.getState().max_date,m=function(e){if(null==A.GetUserSettingsProperty("Filters__c"))return null;for(var t="object"===_typeof(A.GetUserSettingsProperty("Filters__c"))?A.GetUserSettingsProperty("Filters__c"):JSON.parse(A.GetUserSettingsProperty("Filters__c")),n=0;n<t.length;n++)if(t[n].name===e)return t[n].filter;return null}(t.selectedFilter),o=null,h=[],g=(-1<t.SearchText.indexOf(",")&&""===(o=t.SearchText.replace(/, /g,",").split(","))[o.length-1]&&o.length--,o?h=o:h.push(t.SearchText),0);for(a in e)for(var v=0;v<h.length;v++){var f=function(e,t,n){{if(e.name&&-1!=e.name.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.ganttLabel&&-1!=e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.id&&-1!==e.id.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.status&&-1!==e.status.toLowerCase().indexOf(t.toLowerCase()))return!0}for(var i=0;i<n.length;i++)if((n[i].Type===w.fieldsTypes.String||n[i].Type===w.fieldsTypes.TextArea||n[i].Type===w.fieldsTypes.Reference||n[i].Type===w.fieldsTypes.Picklist)&&e[n[i].APIName]&&-1!==e[n[i].APIName].toLowerCase().indexOf(t.toLowerCase()))return!0;return!1}(e[a],h[v],n),S=function(e,t,n,i){i=new Date(i);{if(void 0!==t.earlyStart&&t.earlyStart&&e.earlyStart&&e.earlyStart>n&&e.earlyStart<=i)return!0;if(void 0!==t.dueDate&&t.dueDate&&e.dueDate&&e.dueDate>n&&e.dueDate<=i)return!0;if(void 0!==t.appStart&&t.appStart&&e.appStart&&e.appStart>n&&e.appStart<=i)return!0;if(void 0!==t.appEnd&&t.appEnd&&e.appEnd&&e.appEnd>n&&e.appEnd<=i)return!0;if(void 0!==t.finish&&t.finish&&e.finish&&e.finish>n&&e.finish<=i)return!0;if(void 0!==t.start&&t.start&&e.start&&e.start>n&&e.start<=i)return!0;if(void 0!==t.display&&t.display&&e.ganttDisplay&&e.ganttDisplay>n&&e.ganttDisplay<=i)return!0}return!1}(e[a],t.selectedFiled,d,c);if("Selected"===t.selectedFilter){if(C.SelectedServices[a]&&C.SelectedServices[a]&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if("Flagged"===t.selectedFilter&&f){if(L.flagged[a]){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if("Recent"===t.selectedFilter&&f){if(L.recentlyUsed[a]){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if("Todo"===t.selectedFilter){if((e[a].statusCategory===D.NONE||e[a].violations||e[a].jeopardy)&&e[a].statusCategory!==D.CANCELED&&e[a].statusCategory!==D.COMPLETED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("All"===t.selectedFilter){if(S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Unscheduled"===t.selectedFilter){if(!e[a].resource&&e[a].statusCategory!=D.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Violating"===t.selectedFilter){if(e[a].violations&&e[a].statusCategory!=D.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("inJeopardy"===t.selectedFilter){if(e[a].jeopardy&&e[a].statusCategory!=D.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Scheduled"===t.selectedFilter){if(e[a].resource&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Gantt filter"===t.selectedFilter){if(e[a].resource&&e[a].start<=p&&e[a].finish>=u){var y,b,_=!0;if("LongView"===scheduler._mode&&(y=(e[a].finish-e[a].start)/1e3/60/60,_=window.__currentViewOptions.showMdt?(b=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField,y>=window.__currentViewOptions.minServiceDuration&&e[a].fields[b]):y>=window.__currentViewOptions.minServiceDuration),1<h[v].length&&f&&_){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1&&_){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Contractors filter"===t.selectedFilter){if(e[a].resourceContractor&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Cancelled filter"===t.selectedFilter){if(e[a].statusCategory===D.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Crews filter"===t.selectedFilter){if(e[a].isAssignToCrew){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if(void 0!==e[a].parentFields.MinimumCrewSize||void 0!==e[a].parentFields.RecommendedCrewSize){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Exclude Bundle Members"===t.selectedFilter){if(!I.isBundleMember(e[a])&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if(m&&m.statusCheckboxs[statusTranslations[e[a].status]]&&function(e,t,n){var i,s=new Date(e.minDate),r=new Date(e.maxDate);for(i in s.setHours(0),s.setMinutes(0),r.setDate(r.getDate()+1),r.setHours(0),r.setMinutes(0),t)if(t[i]&&function(e,t,n,i){return void 0!==e[t]&&(e[t]>=n&&e[t]<=i)}(n,i,s,r))return 1;return}(m,t.selectedFiled,e[a])&&(b=e[a],y=m.servicePriority,b.priority<=y)&&(_=e[a],S=m,(!_.jeopardy||S.jeopardies)&&(!(_.violations&&!S.violations)&&!(null===_.start_date&&!S.unScheduled)))&&function(e,t,n){if(n&&!e.location)return 1;for(var i in t)if(e.serviceTerritoryName===i&&t[i])return 1;return}(e[a],m.locationsCheckboxs,m.noLocation)){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}i=T("orderBy")(l,t.orderByField,t.reverse);return i.checksum=r+g.toString(),i}}]),!function(){function e($,G,B,H,e,U,V,z,j,W,q,t,Z,n,i,K){var Y=(new Date).getTime();return setInterval(function(){return Y+=6e4},6e4),i.register("positions",function(e){var t,n=B.getResources();for(t in e)n[t]&&(n[t].lastKnownLongitude=e[t].longitude,n[t].lastKnownLocationDate=e[t].lastModifiedDate.getTime()-1e3*e[t].lastModifiedDate.getTimezoneOffset()*60,n[t].lastKnownLatitude=e[t].latitude)}),function(E,e,t,n,i,s,r){var o=[],a={},l=[],c=e.replace(/, /g,",").split(","),d=H.resourcesAndTerritories(),u=H.resourceToServiceCrewMembers(),e=G.getTerritoriesSortedByTree(),p=z.GetUserSettingsProperty("locations");if(__gantt.inday.isInDayRunning=!1,(e=e.filter(function(t){return p.find(function(e){return e===t.id})})).forEach(function(e){o.push(new X(e,B.getOperatingHours()[e.operatingHours],W)),a[e.id]=o.length-1}),t)for(var m in n)n[m]&&l.push(m);var h,g=$.ganttSettings&&$.ganttSettings.filterCandidates;for(h in d){var v=d[h],f=B.getResources()[h];if(f&&(function(e,t){if(0===t.length)return 1;for(var n=0;n<t.length;n++)if(-1<e.toLowerCase().indexOf(t[n].toLowerCase()))return 1;return}(f.name,c)&&(!("and"===i&&0<l.length&&t)||U.doesHaveSkills(h,l,scheduler._min_date,scheduler._max_date))&&(!("or"===i&&0<l.length&&t)||U.doesHaveSomeSkills(h,l,scheduler._min_date,scheduler._max_date)))){var S,y=!1;for(S in r.resourceFilteringOptions)if(r.resourceFilteringOptions[S]&&!f.sobject[S]){y=!0;break}if(!y){if("select_a_field"!==r.selectedPicklist){if(0<r.picklistOptions.length&&-1===r.picklistOptions.indexOf(f.sobject[r.selectedPicklist])){if(!r.picklistNullValues)continue;if(void 0!==f.sobject[r.selectedPicklist])continue}if(0===r.picklistOptions.length&&r.picklistNullValues&&void 0!==f.sobject[r.selectedPicklist])continue}if(H.isCrewViewActive){var b=H.currentCrewToShow;if(void 0===b[h])continue;if(void 0!==b[h].members){var _,w,T,L=!1;for(_ in b[h].members)if(useLocationTimezone)for(var A in v)J(scheduler._min_date,scheduler._max_date,v[A].effectiveStartDate,v[A].effectiveEndDate)&&(w=$.convertDateBetweenTimeZones(b[h].members[_].startDate,"GMT",v[A].timezone),T=$.convertDateBetweenTimeZones(b[h].members[_].endDate,"GMT",v[A].timezone),J(scheduler._min_date,scheduler._max_date,w,T)&&(L=!0));else w=$.convertDateBetweenTimeZones(b[h].members[_].startDate,"GMT",userTimeZone),T=$.convertDateBetweenTimeZones(b[h].members[_].endDate,"GMT",userTimeZone),J(scheduler._min_date,scheduler._max_date,w,T)&&(L=!0);if(!1===L)continue}}if(r.crewsSelectionOptions.selectedPicklist!==customLabels.showAll){if($.crewsFilter=!0,r.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewMembers){if("C"!==f.sobject.ResourceType){var C,D=!1;for(C in u[h])J(scheduler._min_date,scheduler._max_date,u[h][C].startDate,u[h][C].endDate)&&(D=!0);if(!0===D)continue}}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.showCrewsAndCrewMembers){if("C"!==f.sobject.ResourceType){var I,k=!1;for(I in u[h])J(scheduler._min_date,scheduler._max_date,u[h][I].startDate,u[h][I].endDate)&&(k=!0);if(!0!==k)continue}}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.showOnlyCrews){if("C"!==f.sobject.ResourceType)continue}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewsAndCrewMembers){if("C"===f.sobject.ResourceType)continue;var R,F=!1;for(R in u[h])J(scheduler._min_date,scheduler._max_date,u[h][R].startDate,u[h][R].endDate)&&(F=!0);if(!0===F)continue}}else $.crewsFilter=!1;if(!g||!j.getCandidatesIds()||j.getCandidatesIds()[h])for(var M in v){var x=$.generateResourceId(v[M].serviceResource,v[M].serviceTerritory);s.showWorkingResource&&!function(e,t,n){var i=new Date(scheduler._min_date),s=t.resourceToWorkingDates[e];if(!s)return;for(;i<scheduler._max_date;){var r=s[n.formatDayToString(i)];if(r&&(0<r.regular||0<r.overtime))return 1;i.setDate(i.getDate()+1)}return}(x,V,$)||p&&-1==p.indexOf(v[M].serviceTerritory)||J(scheduler._min_date,scheduler._max_date,v[M].effectiveStartDate,v[M].effectiveEndDate)&&(x=o[a[v[M].serviceTerritory]],M=new Q($.generateResourceId,B.getResources()[v[M].serviceResource],v[M].serviceTerritory,function(e){if(window.customPermissions.Hide_Gantt_Last_Seen_Indicator)return!1;if(!e.lastKnownLocationDate)return e.online=!1;if(e.lastKnownLocationDate&&e.onlineOffset){var t=moment(Y).tz(window.userTimeZone)._offset;if(e.lastSeen=parseInt((Y-e.lastKnownLocationDate)/1e3/60+t),e.lastKnownLocationDate+60*(e.onlineOffset-t)*1e3>Y&&0<=e.lastSeen)return e.online=!0}return e.online=!1}(B.getResources()[v[M].serviceResource]),!1,"S"===v[M].serviceTerritoryType,Z),x&&-1===x.children.map(function(e){return e.key}).indexOf(M.key)&&x.children.push(M))}}}}var O=[],P=0;return o.forEach(function(e,t){return 0===e.children.length&&O.push(t)}),O.forEach(function(e){return o.splice(e-P++,1)}),o.forEach(function(e){e.children.sort(N);var t=K.isTerritoryHasInDayOptimizationInProgress(scheduler._min_date,scheduler._max_date,e.key);t&&(__gantt.inday.isInDayRunning=!0,e.addInDayOptimizationInProgress(t,K.calculateIndayProgress))}),$.hasCustomPermission("Utilization_on_Service_Territory")&&showDailyUtilization&&"MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&"LongView"!==scheduler._mode&&o.forEach(function(e){for(var t=[],n=new Date(scheduler._min_date);n<scheduler._max_date;n.setDate(n.getDate()+1))t.push(Z.calculateLocation(e.children,n));var i=t.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0}),i=Z.calculateLocationUtilization(i);e.addUtilizationHtml(i)}),o;function N(e,t){var e=B.getResources()[e.resourceId].sobject[q.resourceFieldToSortyBy],t=B.getResources()[t.resourceId].sobject[q.resourceFieldToSortyBy],n=q.descending?1:-1;return void 0===e&&void 0===t?0:void 0===e&&void 0!==t?-1*n:void 0!==e&&void 0===t||t<e?n:e<t?-1*n:0}}}function J(e,t,n,i){return isIntersect(e,t,n,i)}function X(e,t,n){this.key=e.id,this.name=e.name,this.children=[],this.generateHtml(e,t.timezone),void 0===n.ganttOpenedTerritories[e.id]&&(n.ganttOpenedTerritories[e.id]=!0),this.open=n.ganttOpenedTerritories[e.id]}function Q(e,t,n,i,s,r,o){this.key=e(t.id,n),this.resourceId=t.id,this.name=t.name,this.contractor=t.isCapacityBased,this.online=i,this.lastSeen=t.lastSeen,this.secondary=r,this.isUndestaffOrOverstaff=s,this.utilization=null,this.calculatePeriodUtilization(o,t),t.isUndestaffOrOverstaff=s,this.generateHtml(t)}angular.module("serviceExpert").filter("timelineFilter",e),e.$inject=["utils","LeftSideLocationFilteringService","ResourcesAndTerritoriesService","TimePhasedDataService","ResourceCrewsService","SkillsService","calendarsService","userSettingsManager","GetSlotsService","StateService","resourceFilterHelper","LastKnownPositionService","monthlyViewHelperService","DeltaService","RegisterService","OptimizationRequestsService"],X.prototype.generateHtml=function(e,t){var n,i;e.parentTerritory?this.label='<div class="truncate ParentName" title="'+e.parentTerritory.name.encodeHTML()+'">'+e.parentTerritory.name.encodeHTML()+'</div>\n                          <div class="truncate LocationName" title="'+e.name.encodeHTML()+'">'+e.name.encodeHTML()+"</div>":this.label='<div class="truncate LocationName no-parent-location" title="'+e.name.encodeHTML()+'">'+e.name.encodeHTML()+"</div>","MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&(i=new Date,n=e.parentTerritory?"margin-top:-26px;":"",(i=new Date(i.valueOf()+6e4*i.getTimezoneOffset())).setMinutes(i.getMinutes()+utils.getLocationOffset(i,e.id)),this.label+="<div class='timeZoneFolder' style=\""+n+'">'+t+" - "+moment(i).format("llll")+"</div>")},X.prototype.addInDayOptimizationInProgress=function(e,t){var n=this.label.indexOf("</div>"),i=customLabels.PreparingData,s={percent:0},t='<div class="left-territory-info-box" >'+('<div class="inDayOptimizationRunningContainer"><span>'+('<div class="inday-opt-progress">\n                            <span class="opt-progress-preparing">'+(i=null!=e.objectToScheduled?(s=t(e)).text:i)+'</span>\n                                <span class="opt-progress-text">'+s.percent+'%</span>\n\n                                <div class="opt-progress-bar inday-progress-animation" style="width:'+s.percent+'%">\n                            </div>\n\n                        </div>')+"</span></div>")+"</div>";this.label=this.label.slice(0,n+6)+t+this.label.slice(n+6)},X.prototype.addUtilizationHtml=function(e){var t=this.label.indexOf("</div>"),n="green-daily-utlz",i=this.label.indexOf("inDayOptimizationRunningContainer"),s=-1==i&&-1<this.label.indexOf("Parent")?'style="margin-top: -9px"':"",r=(e>=monthlyViewSettings.high&&e<monthlyViewSettings.critical?n="yellow-daily-utlz":e>=monthlyViewSettings.critical&&(n="red-daily-utlz"),"");-1<navigator.userAgent.indexOf("rv:11.0")&&(r="dailyViewUtilizationIE"),null!==e&&(n='<b class="'+n+'">'+e+"%</b>",-1<i?(e='<div class="dailyViewUtilization '+r+' utilizationWithInday"><span>'+customLabels.UtilizationDaily.replace("$0",n)+" </span></div>",this.label=this.label.slice(0,i-12)+e+this.label.slice(i-12)):(e='<div class="dailyViewUtilization '+r+'" '+s+"><span>"+customLabels.UtilizationDaily.replace("$0",n)+"</span> </div>",this.label=this.label.slice(0,t+6)+e+this.label.slice(t+6)))},Q.prototype.calculatePeriodUtilization=function(e,t){if("MonthlyView"===scheduler._mode){for(var n=[],i=new Date(scheduler._min_date);i<scheduler._max_date;i.setDate(i.getDate()+1))n.push(e.calculateDailyResourceCapacity(this,i));var s=n.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0});this.utilization=e.calculateLocationUtilization(s),t.sobject.__Utilization__=this.utilization}},Q.prototype.generateHtml=function(e){this.label="";var t,n=this.online?"online-indicator":"online-indicator offline-indicator",i=this.secondary?"<span class='secondaryGanttLabel' title=\""+customLabels.Secondary+'">('+customLabels.Secondary+")</span>":"",n=e.lastKnownLocationDate&&this.lastSeen<1440&&0<=this.lastSeen?'<div class="'+n+'" title="'+utils.hoursMinutes(this.lastSeen,customLabels.SeenXMinsHoursAgo,customLabels.SeenXAgoHours,customLabels.SeenXAgo)+'"></div>':"",s=(void 0!==e.serviceCrew__r?(s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourceCrewPhoto":"ResourceCrewPhoto",e.pictureLink?this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+s+"' />":this.label+="<span class='"+s+'\'><svg aria-hidden="true" class="crew-slds-icon crewContextMenuIcon"><use xlink:href=\''+lsdIcons.crew+"'></use></svg></span>",this.label+=n):e.pictureLink?(s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhoto":"ResourcePhoto",this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+s+"' />"+n):(s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhotoDefault":"NormalResourcePhotoDefault",this.label+="<div title='"+e.description+"' class=\"ResourcePhotoIcon "+s+'"></div>'+n),this.label+='<div class="resourceMenuBtn">\n                            <svg aria-hidden="true" class="slds-icon resourceMenuIcon">\n                                <use xlink:href="'+lsdIcons.threedots+'"></use>\n                            </svg>\n                        </div>',e.ganttLabel?utils.escapeResourceName(e.ganttLabel):""),n=utils.escapeResourceName(this.name),r=utils.escapeResourceName(this.name);e.description&&(r=this.name+" - "+e.description),"MonthlyView"===scheduler._mode&&null!==this.utilization?(t="resource-utiliz-low",s=customLabels.TotalUtilizationResource,monthlyViewSettings.critical<=this.utilization?t="resource-utiliz-high":monthlyViewSettings.high<=this.utilization&&(t="resource-utiliz-med"),s+=' <span class="'+t+'">'+this.utilization+"%</span>",scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class=\"truncate smallResourceNameField\" title='"+r+"'>"+n+" "+i+"\n                    <div class='smallResourceGanttLabel truncate'>"+s+"</div></a>":this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup' title='"+r+"'>"+n+" "+i+"\n                    <div class='resourceGanttLabel truncate'>"+s+"</div></a>"):e.ganttLabel?scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class=\"truncate smallResourceNameField\" title='"+r+"'>"+n+" "+i+"\n                        <div class='smallResourceGanttLabel truncate'>"+s+"</div></a>":this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup' title='"+r+"'>"+n+" "+i+"\n                        <div class='resourceGanttLabel truncate'>"+s+"</div></a>":scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup resource-no-label' style='margin-top:1px;' title='"+r+"'>"+n+" "+i+"</a>":this.label+='<a class="truncate resource-no-label" resource=\''+this.resourceId+"' style='margin-top:1px;' title='"+r+"'>"+n+" "+i+"</a>",this.label='<div class="resourceY-container">'+this.label+"</div>"}}(),angular.module("serviceExpert").filter("toArray",function(){return function(e){var n=[];return angular.forEach(e,function(e,t){n.push(e)}),n}}),!function(){function stringifySingleCondition(e,t,n){if(e[getPropertyName(t.property)]||!1===e[getPropertyName(t.property)]||(e[getPropertyName(t.property)]=""),"FSL__RULE_VIOLATIONS__FSL"===t.property)return e="true"===t.value.toString(),"equals"===t.operator&&e||"not equal to"===t.operator&&!e?"(Array.isArray(__evalRealService.violations) && __evalRealService.violations.length > 0)":"(!__evalRealService.violations || (Array.isArray(__evalRealService.violations) && __evalRealService.violations.length === 0))";var e=evaluateOperator(t.operator);return t.value&&t.value.indexOf&&-1<t.value.indexOf(",")&&(t.value=t.value.replace(/, /g,",").split(",")),Array.isArray(t.value)?(t.value=t.value.map(function(e){return e.toLowerCase?e.toLowerCase():e}),__picklistArrayForFilter[n]=t.value,evaluateArrayValue(t.operator,t.property,n)):(evaluateValue(t.property,t.value,__ganttFilterFieldSet,n),e?"STRING"===(e=__ganttFilterFieldSet[t.property].Type)||"TEXTAREA"===e||"EMAIL"===e||"REFERENCE"===e?"__evalService."+getPropertyName(t.property)+".toLowerCase() "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+n+".toLowerCase()":"__evalService."+getPropertyName(t.property)+" "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+n:evaluateSepcialOperator(t.operator,t.value,t.property))}function evaluateArrayValue(e,t,n){switch(e){case"contains":return"new RegExp(__picklistArrayForFilter["+n+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"does not contain":return"new RegExp(__picklistArrayForFilter["+n+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === false";case"start with":return"new RegExp('^' + __picklistArrayForFilter["+n+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"equals":return"__picklistArrayForFilter["+n+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) > -1";case"not equal to":return"__picklistArrayForFilter["+n+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) === -1";default:return"__picklistArrayForFilter["+n+"].some( element => __evalService."+getPropertyName(t)+" "+evaluateOperator(e)+" element)"}}function getPropertyName(e){return"FSL__RULE_VIOLATIONS__FSL"===e?"FSL__RULE_VIOLATIONS__FSL":removeNamespace(__ganttFilterFieldSet[e].APIName)}function evaluateCondition(service,conditions,logic){var serviceFields=service.fields,stringConditions=(window.__evalService=serviceFields,window.__evalRealService=service,logic?replaceLogicOperators(logic):""),conditionsMapped={},i,_i;for(i in conditions)conditionsMapped[i]=stringifySingleCondition(serviceFields,conditions[i],i-1),logic||(stringConditions+="{"+i.toString()+"} && ");for(_i in logic||(stringConditions=stringConditions.substr(0,stringConditions.length-3)),conditionsMapped)stringConditions=stringConditions.replace("{"+_i+"}",conditionsMapped[_i]);return""===stringConditions?1:eval(stringConditions)}function evaluateValue(e,t,n,i){if(n[e])switch(n[e].Type){case"BOOLEAN":window.__evalConditionValue[e+"_"+i]=!0===t;break;case"DATE":case"DATETIME":window.__evalConditionValue[e+"_"+i]=new Date(t);break;case"STRING":case"EMAIL":case"TEXTAREA":case"REFERENCE":window.__evalConditionValue[e+"_"+i]=t?t.toLowerCase():"";break;default:window.__evalConditionValue[e+"_"+i]=t}else window.__evalConditionValue[e]=null}function evaluateOperator(e){switch(e){case"equals":return"==";case"not equal to":return"!=";case"less than":return"<";case"greater than":return">";case"less or equal":return"<=";case"greater or equal":return">=";default:return null}}function evaluateSepcialOperator(e,t,n){switch(e){case"contains":return"__evalService."+getPropertyName(n)+".toLowerCase().indexOf('"+t.toLowerCase()+"') > -1";case"does not contain":return"__evalService."+getPropertyName(n)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === -1";case"start with":return"__evalService."+getPropertyName(n)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === 0"}}function replaceLogicOperators(e){return e=(e=(e=e.split("AND").join("&&")).split("OR").join("||")).split("NOT").join("!")}function removeNamespace(e){var t;return fslNamespace&&0===e.indexOf(fslNamespace+"__")?(t=fslNamespace.length+2,e.substr(t,e.length-t)):e}function isServiceInDateRange(e,t,n,i){var s=scheduler._min_date,r=scheduler._max_date;return i.List_only_appointments_on_the_gantt?e.end_date&&isIntersectIncludeLimits(s,r,e.end_date,e.end_date)||!(!e.start_date||!isIntersectIncludeLimits(s,r,e.start_date,e.start_date)):(s=new Date(n),r=new Date(n),s.setDate(s.getDate()-i.Days_before_horizon),r.setDate(r.getDate()+i.Days_after_horizon+1),r.setMinutes(r.getMinutes()-1),t.earlyStart&&e.earlyStart&&isIntersectIncludeLimits(s,r,e.earlyStart,e.earlyStart)||(t.dueDate&&e.dueDate&&isIntersectIncludeLimits(s,r,e.dueDate,e.dueDate)||(t.start&&e.start&&isIntersectIncludeLimits(s,r,e.start,e.start)||(t.finish&&e.finish&&isIntersectIncludeLimits(s,r,e.finish,e.finish)||(t.appStart&&e.appStart&&isIntersectIncludeLimits(s,r,e.appStart,e.appStart)||(t.appEnd&&e.appEnd&&isIntersectIncludeLimits(s,r,e.appEnd,e.appEnd)||!!(t.display&&e.ganttDisplay&&isIntersectIncludeLimits(s,r,e.ganttDisplay,e.ganttDisplay))))))))}function searchOnService(e,t,n){if(e.name&&-1!==e.name.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.ganttLabel&&-1!==e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.id&&-1!==e.id.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.status&&-1!==e.status.toLowerCase().indexOf(t.toLowerCase()))return 1;for(var i=0;i<n.length;i++)if((n[i].Type===utils.fieldsTypes.String||n[i].Type===utils.fieldsTypes.TextArea||n[i].Type===utils.fieldsTypes.Reference||n[i].Type===utils.fieldsTypes.Picklist)&&e[n[i].APIName]&&-1!==e[n[i].APIName].toLowerCase().indexOf(t.toLowerCase()))return 1}window.__ganttFilterFieldSet={},window.__picklistArrayForFilter=[],window.__evalConditionValue={},angular.module("serviceExpert").filter("servicesListFilterNew",["utils","$filter","GanttFilterService","FieldSetFieldsService",function(e,p,m,t){return t.fieldsSetFields().then(function(e){e.ganttFilter.forEach(function(e){return __ganttFilterFieldSet[e.FullAPIName]=e})}),function(e,t,n){var i=0,s=[],r=m.getFilterById(t.selectedFilter);if(r){var o,a=null,l=[];for(o in-1<t.SearchText.indexOf(",")&&""===(a=t.SearchText.replace(/, /g,",").split(","))[a.length-1]&&a.length--,a?l=a:l.push(t.SearchText),e){if(t.SearchText){for(var c=!1,d=0;d<l.length;d++)if(searchOnService(e[o],l[d],n)){c=!0;break}if(!c)continue}t.pivotDate=new Date(t.endDate),t.pivotDate.setHours(0),t.pivotDate.setMinutes(0),isServiceInDateRange(e[o],t.selectedFiled,t.pivotDate,r)&&evaluateCondition(e[o],r.Criterias,r.Logic)&&(i+=e[o].totalModifiedTimes,s.push(e[o]))}}else for(var u in e)i+=e[u].totalModifiedTimes,s.push(e[u]);a=p("orderBy")(s,t.orderByField,t.reverse);return a.totalChecksum=i,a}}])}(),!function(){function e(){function e(n,s,r,o,a,l,c,d,e,u,p,m,h,t){n.bulkActionsOrder=bulkActionsOrder,n.customActions=[],n.actionNames={Schedule:{name:"Schedule",nameLabel:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:"Dispatch",nameLabel:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:"Optimize",nameLabel:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:"Flag-Unflag",nameLabel:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:"Unschedule",nameLabel:customLabels.Unschedule,icon:lsdIcons.na},"Check Rules":{name:"Check Rules",nameLabel:customLabels.check_rules_action_label,icon:lsdIcons.violation,isAvailable:function(){return window.customPermissions.Enable_Bulk_Check_Rules}},Bundle:{name:"Bundle",nameLabel:h.Bundle.label,icon:h.Bundle.icon,isAvailable:function(){return t.isActive()}},Unbundle:{name:"Unbundle",nameLabel:h.Unbundle.label,icon:h.Unbundle.icon,isAvailable:function(){return t.isActive()}}},r.customActionsPromise.then(function(){var e,t=r.getCustomActions("bulk");(e=n.customActions).push.apply(e,_toConsumableArray(t))}),n.runCustomServiceAction=function(n){var e,t,i=l.getSelected();n.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),t=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===i.length?p.open(n.name,n.visualforce+"?id="+i[0]+"&start="+e+"&end="+t):p.open(n.name,n.visualforce+"?services="+i.join(",")+"&start="+e+"&end="+t)):0!==i.length&&u.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,i,scheduler._min_date,scheduler._max_date).then(function(t){u.callRemoteAction(RemoteActions.getServicesById,i).then(function(e){e=m.updateTimePhaseData(e,"service").services;s.drawServicesAndAbsences(e,[],[],[]),t&&r.addNotification(n.name,t,null,null)})}).catch(function(e){return r.addNotification(n.name,e.message,null,null)})},n.isActionAvailable=function(e){return!n.actionNames[e]||!n.actionNames[e].isAvailable||n.actionNames[e].isAvailable()},n.checkHasCustomPermission=function(e){return null==r.hasCustomPermission("Bulk_"+e)||r.hasCustomPermission("Bulk_"+e)},n.openBulkAction=function(e){switch(e){case"Schedule":d.schedule(l.getSelected());break;case"Dispatch":o.open();break;case"Unschedule":a.open();break;case"Optimize":c.open();break;case"Flag-Unflag":for(var t=l.getSelected(),n=0;n<t.length;n++)s.flagged[t[n]]=!s.flagged[t[n]];updateViewDebounced();break;case"Check Rules":var i=l.getSelected();0<i.length&&s.checkRules(i).then(s.drawViolationsOnGantt);break;case"Bundle":i=l.getSelected().map(function(e){return m.serviceAppointments()[e]});h.Bundle.invoke(i).then(function(){}).catch(function(e){});break;case"Unbundle":i=l.getSelected().map(function(e){return m.serviceAppointments()[e]});h.Unbundle.invoke(i).then(function(){}).catch(function(e){})}}}return e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService","sfdcService","GeneralLightbox","TimePhasedDataService","BundleActions","BundleService"],{restrict:"E",template:'<div id="quickActionsButtons">\n\t\t\t                    <div fsl-key-press tabindex="0" id="actionQuickFirst" class="truncate quickActionBtn" ng-show="bulkActionsOrder.first.length && checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name) && isActionAvailable(actionNames[bulkActionsOrder.first[0].title].name)" ng-click="openBulkAction(bulkActionsOrder.first[0].title)" title="{{actionNames[bulkActionsOrder.first[0].title].nameLabel}}">\n\t\t\t\t\t\t\t\t\t{{actionNames[bulkActionsOrder.first[0].title].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n\t                        \t<div fsl-key-press tabindex="0" id="actionQuickSecond"\n\t\t\t\t\t\t\t\t\t class="truncate quickActionBtn"\n\t\t\t\t\t\t\t\t\t ng-show="bulkActionsOrder.second.length && checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name) && isActionAvailable(actionNames[bulkActionsOrder.second[0].title].name)"\n\t\t\t\t\t\t\t\t\t ng-click="openBulkAction(bulkActionsOrder.second[0].title)"\n                                     title="{{actionNames[bulkActionsOrder.second[0].title].nameLabel}}">\n                                     {{actionNames[bulkActionsOrder.second[0].title].nameLabel}}\n                                </div>\n\t\t                    \t<div fsl-key-press tabindex="0" class="truncate" id="ActionButton" ng-show="bulkActionsOrder.dropdown.length || customActions.length" cs-toggle="MainActionContainer">\n                                    <span ng-show="(!bulkActionsOrder.first.length &&\n                                                   !bulkActionsOrder.second.length) ||\n                                                   ( (!checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name)  || !isActionAvailable(actionNames[bulkActionsOrder.first[0].title].name )) &&\n                                                     (!checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name) || !isActionAvailable(actionNames[bulkActionsOrder.second[0].title].name)) )">\n                                           '+customLabels.Actions+'\n                                    </span>\n                                    <i class="fa fa-caret-down"></i>\n\t\t                    \t</div>\n\t                    \t</div>\n\t                    \t\n\t                        <div id="MainActionContainer">\n\t\t\t                    <div class="truncate BulkActionMenuItem" tabindex="0" role="select" fsl-tab-switch fsl-key-press ng-repeat="action in bulkActionsOrder.dropdown" ng-show="checkHasCustomPermission(actionNames[action.title].name) && isActionAvailable(actionNames[action.title].name)" ng-click="openBulkAction(action.title)">\n\t\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon mainActionIcon">\n\t\t\t\t\t\t\t\t\t\t<use xlink:href="{{actionNames[action.title].icon}}"></use>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t{{actionNames[action.title].nameLabel}}\n                                </div>\n                                \n                                \n                                <div class="truncate BulkActionMenuItem" tabindex="0" role="select" fsl-tab-switch fsl-key-press ng-repeat="action in customActions" ng-click="runCustomServiceAction(action)">\n                                \n                                    <svg aria-hidden="true" class="slds-icon mainCustomActionIcon">\n\t\t\t\t\t\t\t\t\t\t<use xlink:href="{{action.icon}}"></use>\n\t\t\t\t\t\t\t\t\t</svg>\n                                \n\t\t\t\t\t\t\t\t\t{{action.name}}\n                                </div>\n                                                               \n                                \n\t                        </div>',scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButton",e),e.$inject=[]}(),angular.module("serviceExpert").directive("bulkOptimizeOptions",function(){return{template:customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n\t\t\t\t\t\t\t\t<option value="all">'+customLabels.All+'</option>\n\t\t\t\t\t\t\t\t<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n\t\t\t\t\t\t\t</select>")}}).directive("bulkOptimizePolicy",function(){return{template:customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n\t\t\t\t\t\t\t\t \t<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n\t\t\t\t\t\t\t\t \t<option value="noFilter">'+customLabels.None+"</option>\n\t\t\t\t\t\t\t\t </select>")}}).directive("bulkChangeStatusDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartChangeStatus" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartChangeStatus\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishChangeStatus" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishChangeStatus\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkUnscheduleDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkChangeStatusPicklist",function(){return{template:customLabels.changeStatusBulkMsg.replace("$0",'<select class="selectChangeStatusBulk bulkStatusWidth" ng-model="bulkStatus">\n\t\t\t\t\t\t\t\t<option ng-repeat="(statusType,statusLabel) in statuses" value="{{statusLabel}}" >{{getStatusTranslations()[statusLabel]}}</option>\n\t\t\t\t\t\t\t</select>')}}),!function(){function e(){function e(i){i.colors=[{Name:"Red",Hex:"#E53935"},{Name:"Pink",Hex:"#D81B60"},{Name:"Purple",Hex:"#8E24AA"},{Name:"Indigo",Hex:"#3949AB"},{Name:"Blue",Hex:"#1E88E5"},{Name:"Cyan",Hex:"#00ACC1"},{Name:"Teal",Hex:"#00897B"},{Name:"Green",Hex:"#43A047"},{Name:"Lime",Hex:"#C0CA33"},{Name:"Yellow",Hex:"#FDD835"},{Name:"Amber",Hex:"#FFB300"},{Name:"Orange",Hex:"#FB8C00"},{Name:"Brown",Hex:"#6D4C41"},{Name:"Grey",Hex:"#757575"},{Name:"Blue Grey",Hex:"#546E7A"},{Name:"Black",Hex:"#000"}],i.selectColor=function(e){i.selectedColor=e.Hex,i.setSelectedShapeColor(e.Hex),i.showColorMenu=!1},i.showMenuClick=function(e){i.drawState!=i.drawingStates.EDIT&&i.drawState!=i.drawingStates.DRAW||(i.showColorMenu=!i.showColorMenu)},i.selectedColor="#546E7A",i.showColorMenu=!1,angular.element("#mapOptionsContainer").on("click",function(e){for(var t=["color-square","color-button"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;i.showColorMenu&&(i.showColorMenu=!1)})}return e.$inject=["$scope"],{restrict:"E",template:'<div id="select-color-btn" title="'+customLabels.Select_color+'" class="color-button truncate"  ng-click="showMenuClick()" ng-class="{disabledButton: drawState != drawingStates.EDIT && drawState != drawingStates.DRAW}">\n                            <span class="color-square" ng-style="{\'background-color\': selectedColor}"></span><span>'+customLabels.Select_color+'</span>\n                        </div>\n                        <div class="color-menu" id="colorMenu" ng-show="showColorMenu == true">\n                            <span class="color-box" ng-repeat="color in colors" ng-click="selectColor(color)" ng-style="{\'background-color\': color.Hex}"></span>\n                        </div>',scope:!1,controller:e}}angular.module("serviceExpert").directive("csColorPicker",e),e.$inject=[]}(),angular.module("serviceExpert").directive("fieldInCard",["$filter","utils",function(i,s){return{restrict:"E",link:function(n,e,t){n.fieldsTypes=s.fieldsTypes,n.isFieldEmpty=function(e,t){return void 0===i("displayFieldSetField")(n.service,n.field)},n.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},n.openConsoleTab=s.openConsoleTab},scope:{service:"=",field:"="},template:'\n            \n                <span>\n                \n                    <div class="extra-info-title" title="{{field.Label}}">{{field.Label}}</div>\n                    <span class="extra-info-content" ng-show="field.Type != fieldsTypes.Reference && field.Type != fieldsTypes.Phone" title="{{service | displayFieldSetField : field}}"><service-list-column service="service" field="field"></service-list-column></span>\n                    <span ng-show="isFieldEmpty(service, field)">-</span>\n                    <a draggable="false" ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(service, field))" target="_blank" href="../{{ getRefFieldID(service, field) }}" title="{{service | displayFieldSetField : field}}">{{service | displayFieldSetField : field}}</a>\n                    <span ng-if="field.Type == fieldsTypes.Phone && !isFieldEmpty(service, field)">\n                        <cs-click-to-dial number="{{service[field.APIName]}}" user-id="\'{!$User.Id}\'" user-first-name="\'{!JSENCODE($User.FirstName)}\'" user-last-name="\'{!JSENCODE($User.LastName)}\'"></cs-click-to-dial>\n                    </span>\n\n                </span>\n            '}}]),!function(){function e(){function e(r,t,n,i,s,o,a){r.isEmpty=t.isEmpty,r.paletteApplied=!1,r.updatePaletteView=function(){var i,s;r.calculatePaletteColors=!1,(r.paletteDataIsValid=!0)===r.paletteApplied&&r.clearPalette(),void 0!==r.GanttPalettes[r.selectedPalette]&&(r.currentPalette=r.GanttPalettes[r.selectedPalette],r.picklistMap={},t.serviceFieldsMap().then(function(e){var t,e=e[r.currentPalette.ServiceProperty];try{e.Type===FieldTypes.PICKLIST&&(i=Object.keys(r.currentPalette.ColorScheme.picklist[e.Name]),s=Object.values(r.currentPalette.ColorScheme.picklist[e.Name])),e.Type===FieldTypes.BOOLEAN&&(i=[customLabels.Selected,customLabels.Deselected],s=[r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorScheme.min.color]),e.Type!==FieldTypes.DATE&&e.Type!==FieldTypes.DATETIME||(t=o.convertMomentDtToDt(moment().tz(userTimeZone)),s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=function(e,t,n,i,s,r){for(var i=p(i,t),t=p(s,n),o=e.getTime()+i,a=(e.getTime()+t-o)/r,l=[],c=0;c<r;c++){var d=moment(o+c*a),u=moment(o+(c+1)*a);0===c?l.push(m([customLabels.Earlierthan,u.format("dddd, MMMM Do YYYY, h:mm:ss a")])):c===r-1?l.push(m([customLabels.LaterThan,d.format("dddd, MMMM Do YYYY, h:mm:ss a")])):l.push(customLabels.Between_x_and_y.replaceAll(d.format("dddd, MMMM Do YYYY, h:mm:ss a"),u.format("dddd, MMMM Do YYYY, h:mm:ss a")))}return l}(t,r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorScheme.min.type,r.currentPalette.ColorScheme.max.type,r.currentPalette.ColorLevel)),e.Type===FieldTypes.DOUBLE&&(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=l(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel)),e.Type!==FieldTypes.INTEGER&&e.Type!==FieldTypes.PERCENT||(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=function(e,t,n){e=parseInt(e);for(var i=((t=parseInt(t))-e)/n,s=(i=Math.round(i),[]),r=0;r<n;r++){var o=e+r*i,a=e+(r+1)*i;0===r?s.push(m([a,customLabels.OrLower])):r===n-1?s.push(m([customLabels.HigherThan,o])):s.push(customLabels.Between_x_and_y.replaceAll(o,a))}return s}(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel)),e.Type!==FieldTypes.LOCATION&&e.Type!==FieldTypes.ADDRESS||(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=l(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel,!0)),r.picklistLength=s.length;for(var n=0;n<s.length;n++)r.picklistMap[i[n]]=s[n]}catch(e){r.paletteDataIsValid=!1}}))},r.clearPalette=function(){r.hidePaletteView(),r.paletteApplied=!1,a.$broadcast("paletteUpdated")},r.applyPalette=function(){var e;r.calculatePaletteColors?alert("Still applying last palette"):(r.calculatePaletteColors=!0,void 0!==(e=r.GanttPalettes[r.selectedPalette])?t.applyNewPaletteForGantt(e,n.serviceAppointments()).then(function(e){r.showPaletteView(),r.paletteApplied=!0,r.calculatePaletteColors=!1,a.$broadcast("paletteUpdated")}):(alert("No palette selected"),r.calculatePaletteColors=!1))},r.openPalettesLightbox=function(e){"edit"===e&&i.open(customLabels.GanttPalettes,GanttPalettePage)},r.calculatePalettePortionStyle=function(e){return{background:e,width:100/r.picklistLength+"%",height:"12px"}},t.getGanttPalettes(!1).then(function(e){r.GanttPalettes=e,r.selectedPalette=s.GetUserSettingsProperty("Gantt_Palette__c")||(null==r.GanttPalettes||r.isEmpty(r.GanttPalettes)?customLabels.NoPalettes:customLabels.None),r.updatePaletteView()}),r.getTranslatedPicklistValue=function(e){return r.GanttPalettes[r.selectedPalette]&&r.GanttPalettes[r.selectedPalette].translations&&r.GanttPalettes[r.selectedPalette].translations[e]||e}}function l(e,t,n,i){e=parseFloat(e);for(var s=((t=parseFloat(t))-e)/n,r=[],o=0;o<n;o++){var a=e+o*s,l=e+(o+1)*s;i?0===o?r.push(m([l,distanceUnit,customLabels.OrLower])):o===n-1?r.push(m([customLabels.HigherThan,a,distanceUnit])):r.push(customLabels.Between_x_and_y.replaceAll(m([a,distanceUnit]),m([l,distanceUnit]))):0===o?r.push(m([l,customLabels.OrLower])):o===n-1?r.push(m([customLabels.HigherThan,a])):r.push(customLabels.Between_x_and_y.replaceAll(a,l))}return r}function p(e,t){var n;switch(e){case"Minutes":n=60*t*1e3;break;case"Hours":n=60*t*60*1e3;break;case"Days":n=24*t*60*60*1e3}return n}function c(e,t,n){for(var i=[],s=e.substr(1,2),r=e.substr(3,4).substr(0,2),e=e.substr(5,6),o=t.substr(1,2),a=t.substr(3,4).substr(0,2),t=t.substr(5,6),l=parseInt(s,16),c=parseInt(r,16),d=parseInt(e,16),u=(parseInt(o,16)-l)/n,p=(parseInt(a,16)-c)/n,m=(parseInt(t,16)-d)/n,h=0;h<n;h++){var g=Math.round(Math.abs(l+u*h))%256,v=Math.round(Math.abs(c+p*h))%256,f=Math.round(Math.abs(d+m*h))%256,g=g.toString(16),v=(1===g.length&&(g="0"+g),v.toString(16)),f=(1===v.length&&(v="0"+v),f.toString(16)),g="#"+g+v+(f=1===f.length?"0"+f:f);i.push(g)}return i}function m(e){for(var t="",n=0;n<e.length;n++)t+=e[n]+" ";return t}return e.$inject=["$scope","GanttPalettesService","TimePhasedDataService","GeneralLightbox","userSettingsManager","utils","$rootScope"],{restrict:"E",template:'<div>\n                            <div class="palette-explain-headline">\n                                <div class="palette-explain">\n                                    '+customLabels.PaletteChangeExplain+'\n                                </div>\n\n                                <button ng-if="showPaletteEdit" class="globalWhiteButton truncate palette-editor-button" title="'+customLabels.OpenPaletteEditor+'" ng-click="openPalettesLightbox(\'edit\')">\n                                    '+customLabels.OpenPaletteEditor+'\n                                </button>\n                            </div>\n\n                            <div>\n                                <span>\n                                    <select class="ganttPaletteSelector" ng-model="selectedPalette" ng-change="updatePaletteView()">\n                                        <option ng-if="isEmpty(GanttPalettes) == true" value="'+customLabels.NoPalettes+'">--- '+customLabels.NoPalettes+' ---</option>\n                                        <option ng-if="isEmpty(GanttPalettes) == false" value="'+customLabels.None+'">--- '+customLabels.None+' ---</option>\n                                        <option ng-repeat="(key,value) in GanttPalettes" value="{{key}}">{{value.Name}}</option>\n                                    </select>\n                                </span>\n                            </div>\n\n                            <div class="palette-details-container" ng-if="GanttPalettes[selectedPalette] !== undefined">\n                                \n                                <div ng-if="paletteDataIsValid">\n\n                                    '+customLabels.HoverPaletteColor+'\n                                \n                                    <div style="padding-top: 10px">\n                                        <div class="paletteBox">\n                                            <span title="{{getTranslatedPicklistValue(key)}}" ng-class="{\'roundBoxRight\': $last, \'roundBoxLeft\': $first}" ng-style="calculatePalettePortionStyle(value)" ng-repeat="(key, value) in picklistMap"></span>\n                                        </div>\n                                    </div>\n\n                                    <div class="palette-description" ng-hide="currentPalette.Description === \'\' || currentPalette.Description === undefined">\n                                        <div class="description-label-heading">\n                                            '+customLabels.Description+'\n                                        </div>\n                                        <div class="palette-description-content">\n                                            {{currentPalette.Description}}\n                                        </div>\n                                    </div>\n                                    \n                                    <div class="apply-palette-button-container">\n                                        <button ng-show="paletteApplied === false" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="applyPalette()">'+customLabels.ApplyPalette+'</button>\n                                        <button ng-show="paletteApplied === true" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="clearPalette()">'+customLabels.UseDefaultPalette+'</button>\n                                    </div>\n\n                                </div>\n\n                                <div class="palette-details-error" ng-if="paletteDataIsValid == false">\n                                    '+customLabels.PaletteDataIsInvalid+"\n                                </div>\n\n                            </div>\n                        </div>",scope:{showPaletteView:"=",showPaletteEdit:"=",hidePaletteView:"="},controller:e}}angular.module("serviceExpert").directive("ganttPalette",e),e.$inject=[]}(),!function(){function e(){return{restrict:"E",scope:{request:"=",apptCount:"@",progressStatus:"="},template:'<div class="opt-progress">\n                            <span class="opt-progress-preparing"></span>\n\n                            <div class="opt-progress-bar smart_in_progress">\n                                <span class="opt-progress-text"></span>\n                            </div>\n\n                        </div>',link:function(a,n,e){var l,c,i,d,s;function r(){var e,t,n,i,s,r,o;a.progressStatus[a.request.id].progressInterval||(e=a.request.objectToScheduled,t=d.maxRunTimeSingleService*e,n=(new moment).diff(moment(a.request.requestProgressStart),"seconds"),t>=d.maxRuntimeOverall&&(e=d.maxRuntimeOverall/d.maxRunTimeSingleService,t=d.maxRuntimeOverall),i=n/t*100,s=7,r=0,o=90/e,t<=n&&"In Progress"==a.request.status&&(s=7+(n-t)/d.maxRunTimeSingleService*.1,r=90),a.progressStatus[a.request.id].progressInterval=setInterval(function(){"Aborted"!==a.request.status&&"Aborting"!==a.request.status||u(),90<(i+=o)&&(i=90),r<90?r=i:100<=r?(r=100,clearInterval(a.progressStatus[a.request.id].progressInterval),delete a.progressStatus[a.request.id].progressInterval):90<=r&&(s+=.1,r=Math.round(Math.atan(s)/(Math.PI/2)*100*1e3)/1e3),l.css("width",r+"%"),c.text(r.toFixed(2)+"%")},1e3*d.maxRunTimeSingleService))}function u(){clearInterval(a.progressStatus[a.request.id].progressInterval),delete a.progressStatus[a.request.id].progressInterval}"Global Optimization"===a.request.type&&(l=angular.element(n[0].querySelector(".opt-progress-bar")),c=angular.element(n[0].querySelector(".opt-progress-text")),i=angular.element(n[0].querySelector(".opt-progress-preparing")),d=__gantt[e.optType],a.progressStatus[a.request.id]||(a.progressStatus[a.request.id]={status:a.request.status,objectToScheduled:a.request.objectToScheduled}),a.progressStatus[a.request.id].objectToScheduled||(l.css("width","0%"),i.text(customLabels.PreparingData)),s=a.$watchCollection("[request.objectToScheduled, request.status]",function(e,t){""!=e[0]&&null!=e[0]&&e[0]!=a.progressStatus[a.request.id].objectToScheduled?(i.text(""),a.progressStatus[a.request.id].objectToScheduled=e[0],r()):"In Progress"==e[1]&&null!=e[0]&&"In Progress"==a.progressStatus[a.request.id].status&&(i.text(""),r()),"In Progress"!==e[1]&&"In Progress"==a.progressStatus[a.request.id].status?(a.progressStatus[a.request.id].status=e[1],u(),s()):"Completed"==a.progressStatus[a.request.id].status&&(angular.element(n[0].querySelector(".opt-progress")).remove(),s())}))}}}angular.module("serviceExpert").directive("csOptimizationProgress",e),e.$inject=[]}(),angular.module("serviceExpert").directive("csRange",["$filter","utils",function(a,l){return{restrict:"CAE",link:function(n,e,i){var s=$($(e[0]).find(".showingDates")),r=isAMPM?"ampm":"24",o=$($(e[0]).find(".sliderSelector"));n.$watchCollection(i.ngModel,function(e,t){!o.slider("instance")||e.start===t.start&&e.end===t.end||(o.slider("values",[e.start,e.end]),s.text(i.showingText.replace("{1}",a("ampmOr24")(parseInt(e.start),r,!0)).replace("{2}",a("ampmOr24")(parseInt(e.end),r,!0))))}),o.slider({range:!0,min:parseInt(i.min),max:parseInt(i.max),values:[parseInt(i.defaultStart),parseInt(i.defaultEnd)],slide:function(e,t){e.stopPropagation(),s.text(i.showingText.replace("{1}",a("ampmOr24")(parseInt(t.values[0]),r,!0)).replace("{2}",a("ampmOr24")(parseInt(t.values[1]),r,!0)))},stop:function(e,t){e.stopPropagation(),l.safeApply(n,function(){n[i.ngModel].start=t.values[0],n[i.ngModel].end=t.values[1]})}}),s.text(i.showingText.replace("{1}",a("ampmOr24")(parseInt(i.defaultStart),r,!0)).replace("{2}",a("ampmOr24")(parseInt(i.defaultEnd),r,!0)))},scope:!0,template:'<div class="sliderSelector"></div><span class="showingDates"></span>'}}]),angular.module("serviceExpert").directive("safeBinder",[function(){return{restrict:"A",scope:{safeBinder:"="},link:function(e,t,n){$(t[0]).html(e.safeBinder)}}}]),angular.module("serviceExpert").directive("serviceListColumn",["utils",function(i){return{restrict:"E",link:function(e,t,n){e.isFormulaForImage=i.isFormulaForImage,e.getType=function(){return e.field.FullAPIName===window.fieldNames.Service_Appointment.GanttIcon__c?"gantt-icons":"STRING"!==e.field.Type&&"TEXTAREA"!==e.field.Type||!i.isFormulaForImage(e.service[e.field.FullAPIName])?"normal":"url-formula-icon"}},scope:{service:"=",field:"="},template:'\n            \n            <span>\n                <span ng-if="getType() == \'normal\'">{{service | displayFieldSetField : field}}</span>\n                <img ng-if="getType() == \'gantt-icons\'" class="img-on-service-list" ng-repeat="img in service.icons track by $index" ng-src="{{img}}" track by $index/>\n                <img ng-if="getType() == \'url-icon\'" class="img-on-service-list" ng-src="{{service[field.FullAPIName]}}" />\n                <img ng-if="getType() == \'url-formula-icon\'" class="img-on-service-list" ng-src="{{isFormulaForImage(service[field.FullAPIName])}}" />\n            </span>    \n            '}}]),angular.module("serviceExpert").directive("serviceListPreview",["utils","FieldSetFieldsService","StateService",function(e,t,n){var i=[],r=n.isRtlDirection();return t.fieldsSetFields().then(function(e){i=e.servicePreview}),{restrict:"E",link:function(e,s,t){e.fields=function(){return i},e.handleOver=function(e){e.stopPropagation();var e=document.body.getBoundingClientRect(),t=$(s).find(".service-quick-view")[0].getBoundingClientRect(),n=t.x-e.x+37,i=t.top-e.top,e=e.right-t.right+37,t=$(s).find(".service-preview")[0];t.style.display="inline-block",$(s).find(".service-preview-triangle")[0].style.display="inline-block",document.body.clientHeight<t.clientHeight+t.getBoundingClientRect().y&&(i=document.body.clientHeight-t.clientHeight-26),r?t.style.right=e+"px":t.style.left=n+"px",t.style.top=i+"px"},e.handleOut=function(e){$(s).find(".service-preview-triangle")[0].style.display="none",$(s).find(".service-preview")[0].style.display="none"}},scope:{service:"="},template:'\n            \n            <span>\n                <div class="service-quick-view" ng-mouseenter="handleOver($event)" ng-mouseleave="handleOut($event)">\n                    <svg aria-hidden="true" class="slds-icon">\n                        <use xlink:href="'+window.lsdIcons.info+'"></use>\n                    </svg>\n                </div>\n\n                <div class="service-preview-triangle"></div>\n\n                <div class="service-preview"> \n                    <div class="preview-field-container" ng-repeat="field in fields() track by $index">\n                        <b class="label-preview">{{field.Label}}</b>: <span ng-if="!service[field.APIName]">-</span> <service-list-column service="service" field="field"></service-list-column>\n                    </div>                    \n                </div>\n\n                \n            </span>    \n            '}}]),!function(){function e(){function e(e){e.callMe=function(e,t,n,i){n=n+" "+i;return sendCTIMessage("/CLICK_TO_DIAL?DN="+encodeURIComponent(e)+"&amp;ID="+t+"&amp;ENTITY_NAME=User&amp;OBJECT_NAME="+encodeURIComponent(n)+"&amp;DISPLAY_NAME="+encodeURIComponent("User")),!1}}e.$inject=["$scope"];return{restrict:"E",template:'<span class="tel" style="display: none;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, false);"></img>{{number}}\n                                <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" title="Click to dial disabled"></img>\n                            </span> \n                            <span style="display: block;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, true);"></img>\n                                <a href="javascript:void(0);" onclick="disableClicked(this, \'Click to dial disabled\');" ng-click="callMe(number, userId, userFirstName, userLastName)" title="">{{number}}\n                                    <img src="/img/btn_dial_inline.gif" alt="Click to dial" width="16" height="10" title="Click to dial" style="display: inline;"></img>\n                                    <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" style="display: none;" title="Click to dial disabled"></img>\n                                </a>\n                            </span>',scope:{number:"@",userId:"@",userFirstName:"@",userLastName:"@"},controller:e}}angular.module("serviceExpert").directive("csClickToDial",e),e.$inject=[]}(),angular.module("serviceExpert").directive("dhxScheduler",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService","TimePhasedDataService",function(c,d,u,p,e,m,h,g){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(e,t,n){window.utils=angular.element("#serviceExpertApp").injector().get("utils");var i=_.debounce(function(e){scheduler.updateCollection("resources",e)},500),n=(e.$watch(n.resources,function(e){folderJustToggled?folderJustToggled=!1:i(e)},!0),t.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations(),u.GetUserSettingsProperty("Gantt_View_Start_Hour__c")),s=u.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),r=u.GetUserSettingsProperty("Resource_Row_Height__c"),o=u.GetUserSettingsProperty("View_Capacity_Type__c"),a=u.GetUserSettingsProperty("Include_Weekends__c"),l=u.GetUserSettingsProperty("Load_On_Today__c");null!==r&&schedulerConfig.setRowHeights(r,!1),null!==o&&setCapacityFilter(o),null!==n&&null!==s&&setHoursToDisplay(n,s,a),c.policy=defaultPolicy,p.all([m.promises.territories(),m.promises.resources(),h.fieldsSetFields()]).then(function(){scheduler.init(t[0],new Date,"ZoomLevel3"),e.scheduler=scheduler,e.datalessMethods=attchDatalessSchedulerEvents(),d(function(){l&&scheduler.setCurrentView(new Date),g.promises.initialStmsPhasedData.then(function(){$("#FirstTimeLoading").remove()}),e.getTimePhasedObjects().then(function(){}).catch(function(e){bootstrap.handleError(e)}),c.$broadcast("initCompleted")},20)}).catch(function(e){console.log("err:"+e)})}}}]),angular.module("serviceExpert").directive("dragNA",function(){return{restrict:"CAE",scope:{dragService:"="},link:function(e,t,n,i){cachedDomElements.draggedBreak||(cachedDomElements.draggedBreak=$("#draggedBreak")),cachedDomElements.draggedBreakDiv||(cachedDomElements.draggedBreakDiv=$("#draggedBreak div")),t.bind("dragstart",function(e){var t,n=$("#breakDuration").val(),i=(e.originalEvent.dataTransfer.setData("text","absenceNA_"+n),cachedDomElements.draggedBreakDiv.html(n),getMinAndMaxHoursToDisplay()),s=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),i=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),n=(i.setMinutes(i.getMinutes()+n),getXPositionOfEvent({start_date:s,end_date:i},!1,scheduler.matrix[scheduler._mode])),s=getXPositionOfEvent({start_date:s,end_date:i},!0,scheduler.matrix[scheduler._mode])-n+4,i=(cachedDomElements.draggedBreak.css("width",s+"px"),document.getElementById("draggedBreak").cloneNode(!0));document.body.appendChild(i),"setDragImage"in window.DataTransfer.prototype&&(t="rtl"===document.querySelector("html").getAttribute("dir")?s:0),e.originalEvent.dataTransfer.setDragImage(i,t,40)})}}}),angular.module("serviceExpert").directive("draggableService",["utils","servicesService","SERVICE_STATUS","SERVICE_CATEGORY","StateService",function(a,e,t,l,c){return{restrict:"CAE",scope:{dragService:"="},link:function(o,e,t,n){cachedDomElements.draggedEvent||(cachedDomElements.draggedEvent=$("#draggedEvent")),cachedDomElements.draggedEventDiv||(cachedDomElements.draggedEventDiv=$("#draggedEvent div")),e.bind("dragstart",function(e){e.originalEvent.dataTransfer.setData("text",o.dragService.id);var t="<b>"+(o.dragService.ganttLabel||o.dragService.name)+"</b><br/>"+o.dragService.estDuration+" "+o.dragService.durationType,t=(cachedDomElements.draggedEventDiv.html(t),getMinAndMaxHoursToDisplay()),n=new Date(scheduler._min_date.getTime()+1e3*t.min*60*60),t=new Date(scheduler._min_date.getTime()+1e3*t.min*60*60),i=(o.dragService.durationType?o.dragService.durationType===a.durationTypes.minutes?t.setMinutes(t.getMinutes()+o.dragService.estDuration):o.dragService.durationType===a.durationTypes.hours?t.setMinutes(t.getMinutes()+Math.floor(60*o.dragService.estDuration)):o.dragService.durationType===a.durationTypes.days&&t.setMinutes(t.getMinutes()+Math.floor(60*o.dragService.estDuration*24)):o.dragService.setMinutes(t.getMinutes()+60),getXPositionOfEvent({start_date:n,end_date:t},!1,scheduler.matrix[scheduler._mode])),n=getXPositionOfEvent({start_date:n,end_date:t},!0,scheduler.matrix[scheduler._mode])-i+4,s="";switch(o.dragService.statusCategory){case l.NONE:s=" eventStatusNew";break;case l.SCHEDULED:s=" eventStatusAssigned";break;case l.DISPATCHED:s="eventStatusDispatched";break;case l.IN_PROGRESS:s=" eventStatusTravel";break;case l.COMPLETED:s=" eventStatusCompleted";break;case l.COULD_NOT_COMPLETE:s=" eventStatusCouldntComplete";break;case l.CANCELED:s=" eventStatusCancelled";break;default:s=" eventCustomStatus"}cachedDomElements.draggedEvent.css("width",n+"px"),cachedDomElements.draggedEvent.removeClass(),cachedDomElements.draggedEvent.addClass(s),o.dragService.ganttColor?cachedDomElements.draggedEvent.css("background",o.dragService.ganttColor):cachedDomElements.draggedEvent.css("background","");var r,t=document.getElementById("draggedEvent").cloneNode(!0);document.body.appendChild(t),"setDragImage"in window.DataTransfer.prototype&&(r=c.isRtlDirection()?n:0),e.originalEvent.dataTransfer.setDragImage(t,r,28)})}}}]).directive("dragTarget",["$rootScope","$filter","utils","servicesService","sfdcService","kpiCalculationsService","ResourcesAndTerritoriesService","AbsencesService","TimePhasedDataService","SERVICE_CATEGORY","StateService","OptimizationRequestsService",function(e,t,S,y,n,b,_,w,T,L,A,C){return{restrict:"CAE",link:function(f,e,t,n){var o=Date.now();e.bind("dragover",function(e){var t,n,i,s,r;cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix")),e.preventDefault(),scheduler.config.readonly||Date.now()-o<500||(o=Date.now(),i=scheduler.getActionData(e.originalEvent),t=_.getResources()[i.section.split("_")[0]],n=i.section.split("_")[1],t&&n&&(n=S.getLocationOffset(i.date,n)-S.getUserOffset(i.date),(r=new Date(i.date)).setMinutes(r.getMinutes()+n),t.name&&(!t.isCapacityBased||t.isCapacityBased&&!contractorSupport)?(r=new Date(i.date),s=(i=i.date.getMinutes())%serviceJumpsOnGantt,r=(i=serviceJumpsOnGantt-i%serviceJumpsOnGantt)<s?new Date(r.getTime()+60*i*1e3):new Date(r.getTime()-60*s*1e3),i=moment(r).format("lll"),(s=new Date(r)).setMinutes(s.getMinutes()+n),r=moment(s).format("lll"),e.originalEvent.ctrlKey?cachedDomElements.timesDragFix.html("<b>"+t.name.encodeHTML()+"</b> "+customLabels.SnapOn+" "+i+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+r)):cachedDomElements.timesDragFix.html("<b>"+t.name.encodeHTML()+"</b> "+customLabels.on+" "+i+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+r)),cachedDomElements.timesDragFix.show()):cachedDomElements.timesDragFix.hide()))}),e.bind("dragleave",function(e){cachedDomElements.timesDragFix.hide(),e.preventDefault()}),e.bind("drop",function(e){if(e.preventDefault(),void 0!==cachedDomElements.draggedEvent&&cachedDomElements.draggedEvent.removeClass(),cachedDomElements.timesDragFix.hide(),!scheduler.config.readonly){var t=scheduler.getActionData(e.originalEvent),n=new Date(t.date),i=t.date.getMinutes(),s=i%serviceJumpsOnGantt,i=serviceJumpsOnGantt-i%serviceJumpsOnGantt,n=i<s?new Date(n.getTime()+60*i*1e3):new Date(n.getTime()-60*s*1e3),i=(t.date=n,_.getResources()[t.section.split("_")[0]]);_.territories()[t.section.split("_")[1]];if(i&&i.name){var r,o,s=e.originalEvent.dataTransfer.getData("text");if(-1<s.indexOf("absenceNA_"))return $("#naOptionsContainer").hide(),n=s.substr(10,s.length-10),n=parseInt(n),(r=new Date(t.date)).setMinutes(r.getMinutes()+n),o={end_date:r,resource:i.id,start_date:t.date,start:t.date,absenceType:"None"==f.defaultDragNa.selectedNaType?null:f.defaultDragNa.selectedNaType,ganttLabel:f.defaultDragNa.selectedNaLabel},void S.safeApply(f,function(){y.handleSnap(o,e),w.saveNewAbsence(o,A.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e.error?S.addNotification(customLabels.Action_Could_Not_Be_Performed,e.error):S.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})});var a=T.serviceAppointments()[s];if(a){n=new Date(t.date);if(a.durationType?a.durationType==S.durationTypes.minutes?n.setMinutes(n.getMinutes()+a.estDuration):a.durationType==S.durationTypes.hours?n.setMinutes(n.getMinutes()+Math.floor(60*a.estDuration)):a.durationType==S.durationTypes.days&&n.setDate(n.getDate()+Math.floor(a.estDuration)):n.setMinutes(n.getMinutes()+60),!C.isTerritoryHasInDayOptimizationInProgress(t.date,n,t.section.split("_")[1])||!1!==confirm(customLabels.In_Day_Optimization_In_Progress_Confirm)){if(contractorSupport&&i.isCapacityBased){for(var l=!1,c=!0,d=scheduler.getEvents(t.date,n),u=0;u<d.length;u++)-1<d[u].resourceId.indexOf(t.section)&&"contractorcapacity"==d[u].type&&(l=!0,d[u].timePeriod==S.ganttSettings.capacityDuration&&(c=!1));if(!l)return void alert(customLabels.serviceCantBeAssignedWithoutCapacity);c&&alert(customLabels.is_assigned_to_contractor.replaceAll(a.name,i.name)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}var p,m,h=angular.copy(a),g=(h.end_date=n,h.resourceId=t.section,h.start_date=new Date(t.date),h.assignedResource=null,{statusCategory:L.SCHEDULED,isDummy:!0,id:h.id+"_dummy"}),v=angular.copy(h);for(m in g)v[m]=g[m];p=scheduler.addEvent(v),S.safeApply(f,function(){y.handleSnap(h,e.originalEvent),y.saveChangesToServiceAppointment(a,h).then(function(e){b.calculateKpis()}).catch(function(e){console.warn("Couldn't update service. "+e[2]),S.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message||customLabels.user_is_not_allowed_to_perform_action),scheduler.deleteEvent(p)&&scheduler.parse([e[1]],"json")})})}}}}})}}}]),angular.module("serviceExpert").directive("googlePlaces",function(){return{restrict:"E",replace:!0,scope:{myMap:"=",searchMarker:"="},template:'<input id="google_places_ac" name="google_places_ac" type="text" class="input-block-level"/>',link:function(t,e,n){var i=new google.maps.places.Autocomplete($("#google_places_ac")[0],{});google.maps.event.addListener(i,"place_changed",function(){var e=i.getPlace();t.searchMarker?t.searchMarker.setPosition(e.geometry.location):t.searchMarker=new google.maps.Marker({map:t.myMap,position:e.geometry.location}),e.geometry.viewport?t.myMap.fitBounds(e.geometry.viewport):(t.myMap.setCenter(e.geometry.location),t.myMap.setZoom(17))})}}}),angular.module("serviceExpert").directive("csGroupActions",["$compile",function(u){function p(e,t,n){return Math.ceil($(e).offset().top)>=t+n}return{restrict:"A",link:function(a,l){var c=$('<ul class="moreQuickActionsContainer"></ul>'),d=void 0;angular.element(l[0]).on("click",function(e){e.stopPropagation(),$("#MainActionContainer").hide();var t=$(l).parent().parent().children(),e=$(t).last(),n=$(t).first(),i=$(n).offset().top,s=$(n).outerHeight(!0);if(c.hasClass("viewMoreActive"))return c.removeClass("viewMoreActive"),c.empty(),void c.remove();if(p($(e),i,s)){for(var r,o=t.length-1;1<o;o--)d=$(t[o]),p(d,i,s)&&(r=$("<li></li>"),d.find("> div:first-child").clone().removeClass("quickActionGoLeft quickCustomActionGoLeft").addClass("menuQuickAction").css({marginBottom:"0",border:"none",width:"87%"}).appendTo(r),r.css({display:"block"}).appendTo(c),u(r)(a));$(c.children().get().reverse()).appendTo(c),$(l).append(c),c.addClass("viewMoreActive"),c.show();n=c.offset().top,e=c.outerHeight(!0);p($("#TaskListPagination"),n,e)||$("#TaskListItems").animate({scrollTop:$("#TaskListItems").scrollTop()+(180<36*c.children().length?180:36*c.children().length)},500)}angular.element("body").on("mousedown",function(e){for(var t=["moreQuickActionsBtn","menuQuickAction","fa-caret-down"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;c.hasClass("viewMoreActive")&&(c.removeClass("viewMoreActive"),c.empty(),c.remove(),angular.element("body").off("mousedown"))})})}}}]).directive("csLastAction",["utils","listQuickActionsService",function(s,r){return{restrict:"A",link:function(e,t,n){var t=$(t),e=e.service,n=n.csLastAction,i=s.getCustomActions("list");r.isLastVisibleQuickAction(n,e)&&0===i.length&&((n=t).hide(),n.parent().children()[0].classList.add("lastQuickAction"))}}}]),angular.module("serviceExpert").directive("keypressEvents",["$rootScope","StateService",function(t,n){var i=[13,16,18,27,37,38,39,40,48,49,50,51,55,69,70,73,77,79,83,84,85,87,90,96,97,98,99,103];return{restrict:"C",link:function(){angular.element("body").bind("keydown",function(e){n.isUserIdle()||(-1<i.indexOf(e.which)?t.$broadcast("keypress",e):e.stopPropagation())})}}}]).directive("fslKeyPress",function(){return{restrict:"A",link:function(e,t,n){t.bind("keypress",function(e){e.stopPropagation(),13!==e.keyCode&&32!==e.keyCode||angular.element(e.target).trigger("click")})}}}).directive("fslTabSwitch",function(){var a=37,l=38,c=39,d=40,u={37:-1,38:-1,39:1,40:1};return{restrict:"A",link:function(e,t,o){t.bind("keydown",function(e){if(e.keyCode===a||e.keyCode===c||e.keyCode===l||e.keyCode===d){for(var t=e,n=o.role,i=t.keyCode,s=t.target.parentElement.querySelectorAll('[role="'+n+'"]'),r=0;r<s.length;++r)s[r].index=r;void 0!==u[i]&&void 0!==(n=t.target).index&&(s[n.index+u[i]]?s[n.index+u[i]].focus():i===a||i===l?s[s.length-1]&&s[s.length-1].focus():i!==c&&i!==d||s[0]&&s[0].focus()),e.stopPropagation(),e.preventDefault()}})}}}),!function(){function e(e,o,t){return{restrict:"E",link:function(r){r.optimizationRequests={},r.optRunning=0,r.optQueued=0,r.replaceText=function(e,t){return customLabels[e].replaceAll(t.toString())},t.register("optimizationRequests",function(e){for(var t=0,n=0,i=0;i<e.length;i++){var s=new OptimizationRequest(e[i]);"Queued"==s.status&&n++,"In Progress"==s.status&&t++,r.optimizationRequests[s.id]&&"Completed"==s.status&&"Completed"!=r.optimizationRequests[s.id].status&&o.addNotification(customLabels.Optimization_Completed,customLabels.x_services_were_sched_out_of.replaceAll(s.scheduledAmount,s.objectToScheduled)+".",function(e){o.openSObjectLink("../"+e)},s.id),r.optimizationRequests[s.id]&&"Failed"==s.status&&"Failed"!=r.optimizationRequests[s.id].status&&o.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){o.openSObjectLink("../"+e)},s.id),r.optimizationRequests[s.id]=s}r.optQueued=n,r.optRunning=t})},scope:{},template:'\n                <div id="optInProgress" ng-show="optRunning">\n                    '+customLabels.Optimization_in_progress+"\n\t            \t<span ng-show=\"optRunning > 1\">{{ replaceText('XoptimizationRunning',optRunning) }}</span>\n\t            \t<span ng-show=\"optQueued\">{{ replaceText('XoptimizationQueued',optQueued) }}</span>\n        \t\t</div>"}}e.$inject=["DeltaService","utils","RegisterService"],angular.module("serviceExpert").directive("optimizationIndicator",e)}(),angular.module("serviceExpert").directive("csStopPropagation",[function(){return{restrict:"A",link:function(e,t,n){angular.element(t[0]).on(n.csStopPropagation,function(e){e.stopPropagation()})}}}]),angular.module("serviceExpert").directive("csToggle",[function(){return{restrict:"A",link:function(e,t,n){for(var i=$("#"+n.csToggle),s=$("[cs-toggle]"),r={},o=0;o<s.length;o++){var a=$(s[o]);r[a.attr("id")]=$("#"+a.attr("cs-toggle"))}1===i.length&&(angular.element(t[0]).on("click",function(e){for(var t in e.stopPropagation(),$(".moreQuickActionsContainer").hide(),scheduler.isCalendarVisible()&&scheduler.destroyCalendar(),r)t!==e.currentTarget.id?(r[t].hide(),$(".dhx_mini_calendar").hide()):i.toggle()}),angular.element(t[0]).on("keyup",function(e){13===e.keyCode&&i.children()[0].focus()}),angular.element("body").on("click",function(e){for(var t in r)r[t].hide()}),i.children().on("keydown",function(e){if(27===e.keyCode)for(var t in r)r[t].hide()}))}}}]),angular.module("serviceExpert").directive("csTooltip",[function(){return{restrict:"E",transclude:!0,template:'<div class="gantt-tooltip-info-button">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n                                <span class="gantt-tooltip-wrapper" ng-transclude></span>',link:function(e,i,t){var s=!0;i.find(".gantt-tooltip-info-button").bind("mouseenter mouseleave",function(){var e=i.find(".gantt-tooltip-wrapper"),t=e.outerHeight(),n=i.offset();e.toggleClass("active-tooltip"),s&&(s=!1,e.css("top",n.top-t-10+"px"),e.css("position","fixed"),e.css("bottom","initial"))})}}}]),angular.module("serviceExpert").factory("SERVICE_CATEGORY",function(){return{NONE:"None",SCHEDULED:"Scheduled",DISPATCHED:"Dispatched",IN_PROGRESS:"InProgress",COULD_NOT_COMPLETE:"CannotComplete",COMPLETED:"Completed",CANCELED:"Canceled"}}),angular.module("serviceExpert").factory("SERVICE_STATUS",function(){return serviceStatuses}),angular.module("serviceExpert").constant("PARENT_RECORD_TYPE",{WORKORDER:"WorkOrder",LINEITEM:"WorkOrderLineItem",ACCOUNT:"Account"}),angular.module("serviceExpert").constant("DRAWING_STATES",{NONE:0,EDIT:1,DRAW:2,SELECTED:3,INTERSECT:4}),angular.module("serviceExpert").constant("POST_MESSAGE_TYPE",{INIT:0,SHOW_ON_MAP:1,DRAW_MARKERS:2}),!function(){function e(e,t,c,n,d,i,s){var l={},u={},r={},o={},p={};function a(e){if(e.type===o.IN_DAY){if("In Progress"===e.status||"Completed"===e.status&&p[e.id]&&"Completed"!==p[e.id].status||"In Progress"===e.status&&p[e.id]&&"Aborted"!==p[e.id].status)e.timespan=function(e){var t=[];if(e.territories){for(var n={},i=0;i<e.territories.length;i++)n[e.territories[i].serviceTerritory]=!0;var s,r=d.getGanttSectionsIdsByTerritory(n,e.start);for(s in r){var o,a={start:e.start,end:e.finish};for(o in useLocationTimezone||(a.start=c.convertDateBetweenTimeZones(e.start,userTimeZone,r[s].tz),a.end=c.convertDateBetweenTimeZones(e.finish,userTimeZone,r[s].tz)),u[s]||(u[s]={}),u[s][e.id]=a,r[s].resources){var l=scheduler.addMarkedTimespan({start_date:a.start,end_date:a.end,sections:{ZoomLevel2:o+"_"+s,ZoomLevel3:o+"_"+s,ZoomLevel4:o+"_"+s,ZoomLevel5:o+"_"+s,ZoomLevel6:o+"_"+s,ZoomLevel7:o+"_"+s},css:"smart-on-gantt-inday-body"});t.push(l)}}}return t}(e);else if("Completed"===e.status||"Failed"===e.status||"Aborted"===e.status)for(var t=0;t<e.territories.length;t++)u[e.territories[t].serviceTerritory]&&u[e.territories[t].serviceTerritory][e.id]&&delete u[e.territories[t].serviceTerritory][e.id]}else"Failed"!==e.status&&"Aborted"!==e.status&&"Completed"!==e.status&&"Global Optimization"!==e.type&&e.start&&e.finish&&(e.timespan=[function(e){if(!e.resource)return(new Date).getTime();var t=void 0,n=d.getResoruceGanttIdByDate(e.resource,e.start),i="reshufle-on-gantt",s="";{if(!n)return(new Date).getTime();t=n.split(",")}switch(e.type){case"Fix Overlaps":i="fix-overlaps-on-gantt",s=customLabels.FixOverlaps;break;case"SA Reshuffle":i="reshufle-on-gantt",s=customLabels.Reshuffle;break;case"Fill-In Schedule":i="fillin-on-gantt",s=customLabels.Fill_in_Schedule;break;case"Group Nearby SAs":i="group-near-on-gantt",s=customLabels.GroupNearby;break;case"Resource Schedule Optimization":i="resource-day-on-gantt",s=customLabels.RDOptimize;break;default:i="reshufle-on-gantt"}{var r;window.useLocationTimezone&&e.territories&&e.territories[0]&&"Resource Schedule Optimization"!==e.type?(n=c.getLocationOffset(e.start,e.territories[0].serviceTerritory),r=c.getLocationOffset(e.finish,e.territories[0].serviceTerritory),e.start.setMinutes(e.start.getMinutes()+n),e.finish.setMinutes(e.finish.getMinutes()+r)):e.territories&&e.territories[0]&&"Resource Schedule Optimization"===e.type&&(n=c.getLocationOffset(e.start,e.territories[0].serviceTerritory),r=c.getLocationOffset(e.finish,e.territories[0].serviceTerritory),e.start=new Date(e.start.getTime()-60*n*1e3+60*c.getUserOffset(e.start)*1e3),e.finish=new Date(e.finish.getTime()-60*r*1e3+60*c.getUserOffset(e.finish)*1e3))}return scheduler.addMarkedTimespan({start_date:e.start,end_date:e.finish,sections:{ZoomLevel2:t,ZoomLevel3:t,ZoomLevel4:t,ZoomLevel5:t,ZoomLevel6:t,ZoomLevel7:t},css:"smart-on-gantt "+i,html:"<div><span>"+s+"</span></div>"})}(e)])}function m(e){if(!c.hasCustomPermission("Abort_Optimization_Request"))return!1;if(p[e.id]&&p[e.id].aborting)return!1;if("Completed"===e.status||"Aborted"===e.status||"Failed"===e.status||"Finalizing"===e.status)return!1;for(var t in o)if(e.type==o[t])return!0;return!1}return e.all([d.promises.initialPhasedData,i.promises.policies(),t.getOptimizationRequests(),t.callRemoteAction(RemoteActions.getOptimizationsRequestTypes)]).then(function(e){e[1].forEach(function(e){r[e.Id]=e}),o=e[3],e[2].forEach(function(e){l[e.Id]=new OptimizationRequest(e),p[e.Id]={canAbort:m(l[e.Id]),status:l[e.Id].status,objectToScheduled:l[e.Id].objectToScheduled,aborting:!1,progressInterval:null},a(l[e.Id])})}),n.register("optimizationRequests",function(e){e.forEach(function(e){var t=new OptimizationRequest(e);if(l[e.Id]&&l[e.Id].timespan)for(var n=0;n<l[e.Id].timespan.length;n++)scheduler.deleteMarkedTimespan(l[e.Id].timespan[n]);if(l[e.Id]&&"Global Optimization"===l[e.Id].type)for(var i in t)l[e.Id][i]=t[i];else l[e.Id]=t;p[e.Id]?p[e.Id].canAbort=m(t):p[e.Id]={canAbort:m(t),status:t.status,objectToScheduled:t.objectToScheduled,aborting:!1,progressInterval:null},a(t)}),updateViewDebounced()}),{getNumOfActiveOptimizationRequests:function(){var e,t=0;for(e in l)"Completed"!==l[e].status&&"Failed"!==l[e].status&&"Aborted"!==l[e].status&&t++;return t},optimizationRequests:function(){return l},isTerritoryHasInDayOptimizationInProgress:function(e,t,n){if(u[n])for(var i in u[n])if(isIntersect(u[n][i].start,u[n][i].end,e,t))return l[i];return!1},policies:r,OptimizationRequestsProgressStatus:p,generateRequestResultText:function(e){if(e.failureReason&&0<e.failureReason.length)return"User Aborted"===e.failureReason?e.failureDetails:e.failureReason;if(e.type==o.RSO&&s.getResources()[e.resource])return customLabels.rso_optimization_request_for_name.replaceAll(e.resourceName);if(e.type==o.IN_DAY||e.type==o.BGO){var t=[];if(e.territories.forEach(function(e){t.push(e.serviceTerritoryName)}),t=3<t.length?t.length+" "+customLabels.UTterr:t.join(", "),"In Progress"==e.status)return customLabels.optimization_for_terr_in_progress.replaceAll(e.type,t);if("Completed"==e.status)return customLabels.optimization_for_terr_completed.replaceAll(e.type,t,e.scheduledAmount)}return e.result},calculateIndayProgress:function(n){var e=void 0;if("Completed"==n.status)return p[n.id].status="Completed",setTimeout(function(){if(l[n.id]&&l[n.id].timespan)for(var e=0;e<l[n.id].timespan.length;e++)scheduler.deleteMarkedTimespan(l[n.id].timespan[e]);for(var t=0;t<n.territories.length;t++)u[n.territories[t].serviceTerritory]&&u[n.territories[t].serviceTerritory][n.id]&&delete u[n.territories[t].serviceTerritory][n.id]},2e3),{percent:100,text:customLabels.In_Day_Optimization_Completed};"In Progress"==n.status&&p[n.id]&&"Aborted"==p[n.id].status?e=customLabels.In_Day_Optimization_Aborting:(e=customLabels.In_Day_Optimization_In_Progress,p[n.id].status="In Progress");var t=__gantt.inday,i=n.objectToScheduled,i=t.maxRunTimeSingleService*i,s=null!=n.requestProgressStart?(new moment).diff(moment(n.requestProgressStart),"seconds"):0,r=(i>=t.maxRuntimeOverall&&(t.maxRuntimeOverall,t.maxRunTimeSingleService,i=t.maxRuntimeOverall),0!==i?s/i*100:0),o=7,a=0;return i<=s&&"In Progress"==n.status&&(o=7+(s-i)/t.maxRunTimeSingleService*.1,a=90),100<=(a=a<90?r:a)&&100<=r?a=100:90<=a&&(o+=.1,a=Math.round(Math.atan(o)/(Math.PI/2)*100*1e3)/1e3),{percent:100!==a?a.toFixed(1):a,text:e}},updateProgressStatus:function(e,t){p[e]?p[e].status=t:p[e]={status:t}},canAbortOR:m,abortOptRequest:function(e){confirm(customLabels.confirm_abort_current_optimization)&&(e.status="Aborting",p[e.id]?(p[e.id].aborting=!0,p[e.id].canAbort=!1):p[e.id]={aborting:!0,canAbort:!1},t.callRemoteAction(RemoteActions.abortOptimizationRequest,e.id).then().catch(function(e){console.warn(e)}))}}}e.$inject=["$q","sfdcService","utils","RegisterService","TimePhasedDataService","StateService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("OptimizationRequestsService",e)}(),angular.module("serviceExpert").factory("listQuickActionsService",["BundleActions","BundleService","utils","SERVICE_STATUS","SERVICE_CATEGORY","StateService",function(t,n,i,s,r,o){var a=[];function l(e){for(var t=CustomSettings.pinnedStatusesSF.split(","),n=0;n<t.length;n++)if(e===t[n])return 1}i.customActionsPromise.then(function(){var e=i.getCustomActions("list");a.push.apply(a,_toConsumableArray(e))});var c={flagUnflag:function(e){return!0},schedule:function(e){return!e.pinned&&e.status!=s.COMPLETED&&e.statusCategory!=r.CANCELED&&!l(e.status)&&i.hasCustomPermission("Schedule")&&(!n.isActive()||!n.isBundleMember(e))},getCandidates:function(e){return!(!(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)||e.pinned||e.status==s.COMPLETED||e.statusCategory==r.CANCELED||l(e.status)||n.isActive()&&n.isBundleMember(e))},edit:function(e){return!0},reshuffle:function(e){return!e.pinned&&i.hasCustomPermission("Reshuffle")&&(!n.isActive()||!n.isBundleMember(e))},groupNearby:function(e){return e.isScheduled()&&e.latitude&&e.longitude&&i.hasCustomPermission("Group_Nearby")&&(!n.isActive()||!n.isBundleMember(e))},dispatch:function(e){return!(e.pinned||e.status!=s.SCHEDULED||n.isActive()&&n.isBundleMember(e))},gantt:function(e){return!!(e=n.verifyShowSaOnGantt(e))&&e.isScheduled()},map:function(e){return o.isMapEnabled()&&e.latitude&&e.longitude},bundle:function(e){return i.hasCustomPermission("Bundle_Unbundle")&&t.Bundle.canInvoke([e])},unbundle:function(e){return i.hasCustomPermission("Bundle_Unbundle")&&t.Unbundle.canInvoke([e])}},e={shouldShowQuickActionBtn:function(e,t){return!(!t||!c[e])&&c[e](t)},isLastVisibleQuickAction:function(e,t){if(0<a.length)return!1;var n,i=!1;for(n in c)if(i){if(this.shouldShowQuickActionBtn(n,t))return!1}else if(e==n){if(!this.shouldShowQuickActionBtn(e,t))return!1;i=!0}return i}};return e}]),angular.module("serviceExpert").factory("servicesService",["$q","$rootScope","BundleService","sfdcService","utils","userSettingsManager","monthlyViewHelperService","TimePhasedDataService","ServiceAppointmentLightboxService","kpiCalculationsService","bulkResultsService","SERVICE_STATUS","SERVICE_CATEGORY","StateService","MstResolver","DeltaService",function(h,e,p,g,v,a,t,w,f,d,S,n,i,y,b,T){var s=new Date,L=(s.setDate(s.getDate()+3),window.globalStatuses=n,window.globalCategories=i,{servicesObjects:{},recentlyUsed:{},flagged:flaggedServices,filteredServices:{servicesArray:[]},filter:{searchOnServer:null,advancedFilter:{statusCheckboxs:{New:!0,Assigned:!0,Dispatched:!0,Travel:!0,"On Site":!0,Incomplete:!0},selectedDates:{dueDate:!0,appEnd:!0,end_date:!0},minDate:new Date(Date.now()-6048e5),maxDate:new Date(Date.now()+6048e5),servicePriority:10,jeopardies:!0,violations:!0,unScheduled:!0},selectedFiled:{appEnd:!0,appStart:!0,dueDate:!0,earlyStart:!0,finish:!0,start:!0,display:!0},selectedFilter:a.GetUserSettingsProperty("Selected_List_View__c")||(customPermissions.Service_List_Todo?"Todo":"All"),orderByField:"start",reverse:!1,SearchText:"",endDate:s,currentPage:1,servicesPerPage:200,totalServices:0,totalPages:1}});if(a.GetUserSettingsProperty("Date_Horizon_Properties__c")){var r,o=JSON.parse(a.GetUserSettingsProperty("Date_Horizon_Properties__c"));for(r in o)L.filter.selectedFiled[r]=o[r]}function A(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function l(n,i,s,e){var r=3<arguments.length&&void 0!==e&&e,o={};n.schedulingResult&&Array.isArray(n.schedulingResult)&&n.schedulingResult[0]?(o.partialResults=n.schedulingResult[0].PartialResults||[],0===n.services.length?g.callRemoteAction(RemoteActions.getServicesById,[s]).then(function(e){o.absences=w.updateTimePhaseData(n.na,"na",!r).absences,o.services=w.updateTimePhaseData(n.services,"service",!r).services,(t=o.services).push.apply(t,_toConsumableArray(w.updateTimePhaseData(e,"service",!r).services));var t=a.GetUserSettingsProperty("locations");1===e.length&&-1===t.indexOf(o.services[o.services.length-1].ServiceTerritoryId)&&v.addNotification(customLabels.SchedulingResult,customLabels.WasScheduledToFilteredTeritory.replace("$0",o.services[o.services.length-1].AppointmentNumber)),i.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getRelatedServices(s)).then(L.drawViolationsOnGantt)}):(o.absences=w.updateTimePhaseData(n.na,"na",!r).absences,o.services=w.updateTimePhaseData(n.services,"service",!r).services,i.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getRelatedServices(s)).then(L.drawViolationsOnGantt))):(o.absences=w.updateTimePhaseData(n.na,"na",!r).absences,o.services=w.updateTimePhaseData(n.services,"service",!r).services,i.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getRelatedServices(s)).then(L.drawViolationsOnGantt))}return v.ganttSettings&&(L.filter.servicesPerPage=parseInt(v.ganttSettings.servicesPerPage)),L.checkRules=function(e){var t,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:-1;if(-1===r&&(r=window.__gantt.maxIterationsOfCheckRules),0===(e=e.filter(function(e){return w.serviceAppointments()[e]&&w.serviceAppointments()[e].isScheduled()})).length)return(t=h.defer()).resolve([]),t.promise;for(var o=function(e){var t=window.__gantt.maxResourcesForCheckRules,n=window.__gantt.dayRangeForCheckRules,i=window.__gantt.maxServicesForCheckRules,s={},r=[],o=null,a=null,l={},c=0,d=0,u=0,p=0;e.forEach(function(e){var t=w.serviceAppointments()[e],n=A(t.start);(!o||o>t.start)&&(o=t.start),(!a||a<t.start)&&(a=t.start),s[t.resource]=s[t.resource]||{},s[t.resource][n]=s[t.resource][n]||[],s[t.resource][n].push(e)});for(var a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1),m=new Date(o);m<a;m.setDate(m.getDate()+1)){var h,g=A(m);for(h in++p===n&&(u++,p=c=d=0,l={}),s){if(s[h][g])if(r[u]=r[u]||[],(v=r[u]).push.apply(v,_toConsumableArray(s[h][g])),i<=(d+=s[h][g].length)&&(u++,p=c=d=0,l={}),!l[h]&&(l[h]=!0,++c===t)){if(d<=i){var v=new Date(m),f=(v.setDate(v.getDate()+1),new Date(v));f.setDate(f.getDate()+n-p+1);for(var S=v;S<f;S.setDate(S.getDate()+1)){var y,b,_=A(S);for(y in l)if(s[y][_]&&((b=r[u]).push.apply(b,_toConsumableArray(s[y][_])),d+=s[y][_].length),delete s[y][_],i<=d)break;if(i<=d)break}}u++,p=c=d=0,l={}}delete s[h][g]}}return r=r.filter(function(e){return e})}(e),a=[],l={},c=h.defer(),n=0;n<o.length;n++)a.push(h.defer()),a[n].promise.then(function(i){g.checkRules(o[i],y.selectedPolicyId).then(function(e){for(var t in r--,o[i].forEach(function(e){return l[e]=!0}),e){delete l[t];var n=w.serviceAppointments()[t];0<e[t].length&&n?(n.violations=e[t],s.push(t)):n&&(n.violations=null)}if(0===r)return d.calculateKpis(),c.resolve(s),void(a[i+1]&&v.addNotification(window.customLabels.ValidateRulesApiExceededTitle,window.customLabels.ValidateRulesApiExceededMessage));a[i+1]?a[i+1].resolve(i+1):0===Object.keys(l).length?(d.calculateKpis(),c.resolve(s)):L.checkRules(Object.keys(l),s,r).then(function(e){d.calculateKpis(),c.resolve([].concat(_toConsumableArray(e),_toConsumableArray(s)))})}).catch(function(e){v.addNotification(customLabels.Rule_validation_failed,e.message),c.reject(e),console.warn("rule checking failed"),console.log(e)})});return a[0].resolve(0),c.promise},L.postToChatter=function(e,t){var n=h.defer();return g.callRemoteAction(RemoteActions.postToChatter,e,t).then(function(e){n.resolve(e)}),n.promise},L.sortServicesByPriority=function(e){var t=h.defer();return g.callRemoteAction(RemoteActions.sortServicesByPriority,e).then(function(e){t.resolve(e)}),t.promise},L.autoScheduleService=function(s){var r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=h.defer();return null==window.userHasAdminPermissions&&g.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=e}),g.autoScheduleService(s,y.selectedPolicyId).then(function(e){var t,n,i;e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&(n=e.schedulingResult[0].PartialResults||[],t="",0<n.length&&(window.userHasAdminPermissions?n.forEach(function(e){t+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):t+=customLabels.ContactSysAdmin,""!==t&&v.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),t))),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&e.schedulingResult[0].LongOperationId?b.getUpdates(e.schedulingResult[0].LongOperationId).then(function(e){e.services&&(e.mst=!0,r?l(e,o,s,!0):o.resolve(e))}).catch(function(e){console.error(e),o.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):(e.services=e.deltaResult.updatedGanttServices,e.na=e.deltaResult.updatedAbsence,n="On Demand"!==window.__gantt.checkRulesMode,T.handleDeltaResponse(e.deltaResult,n),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&(n=e.schedulingResult[0].PartialResults||[],i="",0<n.length&&(window.userHasAdminPermissions?n.forEach(function(e){i+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):i+=customLabels.ContactSysAdmin,""!==i&&v.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),i))),l(e,o,s))}).catch(function(e){var t;e.message&&(e.message.includes("Too many SOQL queries")||e.message.includes("Apex CPU time limit"))?(t="On Demand"!==window.__gantt.checkRulesMode,T.getDelta(t)):console.log(e),o.reject(e)}),o.promise},L.saveChangesToServiceAppointment=function(o,a){var e,l=h.defer(),c=new Date(a.start_date.getTime()+1e3*a.travelTo),d=new Date(a.end_date.getTime()-1e3*a.travelFrom),t=!!a.savedFromScheduleHereAndConsecutive,n=(useLocationTimezone&&(e=w.getIntersectingSrstOffset(a,a.getGanttResource()),n=v.getUserOffset(c),i=v.getUserOffset(d),c.setMinutes(c.getMinutes()+n-e),d.setMinutes(d.getMinutes()+i-e)),L.recentlyUsed[o.id]=!0,a.snapToId&&a.ServiceAppointmentLastModifiedDate--,null),i=null;if(a.snapToId){var s,r,u=[],p=scheduler._events[a.snapToId].end||scheduler._events[a.snapToId].finish;for(s in scheduler._events)s!==a.id&&((r=scheduler._events[s]).resourceId===a.resourceId&&"break"!==r.type&&r.latitude&&isIntersect(r.start_date,r.end_date,scheduler._min_date,p)&&u.push(s));u.sort(function(e,t){return scheduler._events[e].start>scheduler._events[t].start?-1:scheduler._events[e].start<scheduler._events[t].start?1:0}),0<u.length&&(n=scheduler._events[u[0]].latitude,i=scheduler._events[u[0]].longitude)}var m=null;return a.isImmidietlyFollow&&!window.__lockedServicesIds[a.id]&&(window.__lockedServicesIds[a.id]=!0,m={id:a.relatedService1||a.relatedService2,isFirst:!!a.relatedService1},w.serviceAppointments()[m.id]&&(window.__lockedServicesIds[m.id]=!0)),g.saveChangesToServiceAppointment(a.id,a.getGanttResource(showSecondarySTMs),a.assignedResource,c,d,y.selectedPolicyId,a.scheduleMode,a.snapToId||null,a.snapToType||null,a.snapDirection||null,n,i,t).then(function(t){scheduler._events[a.id+"_dummy"]&&scheduler.deleteEvent(a.id+"_dummy");var n,e,i,s,r="On Demand"!==window.__gantt.checkRulesMode;T.handleDeltaResponse(t,r),t.ValidationError?(window.__lockedServicesIds[a.id]=!1,_.isEmpty(o)?l.reject(["",a.eventBeforeDrag,t.ValidationError]):l.reject(["",o,t.ValidationError])):m&&m.id?(r=w.serviceAppointments()[m.id]||{id:m.id,scheduleMode:a.scheduleMode},n=angular.copy(r),e=scheduler._events[a.id],i=m.isFirst?"left":"right",s=v.getServiceDurationInTheory(r)/1e3/60,n.start_date=new Date(r.start),n.end_date=new Date(r.start),n.start_date.setMinutes(e.start.getMinutes()+1),n.end_date.setMinutes(e.start.getMinutes()+s+1),(d=new Date(c)).setMinutes(d.getMinutes()+s),g.saveChangesToServiceAppointment(n.id,a.getGanttResource(showSecondarySTMs),null,c,d,y.selectedPolicyId,n.scheduleMode,a.id,"service",i,null,null).then(function(){window.__lockedServicesIds[a.id]=!1,window.__lockedServicesIds[n.id]=!1;var e="On Demand"!==window.__gantt.checkRulesMode;T.handleDeltaResponse(t,e),l.resolve({})})):l.resolve({})}).catch(function(e){window.__lockedServicesIds[a.id]=!1,a.relatedService1&&(window.__lockedServicesIds[a.relatedService1]=!1),a.relatedService2&&(window.__lockedServicesIds[a.relatedService2]=!1),_.isEmpty(o)?l.reject([e,a.eventBeforeDrag,e.message]):l.reject([e,o,e.message]),console.warn(e)}),l.promise},L.handleSnap=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(t.ctrlKey){var i,s=[];for(i in scheduler._events){var r=scheduler._events[i];"service"!==r.type&&"na"!==r.type||-1<r.id.indexOf("dummy")||r.id===e.id||e.resourceId&&-1===r.resourceId.indexOf(e.resourceId)||isIntersect(r.start_date,r.end_date,e.start_date,e.end_date)&&s.push(r)}s.sort(function(e,t){return e.start>t.start?1:e.start<t.start?-1:0}),s.length>(n?1:0)?(t=new Date(e.start_date),n="right",(t=e.travelTo?t.setSeconds(t.getSeconds()+e.travelTo):t)<s[s[0].isDummy?1:0].start&&(n="left"),s[t=s[t=0].isDummy?1:t]?(e.snapToId=s[t].id,e.snapToType=s[t].type,e.snapDirection=n):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)}},L.unscheduleServices=function(c,e,d,u){var p=h.defer(),t=u?g.unscheduleServicesByLocationsId:g.unscheduleServicesByServicesId,m=null;return u||(m=v.getRelatedServices(c)),t(c,e,d,u).then(function(e){var n,l={};e.nothingToUnschedule?p.resolve(e):(n=h.defer(),e.fslOperation?b.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services;g.callRemoteAction(RemoteActions.getServicesById,e).then(function(e){w.updateTimePhaseData(e,"service").services,n.resolve({services:e,resourceAbsences:[],resourceCapacities:[],failedResults:t.fslOperation.result.failedResults})})}).catch(function(e){n.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):n.resolve(e),n.promise.then(function(t){l.absences=w.updateTimePhaseData(t.resourceAbsences,"na",!0).absences,l.services=w.updateTimePhaseData(t.services,"service",!0).services,l.capacities=w.updateTimePhaseData(t.resourceCapacities,"capacity").capacities,l.failedResults=t.failedResults,L.drawServicesAndAbsences(l.services,l.absences),u||"On Demand"===window.__gantt.checkRulesMode||L.checkRules(m).then(L.drawViolationsOnGantt),u&&"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getServicesOfLocations(c,d,u)).then(L.drawViolationsOnGantt);var n,i,s,r,e,o=void 0,a=void 0;1!==c.length||u?(n=[],i=[],u?t.services.forEach(function(e){(t.failedResults[e.Id]&&w.serviceAppointments()[e.Id].isScheduled()?i:n).push(e.Id)}):c.forEach(function(e){(w.serviceAppointments()[e].isScheduled()?i:n).push(e)}),o=customLabels.x_services_were_unscheduled.replaceAll(n.length),a=u?customLabels.x_services_were_unscheduled_out_of_y.replaceAll(n.length,n.length,i.length+n.length):customLabels.x_services_were_unscheduled_out_of_y.replaceAll(n.length,n.length,c.length),0<i.length&&(a+="<div title='"+i.map(function(e){return w.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_unschedule.replaceAll(i.length)+". "+customLabels.View_services+"</div>"),s=angular.copy(t),r=[],s.services.forEach(function(e){if(u)e.Fields.SchedStartTime||r.push(e);else for(var t=0;t<c.length;t++)e.Id===c[t]&&r.push(e)}),s.services=r,v.addNotification(o,a,function(){var e={success:customLabels.SuccessfullyUnscheduled,fail:customLabels.FailToUnschedule};S.open(s,e)})):(e=w.serviceAppointments()[c[0]].name,a=w.serviceAppointments()[c[0]].isScheduled()?(o=customLabels.Couldnt_unschedule.replaceAll(e),customLabels.Couldnt_unschedule.replaceAll(e)+". "+t.failedResults[c[0]].errorMessage):(o=customLabels.was_unscheduled.replaceAll(e),customLabels.was_unscheduled_successfully.replaceAll(e)),v.addNotification(o,a,function(){L.recentlyUsed[c[0]]=!0,f.open(c[0])})),p.resolve(l)}))}).catch(function(e){p.reject(e),console.warn(e)}),p.promise},L.drawServicesAndAbsences=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[];if(0!==e.length||0!==t.length||0!==n.length||0!==i.length){var s,r,o={},a={},l={},c={scheduledServices:[],unscheduledServices:[],deletedIds:n};for(r in Array.isArray(e)?e.forEach(function(e){return o[e.id||e.Id]=e instanceof GanttService?e:new GanttService(e)}):o=e,Array.isArray(t)?t.forEach(function(e){return a[e.id||e.Id]=e}):a=t,Array.isArray(i)?i.forEach(function(e){return l[e.id||e.Id]=e}):l=i,s=angular.extend({},o,a,l)){var d=s[r];(!function(e){if(p.isActive()&&p.isBundleMember(e))return void(scheduler._events[e.id]&&delete scheduler._events[e.id]);if(e.isScheduled())return e.setGanttResource(w.resourcesAndTerritories(),v.generateResourceId),1;scheduler._events[e.id]&&delete scheduler._events[e.id];return}(d)?c.unscheduledServices:c.scheduledServices).push(d)}if(n.forEach(function(e){return delete scheduler._events[e]}),0<c.scheduledServices.length)scheduler.parse(c.scheduledServices,"json");else for(var u in c)if(Array.isArray(c[u])&&0<c[u].length){updateViewDebounced();break}return c}},L.changeStatus=function(a,l,e,c){var d=4<arguments.length&&void 0!==arguments[4]&&arguments[4],u=h.defer();return(c?g.changeStatusServicesByLocationsId:g.changeStatusServicesByServicesId)(a,l,e,c).then(function(e){var n,o={};e.nothingToDispatch?u.resolve(e):(n=h.defer(),e.fslOperation?b.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services;g.callRemoteAction(RemoteActions.getServicesById,e).then(function(e){n.resolve({services:e,failedResults:t.fslOperation.result.failedResults})})}).catch(function(e){n.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):n.resolve(e),n.promise.then(function(t){o.services=w.updateTimePhaseData(t.services,"service",d).services,o.failedResults=t.failedResults;var n,i,e,s=void 0,r=void 0;1!==a.length||c?(n=[],i=[],c?t.services.forEach(function(e){(w.serviceAppointments()[e.Id].status!==l?n:i).push(e.Id)}):a.forEach(function(e){(w.serviceAppointments()[e].status===l?i:n).push(e)}),s=customLabels.x_services_were_changed.replaceAll(i.length,v.statusTranslations[l]||l),r=customLabels.x_services_were_changed_out_of_y.replaceAll(i.length,i.length,i.length+n.length,v.statusTranslations[l]||l),0<n.length&&(r+="<div title='"+n.map(function(e){return w.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_change_status.replaceAll(n.length)+". "+customLabels.View_services+"</div>"),v.addNotification(s,r,function(){var e={success:customLabels.SuccessfullyDispatched,fail:customLabels.FailToDispatch};S.open(t,e)})):(e=w.serviceAppointments()[a[0]].name,w.serviceAppointments()[a[0]].status!==l&&(s=customLabels.could_not_change_title.replaceAll(e),r=t.failedResults&&!v.isEmpty(t.failedResults)?customLabels.could_not_change_status.replaceAll(e,v.statusTranslations[l],t.failedResults[a[0]].errorMessage):customLabels.could_not_change_status.replaceAll(e,v.statusTranslations[l],""),v.addNotification(s,r,function(){f.open(a[0])})),L.recentlyUsed[a[0]]=!0),u.resolve(o)}))}).catch(function(e){u.reject(e),console.warn(e)}),u.promise},L.changePin=function(e,t){var n=h.defer();return g.callRemoteAction(RemoteActions.changePins,e,t).then(function(e){var t=fieldNames.Service_Appointment.pinned;e.forEach(function(e){return w.serviceAppointments()[e.Id].pinned=e[t]}),n.resolve()}).catch(function(e){n.reject(e),console.warn(e)}),n.promise},L.setInJeopardy=function(e){var t=h.defer();return g.callRemoteAction(RemoteActions.setServiceAppointmentsInJeopardy,e).then(function(e){e.forEach(function(e){return w.serviceAppointments()[e.Id].jeopardy=e[fieldNames.Service_Appointment.InJeopardy__c]}),v.addNotification(customLabels.Update_for_service,customLabels.Appointments_marked.replace("$0",customLabels.In_Jeopardy).replace("$1",e.length)),t.resolve()}).catch(function(e){t.reject(e),console.warn(e)}),t.promise},L.drawViolationsOnGantt=function(e){updateViewDebounced()},L.searchServiceByIdOrName=function(e){var n=h.defer();return g.callRemoteAction(RemoteActions.searchServiceByIdOrName,e).then(function(e){var t;null===e?n.resolve(null):((t=w.updateTimePhaseData(e,"service")).services&&0<t.services.length&&scheduler.parse(t.services.filter(function(e){return e.isScheduled()}),"json"),n.resolve(e[0].Id))}).catch(function(e){n.reject(e),console.warn(e)}),n.promise},L}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=(angular.module("serviceExpert").factory("userSettingsManager",["$q",function(s){function n(e){var t,n=s.defer();for(t in e){var i=e[t];e[t]=i+":"+(void 0===i?"undefined":_typeof(i))}return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperties,e,function(e,t){t=JSON.parse(t.result);t.FailedLocations?(bootstrap.loadedUserSettings=t,n.reject(t)):(bootstrap.loadedUserSettings=t,n.resolve())},{buffer:!1,escape:!1,timeout:12e4}),n.promise}return{GetUserSettingsProperty:function(e){return bootstrap.loadedUserSettings[e]},SetUserSettingsProperty:function(e,t){var n=s.defer(),i=void 0===t?"undefined":_typeof(t);return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperty,e,t,i,function(e,t){null!==t.result&&(bootstrap.loadedUserSettings=JSON.parse(t.result),n.resolve())},{buffer:!1,escape:!1,timeout:12e4}),n.promise},SetUserSettingProperties:n,SetUserSettingPropertiesPromise:function(e){var t=s.defer();return n(e),bootstrap.loadedUserSettings=JSON.parse(ev.result),t.promise}}}]),function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")});function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){function e(e,t,i,n,s,p,m,r,o,a,l){var c=void 0,d=[],u=[],h=[],g=[],v={},f={},S={},y={},b={DateTime:"DATETIME",Date:"DATE",String:"STRING",TextArea:"TEXTAREA",Picklist:"PICKLIST",Reference:"REFERENCE",Currency:"CURRENCY",Phone:"PHONE"},_={minutes:"Minutes",hours:"Hours",days:"Days"},w=[],T=e.defer(),L=new DOMParser;function A(e){var t;this.name=e[fieldNames.CustomGanttAction.Label],this.className=e[fieldNames.CustomGanttAction.Class],this.order=e[fieldNames.CustomGanttAction.Order],this.permission=e[fieldNames.CustomGanttAction.Permission],this.section=e[fieldNames.CustomGanttAction.Section],this.visualforce=e[fieldNames.CustomGanttAction.Visualforce],e[fieldNames.CustomGanttAction.Icon]&&(this.icon=(e=e[fieldNames.CustomGanttAction.Icon].split(","),t=(e=_slicedToArray(e,2))[0],e=e[1],window.lsdIcons.globalIcon+"/"+t+"-sprite/svg/symbols.svg#"+e))}function C(e,t){t*=864e5;return new Date(e.getTime()+t)}function D(e){I(null,e)||window.open("../"+e,"_blank")}function I(e,t){return!!m.isInConsole()&&(e&&e.preventDefault(),sforce.console.generateConsoleUrl(["/"+t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):k(t)}),!0)}function k(e){sforce.console.openPrimaryTab(null,"/"+e,!0)}function R(e,t){return moment.tz({year:e.getFullYear(),month:e.getMonth(),date:e.getDate(),hours:e.getHours(),minutes:e.getMinutes()},t)}function F(e){return new Date(e.year(),e.month(),e.date(),e.hours(),e.minutes())}function M(e){return customPermissions[e]}return String.prototype.decodeHTML=function(){var e=L.parseFromString(this,"text/html");return""!==e.documentElement.textContent?e.documentElement.textContent:this},String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},i.callRemoteAction(RemoteActions.getCustomActions).then(function(e){e.forEach(function(e){var t=e[fieldNames.CustomGanttAction.Permission];window.customPermissions[t]&&w.push(new A(e))}),T.resolve(w)}),i.callRemoteAction(RemoteActions.getAllFormulaFields).then(function(e){c=e}),i.callRemoteAction(RemoteActions.getWorkOrderPriority).then(function(e){d.push.apply(d,_toConsumableArray(e))}),v.startHour=p.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),null===v.startHour&&(v.startHour=0),v.finishHour=p.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),null===v.finishHour&&(v.finishHour=24),v.filterCandidates=p.GetUserSettingsProperty("Filter_Candidates__c"),null===v.filterCandidates&&(v.filterCandidates=!0),v.servicesPerPage=p.GetUserSettingsProperty("Services_Per_Page__c"),null===v.servicesPerPage&&(v.servicesPerPage="75"),v.resourceRowHeight=p.GetUserSettingsProperty("Resource_Row_Height__c"),null===v.resourceRowHeight&&(v.resourceRowHeight="medium"),v.capacityDuration=p.GetUserSettingsProperty("View_Capacity_Type__c"),null===v.capacityDuration&&(v.capacityDuration="Day"),v.backHorizon=p.GetUserSettingsProperty("Scheduling_horizon_limit__c"),null===v.backHorizon&&(v.backHorizon=14),v.loadOnToday=p.GetUserSettingsProperty("Load_On_Today__c"),null===v.loadOnToday&&(v.loadOnToday=!0),v.leftPanel=p.GetUserSettingsProperty("DefaultLeftPanel__c")||"salist",v.serviceColoring=p.GetUserSettingsProperty("ServiceListColoring__c")||"default",i.callRemoteAction(RemoteActions.getCustomizationFiles).then(function(e){var t;e&&e.CSS&&((t=jQuery("<link>")).attr({rel:"stylesheet",type:"text/css",href:e.CSS}),$("head").append(t)),e&&e.JS&&$.ajax({url:e.JS,dataType:"script"})}),window.openConsoleTabFromModal=function(t){m.isInConsole()&&sforce.console.generateConsoleUrl([t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):k(t)})},String.prototype.replaceAll=function(){for(var e=this,t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var s=0;s<n.length;s++)e=e.replace("$"+s,n[s]);return e},i.callRemoteAction(RemoteActions.getStatusFlow).then(function(e){if(e)for(var t in angular.merge(f,e),f)f[t]=f[t].sort()}).catch(function(e){console.warn("could not get status flow :("),console.log(e)}),i.callRemoteAction(RemoteActions.getStatusTranslations).then(function(e){angular.merge(S,e),window.statusTranslations=S}).catch(function(e){console.warn("could not get status translations :("),console.log(e)}),i.callRemoteAction(RemoteActions.getStatuses).then(function(e){angular.merge(y,e)}).catch(function(e){console.warn("could not get status :("),console.log(e)}),{getFilteredLocations:function(){var e=p.GetUserSettingsProperty("locations");return e||[]},getSVGIconHTMLCustom:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use width="17px" height="17px" xlink:href="'+e+'"></use></svg>'},getSVGIconHTML:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use xlink:href="'+e+'"></use></svg>'},getRelatedServices:function(e,t){var n,i=Array.isArray(e)?e.concat():[e];for(n in t+=i.reduce(function(e,t){return scheduler._events[t]?e+","+scheduler._events[t].resource:e},""),scheduler._events){var s=scheduler._events[n];("service"===s.type&&-1!=t.indexOf(s.resource)||s.relatedService1&&-1!=e.indexOf(s.relatedService1)||s.relatedService2&&-1!=e.indexOf(s.relatedService2))&&(i.push(s.id),s.relatedTo&&i.push(s.relatedTo),s.relatedFather&&i.push(s.relatedFather),s.relatedService2&&i.push(s.relatedService2),s.relatedService1&&i.push(s.relatedService1))}return i},getServicesOfLocations:function(e,t,n){var i,s=[],r=(e=Array.isArray(e)?e:[e]).join(",");for(i in scheduler._events){var o=scheduler._events[i];"service"===o.type&&r.indexOf(o.serviceTerritory)&&isIntersect(o.start_date,o.end_date,t,n)&&(s.push(o.id),o.relatedTo&&s.push(o.relatedTo),o.relatedFather&&s.push(o.relatedFather),o.relatedService2&&s.push(o.relatedService2),o.relatedService1&&s.push(o.relatedService1))}return s},getServicesBetweenDates:function(e,t){var n,i=[];for(n in scheduler._events){var s=scheduler._events[n];"service"===s.type&&isIntersect(s.start_date,s.end_date,e,t)&&(i.push(s.id),s.relatedTo&&i.push(s.relatedTo),s.relatedFather&&i.push(s.relatedFather),s.relatedService2&&i.push(s.relatedService2),s.relatedService1&&i.push(s.relatedService1))}return i},getServiceDuration:function(e){var t=0;if(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),e.isScheduled())t=e.finish.getTime()-e.start.getTime();else switch(e.durationType){case _.minutes:t=60*e.estDuration*1e3;break;case _.hours:t=60*e.estDuration*60*1e3;break;case _.days:t=24*e.estDuration*60*60*1e3;break;default:t=6e4}return t},safeApply:function(e,t){var n=e.$root.$$phase;"$apply"===n||"$digest"===n?t&&"function"==typeof t&&t():e.$apply(t)},formatDayToString:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},showOnGantt:function(e){if("MonthlyView"===scheduler._mode)alert(customLabels.serviceCantDisplayMonthlyMsg);else{var t=scheduler._events[e],n=getMinAndMaxHoursToDisplay(),i=t.start_date.getHours(),s=t.end_date.getHours();if((scheduler._min_date>t.start||t.start>scheduler._max_date)&&scheduler.setCurrentView(new Date(t.start)),0===t.end_date.getHours()&&t.end_date.getDate()>t.start_date.getDate()&&(s=24),"ZoomLevel2"!==scheduler._mode&&(n.min>s||n.max<=i))alert(customLabels.serviceCantDisplayMsg);else{for(var r=!0,o=scheduler.serverList("resources"),a=0;a<o.length;a++)for(var l=0;l<o[a].children.length;l++)if(-1<t.resourceId.indexOf(o[a].children[l].key)){r=!1;break}if(r)alert(customLabels.resource_filtered_out);else{if(m.areContractorsSupported()){var c=!0;if(t.resourceContractor){for(var d=scheduler.getEvents(t.start,t.finish),u=0;u<d.length;u++)if(d[u].resourceId===t.resourceId&&"contractorcapacity"===d[u].type&&d[u].timePeriod===p.GetUserSettingsProperty("View_Capacity_Type__c")){t=d[u],e=d[u].id,c=!1;break}if(c)return void alert(customLabels.is_assigned_to_contractor.replaceAll(t.name,t.resourceName)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}}try{scheduler._els.dhx_cal_data[0].scrollTop=0,t.showEventPopupEffect=!0,scheduler.showEvent(e)}catch(e){scheduler.callEvent("onAfterEventDisplay",[t,scheduler._mode])}}}}},openConsoleTab:I,trust:function(e){return"string"==typeof e?t.trustAsHtml(e):null},openLink:function(e,t){t.Type==b.Reference&&D(e[t.JsAPIName.replace("__r","__c")])},openSObjectLink:D,openLightningSubtab:function(t){sforce.console.getEnclosingPrimaryTabId(function(e){e=e.id;sforce.console.openSubtab(e,"/"+t,!0)})},openLightningPrimaryTab:k,getServiceInfoRowClass:function(e){var t;if(e)return t={},e.Type==b.Reference&&(t.resourceOnServiceTT=!0),t},isEmpty:function(e){return!Object.keys(e).length},generateResourceId:function(t,n){return Array.isArray(t)&&!Array.isArray(n)?t.map(function(e){return e+"_"+n}).join(","):Array.isArray(t)&&Array.isArray(n)?t.map(function(e,t){return e+"_"+n[t]}).join(","):Array.isArray(t)||Array.isArray(n)?!Array.isArray(t)&&Array.isArray(n)?n.map(function(e){return t+"_"+e}).join(","):void 0:t+"_"+n},addNotification:function(e,t,n,i){var s=4<arguments.length&&void 0!==arguments[4]&&arguments[4],r=(void 0===i&&(i=null),new Date);g.push({title:e,text:t,action:function(){n(i),this.show=!s},when:new Date(r.getTime().valueOf()+60*r.getTimezoneOffset()*1e3),unread:!0,param:i,show:!0})},addDaysToDate:C,setDatesByStartAndMode:function(e){var t=new Date(e);switch(scheduler._mode){case"ZoomLevel2":case"ZoomLevel3":t=C(t,1);break;case"ZoomLevel4":t=C(t,2);break;case"ZoomLevel5":t=C(t,3);break;case"ZoomLevel6":t=C(t,7);break;case"ZoomLevel7":t=C(t,14);break;case"MonthlyView":t=C(t,30);break;case"MTDView":t=C(t,35);break;case"LongView":t=C(t,scheduler.matrix.LongView.x_size)}return{start:new Date(e),end:t}},sortByTime:function(e,t){return e.start>t.start?1:e.start.getTime()==t.start.getTime()?0:-1},getReports:function(){var n=e.defer();return i.callRemoteAction(RemoteActions.getReportsWithGeolocationCols).then(function(e){if(e){for(var t=0;t<e.length;t++)u.push(e[t]);n.resolve(u)}else n.resolve(null)}).catch(function(e){return n.reject(e)}),n.promise},getPolygons:function(){var n=e.defer();if(M("Polygons_view"))return i.getPolygons().then(function(e){if(e){for(var t=0;t<e.length;t++)h.push(e[t]);n.resolve(h)}else n.resolve(null)}),n.promise;n.resolve(null)},intersectDates:function(e,t){for(var n={},i=[],s=(e.start>=t.start&&e.start<t.finish?(n.start=e.start,e.finish<t.finish?n.finish=e.finish:(n.finish=t.finish,i.push({start:t.finish,finish:e.finish,isStart:!1}))):e.finish>t.start&&e.finish<=t.finish?(e.start>t.start?n.start=e.start:(n.start=t.start,i.push({start:e.start,finish:t.start,isStart:!0})),n.finish=e.finish):e.start<t.start&&e.finish>t.finish?(n=angular.copy(t),i.push({start:e.start,finish:t.start,isStart:!0}),i.push({start:t.finish,finish:e.finish,isStart:!1})):n=null,[]),r=0;r<i.length;r++){var o=i[r];o.start.getTime()!=o.finish.getTime()&&s.push(o)}return{intersection:n,remainderFrom1:s}},getCSSClassForContext:function(e,t){switch(e){case t.NONE:return"serviceList_new";case t.SCHEDULED:return"serviceList_assigned";case t.DISPATCHED:return"serviceList_dispatched";case t.IN_PROGRESS:return"serviceList_travel";case t.COMPLETED:return"serviceList_completed";case t.COULD_NOT_COMPLETE:return"serviceList_couldnt_complete";case t.CANCELED:return"serviceList_cancelled";default:return"serviceList_other"}},fieldsTypes:b,ganttSettings:v,butlerNotifications:function(){return g},getIdsOfSObjectsAbsence:function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t},showServiceList:{show:!0},checkBoxFields:function(){return c},woPriorities:d,durationTypes:_,statusFlow:f,statusTranslations:S,statuses:y,convertDateBetweenTimeZones:function(e,t,n){return F(R(e,t).tz(n))},convertDtToMomentDt:R,convertMomentDtToDt:F,getUserOffset:function(e){return-moment.tz.zone(userTimeZone).utcOffset(R(e,userTimeZone).valueOf())},getLocationOffset:function(e,t){return t?(t=o.territories()[t],t=o.getOperatingHours()[t.operatingHours].timezone,-moment.tz.zone(t).utcOffset(R(e,t).valueOf())):null},setMapCloseButtonPosition:function(){s(function(){var e=$(".gm-style-iw");$($(".gm-ui-hover-effect")[0]).css({right:"0px",top:"0px",opacity:1}),e.next().css({right:"12px",left:"",opacity:1})},0)},getIdsOfSObjects:function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].id);return t},hoursMinutes:function(e,t,n,i){return e<60?i.replaceAll([e]):(i=e%60,e=Math.round(e/60),0==i?n.replaceAll([e]):t.replace("$0",e).replace("$1",i))},hasCustomPermission:M,formatDateWithDayOfWeek:function(e){(e=new Date(e)).setHours(12);try{return e.toLocaleDateString(userLocale.replace("_","-"),{weekday:"short",month:"long",day:"numeric",year:"numeric"})}catch(e){return null}},isLightning:function(){return"undefined"!=typeof sforce&&sforce&&!!sforce.one},getCustomActions:function(t){return w.filter(function(e){return e.section===t})},customActionsPromise:T.promise,removeFSLNamespace:function(e){return 0===e.indexOf("FSL__")?e.substr(5,e.length):e},crewsFilter:!1,generateDateKey:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},isUseEdge:function(e){return __gantt[e].useEdge},getColorHexByCategory:function(e){switch(e){case l.NONE:return"#a5e2d6";case l.SCHEDULED:return"#F9D058";case l.DISPATCHED:return"#8DD8FA";case l.IN_PROGRESS:return"#D68EF9";case l.COMPLETED:return"#95d155";case l.COULD_NOT_COMPLETE:return"#f58556";case l.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}},getRelevantDataForDraggingService:function(e){var t={},n=(t.label=e.ganttLabel||e.name,t.estimatedDurationText=e.estDuration+" "+e.durationType,getMinAndMaxHoursToDisplay()),i=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60),n=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60),e=(e.durationType?e.durationType===_.minutes?n.setMinutes(n.getMinutes()+e.estDuration):e.durationType===_.hours?n.setMinutes(n.getMinutes()+Math.floor(60*e.estDuration)):e.durationType===_.days&&n.setMinutes(n.getMinutes()+Math.floor(60*e.estDuration*24)):e.setMinutes(n.getMinutes()+60),getXPositionOfEvent({start_date:i,end_date:n},!1,scheduler.matrix[scheduler._mode])),i=getXPositionOfEvent({start_date:i,end_date:n},!0,scheduler.matrix[scheduler._mode]);return t.meetingLengthInPx=i-e+4,t},getSchedulingPolicyObject:function(e){for(var t=0;t<m.policies.length;t++)if(m.policies[t].Id===e)return m.policies[t]},getServiceDurationInTheory:function(e){switch(e.durationType){case _.minutes:return 60*e.estDuration*1e3;case _.hours:return 60*e.estDuration*60*1e3;case _.days:return 24*e.estDuration*60*60*1e3;default:return 6e4}},isUrlImg:function(e){return t=e,!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(t)&&null!==e.match(/\.(jpeg|jpg|gif|png|svg)$/);var t},isFormulaForImage:function(e){return e&&e.startsWith("<img")&&(e=e.split(" ")[1]).includes("src=")?e.substr(5,e.length-6):null},escapeResourceName:function(e){return e=(e=(e=e.encodeHTML()).split("'").join("&lsquo;")).split('"').join("&ldquo;")}}}e.$inject=["$q","$sce","sfdcService","$rootScope","$timeout","userSettingsManager","StateService","kpiCalculationsService","ResourcesAndTerritoriesService","$injector","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("utils",e)}(),angular.module("serviceExpert").factory("sfdcService",["$q","$rootScope","userSettingsManager","$injector",function(f,i,s,S){var y={servicesArray:[],servicesObjs:{},activeRequests:{active:0},activeRuleCheckRequests:{active:0},serviceChangesQueue:[],resourceOperationsCounter:{}},l=(window.__isCheckingRules=function(){return!!y.activeRuleCheckRequests.active},{}),c={};function b(){return s.GetUserSettingsProperty("locations")||[]}function r(){return JSON.parse(s.GetUserSettingsProperty("Show_Orphan_Services__c"))}return c[RemoteActions.GetTimePhasedObjects]=!0,c[RemoteActions.GetResourcesAndTerritories]=!0,c[RemoteActions.getDelta]=!0,y.callRemoteAction=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var s=e===RemoteActions.getDelta,r=e in l,o=!(e in c),a=f.defer(),e=[e].concat(n).concat(function(e,t){s||y.activeRequests.active--,t.status?a.resolve(e):a.reject(t)}).concat({buffer:o,escape:r,timeout:12e4}).map(function(e){return void 0===e?null:e});return s||y.activeRequests.active++,window.Visualforce.remoting.Manager.invokeAction.apply(window.Visualforce.remoting.Manager,e),a.promise},y.checkRules=function(e,t){var n=f.defer();return y.activeRuleCheckRequests.active++,i.policy||(i.policy=null),t=t||i.policy,window.Visualforce.remoting.Manager.invokeAction(RemoteActions.checkRules,e,t,function(e,t){y.activeRuleCheckRequests.active--,t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},y.getOptimiztionRequestsUpdate=function(e){return y.callRemoteAction(RemoteActions.getOptimiztionRequestsUpdate,e,b())},y.getGanttServiceOnAssignedResourceUpdate=function(e){return y.callRemoteAction(RemoteActions.getGanttServiceOnAssignedResourceUpdate,e,b())},y.getUpdatedAbsences=function(e){return y.callRemoteAction(RemoteActions.getUpdatedAbsences,e,b())},y.getDeletedAbsences=function(e){return y.callRemoteAction(RemoteActions.getDeletedAbsences,e,b())},y.getUpdatedServices=function(e,t){return y.callRemoteAction(RemoteActions.getUpdatedServices,e,t,b())},y.getUpdatedResourceCapacities=function(e){return y.callRemoteAction(RemoteActions.getUpdatedResourceCapacities,e,b())},y.getLivePositionsStreaming=function(e){return y.callRemoteAction(RemoteActions.getLivePositionsStreaming,e,b())},y.getLivePositions=function(){return y.callRemoteAction(RemoteActions.getLivePositions,b())},y.getDelta=function(e,t,n){return y.callRemoteAction(RemoteActions.getDelta,e,b(),t,n)},y.getSlots=function(e,t){var i=f.defer();return y.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSlots,e,t,function(e,t){var n={};n.value=e,n.eventType=t.type,"exception"===t.type&&(n.event=t,i.resolve(n),--y.activeRequests.active),t.status?i.resolve(n):i.reject(t),--y.activeRequests.active},{buffer:!0,escape:!0,timeout:12e4}),i.promise},y.getPolygons=function(){return y.callRemoteAction(RemoteActions.getPolygons,b())},y.autoScheduleService=function(e,t){return y.callRemoteAction(RemoteActions.autoScheduleService,e,t,b())},y.unscheduleServicesByServicesId=function(e,t){return t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),y.callRemoteAction(RemoteActions.unscheduleServicesByServicesId,e,t)},y.unscheduleServicesByLocationsId=function(e,t,n,i){return t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),y.callRemoteAction(RemoteActions.unscheduleServicesByLocationsId,e,t,n,i)},y.GetResourcesAndTerritories=function(e){return y.callRemoteAction(RemoteActions.GetResourcesAndTerritories,e||b(),!0,!1)},y.GetTimePhasedObjects=function(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=3<arguments.length&&void 0!==arguments[3]&&arguments[3],s=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,r=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,a=7<arguments.length&&void 0!==arguments[7]?arguments[7]:null,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,c=9<arguments.length&&void 0!==arguments[9]&&arguments[9];return y.callRemoteAction(RemoteActions.GetTimePhasedObjects,e,t,b(),n,i,s,r,o,maxServicesToLoadEachBulkInGantt,maxAbsencesToLoadEachBulkInGantt,maxShiftsToLoadEachBulkInGantt,a,l,c)},y.loadServicesInBulk=function(e,t,n,i,s){return y.callRemoteAction(RemoteActions.loadServicesInBulk,e,b(),r(),t,n,i,s)},y.saveChangesToAbsence=function(e,t,n,i,s,r){return y.callRemoteAction(RemoteActions.saveChangesToAbsence,e,t,n,i,s,r,6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,7<arguments.length&&void 0!==arguments[7]?arguments[7]:null,8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,9<arguments.length&&void 0!==arguments[9]?arguments[9]:null,b())},y.saveChangesToServiceAppointment=function(e,n,i,t,s,r,o,a,l,c,d,u){var p=12<arguments.length&&void 0!==arguments[12]&&arguments[12],m=(y.resourceOperationsCounter[n]=y.resourceOperationsCounter[n]||0,i&&(y.resourceOperationsCounter[i]=y.resourceOperationsCounter[i]||0),f.defer()),h=f.defer();y.resourceOperationsCounter[n]?y.serviceChangesQueue.push({deferred:h,srcResource:i,destResource:n,valid:!0}):i&&!y.resourceOperationsCounter[i]?(y.resourceOperationsCounter[n]++,y.resourceOperationsCounter[i]++,h.resolve()):i||(y.resourceOperationsCounter[n]++,h.resolve());var g=S.get("TimePhasedDataService").serviceAppointments()[e],v=!1;return g&&(v=!!g.fromGetCandidateFlow),h.promise.then(function(){y.activeRequests.active++,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToServiceAppointment,e,n,i,t,s,r,o,a,l,c,d,u,b(),p,v,function(e,t){y.activeRequests.active--,i&&y.resourceOperationsCounter[i]--,y.resourceOperationsCounter[n]--,y.serviceChangesQueue.forEach(function(e){!e.valid||y.resourceOperationsCounter[e.destResource]||(!e.srcResource||y.resourceOperationsCounter[e.srcResource])&&e.srcResource||(y.resourceOperationsCounter[e.srcResource]++,y.resourceOperationsCounter[e.destResource]++,e.valid=!1,e.deferred.resolve())}),t.status?m.resolve(e):m.reject(t)},{buffer:!0,escape:!1,timeout:12e4})}),m.promise},y.changeStatusServicesByServicesId=function(e,t){return y.callRemoteAction(RemoteActions.changeStatusServicesByServicesId,e,t)},y.changeStatusServicesByLocationsId=function(e,t,n,i){return y.callRemoteAction(RemoteActions.changeStatusServicesByLocationsId,e,t,n,i)},y.getOptimizationRequests=function(){return y.callRemoteAction(RemoteActions.getOptimizationRequests,b(),r())},y.runFillInSchedule=function(e,t,n){return y.callRemoteAction(RemoteActions.runFillInSchedule,e,t,n)},y.runFixOverlaps=function(e,t,n){return y.callRemoteAction(RemoteActions.runFixOverlaps,e,t,n)},y.getFslOperation=function(e){return y.callRemoteAction(RemoteActions.getFslOperation,e,resourceId,policyId)},y}]),!function(){function e(n,i,s,r,o,a){var l=null;function c(){a.setLightBoxStatus(!1),l.$destroy()}function d(e){e!==l.selectedTab&&(l.selectedTab=e)}return{open:function(e){(l=n.$new(!0)).lightboxAbsence=i.resourceAbsences()[e],l.selectedTab="details",l.urls={chatter:s.trustAsResourceUrl(customAbsenceChatterPage+"?id="+e).toString(),details:s.trustAsResourceUrl(customAbsencePage+"?id="+e).toString()},l.changeTab=d,l.closeLightbox=c,l.chatterAvailable=fieldTrackingEnabled.absence,l.openConsoleTab=o.openConsoleTab;var t=angular.element('<div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="AbsenceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="AbsenceLightboxHeader">\n\n                            <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                            <h1 class="lightboxHeader">\n                                <i ng-show="lightboxAbsence.type == \'na\'">'+customLabels.NA+":</i>\n                                <i ng-show=\"lightboxAbsence.type == 'break'\">"+customLabels.Break+':</i>\n                                {{ lightboxAbsence.name }}\n                            </h1>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </button>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxAbsence.id)" target="_blank" href="../{{ lightboxAbsence.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'details\'" ng-src="{{ urls.details }}"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'chatter\'" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");t.find("#AbsenceLightbox").draggable({containment:"document",handle:"#AbsenceLightboxHeader"}),a.setLightBoxStatus(),l.$on("$destroy",function(){return t.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),r(t)(l),o.safeApply(l,function(){angular.element("body").append(t)})}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("AbsenceLightboxService",e)}(),!function(){function e(c,d,u,p,e,m){return{saveChangesToAbsence:function(n,e,t){var i,s,r,o=c.defer(),a=new Date(e.start_date.getTime()+1e3*e.travelTo),l=new Date(e.end_date.getTime()-1e3*e.travelFrom);return useLocationTimezone&&(i=d.getIntersectingSrstOffset(e,e.getGanttResource()),s=m.getUserOffset(a),r=m.getUserOffset(l),a.setMinutes(a.getMinutes()+s-i),l.setMinutes(l.getMinutes()+r-i)),u.saveChangesToAbsence(e.id,e.getGanttResource(),t,a,l,null,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){var t="On Demand"!==window.__gantt.checkRulesMode;p.handleDeltaResponse(e,t),e.error?o.reject([e,n]):o.resolve()}).catch(function(e){o.reject([e,n])}),o.promise},saveNewAbsence:function(e,t){var n,i,s,r=c.defer();return useLocationTimezone&&(n=d.getIntersectingSrstOffset(e,e.resource),i=m.getUserOffset(e.start_date),s=m.getUserOffset(e.end_date),e.start_date.setMinutes(e.start_date.getMinutes()+i-n),e.end_date.setMinutes(e.end_date.getMinutes()+s-n)),u.saveChangesToAbsence(null,e.resource,t,e.start_date,e.end_date,e.absenceType,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){var t="On Demand"!==window.__gantt.checkRulesMode;p.handleDeltaResponse(e,t),e.error?r.reject(e):r.resolve()}).catch(function(e){r.reject(e)}),r.promise},deleteAbsence:function(e){var t=c.defer();return u.callRemoteAction(RemoteActions.deleteResourceAbsence,e).then(function(e){e?(e="On Demand"!==window.__gantt.checkRulesMode,p.getDelta(e)):m.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.Failed_To_Delete_Break,null,null)}).catch(function(e){t.reject(e)}),t.promise},getEmployeeAbsenceTypes:function(){var t=c.defer();return u.callRemoteAction(RemoteActions.getEmployeeAbsenceTypes).then(function(e){e&&t.resolve(e)}).catch(function(e){t.reject(e)}),t.promise}}}e.$inject=["$q","TimePhasedDataService","sfdcService","DeltaService","servicesService","utils"],angular.module("serviceExpert").factory("AbsencesService",e)}(),!function(){function e(n,i,s,r,o,a,l,c,d){for(var u=null,p=[],e=0;e<60;e++)p.push(e);var m=a.isRtlDirection();function h(){"running"!==u.bulkState&&(a.setLightBoxStatus(!1),u.$destroy())}function g(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function f(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function S(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function y(e){l.flagged[e]=!l.flagged[e]}function b(e){return l.flagged[e]}function _(e){return c.serviceAppointments()[e].name}function w(){var n=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var i in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[i]&&n.push(i);if(0===n.length)return void alert(customLabels.noLocationWasSelected)}else n=r.getSelected();a.setBulkActionRunning(),u.bulkState="running",l.changeStatus(n,d.DISPATCHED,e,t,!0).then(function(e){if(e.nothingToDispatch)u.nothingToDispatch=!0;else{l.drawServicesAndAbsences(e.services),u.results.dispatched=[],n="locations"===u.targetServices?e.services.map(function(e){return e.id}):n;for(var t=0;t<n.length;t++)c.serviceAppointments()[n[t]].status===d.DISPATCHED&&u.results.dispatched.push(c.serviceAppointments()[n[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk dispatch failed :("),console.log(e)}).finally(function(){a.setBulkActionRunning(!1),u.bulkState="finished"})}return{open:function(){(u=i.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=o.GetUserSettingsProperty("locations"),t=(u.filteredLocations=e.map(function(e){return s.territories()[e]}),u.selectedCount=r.countSelectedServices(),u.contractorSupport=a.areContractorsSupported(),u.minutes=p,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=g,u.dateSelectStartWidget=v,u.validateDatesStart=f,u.validateDatesEnd=S,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkDispatch=w,u.results={},u.toggleFlag=y,u.isFlagged=b,u.getServiceName=_,u.selectedLocations={},u.nothingToDispatch=!1,u.isAmpm=isAMPM?"ampm":"24",u.selectedMashu=customLabels.x_selected,e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>'),angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+m+' }" >\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">'+customLabels.BulkDispatch+'</h1>\n                    </div>\n\n                    \n                    <div id="bulkDispatchModalCont" ng-show="bulkState == \'finished\'">\n                        <div ng-show="bulkState == \'finished\'">\n    \n                            <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n    \n                            <div ng-show="results.dispatched.length" class="lightboxResultContainer dispatchResultsContainer1">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyDispatched+'</div>\n    \n                                <div ng-repeat="dispatced in results.dispatched" class="lightboxTableRow">\n                                    {{ dispatced.name }}\n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(dispatced.id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(dispatced.id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToDispatch+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkLightboxExplainCell">{{ failedReason.errorMessage }}</span>\n    \n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n    \n                        </div>\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.DispatchingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.DispatchLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ selectedMashu | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton" ng-click="bulkDispatch()">'+customLabels.Dispatch+"</button>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            "));t.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=h,u.$on("$destroy",function(){return t.remove()}),n(t)(u),t.show(),a.setLightBoxStatus(),t.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkDispatchService",e)}(),!function(){function e(s,r,o,t,a){for(var l=null,c=null,e=[],n=0;n<60;n++)e.push(n);var d=o.isRtlDirection();function u(e){l.flagged[e]=!l.flagged[e]}function p(e){return l.flagged[e]}function m(e){return t.serviceAppointments()[e].name}function h(){o.setLightBoxStatus(!1),c.$destroy()}return{open:function(e,t){l=a.get("servicesService"),(c=r.$new(!0)).getServiceName=m,c.results={success:[],failed:0<Object.keys(e.failedResults).length?e.failedResults:null},c.labels=t,c.toggleFlag=u,c.isFlagged=p;for(var n=0;n<e.services.length;n++)e.failedResults[e.services[n].Id]||c.results.success.push(e.services[n].Id);c.$on("keypress",function(e,t){27==t.which&&c.$evalAsync(c.closeLightbox)});var i=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+d+' }">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <h1 class="light-box-header">'+customLabels.BulkActionResults+'</h1>\n                        </div>\n\n                        <div class="resultsContainerOverflow">\n                            <div ng-show="results.success && results.success.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">{{labels.success}}</div>\n    \n                                <div ng-repeat="id in results.success" class="lightboxTableRow">\n                                    {{ getServiceName(id) }}\n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed && results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">{{labels.fail}}</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkResultLine">{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+"</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n            ");i.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(i),c.closeLightbox=h,c.$on("$destroy",function(){return i.remove()}),s(i)(c),i.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkResultsService",e)}(),!function(){function e(s,r,o,t,a){var l=null,c=o.isRtlDirection();function d(e){return angular.isObject(e)}function u(e){return t.serviceAppointments()[e]}function p(e){l.flagged[e]=!l.flagged[e]}function m(e){return l.flagged[e]}function h(e){o.setLightBoxStatus(!1),e.$destroy()}return{open:function(e){var t,n=null;for(t in l=a.get("servicesService"),(n=r.$new(!0)).isAdmin=!1,null==window.userHasAdminPermissions?sfdcService.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=!!e&&(n.isAdmin=!0)}):n.isAdmin=window.userHasAdminPermissions,n.toggleFlag=p,n.isFlagged=m,n.results=e,n.getService=u,n.isError=d,n.successfullyScheduled=0,n.globalSelectedCount=Object.keys(e).length,n.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},n.replaceLabelsForSebas=function(){return customLabels.x_services_scheduled_of_y_here_are_results.replaceAll(n.successfullyScheduled,n.globalSelectedCount)},e)"scheduled"===e[t].textResult&&n.successfullyScheduled++;n.$on("keypress",function(e,t){27==t.which&&n.$evalAsync(n.closeLightbox)}),n.closeLightbox=h,n.$on("$destroy",function(){return i.remove()});var i=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+c+' }">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox(this)" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkScheduleResults+'</h1>\n                        </div>\n\n                        <div style="padding:0 15px">\n                        \n                            <p>{{ replaceLabelsForSebas() }}</p>\n            \n                            <div id="ResultTableHeader">\n                                <span>'+customLabels.ID+'</span>\n                                <span id="ResultHeaderStart">'+customLabels.Start+"</span>\n                                <span>"+customLabels.Finish+'</span>\n                                <span id="ResultResourceHeader">'+customLabels.Resource+'</span>\n                            </div>\n            \n                            <div id="ScheduledResultsTable">\n                                <div ng-repeat="(id,res) in results" class="ScheduleResultRow">\n                                \n                                    <span class="scheduledResultColName">{{ getService(id).name }}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).start | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).finish | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).resourceName}}</span>\n                                    <span class="ScheduleResultUnscheduled" ng-if="isError(res)">{{ res.msg }}</span>\n                                    \x3c!--<span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.NoCandidates+'</span>--\x3e\n                                    <span class="ScheduleResultUnscheduled" ng-if="res.textResult == \'no candidates\'">'+customLabels.NoCandidates+'</span>\n                                    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                    \n                                    <div class="PartialResultsBulk" ng-show="res.partialResults.length > 0" ng-init="res.showDetails = false;">\n                                        <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="res.showDetails = !res.showDetails">'+customLabels.ShowDetails+'</u></div>\n            \n                                        <div ng-show="res.showDetails">\n                                            <ul>\n                                                <li ng-repeat="partial in res.partialResults">\n                                                    {{ generatePartialResult(partial) }}\n                                                </li>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                    \n                                </div>\n                            </div>\n                            \n                        </div>\n                    </div>\n\n                </div>\n            ');i.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),s(i)(n),angular.element("body").append(i),i.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkScheduleResultsService",e)}(),!function(){function e(o,t,n,a,l,c,e,i){var d=null;function s(){(d=n.$new(!0)).isInConsole=c.isInConsole(),d.actionName="Schedule",d.currentSchedulingIndex=0,d.successfullyScheduled=0,d.afterSchedulingServiceObjects={},d.close=r,d.showResults=u,d.progressBarStyle=p,d.getLabel=function(e){return customLabels[e]};var e=angular.element('\n            <div id="SchedulingInProgress" class="slideInProgressBox" ng-class="{SchedulingInProgressConsole: isInConsole}">\n\n\t\t\t\t<div ng-show="currentSchedulingIndex != globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-spinner fa-spin"></i> '+customLabels.Scheduling_Services+'\n\t\t\t\t\t<div class="ProgressBar">\n\t\t\t\t\t\t<div ng-style="progressBarStyle()"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div ng-cloak class="ProgressBarLabel">{{ getLabel(\'Scheduling_service\') | replaceLabels : (currentSchedulingIndex+1) : globalSelectedCount }}</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div ng-show="currentSchedulingIndex == globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-check"></i> '+customLabels.Scheduling_Complete+'\n\t\t\t\t\t<div ng-cloak class="HowManyWereScheduled">{{  getLabel(\'Scheduled_x_out_of_y\') | replaceLabels : successfullyScheduled : globalSelectedCount }}</div>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="close()">'+customLabels.Close+'</span>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="showResults()">'+customLabels.View_services+"</span>\n\t\t\t\t</div>\n\n\t\t\t</div>");angular.element("body").append(e),d.$on("$destroy",function(){return e.remove()}),t(e)(d),e.show()}function r(){d.$destroy()}function u(){e.open(d.afterSchedulingServiceObjects),d.$destroy()}function p(){return{width:(d.currentSchedulingIndex+1)/d.globalSelectedCount*100+"%"}}return{schedule:function(e){0===e.length||c.isScheduleRunning||(0===(e=e.filter(function(e){e=l.serviceAppointments()[e];return!(e.relatedService1&&e.isImmidietlyFollow)})).length?alert(window.customLabels.AllServicesAreFollowing):(d&&d.$destroy(),s(),c.isScheduleRunning=!0,d.globalSelectedCount=e.length,a.sortServicesByPriority(e).then(function(e){var i=[],s=[];e.forEach(function(e){s.push(l.serviceAppointments()[e.ServiceId])}),d.globalSelectedServiceObjects=s;for(var t=0;t<d.globalSelectedCount;t++){var n=o.defer();n.promise.then(r),i.push(n)}function r(n){c.schedulingRunningFor[s[n].id]=!0,a.autoScheduleService(s[n].id,!0).then(function(e){a.drawServicesAndAbsences(e.services,e.absences),d.afterSchedulingServiceObjects[s[n].id]={},d.afterSchedulingServiceObjects[s[n].id].partialResults=e.partialResults,d.afterSchedulingServiceObjects[s[n].id].textResult="no candidates",e.services.forEach(function(e){e.id===s[n].id&&(d.afterSchedulingServiceObjects[s[n].id].textResult="scheduled",d.successfullyScheduled++)})}).catch(function(e){var t={};t.msg=e.message,d.afterSchedulingServiceObjects[s[n].id]=t}).finally(function(){if(d.currentSchedulingIndex++,c.schedulingRunningFor[s[n].id]=!1,n+1<d.globalSelectedCount&&i[n+1].resolve(n+1),n+1===d.globalSelectedCount){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&"On Demand"!==window.__gantt.checkRulesMode&&a.checkRules(t).then(a.drawViolationsOnGantt),c.isScheduleRunning=!1}})}i[0].resolve(0)})))}}}e.$inject=["$q","$compile","$rootScope","servicesService","TimePhasedDataService","StateService","bulkScheduleResultsService","utils"],angular.module("serviceExpert").factory("bulkScheduleService",e)}(),!function(){function e(n,i,s,r,o,a,l,c,d){for(var u=null,p=[],e=0;e<60;e++)p.push(e);var m=a.isRtlDirection();function h(){"running"!==u.bulkState&&(a.setLightBoxStatus(!1),u.$destroy())}function g(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function f(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function S(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function y(e){l.flagged[e]=!l.flagged[e]}function b(e){return l.flagged[e]}function _(e){return c.serviceAppointments()[e].name}function w(){var n=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var i in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[i]&&n.push(i);if(0===n.length)return void alert(customLabels.noLocationWasSelected)}else n=r.getSelected();a.setBulkActionRunning(),u.bulkState="running",l.unscheduleServices(n,a.selectedPolicyId,e,t).then(function(e){if(e.nothingToUnschedule)u.nothingToUnschedule=!0;else{l.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),u.results.unscheduled=[],n="locations"===u.targetServices?e.services.map(function(e){return e.id}):n;for(var t=0;t<n.length;t++)c.serviceAppointments()[n[t]].isScheduled()||u.results.unscheduled.push(c.serviceAppointments()[n[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk unschedule failed :("),console.log(e),u.exception=e}).finally(function(){a.setBulkActionRunning(!1),u.bulkState="finished",d.calculateKpis()})}return{open:function(){(u=i.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=o.GetUserSettingsProperty("locations"),t=(u.filteredLocations=e.map(function(e){return s.territories()[e]}),u.selectedCount=r.countSelectedServices(),u.contractorSupport=a.areContractorsSupported(),u.minutes=p,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=g,u.dateSelectStartWidget=v,u.validateDatesStart=f,u.validateDatesEnd=S,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkUnschedule=w,u.results={},u.toggleFlag=y,u.isFlagged=b,u.getServiceName=_,u.selectedLocations={},u.nothingToUnschedule=!1,u.isAmpm=isAMPM?"ampm":"24",u.exception=null,e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>'),angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="UnschduleLightbox" ng-class="{\'rtlDirection\': '+m+' }">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">'+customLabels.BulkUnschedule+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n\n                        <div ng-show="nothingToUnschedule" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div class="resultsContainerOverflow class="unschedule_res_thingy_qa_halash">\n                        \n                            <div class="bulk-exception" ng-show="exception">\n                                <svg aria-hidden="true" class="slds-icon kpiIcon">\n                                    <use xlink:href="'+lsdIcons.violation+'"></use>\n                                </svg>\n                                {{ exception.message }} \n                            </div>\n                        \n                            <div ng-show="results.unscheduled.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyUnscheduled+'</div>\n    \n                                <div ng-repeat="unscheduled in results.unscheduled track by $index" class="lightboxTableRow">\n                                    {{ unscheduled.name }}\n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(unscheduled.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(unscheduled.id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(unscheduled.id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToUnschedule+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed track by $index" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkLightboxExplainCell">{{ failedReason.errorMessage }}</span>\n    \n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.UnschedulingPleaseWait+'\n                    </div>\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.UnscheduleLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ getCustomLabel(\'x_selected\') | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+'</label>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    '+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton" ng-click="bulkUnschedule()">'+customLabels.Unschedule+"</button>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            "));t.find("#UnschduleLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=h,u.getCustomLabel=function(e){return customLabels[e]},u.$on("$destroy",function(){return t.remove()}),n(t)(u),t.show(),a.setLightBoxStatus(),t.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","kpiCalculationsService"],angular.module("serviceExpert").factory("bulkUnscheduleService",e)}(),!function(){function e(s,i,r,o){return{Bundle:{label:customLabels.Bundle,icon:lsdIcons.bundleIcons+"#ad_set",canInvoke:function(e){if(!s.isActive()||!e||0===e.length)return!1;if(1<e.length)return!0;for(var t=!0,n=0;n<e.length;n++){if(e[n]&&-1<e[n].id.indexOf("_dummy")){t=!1;break}var i=e[n];if(!i||i.pinned||i.isBundle||i.isBundleMember){t=!1;break}}return t},invoke:function(e,t){var n=r.defer();if(0!==e.length)return i.open(e,t);e={message:customLabels.BundleNotSelected,status:"ERROR"};return o.$broadcast("showServiceExpertToast",e),utils.addNotification(customLabels.BundleCreatedFailedNTitle,customLabels.BundleNotSelected,function(){}),n.reject(),n.promise}},Unbundle:{label:customLabels.UnBundle,icon:lsdIcons.bundleIcons+"#archive",canInvoke:function(e){if(!s.isActive()||!e||0===e.length)return!1;if(1<e.length)return!0;for(var t=!0,n=0;n<e.length;n++){if(e[n]&&-1<e[n].id.indexOf("_dummy")){t=!1;break}var i=e[n];if(!i||i.pinned||!i.isBundle){t=!1;break}}return t},invoke:function(e,t){var n=1<e.length?customLabels.VerifyUnBundleActionMulti:customLabels.VerifyUnBundleAction;if(window.confirm(n))return n=e.map(function(e){return e.id}),s.UndbundleServiceAppointment(n,e,t);n=r.defer();return n.reject(null),n.promise}},UpdateBundle:{label:customLabels.Bundle,icon:lsdIcons.bundleIcons+"#ad_set",canInvoke:function(e){return!0},invoke:function(e,t,n){e=e.map(function(e){return e.id});return s.updateBundleServiceAppointments(e,t,n)}}}}e.$inject=["BundleService","BundlerAddCreateLightboxService","$q","$rootScope","utils"],angular.module("serviceExpert").factory("BundleActions",e)}(),!function(){function e(s,r,d,u,e,t,p,m){function n(){return"0"!==isSchedulingBundlingEnabled&&!!isSchedulingBundlingEnabled}function i(e){return e.isBundleMember}return{isBundleMember:i,isBundle:function(e){return e.isBundle},isActive:n,bundleServiceAppointments:function(e,t,n){var l=s.defer(),c=!1;if(0===(e=Array.isArray(e)?e:[e]).length)return i={message:customLabels.BundleNotSelected,status:"ERROR"},p.$broadcast("showServiceExpertToast",i),l.reject(),l.promise;1===n.length&&(c=n[0].name);var i=window.location.search,n=new URLSearchParams(i).get("token");return r.callRemoteAction(RemoteActions.createBundleManually,e,t,n).then(function(e){var t="",n=e.bundleStatus,i=void 0,s=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var r=e.error_msg.split("/bundleflow"),i=r[0]+" or ask your Salesforce admin for help.",s=r[0].split("endpoint =")[1]}catch(e){i="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",s="the URL"}alert(i),u.addNotification(customLabels.BundleCreatedFailedNTitle,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+s,function(){});r={message:customLabels.BundleCreationFailedM,status:"ERROR"};return p.$broadcast("showServiceExpertToast",r),void l.resolve(a)}if(e&&e.debugMode)for(var o in console.log("--createBundleManually--"),console.log(e),e)console.log(o+": "+e[o]);t=e.bundle||(i=e.bundleId,{AppointmentNumber:e.AppointmentNumber,Id:i});var a=e.bundledMembers;if("COMPLETE_BUNDLE"==n)return s=String.format(customLabels.BundleSuccessfullyCreated,t.AppointmentNumber),u.addNotification(customLabels.BundleCreatedNTitle,String.format(customLabels.BundleSuccessfullyCreated,t.AppointmentNumber),function(){m.open(t.Id)}),r={message:s,status:"SUCCESS",f:function(e){m.open(e)},p:t.Id},p.$broadcast("showServiceExpertToast",r),void l.resolve(a);i="",n=i=c?String.format(customLabels.BundleCreationFailedSingle,c):customLabels.BundleCreationFailedM,s={message:n=e.shortMsg&&""!=e.shortMsg?e.shortMsg:n,status:"ERROR"},p.$broadcast("showServiceExpertToast",s),r=i;e.longMsg&&""!=e.longMsg&&(r=e.longMsg),u.addNotification(customLabels.BundleCreatedFailedNTitle,r,function(){}),l.reject(e.bundleStatus)}).catch(function(e){var t="",n=t=c?String.format(customLabels.BundleCreationFailedSingle,c):customLabels.BundleCreationFailedM;p.$broadcast("showServiceExpertToast",{message:n,status:"ERROR"}),u.addNotification(customLabels.BundleCreatedFailedNTitle,t,function(){}),console.warn(e),l.reject(e)}),l.promise},updateBundleServiceAppointments:function(e,t,o,a){var e=Array.isArray(e)?e:[e],l=s.defer();return r.callRemoteAction(RemoteActions.updateBundleManually,e,t,o).then(function(e){var t=void 0,n=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var i=e.error_msg.split("/bundleflow"),t=i[0]+" or ask your Salesforce admin for help.",n=i[0].split("endpoint =")[1]}catch(e){t="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",n="the URL"}alert(t),u.addNotification(customLabels.BundleUpdateFailedNT,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+n,function(){});i={message:customLabels.BundleUpdateFailedNT,status:"ERROR"};return p.$broadcast("showServiceExpertToast",i),void l.resolve(r)}if(e&&e.debugMode)for(var s in console.log("+++"),console.log(e),e)console.log(s+": "+e[s]);var t=e.bundleStatus,n=void 0,r=(n=e.bundle||(i=e.bundleId,{AppointmentNumber:e.AppointmentNumber,Id:i}),e.bundledMembers);if("COMPLETE_BUNDLE"==t)return i=String.format(customLabels.BundleUpdateSuccessfully,a),t=customLabels.BundleUpdateSuccessfullyNT,u.addNotification(t,i,function(){m.open(o)}),t={message:i,status:"SUCCESS",f:function(e){m.open(e)},p:n.Id},p.$broadcast("showServiceExpertToast",t),void l.resolve(r);i=String.format(customLabels.BundleUpdateFailed,a),n={message:i=e.shortMsg&&""!=e.shortMsg?e.shortMsg:i,status:"ERROR"},p.$broadcast("showServiceExpertToast",n),t=String.format(customLabels.BundleUpdateFailed,a);e.longMsg&&""!=e.longMsg&&(t=e.longMsg),u.addNotification(customLabels.BundleUpdateFailedNT,t,function(){}),l.reject(e.bundleStatus)}).catch(function(e){var t={message:String.format(customLabels.BundleUpdateFailed,a),status:"ERROR"};p.$broadcast("showServiceExpertToast",t),u.addNotification(customLabels.BundleUpdateFailedNT,String.format(customLabels.BundleUpdateFailed,a),function(){}),l.reject(e)}),l.promise},UndbundleServiceAppointment:function(e,n,t){var i,o=s.defer();if(0===(e=Array.isArray(e)?e:[e]).length)return i={message:customLabels.UnbundledNotSelected,status:"ERROR"},p.$broadcast("showServiceExpertToast",i),u.addNotification(customLabels.FailedUnbundledNT,customLabels.UnbundledNotSelected,function(){}),o.reject(),o.promise;1===n.length&&n[0].name;var a=[],l="",c="";return r.callRemoteAction(RemoteActions.unbundleManually,e,t).then(function(e){var t=void 0,n=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var i=e.error_msg.split("/bundleflow"),t=i[0]+" or ask your Salesforce admin for help.",n=i[0].split("endpoint =")[1]}catch(e){t="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",n="the URL"}alert(t),u.addNotification(customLabels.FailedUnbundledM,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+n,function(){});i={message:customLabels.FailedUnbundledM,status:"ERROR"};return p.$broadcast("showServiceExpertToast",i),void o.resolve(resBundledMembers)}if(e&&e.debugMode)for(var s in console.log("--unbundle---"),console.log(e),e)console.log(s+": "+e[s]);var t="On Demand"!==window.__gantt.checkRulesMode,n=(d.getDelta(t),e.unbundleStatus),r=e.unbundle;if("STATUS_MULTI_UNBUNDLE_COMPLETE"==n)return i=customLabels.SuccessfullyUnbundledM,p.$broadcast("showServiceExpertToast",{message:i,status:"SUCCESS"}),t=customLabels.SuccessfullyUnbundledM,u.addNotification(customLabels.SuccessfullyUnbundledNT,t,function(){}),void o.reject(e.bundleStatus);if("STATUS_MULTI_UNBUNDLE_FAILED"==n)return i=customLabels.FailedUnbundledM,p.$broadcast("showServiceExpertToast",{message:i,status:"ERROR"}),t=customLabels.FailedUnbundledM,u.addNotification(customLabels.FailedUnbundledNTM,t,function(){}),void o.reject(e.bundleStatus);if("STATUS_MULTI_UNBUNDLE_PARTIAL"==n)return i=customLabels.PartialUnbundledM,p.$broadcast("showServiceExpertToast",{message:i,status:"ERROR"}),t=customLabels.PartialUnbundledM,u.addNotification(customLabels.FailedUnbundledNT,t,function(){}),void o.reject(e.bundleStatus);if("COMPLETE_UNBUNDLE"==n)return e.AppointmentNumber?a.push(e.AppointmentNumber):Object.keys(r).map(function(e){r[e]&&r[e].AppointmentNumber&&a.push(r[e].AppointmentNumber)}),i={message:l=1<a.length?customLabels.SuccessfullyUnbundledM:(c=a[0],String.format(customLabels.SuccessfullyUnbundled,c)),status:"SUCCESS"},p.$broadcast("showServiceExpertToast",i),u.addNotification(customLabels.SuccessfullyUnbundledNT,l,function(){}),void o.resolve(r);t="",n={message:t=e.shortMsg&&""!=e.shortMsg?e.shortMsg:t,status:"ERROR"},p.$broadcast("showServiceExpertToast",n),i="";e.longMsg&&""!=e.longMsg&&(i=e.longMsg),u.addNotification(customLabels.FailedUnbundledNT,i,function(){}),o.reject(r)}).catch(function(e){console.warn(e),Object.keys(n).map(function(e){n[e]&&n[e].AppointmentNumber&&a.push(n[e].AppointmentNumber)});var t={message:l=1<a.length?customLabels.FailedUnbundledM:(c=a[0],String.format(customLabels.FailedUnbundled,c)),status:"ERROR"};p.$broadcast("showServiceExpertToast",t),u.addNotification(customLabels.FailedUnbundledNT,l,function(){}),o.reject(e)}),o.promise},verifyShowSaOnGantt:function(e){return n()&&e?e=n()&&i(e)?t.serviceAppointments()[e.RelatedBundle]:e:e}}}e.$inject=["$q","sfdcService","DeltaService","utils","$timeout","TimePhasedDataService","$rootScope","ServiceAppointmentLightboxService"],angular.module("serviceExpert").factory("BundleService",e)}(),!function(){function e(o,a,l,t,s,c,d,e,u,n,p){var m=null,h=void 0,i=200,r=1,g=2,v=3,f=4,S=5;function y(e){u.setLightBoxStatus(!1),m.$destroy(),e||m.deffered.reject("closed")}function b(){var t=0;return Object.keys(m.selectedSa).map(function(e){m.selectedSa[e]&&t++}),t}function _(){var e,t;m.errorMode==f&&(m.errorMode=0),m.errorMode||(e=b(),i<e&&(m.errorMode=f,t=(t=customLabels.SelectedServiceAppointmentMax).replace("(0)",i),m.errorMsg=t.replace("(1)",e-i)))}function w(e){m.mode=e}function T(e){t.open(e)}function L(e){m.selectedSa[e]=!m.selectedSa[e],_()}function A(){var t=!0;return Object.keys(m.selectedSa).map(function(e){m.selectedSa[e]||(t=!1)}),t}function C(){var t=!0;return Object.keys(m.selectedSa).map(function(e){m.selectedSa[e]&&(t=!1)}),m.bundlerMap[m.existingBundler]||"UPDATE"!==m.mode||(t=!0),m.selectedBundlePolicy&&m.bundlerPolicyMapLookup[m.selectedBundlePolicy]||"NEW"!==m.mode||(t=!0),t=m.isNativeMode&&"NEW"===m.mode?!1:t}function D(){m.getAllSelected()?m.lightboxServices.forEach(function(e){m.selectedSa[e.id]=!1}):m.lightboxServices.forEach(function(e){m.selectedSa[e.id]=!0}),_()}function I(){m.errorMode!=v&&(m.errorMode=0,_())}function k(){if(m.errorMode!=v&&m.errorMode!=f){if(0==b())return m.errorMode=S,void(m.errorMsg=customLabels.BundleNotSelected);m.errorMsg=customLabels.ReviewBundleErrors,m.errorMode=0;var e=m.isNativeMode?m.selectedPolicyId:m.bundlerPolicyMapLookup[m.selectedBundlePolicy],t=m.bundlerMap[m.existingBundler],n=[],i=[];if(Object.keys(m.selectedSa).map(function(e){m.selectedSa[e]&&(n.push(e),i.push(m.fullSaAll[e]))}),"NEW"==m.mode){if(null==e&&0==m.isNativeMode)return void(m.errorMode=r);s.bundleServiceAppointments(n,e,i).then(function(e){console.log(e),h.resolve(e)},function(){h.reject("closed")})}else{if(null==t)return void(m.errorMode=g);s.updateBundleServiceAppointments(n,e,t,m.existingBundler).then(function(e){h.resolve(e)},function(){h.reject("closed")})}y(!0)}}return{open:function(e,t){(m=c.$new(!0)).deffered=o.defer(),h=m.deffered,m.lightboxServices=e,m.mode="NEW",m.errorMode=0,m.errorMsg=customLabels.ReviewBundleErrors,m.isNativeMode=!0,m.workTypes={},m.fullSaAll={},m.skills={},e.forEach(function(e){e.earlyStartView=a("amDateFormat")(e.earlyStart,"l LT"),e.dueDateView=a("amDateFormat")(e.dueDate,"l LT")}),p.callRemoteAction(RemoteActions.getWorkTypes).then(function(e){e.forEach(function(e){m.workTypes[e.Id]=e.Name}),m.showData2=!0}),p.callRemoteAction(RemoteActions.getWorkOrders).then(function(e){e.forEach(function(e){if(e&&e.SkillRequirements)for(var t=0;t<e.SkillRequirements.length;t++)m.skills[e.Id]=m.skills[e.Id]||[],m.skills[e.Id].push(e.SkillRequirements[t].Skill.MasterLabel)}),m.showData=!0}),p.callRemoteAction(RemoteActions.checkBundleConfig).then(function(e){0==e&&(m.errorMode=v,m.errorMsg=customLabels.NoBundleConfig)}),p.callRemoteAction(RemoteActions.getBundleApexMode).then(function(e){(m.isNativeMode=e)||p.callRemoteAction(RemoteActions.getBundlePolicy).then(function(e){m.bundlerPolicyArr=[],m.bundlerPolicyMap={},0==e.length&&m.errorMode!=v&&(m.errorMode=v,m.errorMsg=customLabels.NoBundlePolicies),e.forEach(function(e){i=36<e.Name.length?e.Name.substring(0,33)+"...":e.Name,m.bundlerPolicyNamesMapLookup[i]=e.Name,m.bundlerPolicyArr.push(i),m.bundlerPolicyMapLookup[i]=e.Id,m.bundlerPolicyMap[e.Id]=i},function(e){console.error(e)})})}),m.selectedValue="cleared",m.cleared=!1,m.fraudulent=!1,m.reviewed=!1,m.selectedPolicyId=t,m.selectedSa={},m.lightboxServices.forEach(function(e){m.selectedSa[e.id]=!0,m.fullSaAll[e.id]=e}),m.$on("keypress",function(e,t){27==t.which&&(m.$evalAsync(m.closeLightbox),h.reject("closed"))}),m.bundlers=[],m.bundlerMap={},m.bundlerFullNameMap={},m.bundlerPolicyMap={},m.bundlerPolicyMapLookup={},m.bundlerPolicyNamesMapLookup={},m.bundlerPolicyArr=[];var n,i="";for(n in d.serviceAppointments()){var s=d.serviceAppointments()[n];s.isBundle&&(m.bundlers.push(s.name),m.bundlerMap[s.name]=s.id,m.bundlerFullNameMap[s.id]=s.name)}var r=angular.element('\n                <div class="LightboxBlackContainer" id="createUpdateBundlePopup" >\n                    <div id="BundlerLightbox" class="LightboxContainer">\n\n                        <div class="lightboxHeaderContainer" id="BundlerLightboxHeader">\n                            <svg ng-click="closeLightbox(false)" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <h1 class="light-box-header">'+customLabels.BundleCaption+'</h1>\n                        </div>\n\n                        <div class="lightboxContentContainer">\n\n                       <div  ng-show="errorMode != 0" class=\'slds-theme_error bundle-error\'> \n                            <svg aria-hidden="true" class="slds-icon bundler-error-icon">\n                                        <use xlink:href="'+lsdIcons.violation+'"></use>\n                                    </svg>\n                         {{errorMsg}}\n                        </div> \n                       \n\n                            <p class="saHeader">{{selectedCount()}} '+customLabels.SelectedServiceAppointment+'</p>\n\n                            <div class="tableDiv slds">\n                                \n                                <table id="saTable" class="slds slds-table slds-table_cell-buffer slds-table_bordered" >\n                                        <thead>\n                                        <tr class="slds slds-line-height_reset">\n                                        <th> <input ng-checked="getAllSelected()" ng-click="allSelection()" type="checkbox" > </th>\n                                            <th>'+customLabels.SANumberHeader+"</th>\n                                            <th>"+customLabels.DurationHeader+"</th>\n                                            <th>"+customLabels.AddressHeader+"</th>\n                                            <th>"+customLabels.EarlyStartHeader+"</th>\n                                            <th>"+customLabels.DueDateHeader+"</th>\n                                            <th>"+customLabels.WorkTypeHeader+"</th>\n                                            <th>"+customLabels.AccountHeader+"</th>\n                                            <th>"+customLabels.RequiredSkillsHeader+'</th>\n                                        </tr>\n\n                                        </thead>\n                                        <tbody class=\'slds slds-tbody\'> \n                                        <tr class="slds slds-hint-parent dataRow maxHight30" ng-repeat="sa in lightboxServices | orderBy: \'name\' " >   \n                                        <td class="Width20">\n                                        <input ng-checked="showData && showData2 && selectedSa[sa.id]" ng-click="toggleSelection(sa.id)" type="checkbox" value="{{sa.id}}">\n                                        </td> \n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.name}}">\n                                                <a class="saLink ng-click="" target="_blank" href="../{{ sa.id }}" title="{{sa.name}}">{{showData && showData2 ? sa.name : \'\'}}</a>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.DurationInMinutes}}">\n                                                <span class="">{{showData && showData2 ? sa.DurationInMinutes : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.City + \' \' + sa.Street}}">\n                                                <span class="">{{showData && showData2 ? sa.City + \' \' + sa.Street : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.earlyStartView}}" ng-bind="showData && showData2 ? sa.earlyStartView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.dueDateView}}" ng-bind="showData && showData2 ? sa.dueDateView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}">\n                                                <span class="">{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.accountName}}">\n                                                <span class="">{{showData && showData2 ? sa.accountName : \'\'}}</span>\n                                            </td>\n\n                                            <td class="slds slds-truncate Width100 " ng-attr-title="{{ skills[sa.parentRecord].join(\',\') }}" >\n                                            <span class=""> {{ showData && showData2 ? skills[sa.parentRecord].join(\',\') : \'\' }}</span>\n                                        </td>\n                                           \n                                        </tr>\n                                        </tbody>\n                                </table>\n                                \n                                \n                            </div>\n\n                             <p>\n                                <div>\n                                    <input ng-model="mode" id="createBundleMode" checked="checked" class="modeRadioButton" type="radio" ng-change="clearError()" value="NEW" ng-disabled="errorMode == 3"><label class="radioLables" for="createBundleMode">'+customLabels.CreateNewBundle+'</label></td>\n                                </div>    \n\n                                    <div class="newB">\n                                        <div class="selectBundler" ng-hide="isNativeMode == true">\n                                            <div><span class="required">*</span><span>'+customLabels.BundlePolicy+'</span></div>\n                                            <div>\n                                                <input type="text" ng-class="errorMode == 1  ? \'error-field\' : \'\' " list="bundlerPolicyList" ng-change="clearError()" placeholder="'+customLabels.SelectBundlePolicyDrop+'" ng-model="selectedBundlePolicy"  title="{{bundlerPolicyNamesMapLookup[ selectedBundlePolicy ]}}" class="bundlerInput" ng-disabled="mode === \'UPDATE\' || errorMode == 3">\n                                                \n                                                <datalist id="bundlerPolicyList">\n                                                    <option ng-repeat="(key, value) in bundlerPolicyMap"  [key]="{{value}}">{{value}}</option>\n                                                </datalist>\n                                            </div>\n\n                                            <div ng-class="errorMode == 1 ? \'field-required-lable\' : \'error-hide\' ">'+customLabels.SelectAPolicy+'</div>\n\n                                        </div>\n                                    </div>\n                                <div>\n                                    <p>\n                                        <div>\n                                            <input ng-model="mode" id="updateBundleMode" class="modeRadioButton" type="radio" ng-change="clearError()" value="UPDATE" ng-disabled="errorMode == 3" ><label class="radioLables" for="updateBundleMode">'+customLabels.AddToExistingBundle+'</label> \n                                        </div>\n\n                                        <div class="updateB">\n                                            <div class="selectBundler">\n                                            <div><span class="required">*</span><span>'+customLabels.ExistingBundle+'</span></div>\n                                                <div>\n                                                    <input type="text" ng-class="errorMode == 2 ? \'error-field\' : \'\' " list="bundlerList" placeholder="'+customLabels.SelectBundle+'" title="{{existingBundler}}" ng-model="existingBundler" ng-change="clearError()" class="bundlerInput" ng-disabled="mode === \'NEW\' || errorMode == 3 ">\n                                                    \n                                                    <datalist id="bundlerList">\n                                                        <option ng-repeat="bundlerName in bundlers" value="{{bundlerName}}"/>\n                                                    </datalist>\n                                                </div>\n                                                <div ng-class="errorMode == 2 ? \'field-required-lable\' : \'error-hide\' ">'+customLabels.SelectAnExistingBundle+'</div>\n                                            </div>\n                                        </div>    \n                                    </p>\n                                </div>\n                                    \n                               \n                            </p>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n\n                            <button class="btn cancelButton" ng-click="closeLightbox(false)">'+customLabels.CancelButton+'</button>\n                            <button class="btn apllyButton"  ng-click="apply()" ng-disabled="errorMode == 3" >'+customLabels.SaveButton+'</button> \x3c!-- ng-disabled="nonSelected()"--\x3e\n                        </div>\n\n                    </div>\n                </div>\n            ');return r.find("#BundlerLightbox").draggable({containment:"document",handle:"#BundlerLightboxHeader"}),angular.element("body").append(r),m.closeLightbox=y,m.setMode=w,m.apply=k,m.clearError=I,m.toggleSelection=L,m.allSelection=D,m.nonSelected=C,m.getAllSelected=A,m.editSa=T,m.checkMax=_,m.selectedCount=b,m.$on("$destroy",function(){return r.remove()}),l(r)(m),r.show(),u.setLightBoxStatus(),_(),m.deffered.promise}}}e.$inject=["$q","$filter","$compile","ServiceAppointmentLightboxService","BundleService","$rootScope","TimePhasedDataService","userSettingsManager","StateService","utils","sfdcService"],angular.module("serviceExpert").factory("BundlerAddCreateLightboxService",e)}(),angular.module("serviceExpert").factory("calendarsService",["ResourcesAndTerritoriesService","TimePhasedDataService","HolidayService","$rootScope","utils",function(N,$,G,e,B){var c={},S={},H={};function U(e,t){return B.convertDtToMomentDt(e,t)}function V(e){return B.convertMomentDtToDt(e)}function y(e,t,n,i,s){y(e,t,n,i,s,null,null)}function y(e,t,n,i,s,r){y(e,t,n,i,s,r,null)}function y(e,t,n,i,s,r,o){var a=N.getOperatingHours()[n]||r,l=a.timezone,c=useLocationTimezone?l:userTimeZone;if(s&&useLocationTimezone)for(var d=i.split(","),u=0;u<d.length;u++)var p=d[u].split("_")[1],p=N.territories()[p].operatingHours,c=N.getOperatingHours()[p].timezone;for(var m,r=U(e,c),e=U(t,c),h=(r.clone().tz(l),e.clone().tz(l),V(r)),g=V(e),v=h,f=[r.clone().add(-1,"days"),r.clone(),r.clone().add(1,"days")],S=0;S<f.length;S++){var y=f[S],b=[];if(o){var _=o[B.formatDayToString(V(y))];if(_)for(var w=0;w<_.length;w++)_[w].serviceTerritoryId!=i.split("_")[1]&&_[w].serviceTerritoryId||b.push({slotStart:_[w].startTime,slotFinish:_[w].endTime,type:_[w].timeSlotType,record:"shift",hasTerritory:!!_[w].serviceTerritoryId,isHolidaySlot:!!isHolidayEnabled&&_[w].isHolidayShift,slotColor:_[w].backgroundColor})}if(a)for(var T=a.slots[y.get("day")]||[],L=0;L<T.length;L++){var A=T[L],C=z(y,A,"startHour","startMinute",l,c,s),E=(0==A.startHour&&24==A.endHour&&0!==A.endMinute&&(A.endHour=0),z(y,A,"endHour","endMinute",l,c,s));b.push({slotStart:C,slotFinish:E,type:A.type,record:"timeslot"})}var D=[],D=o&&!a||!o&&a?b:function(e,t){for(var n=[],i=0;i<e.length-1;i++){var s=void 0,r=e[i],o=e[i+1];if(r.getTime()!=o.getTime()){for(var a=0;a<t.length;a++){var l,c=t[a];!B.intersectDates({start:r,finish:o},{start:c.slotStart,finish:c.slotFinish}).intersection||(void 0===(l=s)||"timeslot"==l.record||"shift"==l.record&&(!l.hasTerritory&&c.hasTerritory||!l.isHolidaySlot&&c.isHolidaySlot)||(l.hasTerritory&&c.hasTerritory||!l.hasTerritory&&!c.hasTerritory)&&l.originalSlotStart>c.slotStart)&&(s={slotStart:r,slotFinish:o,type:c.type,record:c.record,hasTerritory:c.hasTerritory,originalSlotStart:c.slotStart,isHolidaySlot:c.isHolidaySlot,slotColor:c.slotColor})}s&&n.push(s)}}return n.reduce(function(e,t){var n;return e.length?(n=e.pop()).slotFinish==t.slotStart&&n.record==t.record&&n.type==t.type&&n.isHolidaySlot==t.isHolidaySlot&&"shift"!=n.record&&"shift"!=t.record?(n.slotFinish=t.slotFinish,e.push(n)):e.push(n,t):e.push(t),e},[])}((m=b)&&m.length?m.reduce(function(e,t){return e.push(t.slotStart,t.slotFinish),e},[]).sort(function(e,t){return e-t}):[],b.sort(function(e,t){return e.slotStart-t.slotStart}));a&&$.operatingHoursAndHolidays()&&!function(){var e=B.formatDayToString(V(y)),e=($.operatingHoursAndHolidays()[n]||{})[e]||[],t=[];e.forEach(function(e){t.push(G.enhanceHoliday(e,i,l,c,n))}),G.addHolidaysIntoCollection(t),D=function(e,t,n,i){e.forEach(function(e){return G.trimHoliday(e,n,i)}),e.sort(function(e,t){return e.start-t.start||e.finish-t.finish});e=G.mergeHolidays(e);return G.excludeHolidaysFromSlots(e,t,"slotStart","slotFinish")}(t,D,h,g)}();for(var I=0;I<D.length;I++){var k,R,F,M,x,O,P=B.intersectDates({start:D[I].slotStart,finish:D[I].slotFinish},{start:h,finish:g}).intersection;P&&(k=P.start,P=P.finish,"shift"==D[I].record&&D[I].slotColor?(j(v,k,i,null),j(k,P,i,D[I].record,D[I].slotColor)):"Extended"==D[I].type?(j(v,k,i,null),j(k,P,i,D[I].type)):j(v,k,i,D[I].type),R=M=O=x=F=void 0,R=k,x=P,F=D[I].type,M=i,x=(x.getTime()-R.getTime())/6e4,(O=H[M])||(O={},H[M]=O),M=B.formatDayToString(R),(R=O[M])||(R={regular:0,overtime:0},O[M]=R),"Extended"==F?R.overtime+=x:R.regular+=x,v=P)}}j(v,g,i,null)}function z(e,t,n,i,s,r,o){e=V(e),e.setHours(t[n]),e.setMinutes(t[i]),n=useLocationTimezone?s:userTimeZone;return o&&useLocationTimezone&&(n=r),V(U(e,s).tz(n))}function j(e,t,n,i,s){if(e.getTime()!=t.getTime()){var r,o={};for(r in scheduler.matrix)"MonthlyView"!==r&&"LongView"!==r&&(o[r]=-1<n.indexOf(",")?n.split(","):[n]);var a="gray_section",l=void 0;"shift"===i&&s?(l='<div style="background-color: '+(s+="99").encodeHTML()+'; width:100%; height:100%;"></div>',a=void 0):"Extended"===i&&(a="overtime_section"),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:o,css:a,html:l})}}function b(e){var t,n={},i=e||$.resourcesByPrimariesAndRelocations();for(t in i){var s,r,o=i[t],a={};for(s in n[t]=a,o){var l=o[s],c=a[l.serviceTerritory];c||(a[l.serviceTerritory]=c=[]),c.push({start:l.effectiveStartDate||l.start,finish:l.effectiveEndDate||l.finish,serviceTerritory:l.serviceTerritory,operatingHours:l.operatingHours,type:l.serviceTerritoryType||l.type,id:l.id,ohTerr:l.ohTerr||null,serviceTerritory__r:l.serviceTerritory__r||null})}for(r in a)a[r].sort(B.sortByTime)}return n}e.$on("gotNewTimePhasedSTMsAndShifts",function(e,t){for(var n=t.start,i=t.finish,s=(t.resourceToServiceCrewMembers,new Date(n)),r=null;s<i;){var o=B.formatDayToString(s);if(!c[o]){c[o]=!0,r=r||b($.resourcesAndTerritories());var a,l=new Date(s);for(a in l.setDate(l.getDate()+1),N.getResources())!function(e,t,n,i,s){var r,o={P:[],R:[],S:[]},a={};for(r in i){for(var l=i[r].slice(),c=B.generateResourceId(n,r),d=e,u=0;u<l.length;u++){var p=l[u],m=B.intersectDates({start:d,finish:t},p);if(o[p.type].push(p),"S"==p.type)a[p.serviceTerritory]=p;else if(m.intersection){for(var h,g=0;g<m.remainderFrom1.length;g++){var v=m.remainderFrom1[g];v.isStart&&j(v.start,v.finish,c)}"R"!=p.type||S[p.id]||s||!function(e,t,n){var i=[];if(showSecondarySTMs)for(var s in t)for(var r=0;r<t[s].length;r++)"S"!=t[s][r].type&&-1==i.indexOf(s)&&i.push(s);else i=Object.keys(t);i.splice(i.indexOf(e.serviceTerritory),1);var o=e.serviceTerritory;{var a;N.territories()[o]&&(o=N.territories()[o].operatingHours,a=N.getOperatingHours()[o].timezone)}for(var l=0;l<i.length;l++){var c=[B.generateResourceId(n,i[l])],d=(S[e.id]=!0,e.start),u=e.finish,p=(useLocationTimezone&&N.territories()[i[l]]&&(p=N.territories()[i[l]].operatingHours,p=N.getOperatingHours()[p].timezone,d=V(U(d,a).tz(p)),u=V(U(u,a).tz(p))),N.territories()[e.serviceTerritory]?N.territories()[e.serviceTerritory].name:null),m=null,h=null;h=p?(m=customLabels.Relocated_to.replace("$0",_.escape(p)),_.escape(customLabels.Relocated_to_many_params.replaceAll(p||customLabels.Relocated_No_Permissions,moment(d).format("llll"),moment(u).format("llll")))):(m=customLabels.Relocated_No_Permissions,_.escape(customLabels.Relocated_to_no_permissions_many_params.replaceAll(moment(d).format("llll"),moment(u).format("llll"))));scheduler.addMarkedTimespan({start_date:d,end_date:u,sections:{ZoomLevel2:c,ZoomLevel3:c,ZoomLevel4:c,ZoomLevel5:c,ZoomLevel6:c,ZoomLevel7:c},html:"<div class='relocatedLabel' title='"+h+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg> "+m+"</div>",css:"relocation"}),scheduler.addMarkedTimespan({start_date:d,end_date:u,sections:{MonthlyView:c,MTDView:c,LongView:c},html:"<div class='relocatedLabel' title='"+h+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg></div>",css:"relocation_monthly"})}}(p,i,n),d=m.intersection.finish,N.allTerritories[r]&&(p=p.operatingHours||N.allTerritories[r].operatingHours,h=$.resourcesAndShifts()[n],p?y(m.intersection.start,m.intersection.finish,p,c,s,null,h):j(m.intersection.start,m.intersection.finish,c))}}d.getTime()==t.getTime()||a[c.split("_")[1]]||j(d,t,c)}{var f;!showSecondarySTMs||B.isEmpty(a)||s||(f=b(function(e,t){var n={};n[t]={};for(var i=0;i<e.P.length;i++){var s=e.P[i];if(0==e.R.length)n[t][s.id]=s;else for(var r=0;r<e.R.length;r++){var o=e.R[r],a=B.intersectDates(s,o);if(a.intersection||(n[t][s.id]=s),0<a.remainderFrom1.length)for(var l=0;l<a.remainderFrom1.length;l++){var c=angular.copy(s);c.start=a.remainderFrom1[l].start,c.finish=a.remainderFrom1[l].finish,n[t][s.id+"_"+l]=c}n[t][o.id]||((o=angular.copy(o)).serviceTerritory=s.serviceTerritory,n[t][o.id]=o)}}var d={};d[t]={};for(var u=0;u<e.S.length;u++){var p,m=e.S[u];for(p in n[t]){var h=n[t][p],g=B.intersectDates(h,m);g.intersection&&((h=angular.copy(h)).start=g.intersection.start,h.finish=g.intersection.finish,window.isShowSecondaryOperatingHours&&m.operatingHours&&(h.operatingHours=m.operatingHours),h.ohTerr=h.serviceTerritory,h.serviceTerritory=m.serviceTerritory,d[t][p+"_"+u]=h)}}return d}(o,n)),function(e,t,n,i,s){for(var r in i){for(var o=i[r].slice(),a=B.generateResourceId(n,r),l=e,c=0;c<o.length;c++){var d=o[c],u=B.intersectDates({start:l,finish:t},d);if(u.intersection){for(var p=0;p<u.remainderFrom1.length;p++){var m=u.remainderFrom1[p];m.isStart&&j(m.start,m.finish,a)}l=u.intersection.finish;var h=void 0;try{h=d.operatingHours||(N.allTerritories[d.ohTerr]?N.allTerritories[d.ohTerr].operatingHours:d.serviceTerritory__r?d.serviceTerritory__r.OperatingHoursId:void 0)}catch(e){h=null}var g,v=$.resourcesAndShifts()[n];h||v.length?(g=void 0,N.getOperatingHours()[h]||(g=d.serviceTerritory__r.OperatingHours),y(u.intersection.start,u.intersection.finish,h,a,s,g,v)):j(u.intersection.start,u.intersection.finish,a)}}l.getTime()!=t.getTime()&&j(l,t,a)}}(e,t,n,f[n],!0))}}(new Date(s),new Date(l),a,r[a])}s.setDate(s.getDate()+1)}});var t={resourceToWorkingDates:H,relocationsOnGantt:S,reset:function(){c={},S={},H={},t.resourceToWorkingDates=H}};return t}]),!function(){function e(n,s,r,e,i,o,a,t,l,c,d){var u=null;function p(){a.setLightBoxStatus(!1),u.$destroy()}function m(e){u.capacityKpi={hoursCapacity:0,hoursInUse:0,completed:0,jeopardy:0,workItemsCapacity:0,workItemsAllocated:0},u.dummyServicesCount=0;var t=scheduler.getEvent(e),n=scheduler.getEvents(t.start_date,t.end_date);u.servicesScheduledToCapacity={},u.capacityKpi.hoursCapacity=t.hoursPerTimePeriod||0,u.capacityKpi.hoursInUse=t.hoursInUse||0,u.capacityKpi.completed=0,u.capacityKpi.jeopardy=0,u.capacityKpi.violations=0,u.capacityKpi.workItemsCapacity=t.workItemsPerTimePeriod||0,u.capacityKpi.workItemsAllocated=t.workItemsAllocated||0;for(var i=u.capacityKpi.total=0;i<n.length;i++)n[i].resourceId===t.resourceId&&"service"===n[i].type&&(n[i].isDummy?u.dummyServicesCount++:("LongView"!==scheduler._mode||scheduler.filter_LongView(n[i].id,n[i],!1))&&n[i].start.getTime()>=t.start_date.getTime()&&n[i].start.getTime()<=t.end_date.getTime()&&(u.capacityKpi.total++,n[i].statusCategory===l.COMPLETED&&u.capacityKpi.completed++,n[i].jeopardy&&u.capacityKpi.jeopardy++,n[i].violations&&u.capacityKpi.violations++,u.servicesScheduledToCapacity[n[i].id]=n[i]))}function h(){return customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(u.kpiStart).format("llll"),moment(u.kpiEnd).format("llll"))}function g(e){return 0<Object.keys(e).length?Object.keys(e):0}function v(e){s.flagged[e]?s.flagged[e]&&(s.flagged[e]=!s.flagged[e]):s.flagged[e]=!0}function f(e,t){""===(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)?alert(customLabels.no_empty_msg_to_chatter):(s.recentlyUsed[e]=!0,s.postToChatter([e],t).then(function(e){}))}function S(t){if(u.unscheduleRunning||!confirm(customLabels.are_you_sure_unschedule))return!0;var n=[],i=[];t.forEach(function(e){u.invokedActionFor[e]=!0,i.push(r.serviceAppointments()[e]),n.push(r.serviceAppointments()[e].resource),s.recentlyUsed[e]=!0}),u.unscheduleRunning=!0,s.unscheduleServices(t).then(function(e){s.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),m(u.lightboxCapacity.id),u.invokedActionFor[t[0]]=!1,u.unscheduleRunning=!1}).catch(function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),u.invokedActionFor[t[0]]=!1,u.unscheduleRunning=!0})}function y(e){if(e.violations){for(var t="",n=0;n<e.violations.length;n++)t+=e.violations[n].RuleName+" - "+e.violations[n].ViolationString+"\n";return t=t&&t.substring(0,t.length-1)}}return{open:function(e){(u=n.$new(!0)).lightboxCapacity=r.resourceCapacities()[e],u.fieldsTypes=o.fieldsTypes,u.selectedTab="details",u.kpiStart=u.lightboxCapacity.start_date,u.kpiEnd=u.lightboxCapacity.end_date,u.servicesScheduledToCapacity={},u.tableSort={orderByField:"",reverse:!1},u.flaggedServices=s.flagged,u.invokedActionFor={},u.SERVICE_CATEGORY=l,u.currentMenu=null,u.dummyServicesCount=0,u.closeLightbox=p,u.openConsoleTab=o.openConsoleTab,u.formatKpitText=h,u.getObjectKeys=g,u.flagService=v,u.unscheduleServices=S,u.postToChatter=f,u.getStatusClass=o.getCSSClassForContext,u.violationsTooltip=y,u.calculateKpisForCapacity=m,u.showLongTermWarning=function(){return"LongView"===scheduler._mode},u.unscheduleRunning=!1,d.fieldsSetFields().then(function(e){u.servicesListFields=e.CapacityServiceColumns,u.tableSort.orderByField=u.servicesListFields[0].FullAPIName}),u.order=function(e,t){u.tableSort.orderByField=e,u.tableSort.reverse=t},u.getRefFieldID=function(e,t){return e[t.FullAPIName.replace("__r","__c")]},u.setCurrentMenu=function(e){u.currentMenu===e?u.currentMenu=null:u.currentMenu=e},u.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}},m(e);var t=angular.element('<div class="LightboxBlackContainer">\n\t\t\t\t<div class="LightboxContainer" id="ContractorCapacityLightbox">\n\n\t\t\t\t\t<div class="lightboxHeaderContainer" id="ContractorCapacityLightboxHeader">\n\n\t\t\t\t\t\t<svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n\t\t\t\t\t\t</svg>\n\n\t\t\t\t\t\t<h1 class="lightboxHeader">\n\t\t\t\t\t\t\t<i>'+customLabels.Capacity+':</i>\n\t\t\t\t\t\t\t{{ lightboxCapacity.name }}\n\t\t\t\t\t\t</h1>\n\n\t\t\t\t\t\t<span class="lightboxSelectedTab">\n\t\t\t\t\t\t\t'+customLabels.Details+'\n\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t<div class="ExtendedForm">\n\t\t\t\t\t\t\t<a ng-click="openConsoleTab($event,lightboxCapacity.id)" target="_blank" href="../{{ lightboxCapacity.id }}" title="'+customLabels.ExtandedForm+'">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon openExternalIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.external+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div id="KPIforCapacity" class="KPIforCapacity">\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.hoursCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.hoursInUse }}/{{ capacityKpi.hoursCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Hours_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.workItemsCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.standard_objects+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.workItemsAllocated }}/{{ capacityKpi.workItemsCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Services_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t\x3c!--<i class="fa fa-warning"></i>--\x3e\n\t\t\t\t\t\t\t\t{{ capacityKpi.violations }}</div>\n\t\t\t\t\t\t\t'+customLabels.Violations+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.jeopardy+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.jeopardy }}</div>\n\t\t\t\t\t\t\t'+customLabels.In_Jeopardy+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\n\t\t\t\t\t\t\t\t{{ capacityKpi.completed }}/{{ capacityKpi.total }}</div>\n\t\t\t\t\t\t\t'+customLabels.Completed+'\n\t\t\t\t\t\t</div>\n\n                        <div class="KpiRange">{{formatKpitText()}}</div>\n\t\t\t\t\t\t<div class="KpiRange updateKpiData" ng-if="dummyServicesCount > 0" fsl-key-press tabindex="0" ng-click="calculateKpisForCapacity(lightboxCapacity.id)">\n                            New KPI data is available - click to update\n                        </div>\n\t\t\t\t\t</div>\n                    <div id="ContractorCapacityButtons">\n                    \n                            <span id="LongViewWarning" ng-if="showLongTermWarning()">'+customLabels.LongTermCapacityLBWarning+'</span>\n                    \n                            <button class="capacityServiceUnscheduleAll" ng-disabled="unscheduleRunning" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0" ng-click="unscheduleServices(getObjectKeys(servicesScheduledToCapacity))">\n                                <i class="fa fa-ban"></i>\n                                 '+customLabels.Unschedule_All+'\n                            </button>\n                        </div>\n\t\t\t\t\t<div id="ContractorCapacityLightboxContent">\n\t\t\t\t\t\n                            <div class="NoServicesFound" ng-show="!getObjectKeys(servicesScheduledToCapacity)">\n                                <i class="fa fa-times"></i>\n                                <div>'+customLabels.No_services+'</div>\n                            </div>\n                        \n                        <table id="CapacityServicesTable" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0">\n                          <thead>\n                            <tr class="table-header">\n                                <th></th>\n                                <th></th>\n                                <th></th>\n                                <th ng-attr-title="{{field.Label}}" ng-repeat="field in servicesListFields" ng-class="{sortCapacityServicesBy: tableSort.orderByField == field.FullAPIName}" class="truncate capacityServiceColName" ng-click="tableSort.reverse=!tableSort.reverse;order(field.FullAPIName, tableSort.reverse)">\n                                    <span class="">{{field.Label}}</span>\n                                    <span ng-show="tableSort.orderByField == field.FullAPIName">\n                                        <span>\n                                            <svg ng-show ="!tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </span>\n                                    </span>\n                                </th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="(key, capacityService) in servicesScheduledToCapacity | orderObjectBy:tableSort.orderByField:tableSort.reverse" class="capacityServiceRow">\n                                <td ng-style="getStyleForServiceInList(capacityService)" class="TaskStatusColor {{ getStatusClass(capacityService.statusCategory, SERVICE_CATEGORY) }}" ></td>\n                                <td class="moreOptions">\n                                    <button class="serviceCapacityActionsButton" title="Actions" ng-click="setCurrentMenu($index)">\n                                          <svg class="slds-icon carretDownIcon" aria-hidden="true" ng-show="!invokedActionFor[capacityService.id]">\n                                                <use xlink:href="'+lsdIcons.down+'"></use>\n                                          </svg>\n                                          <img class="capacityServiceLoading"\n                                             src="'+lsdIcons.spinnerGif+'"\n                                             ng-show="invokedActionFor[capacityService.id]"/>\n                                    </button>   \n                                    <div id="actions-menu-{{$index}}" class="serviceCapacityActions" ng-show="currentMenu == $index">\n                                        <a fsl-tab-switch role="select" class="saSingleAction" ng-click="openConsoleTab($event,capacityService.id); setCurrentMenu($index);" target="_blank" href="../{{ capacityService.id }}">'+customLabels.Details+'</a>\n                                        <button fsl-tab-switch role="select" class="saSingleAction" ng-click="flagService(capacityService.id); setCurrentMenu($index);">\n                                            <span ng-show="!flaggedServices[capacityService.id]">'+customLabels.Flag+'</span>\n                                            <span ng-show="flaggedServices[capacityService.id]">'+customLabels.Unflag+'</span>\n                                        </button>\n                                        <button fsl-tab-switch role="select" ng-disabled="unscheduleRunning" class="saSingleAction" ng-click="unscheduleServices([capacityService.id]); setCurrentMenu($index);">'+customLabels.Unschedule+'</button>\n                                        <button fsl-tab-switch role="select" class="saSingleAction" ng-click="postToChatter(capacityService.id, \'\'); setCurrentMenu($index);">'+customLabels.Chatter+'</button>\n                                    </div>\n                                </td>\n                                <td class="iconOnServiceRow"\n                                        title="{{ violationsTooltip(capacityService) }}"\n                                        ng-class="{\'serviceList_jeopardy\': capacityService.jeopardy, \'serviceList_violations\': !capacityService.jeopardy && capacityService.violations}">\n                                        <i class="fa fa-bell" ng-if="capacityService.jeopardy"></i>\n                                        <i class="fa fa-warning" ng-if="capacityService.violations && !capacityService.jeopardy"></i>\n                                </td>\n                                <td ng-attr-title="{{capacityService | displayFieldSetField : field}}" ng-repeat="field in servicesListFields" class="truncate">\n                                    <span ng-show="field.Type != fieldsTypes.Reference" title="{{capacityService | displayFieldSetField : field}}">{{capacityService | displayFieldSetField : field}}</span>\n                                    <a ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(capacityService, field))" target="_blank" href="../{{ getRefFieldID(capacityService, field) }}" title="{{capacityService | displayFieldSetField : field}}">\n                                        {{capacityService | displayFieldSetField : field}}\n                                    </a>\n\n                                </td>\n                            </tr>\n                          </tbody>\n                        </table>\n\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>');t.find("#ContractorCapacityLightbox").draggable({containment:"document",handle:"#ContractorCapacityLightboxHeader"}),angular.element("body").append(t),a.setLightBoxStatus(),u.$on("$destroy",function(){return t.remove()}),u.$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),i(t)(u),o.safeApply(u)}}}e.$inject=["$rootScope","servicesService","TimePhasedDataService","$sce","$compile","utils","StateService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","FieldSetFieldsService"],angular.module("serviceExpert").factory("CapacityLightboxService",e)}(),!function(){function e(i,s,e,l,c,d,u,t,r){var n,o,a,p=null,m=deltaInterval||10,h=null,g={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]};function v(e){var n=!(0<arguments.length&&void 0!==e)||e,i=new Date;!1===d.getStreamingActiveState()?(e=d.getDeltaDates(),s.getDelta(p,e.minDate,e.maxDate).then(function(e){var t=1e3*m-(t=i,new Date-t);h=r(f,t<0?0:t),S(e,n)}).catch(function(e){u.addNotification(customLabels.DeltaFailureTitle,customLabels.DeltaFailureMessage,null,null),console.warn(e)})):h=r(f,1e3*m)}function f(){d.isUserIdle()||v(window.__gantt.checkRulesAfterDelta)}function S(t){var n,e,i,s,r,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],a=(p=t.updateTime,[]);(t.deletedAbsence&&0<t.deletedAbsence.length||t.updatedAbsence&&0<t.updatedAbsence.length)&&(n={},0<t.updatedAbsence.length&&(e=l.updateTimePhaseData(t.updatedAbsence,"na"),n.updated=e.absences,n.deleted=e.notApprovedAbsencesIds,e=n.updated.map(function(e){return e.resource}).join(","),a.push.apply(a,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(n.updated),e)))),0<t.deletedAbsence.length&&(n.deleted?n.deleted=n.deleted.concat(l.deleteTimePhaseData(t.deletedAbsence,"na").absences):n.deleted=l.deleteTimePhaseData(t.deletedAbsence,"na").absences,a.push.apply(a,_toConsumableArray(u.getRelatedServices(n.deleted)))),(n.updated||n.deleted)&&g.absences.forEach(function(e){return e(n)})),(t.updatedGanttServices&&0<t.updatedGanttServices.length||t.deletedGanttServices&&0<t.deletedGanttServices.length)&&(i={},0<t.deletedGanttServices.length&&(i.deleted=l.deleteTimePhaseData(t.deletedGanttServices,"service").services,a.push.apply(a,_toConsumableArray(u.getRelatedServices(i.deleted)))),0<t.updatedGanttServices.length&&(i.updated=l.updateTimePhaseData(t.updatedGanttServices,"service").services,a.push.apply(a,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(i.updated))))),(i.updated||i.deleted)&&g.services.forEach(function(e){return e(i)})),t.updatedLivePositions&&(s=c.updatePositions(t.updatedLivePositions)).isUpdated&&g.positions.forEach(function(e){return e(s.dic)}),0<a.length&&g.rules.forEach(function(e){return e(a,o)}),d.areContractorsSupported&&(t.deletedCapacities&&0<t.deletedCapacities.length||t.updatedCapacities&&0<t.updatedCapacities.length)&&(r={},0<t.deletedCapacities.length&&(r.deleted=l.deleteTimePhaseData(t.deletedCapacities,"capacity").capacities),0<t.updatedCapacities.length&&(r.updated=l.updateTimePhaseData(t.updatedCapacities,"capacity").capacities),(r.updated||r.deleted)&&g.capacities.forEach(function(e){return e(r)})),d.isOptimizationEnabled&&t.optimizationRequests&&0<t.optimizationRequests.length&&g.optimizationRequests.forEach(function(e){return e(t.optimizationRequests)})}return h=r(f,1e3*m),d.getStreamingActiveState()?console.log("using streaming"):(n=0,document.addEventListener("mousemove",function(){m=deltaInterval||10,300<n&&deltaInterval<60&&!d.isUserIdle()&&(r.cancel(h),h=r(f,1e3*m),console.warn("Delta interval back to normal.")),n=0}),window.Worker&&((o=new Worker(window.__gantt.InactivityMonitorWorker)).onmessage=function(e){300<=(n+=10)&&deltaInterval<60&&m<60&&(m=60,console.warn("Delta interval decreased.")),d.isUserIdle()&&o.terminate()}),a=setInterval(function(){300<=n&&deltaInterval<60&&60!==m&&(m=60,console.warn("Delta interval decreased.")),n>=window.__gantt.maxSecondsOfInactivity&&clearInterval(a)},30010)),{register:function(e,t){return g[e]&&g[e].push(t)},unRegister:function(e,t){g[e].splice(g[e].indexOf(t),1)},getDelta:function(){var e,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];!1===d.getStreamingActiveState()&&(e=d.getDeltaDates(),s.getDelta(p,e.minDate,e.maxDate).then(function(e){S(e,t)}).catch(function(e){console.warn(e)}))},getDeltaPromise:function(){var e,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],n=i.defer();return!1===d.getStreamingActiveState()?(e=d.getDeltaDates(),s.getDelta(p,e.minDate,e.maxDate).then(function(e){S(e,t),n.resolve(e)}).catch(function(e){console.warn(e),n.reject(res.ex)})):n.resolve(),n.promise},updateOptimizationRequest:function(t){g.optimizationRequests.forEach(function(e){return e([t])})},handleDeltaResponse:S}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","MstResolver","$timeout"],angular.module("serviceExpert").factory("DeltaService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof=(!function(){function e(e,t){var r,o=e.defer();return e.all([t.callRemoteAction(RemoteActions.getServiceListFields),t.callRemoteAction(RemoteActions.getServiceMiniFormFields),t.callRemoteAction(RemoteActions.getServiceMapInfoWindowFields),t.callRemoteAction(RemoteActions.getServiceGanttTooltipFields),t.callRemoteAction(RemoteActions.getServiceCapacityColumns),t.callRemoteAction(RemoteActions.getGanttFilterFields),t.callRemoteAction(RemoteActions.getServicePreviewFields)]).then(function(e){if(r={ListColumns:e[0],ListExpanded:e[1],MapInfo:e[2],GanttToolTip:e[3],CapacityServiceColumns:e[4],ganttFilter:e[5],servicePreview:e[6]},"object"!==_typeof(GanttService.prototype.allFieldSets)){GanttService.prototype.allFieldSets=r;var t,n={};for(t in GanttService.prototype.allFieldSets)for(var i=GanttService.prototype.allFieldSets[t],s=0;s<i.length;s++)n[i[s].APIName]=i[s];GanttService.prototype.allFieldSetsSet=n}o.resolve(r)}).catch(function(e){o.reject(),console.warn("FieldSetFieldsService: unable to get service appointment field sets")}),{fieldsSetFields:function(){return o.promise}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("FieldSetFieldsService",e)}(),!function(){function e(t,r,i,e){var n,o=t.defer(),a=[],s={};function l(e){for(var t,n,i=e,s=1;s<=10;s++)1===s&&-1<e.indexOf("1")?(t=i.indexOf(1),n=i.indexOf(10),-1!==t&&t===n&&(t=i.lastIndexOf(1)),i=i.substr(0,t)+"{1} "+i.substr(t+2)):-1!==i.indexOf(s)&&(i=i.replace(s,"{"+s+"}"));return i}function c(t){var e=!1,n=!1;try{t[fieldNames.GanttFilter.Criterias]&&(e=JSON.parse(t[fieldNames.GanttFilter.Criterias]))}catch(e){n=!0,i.addNotification(window.customLabels.CustomFilterInvalidCriteriaButlerMsg,window.customLabels.CustomFilterInvalidCriteriaButlerBody.replace("$0",t[fieldNames.GanttFilter.Name]),null,null)}return{Id:t.Id,Name:t[fieldNames.GanttFilter.Name],Description:t[fieldNames.GanttFilter.Description],Days_after_horizon:t[fieldNames.GanttFilter.Days_after_horizon],Days_before_horizon:t[fieldNames.GanttFilter.Days_before_horizon],Criterias:e,List_only_appointments_on_the_gantt:t[fieldNames.GanttFilter.List_only_appointments_on_the_gantt],Logic:function(e,t){if(e)return l(e);for(var n in e="",t)e+=n+" AND ";return l(e.substr(0,e.length-5))}(t[fieldNames.GanttFilter.Logic],e),Public:t[fieldNames.GanttFilter.Public],Hidden:t[fieldNames.GanttFilter.Hidden],CreatedById:t.CreatedById,Displayed_Fields:t[fieldNames.GanttFilter.Displayed_Fields]?JSON.parse(t[fieldNames.GanttFilter.Displayed_Fields]):null,disabled:n}}return useNewFilters&&(n=r.callRemoteAction(RemoteActions.getGanttFilters),e=e.fieldsSetFields(),t.all([n,e]).then(function(e){var t,n=e[1],e=e[0],i={FSL__RULE_VIOLATIONS__FSL:!0};for(t in n)n[t].forEach(function(e){i[e.FullAPIName]=!0,i[e.APIName]=!0});var s=[];e.forEach(function(e){e=c(e);!function(e,t){if(!e.Criterias)return 1;for(var n in e.Criterias){if(-1<e.Criterias[n].property.indexOf("."))return void console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")");if(!t[e.Criterias[n].property])return void console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")")}return 1}(e,i)||s.push(e)}),a=s,o.resolve(s)})),{filtersPromise:o.promise,getFilterById:function(t){var n=null;return a.forEach(function(e){n=e.Id===t?e:n}),n},getFilterFromSalesforce:function(e){var s=t.defer();return r.callRemoteAction(RemoteActions.getFilterById,e).then(function(e){for(var t=c(e),n=!0,i=0;i<a.length;i++)if(a[i].Id===t.Id){a[i]=t,n=!1;break}n&&a.push(t),s.resolve(t)}),s.promise},deleteFilter:function(n){var i=t.defer();return r.callRemoteAction(RemoteActions.deleteFilter,n).then(function(){for(var e=-1,t=0;t<a.length;t++)if(a[t].Id===n){e=t;break}-1!==e&&a.splice(e,1),i.resolve(n)}),i.promise},hideFilter:function(n){var i=t.defer();return r.callRemoteAction(RemoteActions.hideFilter,n).then(function(){for(var e=-1,t=0;t<a.length;t++)if(a[t].Id===n){e=t;break}-1!==e&&a.splice(e,1),i.resolve(n)}),i.promise},setFilterMap:function(e){s=Object.assign(e,{})},getFilterMap:function(){return s}}}e.$inject=["$q","sfdcService","utils","FieldSetFieldsService"],angular.module("serviceExpert").factory("GanttFilterService",e)}(),"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e});function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){function e(l,t,u,c,p,m){var d=void 0,h=void 0,g=void 0,a=!1,v=l.defer();function f(e,t){for(var n in e)t(e[n])}function S(e){e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===h.Id||(!0===e.fields[h.ServicePropertyNoNamespace]?e.ganttPaletteColor={color:h.ColorScheme.max.color,palleteId:h.Id}:e.ganttPaletteColor={color:h.ColorScheme.min.color,palleteId:h.Id})}function y(e){var t;e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===h.Id||(t=void 0===(t=e.fields[h.ServicePropertyNoNamespace])?h.ColorScheme.empty:h.ColorScheme.picklist[h.ServiceProperty][t],e.ganttPaletteColor={color:t,palleteId:h.Id})}function b(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t,n=e.fields[h.ServicePropertyNoNamespace],i=(useLocationTimezone&&(t=void 0,e.resourceId?(c=m.getRelevantSTMToGanttService(e))&&c.operatingHours?t=c.operatingHours:c.serviceTerritory&&(t=p.territories()[c.serviceTerritory].operatingHours):e.ServiceTerritoryId&&(t=p.territories()[e.ServiceTerritoryId].operatingHours),c=p.getOperatingHours()[t],t=c?c.timezone:userTimeZone,c=new Date(n),d=userTimeZone,n=u.convertDateBetweenTimeZones(c,t,d).getTime()),void 0),s=void 0,r=void 0,o=void 0,a=void 0;if(void 0===n)i=h.ColorScheme.empty;else{for(var l in g){if(g[l].start<n&&n<=g[l].end){i=l;break}(void 0===s||g[l].start<=s)&&(s=g[l].start,o=l),(void 0===r||g[l].end>r)&&(r=g[l].end,a=l)}void 0===i&&(i=r<n?a:o)}e.ganttPaletteColor={color:i,palleteId:h.Id}}var c,d}function _(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],n=void 0,i=void 0,s=void 0,r=void 0,o=void 0;if(void 0===t)n=h.ColorScheme.empty;else{for(var a in g){if(g[a].start<t&&t<=g[a].end){n=a;break}(void 0===i||g[a].start<=i)&&(i=g[a].start,r=a),(void 0===s||g[a].end>s)&&(s=g[a].end,o=a)}void 0===n&&(n=s<t?o:r)}e.ganttPaletteColor={color:n,palleteId:h.Id}}}function w(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],n=void 0,i=void 0,s=void 0,r=void 0,o=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)n=h.ColorScheme.empty;else{var a,l=A(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,t.latitude,t.longitude);for(a in g){if(g[a].start<l&&l<=g[a].end){n=a;break}(void 0===i||g[a].start<=i)&&(i=g[a].start,r=a),(void 0===s||g[a].end>s)&&(s=g[a].end,o=a)}void 0===n&&(n=s<l?o:r)}e.ganttPaletteColor={color:n,palleteId:h.Id}}}function T(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){e.fields[h.ServicePropertyNoNamespace];var t=void 0,n=void 0,i=void 0,s=void 0,r=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)t=h.ColorScheme.empty;else{var o,a=A(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,e.latitude,e.longitude);for(o in g){if(g[o].start<a&&a<=g[o].end){t=o;break}(void 0===n||g[o].start<=n)&&(n=g[o].start,s=o),(void 0===i||g[o].end>i)&&(i=g[o].end,r=o)}void 0===t&&(t=i<a?r:s)}e.ganttPaletteColor={color:t,palleteId:h.Id}}}function L(e,t){var n;switch(e){case"Seconds":n=1e3*t;break;case"Minutes":n=60*t*1e3;break;case"Hours":n=60*t*60*1e3;break;case"Days":n=24*t*60*60*1e3}return n}function A(e,t,n,i){e=Math.PI*e/180,n=Math.PI*n/180,t=Math.PI*(t-i)/180,i=Math.sin(e)*Math.sin(n)+Math.cos(e)*Math.cos(n)*Math.cos(t);return i=60*(180*Math.acos(i)/Math.PI)*1.1515,"km"===distanceUnit?1.609344*i:.8684*i}return{serviceFieldsMap:function(){var n=l.defer();return void 0!==d?setTimeout(function(){n.resolve(d)},0):t.callRemoteAction(RemoteActions.getServiceFieldsMap).then(function(e){for(var t in d={},e)d[t]=JSON.parse(e[t].replace(/&quot;/g,'"'));n.resolve(d)}).catch(function(e){n.reject(e)}),n.promise},applyNewPaletteForGantt:function(e,t){var n=l.defer();if(void 0===h||h.Id!==e.Id){c.SetUserSettingsProperty("Gantt_Palette__c",e.Id);var i,s,e=d[(h=e).ServiceProperty],r=e.Type,o=!1;if(g={},FieldTypes.DATETIME!==r&&FieldTypes.DATE!==r||(s=function(e,t,n,i,s){for(var r=u.convertMomentDtToDt(moment().tz(userTimeZone)),n=L(n,e),e=L(i,t),o=r.getTime()+n,a=(r.getTime()+e-o)/s,l=[],c=0;c<s;c++){var d={start:o+c*a,end:o+(c+1)*a};l.push(d)}return l}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorScheme.min.type,h.ColorScheme.max.type,h.ColorLevel),o=!0),FieldTypes.DOUBLE!==r&&FieldTypes.LOCATION!==r&&FieldTypes.ADDRESS!==r||(s=function(e,t,n){e=parseFloat(e);for(var i=((t=parseFloat(t))-e)/n,s=[],r=0;r<n;r++){var o={start:e+r*i,end:e+(r+1)*i};s.push(o)}return s}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),o=!0),FieldTypes.INTEGER!==r&&FieldTypes.PERCENT!==r||(s=function(e,t,n){e=parseInt(e);for(var i=((t=parseInt(t))-e)/n,s=(i=Math.round(i),[]),r=0;r<n;r++){var o={start:e+r*i,end:e+(r+1)*i};s.push(o)}return s}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),o=!0),o){i=function(e,t,n){for(var i=[],s=e.substr(1,2),r=e.substr(3,4).substr(0,2),e=e.substr(5,6),o=t.substr(1,2),a=t.substr(3,4).substr(0,2),t=t.substr(5,6),l=parseInt(s,16),c=parseInt(r,16),d=parseInt(e,16),s=parseInt(o,16),r=parseInt(a,16),e=parseInt(t,16),u=(s-l)/n,p=(r-c)/n,m=(e-d)/n,h=0;h<n;h++){var g=Math.round(Math.abs(l+u*h))%256,v=Math.round(Math.abs(c+p*h))%256,f=Math.round(Math.abs(d+m*h))%256,g=g.toString(16),v=(1===g.length&&(g="0"+g),v.toString(16)),f=(1===v.length&&(v="0"+v),f.toString(16)),g=(1===f.length&&(f="0"+f),"#"+g+v+f);i.push(g)}return i}(h.ColorScheme.min.color,h.ColorScheme.max.color,h.ColorLevel);for(var a=0;a<i.length;a++)g[i[a]]=s[a]}switch(e.Type){case FieldTypes.BOOLEAN:f(t,S);break;case FieldTypes.PICKLIST:f(t,y);break;case FieldTypes.DATETIME:case FieldTypes.DATE:f(t,b);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:f(t,_);break;case FieldTypes.LOCATION:f(t,w);break;case FieldTypes.ADDRESS:f(t,T);break;default:console.log("Other")}n.resolve()}else n.resolve();return n.promise},getGanttPalettes:function(e){return e&&t.callRemoteAction(RemoteActions.getGanttPalettes).then(function(e){for(var t,n=e.palettes,i=(a=!0,{}),s=0;s<n.length;s++){var r={};if(r.Id=n[s].Id,r.Name=n[s][fieldNames.GanttServicePalette.Name],r.ServiceProperty=n[s][fieldNames.GanttServicePalette.ServiceProperty],r.ServicePropertyNoNamespace=u.removeFSLNamespace(r.ServiceProperty),void 0!==n[s][fieldNames.GanttServicePalette.ColorScheme])try{r.ColorScheme=JSON.parse(n[s][fieldNames.GanttServicePalette.ColorScheme])}catch(e){r.ColorScheme=void 0}else r.ColorScheme=void 0;r.Description=n[s][fieldNames.GanttServicePalette.Description],r.ColorLevel=n[s][fieldNames.GanttServicePalette.ColorLevel],r.Active=n[s][fieldNames.GanttServicePalette.Active],i[r.Id]=r}for(t in i){var o=i[t]&&i[t].ServiceProperty;o&&e.translations[o]&&(i[t].translations=e.translations[o])}v.resolve(i)}).catch(function(e){v.reject(e)}),v.promise},updateGanttServicePaletteColor:function(e){if(void 0!==h)switch(d[h.ServiceProperty].Type){case FieldTypes.BOOLEAN:S(e);break;case FieldTypes.PICKLIST:y(e);break;case FieldTypes.DATETIME:case FieldTypes.DATE:b(e);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:_(e);break;case FieldTypes.LOCATION:w(e);break;case FieldTypes.ADDRESS:T(e);break;default:console.log("Other")}},resetCurrentPalette:function(){h=void 0,window.paletteViewActive=!1},isEmpty:function(e){if(null==e)return!0;if(0<e.length)return!1;if(0===e.length)return!0;if("object"!==(void 0===e?"undefined":_typeof(e)))return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},werePalettesLoaded:function(){return a}}}e.$inject=["$q","sfdcService","utils","userSettingsManager","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("GanttPalettesService",e)}(),!function(){function e(i,s,r,o,a){var l=null;function t(){return l.closeLightbox()}function c(){l.killWatch&&l.killWatch(),a.setLightBoxStatus(!1),l.$destroy(),l=null}return window.addEventListener("message",function(e){"closeLightbox"===e.data&&t()},!1),{open:function(e,t){var n;l||((l=i.$new(!0)).url=s.trustAsResourceUrl(t).toString(),__gantt.communityNetworkId&&(l.url=l.url.replace("/apex/","")),l.title=e,l.closeLightbox=c,(n=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer lightbox-general" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            \n                            <h1 class="light-box-header" ng-bind="title"></h1>\n                        </div>\n                        \n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ url }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>")).find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),n.find("#ResourceLightbox").resizable({minHeight:560,minWidth:940,maxWidth:940,handles:"s"}),angular.element("body").append(n),a.setLightBoxStatus(),l.$on("$destroy",function(){return n.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),r(n)(l),o.safeApply(l))},closeLightboxFromOutside:t}}e.$inject=["$rootScope","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("GeneralLightbox",e)}(),!function(){function e(D,n,I,l,i,k,R,s,e,c,d,r,u,o){var a=2,F=null,M=null,p=!1,m={STAR:candidatesGrades.ideal,EXCELLENT:candidatesGrades.ideal,GOOD:candidatesGrades.reecommended};function h(e){F&&g(),F=D.$new(!0),window.__servicesInFilter&&(window.__servicesInFilter.applied=!1,updateViewDebounced()),M=null,F.StateService=R,F.wereSlotsAlreadyDrawnOnGantt=!1,F.gettingSlots=!0,F.closePanel=g,F.getResourceField=f,F.generateMstText=U,F.formatDateIntervalFinish=y,F.formatDateInterval=S,F.service=I.serviceAppointments()[e],F.generateResultText=x,F.allSlotsArray=null,F.slotsTimespansIds=[],F.trustHtml=k.trust,F.jumpToDate=T,F.GRADES=m,F.scheduleToSlot=V,F.replaceLabels=L,F.openLightbox=A,F.showOnGantt=N,F.formatDateHeader=b,F.notifyWhenDoneGettingSlots=_,F.shouldNotify=!1,F.scheduledActionInvoked=!1,F.groupSlotsBy="Resource",F.roundGrade=v,F.bestSlot=null,F.gotSlots=!0,F.exception=null,F.isMst=!1,F.mstPromise=null,F.schedulingTakesLong=!1,F.rawTimespans=[],F.partialResults=[],F.showPartialData=!1,F.generateAsyncLabel=H,F.formatTooltipHeader=G,F.formatAsapObjective=B,F.isAdmin=!1,void 0===window.userHasAdminPermissions?l.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=!!e&&(F.isAdmin=!0)}):F.isAdmin=window.userHasAdminPermissions,F.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},p||l.getSlots(e,R.selectedPolicyId).then(function(e){if(e&&e.value&&e.value.FSLOperationId)return F.isMst=!0,n(function(){return F.schedulingTakesLong=!0},1e3*a),void(F.mstPromise=r.getUpdates(e.value.FSLOperationId).then(function(e){return F.shouldNotify||w({value:e.fslOperation.result}),e}).catch(function(e){console.error(e);e={message:e.message||e};return F.shouldNotify||w({eventType:"exception",event:e}),o.reject({eventType:"exception",event:e})}));w(e)}).catch(function(e){var t={message:e.message||e};console.warn("could not get candidates"),console.log(e),F.shouldNotify||w({eventType:"exception",event:t})}),e='\n                <div id="GetSlotsPanel" xmlns="http://www.w3.org/1999/html">\n\n                    <div class="slots-panel-title-head">\n                        <div class="slots-panel-title">\n                            {{ replaceLabels(\'ShowingCandidatesTo\', [service.name] ) }}\n                        </div>\n                        <div class="clear-slots truncate" ng-click="closePanel()" title="'+customLabels.HideSlots+'">'+customLabels.HideSlots+'</div>\n                    </div>\n\n\n                    <div ng-show="gettingSlots && !wereSlotsAlreadyDrawnOnGantt" class="getting-slots">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.FindingCandidates+'\n                        \n                        <div class="get-slots-mst" ng-show="isMst && schedulingTakesLong">\n                            {{ generateAsyncLabel() }}\n                            <div class="get-slots-mst-button" ng-click="notifyWhenDoneGettingSlots()">'+customLabels.MstNotifyMeWhenDone+'</div>\n                        </div>\n                    </div>\n                    \n                    \n                    <div ng-show="exception" class="get-slots-error">\n                        <svg aria-hidden="true" class="slds-icon">\n                          \u2028<use xlink:href=\''+lsdIcons.violation+"'></use>\n                        \u2028</svg>\n                        {{ exception.message }}\n                        \n                        <div>"+customLabels.ContactSysAdmin+'</div>\n                    </div>\n                    \n                    <div ng-show="!gotSlots && !exception" class="get-slots-error">\n                        <i class="fa fa-frown-o"></i>\n                        \n                        <div>'+customLabels.noCandidatesMessageGantt+'</div>\n                        \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                    </div>\n\n\n\n\n                    <div class="slots-results-recommendations" ng-if="allSlotsArray" ng-show="gotSlots">\n                        <span id="slotsSentence"></span>\n                        <div class="assign-to-recommended" ng-click="scheduleToSlot(bestSlot.Interval.Start, bestSlot.Resource.m_resource.Id, StateService.selectedPolicyId,bestSlot)">'+customLabels.AssignToRecommended+'</div>\n                    </div>\n\n\n\n                    <div class="slots-grouping" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="truncate groupSlotsBy" title="'+customLabels.GroupSlotsBy+'">'+customLabels.GroupSlotsBy+'</span>\n                        <input type="radio" id="groupByResource" name="groupBy" ng-model="groupSlotsBy" value="Resource" checked="checked">\n                        <label class="groupSlotsBy slots-groupByResource truncate" for="groupByResource" title="'+customLabels.Resource+'">'+customLabels.Resource+'</label>\n                        <input type="radio" id="groupByName" name="groupBy" ng-model="groupSlotsBy" value="Date">\n                        <label class="groupSlotsBy truncate slots-groupByName" for="groupByName" title="'+customLabels.Date+'">'+customLabels.Date+'</label>\n\n                        <div class="button-on-grouping" ng-show="service.isScheduled()" ng-click="showOnGantt()" title="'+customLabels.Show_on_gantt+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.table+'"></use>\n                            \u2028</svg>\n                        </div>\n\n                        <div class="button-on-grouping" ng-click="openLightbox()" title="'+customLabels.OpenDetailsWindow+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                        </div>\n                    </div>\n\n\n                    <div id="Slots-List-In-Panel" ng-show="gotSlots">\n                    \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                        \n                        \n                    \n                        <div ng-repeat="candidate in allSlotsArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Resource\'">\n    \n                            <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'name\')" class="candidates-container-row" ng-click="candidate.showSlots = !candidate.showSlots">\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null && getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') == undefined" class="ResourcePhotoIcon"></div>\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') != undefined && getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null" class="ResourcePhotoIcon CrewPhotoIcon"></div>\n                                <img ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') != null" ng-src="{{getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\')}}" class="ResourcePhotoIcon" />\n                                <h1>{{ getResourceField(candidate.Resource.m_resource.Id, \'name\') }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [candidate.SchedulingOptions.length] ) }}\n                                \n                                <div ng-show="candidate.highest.Grade > -1" class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": candidate.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": candidate.highest.Grade >= GRADES.GOOD && candidate.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": candidate.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(candidate.highest.Grade)}}/100\n                                </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in candidate.SchedulingOptions" class="time-interval" ng-init="intervalItem.showExplain[\'Resource\'] = false; intervalItem.showExplain[\'Date\'] = false;" ng-show="candidate.showSlots">\n                               \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                               \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start) }}</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, candidate.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions" title="{{generateMstText(intervalItem.MSTOptions)}}">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                               \n                            </div>\n    \n                        </div>\n                        \n                       \n                       \n                        <div ng-repeat="date in dateKeysArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Date\'">\n                            <div class="candidates-container-row date-title-container" ng-click="slotsByDateObject[date].showDatesSlots = !slotsByDateObject[date].showDatesSlots">\n                                <h1>{{ formatDateHeader(date) }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [slotsByDateObject[date].length] ) }}\n                                \n                                        <div class="slot-grade slots-highest-grade" ng-show="slotsByDateObject[date].highest.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": slotsByDateObject[date].highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": slotsByDateObject[date].highest.Grade >= GRADES.GOOD && slotsByDateObject[date].highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": slotsByDateObject[date].highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(slotsByDateObject[date].highest.Grade)}}/100\n                                        </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in slotsByDateObject[date]" class="time-interval" ng-show="slotsByDateObject[date].showDatesSlots">\n                            \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                            \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start, true)}}</span>\n                                <span> ({{intervalItem.Resource.m_resource.Name}})</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, intervalItem.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                                \n                                \n                            </div>\n    \n                        </div>\n\n                </div>\n            ';var t=angular.element(e);angular.element("#LeftSideContainer").prepend(t),F.$on("$destroy",function(){return t.remove()}),window.__closeLeftSideTerritories&&window.__closeLeftSideTerritories(),i(t)(F),k.safeApply(F)}function g(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(F){M=null,e&&D.$broadcast("GotSlotsEnded"),showCandidates.on=!1,showCandidates.id=null;for(var t=0;t<F.slotsTimespansIds.length;t++)scheduler.deleteMarkedTimespan(F.slotsTimespansIds[t]);updateViewDebounced(),e&&F.$destroy()}}function v(e){return Math.round(e)}function f(e,t){return e&&s.getResources()[e]?s.getResources()[e][t]:null}function S(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=60*new Date(e).getTimezoneOffset()*1e3,e=new Date(e+n);return t?moment(e).format("LT"):moment(e).format("llll")}function y(e,t){var n=60*new Date(e).getTimezoneOffset()*1e3,e=new Date(e+n);return new Date(t+n).getDate()!==e.getDate()?moment(e).format("llll"):moment(e).format("LT")}function b(e){e=e.split("_"),e=new Date(e[2],e[1],e[0],0,0,0,0);return moment(e).format("LL")}function x(e){var t,n;if(e)return t=0,n=0,e.forEach(function(e){t++,n+=e.SchedulingOptions.length}),customLabels.getSlotsExpText.replaceAll("<b>"+t+"</b>","<b>"+n+"</b>","<b>"+F.service.name+"</b>","<b>"+S(F.bestSlot.Interval.Start)+"</b>","<b>"+F.bestSlot.Resource.m_resource.Name+"</b>","<b>"+Math.round(F.bestSlot.Grade)+"</b>")}function _(){F.shouldNotify=!0,F.mstPromise.then(function(t){k.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",F.service.AppointmentNumber),customLabels.MstFinishedGettingSlotsMessage,function(){var e;p=!0,h((e=t).fslOperation.result.Service.Id),"exception"===e.eventType&&w(e),w({value:e.fslOperation.result}),p=!1},null,!0)}).catch(function(e){console.error(e),k.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",F.service.AppointmentNumber),e,function(){})}),g(!0)}function w(e){if(F.gettingSlots=!1,"exception"===e.eventType)return F.gotSlots=!1,void(F.exception=e.event);F.partialResults=e.value.PartialResults||[];var t,n,i=e.value,s="",r=null,o=!1;for(t in i.ResourceIDToScheduleData)if(i.ResourceIDToScheduleData[t].SchedulingOptions)for(var a=i.ResourceIDToScheduleData[t].SchedulingOptions,l=0;l<a.length;l++){var c=function(e){var t=60*new Date(e.Start).getTimezoneOffset()*1e3,n=60*new Date(e.Finish).getTimezoneOffset()*1e3;return{startDate:new Date(e.Start+t),endDate:new Date(e.Finish+n)}}(a[l].Interval),d=I.getResoruceGanttIdByDate(t,c.startDate);if(d=showSecondarySTMs&&F.service.ServiceTerritoryId?I.getResoruceGanttIdByDateAndTerritory(t,c.startDate,F.service.ServiceTerritoryId):d)for(var u in 0===l&&(s+=i.ResourceIDToScheduleData[t].Resource.m_resource.Name+", ",o=!0),(c.startDate<r||null===r)&&(r=new Date(c.startDate)),scheduler.matrix){var p={},u=(p[u]=-1<d.indexOf(",")?d.split(","):[d],"");a[l].MSTOptions&&(u=(new Date).getTime()+Math.floor(1e5*Math.random()),window.mstOptions=window.mstOptions||{},window.mstOptions[u]=a[l].MSTOptions);var m="background-color: rgba(118, 226, 164,"+(.11+parseInt(a[l].Grade)/100*.64)+");",h=a[l].Grade<0?"":Math.round(a[l].Grade)+"/100",g=customLabels.CandidateGradeGantt.replaceAll(moment(c.startDate).format("dddd LT"),moment(c.endDate).format("dddd LT"),h),p={start_date:c.startDate,end_date:c.endDate,sections:p,html:"<div oncontextmenu='scheduleSlot(event, \""+F.service.id+'", "'+c.startDate.getTime()+'", "'+d+'", "'+R.selectedPolicyId+'", "'+u+"\")', title='"+g+"' style='"+m+"'><span class='slotText'>"+h+"</span></div>",css:"slotMark"};F.rawTimespans.push(p)}}if(o?((n=k.setDatesByStartAndMode(r)).start.setDate(n.start.getDate()-1),n.end.setDate(n.end.getDate()+1),I.getTimePhasedObjects(n.start,n.end).then(function(){for(var e=0;e<F.rawTimespans.length;e++)F.slotsTimespansIds.push(scheduler.addMarkedTimespan(F.rawTimespans[e]));showCandidates.on=!0,showCandidates.id=F.service.id,k.ganttSettings&&k.ganttSettings.filterCandidates&&(F.service.resourceId&&-1===s.indexOf(F.service.resourceName)&&(s+=F.service.resourceName+", "),s=s.substr(0,s.length-2)),scheduler.setCurrentView(r),D.$broadcast("GotSlots",{resourceToFilter:s,minDateOfCandidate:r})}).finally(function(){return F.wereSlotsAlreadyDrawnOnGantt=!0})):F.gotSlots=!1,F.gotSlots){F.allSlotsArray=[],F.slotsByDateObject={},F.dateKeysArray=[];var v,f=[],S=[];for(v in M={},e.value.ResourceIDToScheduleData){var y=e.value.ResourceIDToScheduleData[v];F.allSlotsArray.push(y);for(var b=0;b<y.SchedulingOptions.length;b++){var _=new Date(y.SchedulingOptions[b].Interval.Start),w=60*new Date(y.SchedulingOptions[b].Interval.Start).getTimezoneOffset()*1e3,w=(M[v]=!0,_.setMilliseconds(_.getMilliseconds()+w),_.getFullYear()+" "+_.getMonth()+" "+_.getDate()),w=(f.includes(w)||(f.push(w),S.push(_)),E(_));F.slotsByDateObject[w]=F.slotsByDateObject[w]||[],y.SchedulingOptions[b].Resource=e.value.ResourceIDToScheduleData[v].Resource,F.slotsByDateObject[w].push(y.SchedulingOptions[b])}}S.sort(function(e,t){return e-t});for(var T=0;T<S.length;T++)F.dateKeysArray[T]=E(S[T]);F.allSlotsArray.sort(function(e,t){return e.Resource.m_resource.Name>t.Resource.m_resource.Name?1:e.Resource.m_resource.Name<t.Resource.m_resource.Name?-1:0});for(var L,A=0;A<F.allSlotsArray.length;A++)F.allSlotsArray[A].highest=O(F.allSlotsArray[A].SchedulingOptions);for(L in F.slotsByDateObject){var C=F.slotsByDateObject[L];C.sort(function(e,t){return e.Interval.Start>t.Interval.Start?1:e.Interval.Start<t.Interval.Start?-1:0}),C.highest=O(C),(!F.bestSlot||F.bestSlot.Grade<C.highest.Grade)&&(F.bestSlot=C.highest)}setTimeout(function(){return angular.element("#slotsSentence").html(x(F.allSlotsArray))},100)}}function O(e){for(var t=0,n=e,i=n[0],s=0;s<n.length;s++)n[t].Grade<n[s].Grade&&(i=n[t=s]);return i}function T(e){D.$broadcast("JumpToDate",new Date(e))}function L(e,t){return(e=customLabels[e]).replaceAll.apply(e,_toConsumableArray(t))}function A(){e.open(F.service.id)}function N(){k.showOnGantt(F.service.id)}function G(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:-1,t=0;return F.allSlotsArray.forEach(function(e){return t+=e.SchedulingOptions.length}),customLabels.AB_Explanation_Header.replace("{0}",e).replace("{1}",t)}function B(e){e=parseInt(e);return moment.tz(e,userTimeZone).format("llll")}function H(){return F.service.Use_Async_Logic?customLabels.ServiceUsingAsync:customLabels.MstTakingLongTime}function U(e){var t,n="";for(t in e)n=customLabels.RelatedServiceSchedulingSentence.replace("$0",S(e[t].Interval.Start)).replace("$1",e[t].Resource.m_resource.Name);return n}function C(e,t,n){var i=e.Interval.Start,s=e.Interval.Finish,e=e.Resource.m_resource.Id,r=I.serviceAppointments()[t],o=60*new Date(i).getTimezoneOffset()*1e3,a=I.getResoruceGanttIdByDate(e,i);if(i+=o,s+=o,!r)return i=new Date(i),s=new Date(s),l.saveChangesToServiceAppointment(t,e,null,i,s,R.selectedPolicyId,"AutomaticGetSlots"),void u.getDelta();P(r,i,a||e,n),c.saveChangesToServiceAppointment(r,r).then(function(e){d.calculateKpis()})}function V(t,e,n,i){if(!F.scheduledActionInvoked){if(F.scheduledActionInvoked=!0,!F.service.isImmidietlyFollow&&i.MSTOptions&&0<Object.keys(i.MSTOptions).length)for(var s in i.MSTOptions)C(i.MSTOptions[s],s,n);var r=F.service,o=60*new Date(t).getTimezoneOffset()*1e3,o=(t+=o,r.resourceBeforeDrag=r.resourceId,r.eventBeforeDrag=angular.copy(r),r.fromGetCandidateFlow=!0,I.getResoruceGanttIdByDate(e,t));P(r,t,o||e,n),scheduler._events[r.id]?(scheduler.updateEvent(r.id),scheduler.callEvent("onEventChanged",[r.id,scheduler.getEvent(r.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),g()):c.saveChangesToServiceAppointment(r,r).then(function(e){d.calculateKpis(),D.$broadcast("JumpToDate",new Date(parseInt(t)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),k.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){D.$broadcast("JumpToDate",new Date(parseInt(t))),g()}),g()}}function P(e,t,n,i){var s=k.getServiceDuration(e);e.start=new Date(t),e.finish=new Date(t+s),e.start_date=new Date(t),e.end_date=new Date(t+s),e.travelTo=0,e.travelFrom=0,n&&(e.resourceId=n),e.policyUsed=i,e.scheduleMode="AutomaticGetSlots",e.savedFromScheduleHereAndConsecutive=e.isImmidietlyFollow&&e.relatedService2}function E(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}return window.scheduleSlot=function(e,t,s,r,o,a){e.preventDefault(),$("#ScheduleOnSlot").remove(),$('<div id="ScheduleOnSlot">'+customLabels.ScheduleHere+"</div>").css("left",e.clientX-30+"px").css("top",e.clientY+5+"px").on("click",function(){var e=F.service;if(e){if(e.fromGetCandidateFlow=!0,a&&!e.isImmidietlyFollow){var t,n=a,i=o;for(t in mstOptions[n])C(mstOptions[n][t],t,i)}e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),(!e.start||e.start.getTime()===parseInt(s)&&e.resourceId===r)&&e.start||P(e,parseInt(s),r,o),$("#ScheduleOnSlot").remove(),scheduler._events[e.id]?(scheduler.updateEvent(e.id),scheduler.callEvent("onEventChanged",[e.id,scheduler.getEvent(e.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),g()):c.saveChangesToServiceAppointment(e,e).then(function(e){d.calculateKpis(),D.$broadcast("JumpToDate",new Date(parseInt(s)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),k.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){D.$broadcast("JumpToDate",new Date(parseInt(s))),g()})}}).appendTo("body")},$("body").on("click",function(){$("#ScheduleOnSlot").remove()}),{get:h,close:g,getCandidatesIds:function(){return M}}}e.$inject=["$rootScope","$timeout","TimePhasedDataService","sfdcService","$compile","utils","StateService","ResourcesAndTerritoriesService","ServiceAppointmentLightboxService","servicesService","kpiCalculationsService","MstResolver","DeltaService","$q"],angular.module("serviceExpert").factory("GetSlotsService",e)}();var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){function e(a,l,c){var e=scheduler.serverList("holidays"),e=_slicedToArray(e,2),t=e[0],i=void 0===t?{}:t,t=e[1],s=void 0===t?{}:t;function n(e){var t=moment(e.start).startOf("day").toDate().toISOString(),n=(s[t]=r(e,s[t]||[]),i[t]=i[t]||{},i[t][e.id]);n||(delete(n=Object.assign({territories:{}},e)).territory,delete n.start,delete n.finish,i[t][n.id]=n),e.territory&&e.territory.id&&(n.territories[e.territory.id]=e.territory)}function r(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(e.isAllDay)return[{start:moment(e.start).startOf("day").toDate(),finish:moment(e.finish).endOf("day").toDate()}];for(var n=e.start,i=e.finish,s=0;s<t.length;)if(t[s].finish<n)s++;else{if(t[s].start>i)return t.splice(s,0,{start:n,finish:i}),t;t[s].start<n&&(n=t[s].start),t[s].finish>i&&(i=t[s].finish),t.splice(s,1)}return t.push({start:n,finish:i}),t}return{addHolidaysIntoCollection:function(e){e&&e.length&&(e.forEach(n),scheduler.serverList("holidays",[i,s]))},addHolidayIntoCollection:n,enhanceHoliday:function(e,t,n,i,s){var r=t.split("_")[0],o=t.split("_")[1],r=[(t=r&&Object.values(c.resourcesAndTerritories()[r]||{}).find(function(e){return e.serviceTerritory===o})||{}).operatingHours,(t.serviceTerritory__r||{}).OperatingHoursId].includes(s)?l.territories()[o]:null,t=moment(e.date).startOf("day"),s=(e.isAllDay?t:t.clone().add(e.startTimeInMinutes,"minute")).toDate(),t=(e.isAllDay?t.clone().endOf("day"):t.clone().add(e.endTimeInMinutes,"minute")).toDate();return Object.assign({start:a.convertDateBetweenTimeZones(s,n,i),finish:a.convertDateBetweenTimeZones(t,n,i),territory:r},e)},excludeHolidaysFromSlots:function(t,i,s,r){var o=[];e:for(;i&&i.length;)switch(function(){for(var n=i.shift();t.length&&t[0].finish<=n[s];)t.shift();if(!t.length)return o.push.apply(o,[n].concat(_toConsumableArray(i))),"break";if(n[r]<=t[0].start||n.isHolidaySlot)return o.push(n),"continue";var e=a.intersectDates({start:n[s],finish:n[r]},t[0]);e.remainderFrom1&&e.remainderFrom1.length&&(e=e.remainderFrom1.map(function(e){var t;return Object.assign({},n,(_defineProperty(t={},s,e.start),_defineProperty(t,r,e.finish),t))}),i.unshift.apply(i,_toConsumableArray(e)))}()){case"break":break e;case"continue":continue}return o},mergeHolidayIntoDayIntervals:r,mergeHolidays:function(e){var t=[],n=void 0;return e.forEach(function(e){!n||e.start>n.finish?t.push(n=e):e.finish>n.finish&&(n.finish=e.finish)}),t},trimHoliday:function(e,t,n){e.start<t&&(e.start=t),e.finish>n&&(e.finish=n)},reset:function(){scheduler.serverList("holidays",[]);var e=scheduler.serverList("holidays"),t=(e=_slicedToArray(e,2))[0],t=(i=void 0===t?{}:t,e[1]);s=void 0===t?{}:t}}}e.$inject=["utils","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("HolidayService",e)}(),!function(){function e(e,t,n,o){var a={};return{getLastKnownPositions:function(){return t.getLivePositions().then(function(e){for(var t in e)a[t]=new LastKnownPosition(e[t]);return a})},updatePositions:function(e){var t,n={},i=!1;for(t in e){var s=new LastKnownPosition(e[t]),r=void 0;e[t].ServiceCrewMembers&&e[t].ServiceCrewMembers[0].IsLeader&&(r=o.getCrewToResources()[e[t].ServiceCrewMembers[0].ServiceCrewId]),(!a[s.id]||a[s.id].lastModifiedDate<s.lastModifiedDate)&&(n[t]=s,a[t]=s,i=!0,r&&(n[r.Id]=s,a[r.Id]=s))}return{dic:n,isUpdated:i}},lastKnownPositions:function(){return a}}}e.$inject=["$q","sfdcService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("LastKnownPositionService",e)}(),!function(){function e(e,i,t,m,h,g,v,s,r,o,a,l,c,d,n,u,p){var f=i.$new(!0),S=angular.element('\n                        <div class="LeftSideLocationFiltering" >\n\n                            <div class="leftFilteringContentContainer" ng-if="opened">\n\n                                <div id="TF-loadingTerritories" ng-show="currentlySavingTerritories">\n                                    <img src="'+window.lsdIcons.spinnerGif+'" />\n                                    Loading Service Territories\n                                </div>\n\n                                <div class="territories-list-type-tabs">\n                                    <button tabindex="0" fsl-tab-switch role="tab" ng-click="showTree = true; saveTabDebounced()" ng-class="{\'active-territory-tab\' : showTree}">'+customLabels.TerritoriesTree+'</button>\n                                    <button fsl-tab-switch role="tab" ng-click="showTree = false; saveTabDebounced()" ng-class="{\'active-territory-tab\' : !showTree}">'+customLabels.Favorites+'</button>\n                                </div>\n                                \n                                <div tabindex="0" role="tooltip" id="leftLocationFiltering-tooltip" aria-label="'+(showSecondarySTMs&&useLocationTimezone?customLabels.LocationFilteringParagraph+"\n\n "+customLabels.Stms_with_different_tz:customLabels.LocationFilteringParagraph)+'" tooltip-trigger="focus blur mouseenter mouseleave" tooltip-animation="false" tooltip-class="horizonTooltip tooltip-location-inner" tooltip-append-to-body="true" tooltip-placement="bottom" \n                                    tooltip="'+(showSecondarySTMs&&useLocationTimezone?customLabels.LocationFilteringParagraph+"\n\n "+customLabels.Stms_with_different_tz:customLabels.LocationFilteringParagraph)+'">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n\n                                <div class="leftLocationFilteringConf">\n                                \n\n                                    <div class="addBorderBottom">\n                                        <input type="checkbox" ng-model="$parent.showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input \n                                        id="locationFilteringSearch" \n                                        ng-show="(!showAutocompleteTerritoryPicker)" \n                                        type="search" ng-model="locationSearchTerm.text" \n                                        placeholder="'+customLabels.Search_location+'" \n                                    />\n                                    \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(true, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(false, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                                    \n                                    <img class="tp-spinner" ng-show="$parent.currentlyLoading && showTree" src="'+window.lsdIcons.spinnerGif+'" />\n                                    \n                                    <svg aria-hidden="true" class="slds-icon tp-clear-territory-search" ng-show="$parent.searchText && !$parent.currentlyLoading && showTree" ng-click="clearAutocompleteSearch()">\n                                        \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                                    \u2028</svg>\n                                    \n                                    \n                                    <input type="text" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        class="tp-search-input"\n                                        placeholder="'+window.customLabels.SearchServiceTerritory+'" \n                                        ng-model="$parent.searchText" \n                                        ng-model-options="{ debounce: 333 }" \n                                        ng-change="searchTerritory(searchText)" \n                                        ng-click="setSearchResultBox($event)" \n                                    />\n                                    \n                                    \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(true)" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(false)"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                               \n                                </div>\n                                \n                                   \n                                   \n                                \x3c!-- Territories tree with auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTreeWithAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && showTree">\n                                \n                                \n                                    \x3c!-- SEARCH RESULTS --\x3e\n                                    \n                                    <div class="tp-territories-found-summary" ng-show="$parent.searchText && !currentlyLoading && !noTerritoriesFoundOnSearch">\n                                        {{ searchResultText.replace(\'$0\', currentResults.length) }}\n                                    </div>\n                                \n                                    <div ng-repeat="territory in currentResults" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territory.Id]" id="location_{{ territory.Id }}" ng-change="addToCurrentLoadedTerritories(territory.Id, locationFilter[territory.Id])" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territory.Id)}" ng-click="toggleFavorite(territory.Id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territory.Id }}" ng-bind="territory.Name"></label>\n                                        <span class="ter-search-parent" ng-if="territory.ParentTerritory">({{ territory.ParentTerritory.Name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territory.Id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                    \n                                    \n                                    \x3c!-- CURRENTLY LOADED --\x3e\n                                    \n                                    <div ng-repeat="territoryId in currentlyLoadedTerritories" ng-show="!$parent.searchText" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        <span class="ter-search-parent" ng-if="getParentTerritory(territoryId)">({{ getParentTerritory(territoryId).name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                   \n                                    <div class="tp-no-territories-found" ng-show="noTerritoriesFoundOnSearch && !currentlyLoading">\n                                        '+customLabels.NoServiceTerritoriesWereFound+'\n                                    </div>\n                                    \n                                </div>\n                                   \n                                   \n                                <div id="TF-TerritoriesFavoritesAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && !showTree">\n                                    \n                                    <div ng-repeat="territoryId in favorites" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                </div>      \n                                   \n                                   \n                                   \n                                   \n                                \x3c!-- Territories tree without auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTree" class="LocationsTree" ng-show="showTree && !showAutocompleteTerritoryPicker">\n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                \n                                \n                                \n                                \x3c!-- Territories list without auto complete --\x3e\n                                \n                                <div id="TF-TerritoriesListFavorites" class="LocationsTree" ng-show="!showTree && !showAutocompleteTerritoryPicker">\n                                \n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" ng-show="isTerritoryInFavorite(l.id)" class="locationFilterRow">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_f_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_f_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                    \n\n                            </div>\n                            \n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton cancelButtonAndClose" ng-click="closeLightbox()">'+customLabels.Cancel+'</button>\n                                <button class="lightboxSaveButton" ng-click="applyFilterLocationWithRowsCheck()">'+customLabels.Save+"</button>\n                            </div>\n\n                        </div>\n                ").hide(),y=(angular.element("#LeftSideContainer").append(S),n.close(),f.trust=v.trust,f.showOrphanServices=!1,f.locationSearchTerm={text:""},f.showLocationFiltering=!1,f.noLocationsLoad=!1,f.locationFilter={},f.locationFilterCopy={},f.locationsFlat=[],f.territoriesSortedByTree=[],f.showTree=!0,f.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,f.spinnerIcon=window.lsdIcons.spinnerGif,f.showAutocompleteTerritoryPicker=window.__gantt.shouldShowAutoCompleteUi,f.currentResults=[],f.showResults=!1,f.noTerritoriesFoundOnSearch=!1,f.cachedTerritoriesQueryResults={},f.currentlyLoading=!1,f.searchText=null,f.allTerritoriesQueried={},f.territoriesIdsToNames={},f.currentlyLoadedTerritories=[],f.currentlySavingTerritories=!1,f.searchResultText=window.customLabels.TerritoriesFoundInSearch,f.isRTL=r.isRtlDirection(),f.getParentTerritory=function(e){e=m.territories()[e];return e&&e.parentTerritory?m.territories()[e.parentTerritory.id]:null},null!==h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(f.showTree=!h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),f.favorites=h.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(h.GetUserSettingsProperty("FavoriteTerritories__c")):[],_.debounce(function(){h.SetUserSettingsProperty("FavoriteTerritories__c",JSON.stringify(f.favorites))},800));function b(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];f.opened=!0,f.showTree=!0,f.reload=e,e=h.GetUserSettingsProperty("locations"),f.currentlyLoadedTerritories=e?[].concat(_toConsumableArray(e)):[],null!==h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(f.showTree=!h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),f.favorites=h.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(h.GetUserSettingsProperty("FavoriteTerritories__c")):[],S.show("fast",function(){$(this).find(".territories-list-type-tabs").children()[0].focus()})}return f.saveTabDebounced=_.debounce(function(){h.SetUserSettingsProperty("ShowFavoriteTerritoriesTab__c",!f.showTree)},800),e(S)(f),window.__openLocationFilteringAndReload=function(){return b(!0)},f.toggleFavorite=function(e){var t=f.favorites.indexOf(e);-1<t?f.favorites.splice(t,1):f.favorites.push(e),y()},f.isTerritoryInFavorite=function(e){return f.favorites.includes(e)},f.$on("keypress",function(e,t){27===t.which&&f.closeLightbox()}),f.closeLightbox=function(){if(!f.noLocationsLoad){for(var e in f.locationFilterCopy)f.locationFilter[e]=f.locationFilterCopy[e];f.showOrphanServices=f.showOrphanServicesOldValue,S.hide(),window.__closeLeftSideTerritories=null,f.opened=!1}},window.__closeLeftSideTerritories=f.closeLightbox,f.styleForLocationTree=function(e){var t={};return t[f.isRTL?"margin-right":"margin-left"]=20*e+"px",t},f.switchToTerritory=function(e){for(var t in f.locationFilter)f.locationFilter[t]=!1;f.locationFilter[e]=!0,f.applyFilterLocation()},m.promises.territories().then(function(){var e,t,i={},n=[],s=[],r=[];for(e in m.territories()){var o=m.territories()[e];o.hasSharing&&(i[e]={id:e,parent:o.parentTerritory||0,text:o.name,items:[]},f.territoriesIdsToNames[o.id]=o.name)}for(t in i){var a=i[t],l=function e(t){if(!t.id||!t.parent)return;{var n;return i[t.parent.id]?t.parent:(n={},m.allTerritories[t.parent.id]&&(n={id:m.allTerritories[t.parent.id].id,parent:m.allTerritories[t.parent.id].parentTerritory||0}),e(n))}}(a);(0!==a.parent&&l?i[l.id].items:n).push(a)}f.locationsTree=n;for(var c,d,u=0;u<n.length;u++)!function e(t,n,i){t.depth=n;i.push(t);if(t.items)for(var s=0,r=t.items.length;s<r;s++)t.items[s].depth=n,e(t.items[s],n+1,i)}(n[u],0,f.locationsFlat);if(f.showOrphanServices=JSON.parse(h.GetUserSettingsProperty("Show_Orphan_Services__c")),f.showOrphanServicesOldValue=f.showOrphanServices,f.territoriesSortedByTree=(c=m.territories(),d=f.locationsFlat,Object.keys(c).map(function(e){return c[e]}).sort(function(n,i){var s=0,r=0;return d.forEach(function(e,t){e.id===n.id&&(s=t),e.id===i.id&&(r=t)}),r<s?1:s<r?-1:0})),null!==h.GetUserSettingsProperty("locations")&&(s=h.GetUserSettingsProperty("locations")),g.callRemoteAction(RemoteActions.getUnPrivilegeUserSettingsFields).then(function(e){if(1<e.length){for(var t,n=customLabels.Unprivileged_Usersettings_Fields_Msg.split("{1}"),i=n[0],s="",r=0;r<e.length&&r<3;++r)s+="<br>"+e[r];3<e.length&&(t=e.length-3,s+="<br>",i+=n[1].replace("{2}",t)),i=i.replace("{0}",s),v.addNotification(customLabels.Unprivileged_Usersettings_Fields,i)}}).catch(function(e){console.warn("GetUserSettingsProperty failed :-("),console.error(e)}),f.showAutocompleteTerritoryPicker&&0===f.locationsFlat.length||0===s.length)return f.showLocationFiltering=!0,f.noLocationsLoad=!0,b(),void(0!==f.locationsFlat.length&&0!==s.length||$("#FirstTimeLoading").remove());for(var p=0;p<f.locationsFlat.length;p++)f.noLocationsLoad=!1,f.locationFilter[f.locationsFlat[p].id]=-1<s.indexOf(f.locationsFlat[p].id),f.locationFilter[f.locationsFlat[p].id]&&r.push(f.locationsFlat[p].id);f.locationFilterCopy=angular.copy(f.locationFilter),h.SetUserSettingsProperty("locations",JSON.stringify(r))}),f.applyFilterLocationWithRowsCheck=function(){var e,t,n,i=[];for(e in f.locationFilter)f.locationFilter[e]&&i.push(e);0===i.length?alert(customLabels.One_loaded_location):(t=new Date(scheduler._min_date),n=new Date(scheduler._max_date),t.setDate(t.getDate()-window.daysToLoadOnGanttInit),n.setDate(n.getDate()+window.daysToLoadOnGanttInit),f.currentlySavingTerritories=!0,g.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,n,i).then(function(e){e?(f.currentlySavingTerritories=!1,alert(customLabels.MaxedRowsReachedOnGanttAlert)):f.applyFilterLocation()}))},f.applyFilterLocation=function(){var e,n=[],t=[];for(e in f.locationFilter)(f.locationFilter[e]?n:t).push(e);if(0===n.length)return f.currentlySavingTerritories=!1,void alert(customLabels.One_loaded_location);f.noLocationsLoad=!1,angular.extend(f.locationFilterCopy,f.locationFilter),f.showOrphanServicesOldValue=f.showOrphanServices,r.isLoadingNewLocations=!0,d.resetCurrentPalette(),h.SetUserSettingProperties(f.parseLocationSettings(JSON.stringify(n),f.showOrphanServices)).then(function(){f.reload?window.window.location.reload():m.getResourceAndTerritories(function(){a.reset(),m.reset(),scheduler._events={},scheduler.deleteMarkedTimespan();var e=u.filter.searchOnServer;s.reset(e),o.reset(),l.reset(),c.reset(),p.reset()}).then(function(){s.resetReachedMaxRows();var e=new Date(scheduler.getState().min_date),t=new Date(scheduler.getState().max_date);e.setDate(e.getDate()-1),t.setDate(t.getDate()+1),s.getTimePhasedObjects(e,t).then(function(){u.filter.searchOnServer&&s.serviceAppointments(u.filter.searchOnServer)&&i.$broadcast("gotNewTimePhasedObjects",{start:e,finish:t,serviceAppointments:s.serviceAppointments(u.filter.searchOnServer)}),f.currentlySavingTerritories=!1,updateViewDebounced(),i.$broadcast("gotNewResources",{show:n}),r.isLoadingNewLocations=!1}).catch(function(){f.currentlySavingTerritories=!1})})}).catch(function(e){f.currentlySavingTerritories=!1;for(var t=customLabels.territories_r_failure_msg+"\n",n=JSON.parse(e.FailedLocations),i=0;i<n.length;i++)t+=n[i].Name+"\n";v.addNotification(customLabels.territories_r_failure,t),r.isLoadingNewLocations=!1}),f.closeLightbox()},f.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},f.selectLocation=function(e){var t=!f.locationFilter[e],e=function e(t,n){var i=null;for(var s=0;s<t.length;s++){if(t[s].id===n)return t[s];if(i=e(t[s].items,n))return i}return i}(f.locationsTree,e);e&&!function e(t,n){for(var i=0;i<t.items.length;i++)f.locationFilter[t.items[i].id]=n,e(t.items[i],n)}(e,t)},f.selectAllLocations=function(t,e,n,i){i?angular.forEach(e,function(e){n[e.id]=t}):f.selectAllFavoriteLocations(t,e,n)},f.selectAllFavoriteLocations=function(t,e,n){angular.forEach(e,function(e){f.isTerritoryInFavorite(e.id)&&(n[e.id]=t)})},f.searchTerritory=function(n){return""===n?(f.currentResults=[],f.showResults=!1,void(f.noTerritoriesFoundOnSearch=!1)):f.cachedTerritoriesQueryResults[n.toLocaleLowerCase()]?(f.currentResults=f.cachedTerritoriesQueryResults[n.toLocaleLowerCase()],f.showResults=!0,void(0===f.currentResults.length?f.noTerritoriesFoundOnSearch=!0:f.noTerritoriesFoundOnSearch=!1)):(f.currentlyLoading=!0,void window.Visualforce.remoting.Manager.invokeAction(window.RemoteActions.searchTerritories,n,function(e,t){t.status?v.safeApply(f,function(){f.cachedTerritoriesQueryResults[n.toLocaleLowerCase()]=e,f.showResults=!0,f.searchText===n&&(f.currentlyLoading=!1,0===(f.currentResults=e).length?f.noTerritoriesFoundOnSearch=!0:(f.noTerritoriesFoundOnSearch=!1,e.forEach(function(e){f.allTerritoriesQueried[e.Name]=e,f.territoriesIdsToNames[e.Id]=e.Name})))}):console.warn(t)},{buffer:!0,escape:!1,timeout:12e4}))},f.addToCurrentLoadedTerritories=function(e,t){var n=f.currentlyLoadedTerritories.indexOf(e);t&&-1===n&&f.currentlyLoadedTerritories.push(e),!t&&1<n&&f.currentlyLoadedTerritories.splice(n,1)},f.clearAutocompleteSearch=function(){f.currentResults=[],f.showResults=!1,f.noTerritoriesFoundOnSearch=!1,f.currentlyLoading=!1,f.searchText=""},f.selectTerritoriesWithAutocomplete=function(t){f.searchText?f.currentResults.forEach(function(e){f.locationFilter[e.Id]=t,f.addToCurrentLoadedTerritories(e.Id,t)}):f.currentlyLoadedTerritories.forEach(function(e){f.locationFilter[e]=t})},{isOpen:function(){return f&&f.opened},open:b,getFlatTerritoriesArray:function(){return f.locationsFlat},getTerritoriesSortedByTree:function(){return f.showAutocompleteTerritoryPicker?window._.toArray(m.territories()):f.territoriesSortedByTree},isNoTerritoryLoadded:function(){return f.noLocationsLoad}}}e.$inject=["$compile","$rootScope","$q","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService","ResourceCrewsService","ResourceCapacitiesService","GanttPalettesService","GetSlotsService","servicesService","HolidayService"],angular.module("serviceExpert").factory("LeftSideLocationFilteringService",e)}(),!function(){function e(l,c,d,u,p){function m(e,t,n){var i=void 0,s=void 0,r=d.addDaysToDate(t,1-n),o=t;if(e[r]){for(s=r;s<=o&&e[s];)s=d.addDaysToDate(s,1);return i=(o.getTime()-s.getTime())/864e5,{date:o,horizon:++i}}for(s=o;r<=s&&e[s];)s=d.addDaysToDate(s,-1);return i=(s.getTime()-r.getTime())/864e5,{date:s,horizon:++i}}return{getBackHorizonToFetch:m,loadServicesInBulk:function(e,t,n,i,s){var r=l.defer(),o=m(t,n,i),a=d.addDaysToDate(o.date,1-o.horizon),e=function(e,t,n){var i,s=[];for(i in e)!function(e,t,n){n=d.addDaysToDate(t,-n);if(e.earlyStart&&e.earlyStart>n&&e.earlyStart<=t)return 1;if(e.dueDate&&e.dueDate>n&&e.dueDate<=t)return 1;if(e.appStart&&e.appStart>n&&e.appStart<=t)return 1;if(e.appEnd&&e.appEnd>n&&e.appEnd<=t)return 1;if(e.finish&&e.finish>n&&e.finish<=t)return 1;if(e.start&&e.start>n&&e.start<=t)return 1;return}(e[i],t,n)||s.push(i);return s}(e,n,i);return s&&(e=e.filter(function(e){return s<e})),function(e,t,n){var i=new Date(t),s=!1;for(;n;)e[d.generateDateKey(i)]||(s=!0),e[d.generateDateKey(i)]=!0,i.setDate(i.getDate()-1),n--;return s}(t,n,i)||s?c.loadServicesInBulk(o.date,o.horizon,numberOfServicesToLoadInEachBulk,e,s).then(function(e){var t=[],n=(e.ganttServiceAppointments.forEach(function(e){e.AssignedResource&&!scheduler._events[e.Id]&&t.push(e.Id)}),Array.isArray(e.stms)&&0<e.stms.length&&u.updateTimePhaseData(e.stms,"stm"),u.updateTimePhaseData(e.ganttServiceAppointments,"service")),i=u.resourcesAndTerritories(),s={needToCheckRules:t,scheduledServices:[],unscheduledServices:[],remainingCount:e.remainingCount,fetchedFromDate:a,horizon:o,totalFetched:e.ganttServiceAppointments.length,lastFetchedId:e.ganttServiceAppointments[e.ganttServiceAppointments.length-1]?e.ganttServiceAppointments[e.ganttServiceAppointments.length-1].Id:null};n.services.forEach(function(e){e.isScheduled()?(e.setGanttResource(i,d.generateResourceId),s.scheduledServices.push(e)):(scheduler._events[e.id]&&delete scheduler._events[e.id],s.unscheduledServices.push(e))}),p.drawServicesAndAbsences(s.scheduledServices,[],[],[]),r.resolve(s)}).catch(function(e){r.reject(e),console.warn("loadServicesInBulk: something went wrong"),d.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}):r.resolve([]),r.promise}}}e.$inject=["$q","sfdcService","utils","TimePhasedDataService","servicesService"],angular.module("serviceExpert").factory("LoadServiceListService",e)}();var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function GanttService(e,t){if(!t){for(var n in this.sfdcType="service",this.fields={},e.Fields)this.fields[n]=e.Fields[n];this.id=e.Fields.Id||null,this.name=e.Fields.AppointmentNumber||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e.Fields["Account.Name"]||null,this.accountId=e.Fields.AccountId||null,this.latitude=e.Fields.Latitude||null,this.longitude=e.Fields.Longitude||null,this.arrivalWindowEndTime=e.Fields.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.Fields.ArrivalWindowStartTime||null,this.dueDate=e.Fields.DueDate||null,this.ganttDisplay=e.Fields.Gantt_Display_Date__c||null,this.durationType=e.Fields.DurationType||null,this.earliestStartTime=e.Fields.EarliestStartTime||null,this.estDuration=e.Fields.Duration||null,this.travelTimeFrom=e.Fields.EstimatedTravelTimeFrom__c||null,this.travelTimeTo=e.Fields.EstimatedTravelTime||null,this.ganttLabel=e.Fields.GanttLabel__c||null,this.jeopardy=e.Fields.InJeopardy__c||null,this.jeopardyReason=e.Fields.jeopardyReasonTranslated||e.Fields.InJeopardyReason__c||null,this.parentRecord=e.Fields.ParentRecordId||null,this.parentRecordStatus=e.Fields.ParentRecordStatusCategory||null,this.parentRecordType=e.Fields.ParentRecordType||null,this.pinned=e.Fields.Pinned__c||!1,this.isBundleMember=e.Fields.IsBundleMember||!1,this.isBundle=e.Fields.IsBundle||!1,this.RelatedBundle=e.Fields.RelatedBundleId||!1,this.schedEndTime=e.Fields.SchedEndTime||null,this.schedStartTime=e.Fields.SchedStartTime||null,this.serviceTerritory=e.Fields.ServiceTerritory||null,this.serviceTerritoryName=e.Fields["ServiceTerritory.Name"]||null,this.status=e.Fields.Status||null,this.statusCategory=e.Fields.StatusCategory||null,this.subject=e.Fields.Subject||null,this.ganttColor=e.Fields.GanttColor__c||null,this.resource=e.Resource||null,this.resourceName=e.ResourceName||null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.AssignedResource||null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Fields.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Fields.Schedule_Mode__c||null,this.emergency=e.Fields.Emergency__c||!1,this.isServiceInChain=usingNewMstModel&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null,this.relationshipType=e.relationshipType||null,this.isImmidietlyFollow="Immediately Follow"===e.relationshipType,this.ganttPaletteColor=null,this.Use_Async_Logic=e.Fields.Use_Async_Logic__c||!1,this.icons=e.Fields.GanttIcon__c?e.Fields.GanttIcon__c.split(";"):null,this.totalModifiedTimes=this.ServiceAppointmentLastModifiedDate,this.fromGetCandidateFlow=!1,this.AssignedResourceLastModifiedDate&&(this.totalModifiedTimes+=this.AssignedResourceLastModifiedDate),this.icons&&(this.icons=this.icons.map(function(e){return window.encodeURI(e)}));var i,t="WorkOrder"==e.Fields.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField,t=(t&&e.ParentFields&&e.ParentFields[t]&&(this.priority=e.ParentFields[t]),fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField);for(i in this.isMDT=!!e.Fields[t],e.Fields.MDT_Operational_Time__c?this.calculateMdtTimes(e.Fields.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={},e.ParentFields)this.parentFields[i]=e.ParentFields[i];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttService.prototype.allFieldSetsSet,e.Fields,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&1<t.length)for(var n=0;n<t.length;n++)if(e.resourceBeforeDrag.split(",")[n]!=t[n]){e.resourceId=t[n];break}}}function addFieldSetToServiceObject(e,t,n){for(var i in e){var s=null;if((s=t[e[i].APIName])||0==s){switch(e[i].Type){case"DATE":case"DATETIME":s=__setTimeZoneOffsetToDateField(s),n.fields[e[i].APIName]=s.getTime();break;case"REFERENCE":var r=e[i].JsAPIName.replace("__r","__c");n[r]=t[r]}n[e[i].APIName]=s}}}function LastKnownPosition(e){this.id=e.Id,this.latitude=e[fieldNames.ServiceResource.LastKnownLocation__Latitude__s],this.longitude=e[fieldNames.ServiceResource.LastKnownLocation__Longitude__s],this.lastModifiedDate=e[fieldNames.ServiceResource.LastKnownLocationUpdate__c];e=void 0;this.lastModifiedDate&&(e=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3),this.lastModifiedDate=this.lastModifiedDate?new Date(this.lastModifiedDate+e):null}function OptimizationRequest(e){var t;if(this.id=e.Id,this.lastModifiedDate=e.LastModifiedDate,this.lastModifiedDate&&(t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3,this.lastModifiedDate=new Date(this.lastModifiedDate.valueOf()+t)),this.name=e.Name,this.scheduledAmount=e[fieldNames.Optimization_Request.Objects_Scheduled__c],this.objectToScheduled=e[fieldNames.Optimization_Request.Objects_To_Schedule__c],this.status=e[fieldNames.Optimization_Request.Status__c]||null,this.statusLabel=e.statusLabel||e[fieldNames.Optimization_Request.Status__c]||null,this.allTasks=e[fieldNames.Optimization_Request.All_Tasks_Mode__c]||null,this.includeEmptyLocations=e[fieldNames.Optimization_Request.Include_Services_With_Empty_Location__c]||null,this.type=e[fieldNames.Optimization_Request.Type__c]||null,this.failureReason=e[fieldNames.Optimization_Request.Failure_Reason__c]||null,this.failureDetails=e[fieldNames.Optimization_Request.Failure_Details__c]||null,this.optimizationData=e[fieldNames.Optimization_Request.Optimization_Data__c]||null,this.orgResourceAbsence=e[fieldNames.Optimization_Request.Originating_Resource_Absence__c]||null,this.orgServiceAppointment=e[fieldNames.Optimization_Request.Originating_Service_Appointment__c]||null,this.policy=e[fieldNames.Optimization_Request.Scheduling_Policy__c]||null,this.serviceAppointment=e[fieldNames.Optimization_Request.Service_Appointment__c]||null,this.resource=e[fieldNames.Optimization_Request.Service_Resource__c]||null,this.result=e[fieldNames.Optimization_Request.Result__c]||null,this.schedulingRecipe=e[fieldNames.Optimization_Request.Scheduling_Recipe__r]||null,this.territories=[],this.resourceName=null,this.resource&&(this.resourceName=e[fieldNames.Optimization_Request.Service_Resource__c.replace("__c","__r")].Name),this.requestProgressStart=e[fieldNames.Optimization_Request.Request_Progress_Start__c]||null,e[territoryOptimizationRequestRelationshipName])for(var n=0;n<e[territoryOptimizationRequestRelationshipName].length;n++)this.territories.push(new TerritoryOptimizationRequest(e[territoryOptimizationRequestRelationshipName][n]));this.timespan=null,this.finish=e[fieldNames.Optimization_Request.Finish__c]||null,this.start=e[fieldNames.Optimization_Request.Start__c]||null,this.start=__setTimeZoneOffsetToDateField(this.start),this.finish=__setTimeZoneOffsetToDateField(this.finish)}function ResourceAbsence(e){this.id=e.Id,this.end=e[fieldNames.ResourceAbsence.End],this.resource=e[fieldNames.ResourceAbsence.Resource],this.start=e[fieldNames.ResourceAbsence.Start],this.absenceType=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.reason=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.ganttLabel=e[fieldNames.ResourceAbsence.GanttLabel__c]||null,this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.AbsenceNumber,this.resourceName=e[fieldNames.ResourceAbsence.Resource__r].Name,this.ganttColor=e[fieldNames.ResourceAbsence.Gantt_Color__c],this.approved=e[fieldNames.ResourceAbsence.Approved__c],this.latitude=e.Latitude,this.longitude=e.Longitude,this.travelTo=e[fieldNames.ResourceAbsence.EstTravelTime__c]?60*e[fieldNames.ResourceAbsence.EstTravelTime__c]:0,this.travelFrom=e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]?60*e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]:0,this.sfdcType="absence",e.RecordType&&e.RecordType.DeveloperName&&"Non_Availability"==e.RecordType.DeveloperName?this.type="na":this.type="break",this.setSchedulerProperties()}function ResourceCapacity(e){this.sfdcType="capacity",this.id=e.Id,this.end=e[fieldNames.ResourceCapacity.EndDate],this.resource=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceId=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource__r]?e[fieldNames.ResourceCapacity.ServiceResource__r].Name:null,this.start=e[fieldNames.ResourceCapacity.StartDate],this.hoursInUse=e[fieldNames.ResourceCapacity.HoursInUse__c],this.hoursPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInHours]||0,this.minutesUsed=e[fieldNames.ResourceCapacity.MinutesUsed__c],this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.CapacityNumber,this.timePeriod=e[fieldNames.ResourceCapacity.TimePeriod],this.workItemsAllocated=e[fieldNames.ResourceCapacity.Work_Items_Allocated__c],this.workItemsPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInWorkItems]||0,this.setSchedulerProperties()}function addDaysToDate(e,t){t*=864e5;return new Date(e.getTime()+t)}function calcCapacityPercentage(e,t){return parseFloat((e/t*100).toFixed(2))}function ResourcesAndTerritories(e){this.id=e.Id,this.name=e.MemberNumber,this.effectiveEndDate=e[fieldNames.ServiceTerritoryMember.EffectiveEndDate]||null,this.effectiveStartDate=e[fieldNames.ServiceTerritoryMember.EffectiveStartDate],this.latitude=e[fieldNames.ServiceTerritoryMember.Latitude],this.longitude=e[fieldNames.ServiceTerritoryMember.Longitude],this.serviceResource=e[fieldNames.ServiceTerritoryMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceTerritoryMember.ServiceResource__r],this.serviceTerritory=e[fieldNames.ServiceTerritoryMember.ServiceTerritory],this.serviceTerritory__r=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r],this.serviceTerritoryType=e[fieldNames.ServiceTerritoryMember.TerritoryType],this.operatingHours=e[fieldNames.ServiceTerritoryMember.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritoryMember.OperatingHours__r],this.effectiveStartDate=__setTimeZoneOffsetToDateField(this.effectiveStartDate,!1,!0),this.effectiveEndDate=__setTimeZoneOffsetToDateField(this.effectiveEndDate,!1),this.timezone=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r][fieldNames.ServiceTerritory.OperatingHours__r][fieldNames.OperatingHours.Timezone]}function ServiceCrewMember(e){this.id=e.Id,this.name=e.Name,this.endDate=e[fieldNames.ServiceCrewMember.EndDate]||null,this.startDate=e[fieldNames.ServiceCrewMember.StartDate],this.serviceResource=e[fieldNames.ServiceCrewMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceCrewMember.ServiceResource__r],this.serviceCrew=e[fieldNames.ServiceCrewMember.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceCrewMember.ServiceCrew__r],this.leader=e[fieldNames.ServiceCrewMember.Leader],this.ganttLabel=e[fieldNames.ServiceCrewMember.GanttLabel],this.ganttColor=e.ServiceCrew?e.ServiceCrew[fieldNames.ServiceCrew.GanttColor__c]:null,this.startDate=__setTimeZoneOffsetToDateField(this.startDate,!1,!0),this.endDate=__setTimeZoneOffsetToDateField(this.endDate,!1)}function ServiceResource(e){var t=this;this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Name,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},(this.sobject=e)[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]?(Array.isArray(t.skills[e[fieldNames.ServiceResourceSkill.Skill]])||(t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=[t.skills[e[fieldNames.ServiceResourceSkill.Skill]]]),t.skills[e[fieldNames.ServiceResourceSkill.Skill]].push(new ServiceResourceSkill(e))):t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceResourceSkill(e){this.id=e.Id,this.name=e.SkillNumber,this.effectiveEndDate=e[fieldNames.ServiceResourceSkill.EffectiveEndDate],this.effectiveStartDate=e[fieldNames.ServiceResourceSkill.EffectiveStartDate],this.level=e[fieldNames.ServiceResourceSkill.SkillLevel],this.serviceResource=e[fieldNames.ServiceResourceSkill.ServiceResource],this.skill=e[fieldNames.ServiceResourceSkill.Skill];var e=void 0,t=void 0;this.effectiveStartDate&&(e=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(t=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+e):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+t):new Date(864e11)}function ServiceTerritory(e){this.id=e.Id,this.name=e.Name,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory__r]?e[fieldNames.ServiceTerritory.ParentTerritory]:void 0,this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory__r]&&(this.parentTerritory=new ServiceTerritory(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}function TerritoryOptimizationRequest(e){this.id=e.Id,this.optimizationRequest=e[fieldNames.TerritoryOptimizationRequest.OptimizationRequest]||null,this.serviceTerritory=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory]||null,this.serviceTerritoryName=null,this.serviceTerritory&&(this.serviceTerritoryName=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory.replace("__c","__r")].Name||null)}!function(){function e(i,o,c,d,a,n,s,r,t,e,l,u,p,m,h,g){function v(e){var t=e;void 0!==(t=y.iframeMapMode===S.IFRAME_TYPE.NORMAL?e.data:t).type&&(t.type.includes(f)?T:w)(t)}var f="[POLYGONS]",S={IFRAME_TYPE:{SECURED:"1",NORMAL:"2"},IFRAME_RECEIVED_MESSAGES_TYPES:{FSL_MAP_LOADED:"FSL_MAP_LOADED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_DATA_UPDATE:"FSL_MAP_DATA_UPDATE",VIEW_DETAILS:"VIEW_DETAILS",FLAG_SA:"FLAG_SA",API_REQUEST:"API_REQUEST",GET_ICON:"GET_ICON"},IFRAME_SEND_MESSAGES_TYPES:{API_REQUEST_SUCCEED:"API_REQUEST_SUCCEED",API_REQUEST_FAILED:"API_REQUEST_FAILED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_SERVICES_UPDATE:"FSL_MAP_SERVICES_UPDATE",SHOW_SERVICE_ON_MAP:"SHOW_SERVICE_ON_MAP",GET_ICON_SUCCEED:"GET_ICON_SUCCEED",GET_ICON_FAILED:"GET_ICON_FAILED",FSL_MAP_LIVE_POSITION:"FSL_MAP_LIVE_POSITION",FSL_MAP_UPDATE_FILTER:"FSL_MAP_UPDATE_FILTER",FSL_MAP_UPDATE_VIEW:"FSL_MAP_UPDATE_VIEW"},POLYGON_MENU_ACTIONS:{SCHEDULE:f+" SCHEDULE",UNSCHEDULE:f+" UNSCHEDULE",DISPATCH:f+" DISPATCH",IN_JEOPARDY:f+" IN_JEOPARDY",DELETE_POLYGON:f+" DELETE_POLYGON",CUSTOM_ACTION:f+" CUSTOM_ACTION"}},y={showServiceOnMapId:void 0,showServiceOnMap:!1,reactDomain:void 0,targetOrigin:void 0,reactMapInitialize:!1,iframeMapMode:window.iframeMapMode,debugMode:window.debugMode,iframeWindow:void 0,serviceFields:[],dynamicIcons:{}},b=(d.getLastKnownPositions(),e.fieldsSetFields().then(function(e){y.serviceFields=e.MapInfo}),setTimeout(function(){var e,t,n;y.iframeMapMode===S.IFRAME_TYPE.SECURED&&(y.debugMode?SfdcApp.iframe.addMessageHandler("GanttReactMapIframeDebug",v):SfdcApp.iframe.addMessageHandler("GanttReactMapIframe",v)),y.iframeMapMode===S.IFRAME_TYPE.NORMAL&&(y.targetOrigin=window.location.origin+window.location.pathname,y.iframeWindow=document.getElementById("GanttReactMapIframeSF").contentWindow,e=window,t="message",n=v,e.addEventListener?e.addEventListener(t,n):e.attachEvent&&e.attachEvent("on"+t,n))},0),function(e){y.iframeMapMode===S.IFRAME_TYPE.SECURED&&(y.debugMode?SfdcApp.iframe.sendMessage("GanttReactMapIframeDebug",e):SfdcApp.iframe.sendMessage("GanttReactMapIframe",e)),y.iframeMapMode===S.IFRAME_TYPE.NORMAL&&y.iframeWindow.postMessage(e,y.targetOrigin)}),w=function(t){switch(t.type){case S.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_LOADED:break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_INITIALIZATION:y.reactMapInitialize=!0,x(),M(),O();break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_DATA_UPDATE:y.showServiceOnMap&&y.showServiceOnMapId&&setTimeout(function(){var e={serviceId:y.showServiceOnMapId,type:S.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};b(e),y.showServiceOnMap=!1,y.showServiceOnMapId=void 0},7e3);break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.VIEW_DETAILS:H(t.id,t.objectType);break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.FLAG_SA:U(t.serviceAppointmentsId);break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.API_REQUEST:G(t.method,t.filter,t.params).then(function(e){"getCustomActions"===t.method?L(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}).catch(function(e){console.warn(e)}):"getReportRowsForMap"===t.method?C(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}):"getReportsWithGeolocationCols"===t.method?A(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}):"getMapReports"===t.method?N(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}):(e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED},b(e))}).catch(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_FAILED};b(e)});break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.GET_ICON:k(t.hex,t.folder,t.icon,t.iconKey).then(function(e){e={response:e,iconKey:t.iconKey,type:S.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_SUCCEED};b(e)}).catch(function(e){e={response:e,iconKey:t.iconKey,type:S.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_FAILED};b(e)})}},T=function(e){switch(e.type){case S.POLYGON_MENU_ACTIONS.CUSTOM_ACTION:B(e.servicesIds,e.action);break;case S.POLYGON_MENU_ACTIONS.DISPATCH:n.changeStatus(e.servicesIds,h.DISPATCHED).then(function(e){n.drawServicesAndAbsences(e.services)}).catch(function(e){a.addNotification(window.customLabels.Action_Could_Not_Be_Performed,e.message||window.customLabels.user_is_not_allowed_to_perform_action)});break;case S.POLYGON_MENU_ACTIONS.UNSCHEDULE:n.unscheduleServices(e.servicesIds);break;case S.POLYGON_MENU_ACTIONS.SCHEDULE:t.schedule(e.servicesIds);break;case S.POLYGON_MENU_ACTIONS.IN_JEOPARDY:n.setInJeopardy(e.servicesIds)}},L=function(e){for(var t=o.defer(),n={},i=0;i<e.length;i++)a.hasCustomPermission(e[i][window.GanttMap.fieldNames.CustomGanttAction.Permission])&&"map"===e[i][window.GanttMap.fieldNames.CustomGanttAction.Section]&&(n[e[i].Id]=function(e){var t=o.defer();try{var n={};n.id=e.Id,n.name=e[window.GanttMap.fieldNames.CustomGanttAction.Label],n.className=e[window.GanttMap.fieldNames.CustomGanttAction.Class],n.order=e[window.GanttMap.fieldNames.CustomGanttAction.Order],n.permission=e[window.GanttMap.fieldNames.CustomGanttAction.Permission],n.section=e[window.GanttMap.fieldNames.CustomGanttAction.Section],n.visualforce=e[window.GanttMap.fieldNames.CustomGanttAction.Visualforce],e[window.GanttMap.fieldNames.CustomGanttAction.Icon]&&D(I(e[window.GanttMap.fieldNames.CustomGanttAction.Icon].split(","))).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="#17325c"'),e=window.btoa(e);n.icon="url('data:image/svg+xml;base64,"+e+"')",t.resolve(n)})}catch(e){t.reject(e)}return t.promise}(e[i]));return o.all(n).then(function(e){t.resolve(e)}).catch(function(e){console.warn(e.message),t.reject()}),t.promise},A=function(i){var e=a.butlerNotifications();if(0===Object.keys(i[0].report).length&&"error"===i[0].color)return 1<=e.filter(function(e){return e.title===window.customLabels.Report_Object_Access_Deny}).length?void 0:void a.addNotification(window.customLabels.Report_Object_Access_Deny,window.customLabels.Report_Object_Access_Error_Message,function(){});var s=o.defer(),t=[];try{for(var n,r=0;r<i.length;r++)i[r].icon&&(n=i[r].icon.split(","),t.push(k("#ffffff",n[0],n[1],"report_"+n[0]+"_"+n[1])))}catch(e){console.warn("failed to add icon to report based on configuration"),s.reject(e)}return o.all(t).then(function(e){for(var t=0,n=0;n<i.length;n++)i[n].icon&&(i[n].icon=e[t],t++);s.resolve(i)}).catch(function(e){s.resolve(reportRows)}),s.promise},N=function(e){for(var t=o.defer(),n=Object.keys(e),i={},s=0;s<n.length;s++)i[n[s]]=C(e[n[s]]);return o.all(i).then(function(e){t.resolve(e)}),t.promise},C=function(n){for(var i=o.defer(),e=[],t=0;t<n.length;t++){var s=n[t],r=s.sObjectType.split(/(?=[A-Z])/).join("_").toLowerCase();"ServiceAppointment"===s.sObjectType&&(r="work_order"),"ServiceResource"===s.sObjectType&&(r="home"),"Asset"===s.sObjectType&&(r="product"),e.push(k("#ffffff","standard",r,"report_"+r))}return o.all(e).then(function(e){for(var t=0;t<n.length;t++)n[t].reportIcon=e[t];i.resolve(n)}).catch(function(e){i.resolve(n)}),i.promise};function D(e){var t=o.defer(),n=new XMLHttpRequest;return n.onload=function(){var e;404==n.status?t.reject():((e=new FileReader).onloadend=function(){t.resolve(e.result)},e.readAsDataURL(n.response))},n.open("GET",e),n.responseType="blob",n.send(),t.promise}function I(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];return window.GanttMap.icons.globalIcon+"/"+t+"/"+e+".svg"}function k(t,n,e,i){var s=o.defer();try{y.dynamicIcons[i]?s.resolve(y.dynamicIcons[i]):D(I([n,e])).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+t+'"'),e=window.btoa(e);y.dynamicIcons[i]="data:image/svg+xml;charset=utf-8;base64,"+e,s.resolve(y.dynamicIcons[i])}).catch(function(e){D(I([n,"report"])).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+t+'"'),e=window.btoa(e);y.dynamicIcons[i]="data:image/svg+xml;charset=utf-8;base64,"+e,s.resolve(y.dynamicIcons[i])})})}catch(e){s.reject(e.message)}return s.promise}function R(e){var t;!e&&y.reactMapInitialize||(e=j(),t=E(),t={ganttMapDefinitions:window.GanttMap,livePositions:t,territories:e,type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_INITIALIZATION,ganttDate:scheduler._min_date},b(t))}function F(e,t){var n,i=2<arguments.length&&void 0!==arguments[2]&&arguments[2];y.reactMapInitialize?_.isEmpty(e)&&_.isEmpty(t)||(n={clearServices:!1,services:$(e),deletedServicesIds:t,type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_SERVICES_UPDATE},b(n)):setTimeout(function(){F(e,t,i)},5e3)}function $(e){var t={};if(Array.isArray(e))for(var n=0;n<e.length;n++)t[e[n].id]=P(e[n]);else for(var i in e)t[e[i].id]=P(e[i]);return t}var G=function(s,r){for(var e=arguments.length,o=Array(2<e?e-2:0),t=2;t<e;t++)o[t-2]=arguments[t];var n={},a=(n[RemoteActions.getReportsWithGeolocationCols]=!0,!(s in n));return new Promise(function(n,i){var e=(e=[RemoteActions[s]]).concat.apply(e,o).concat(function(e,t){t.status?n(e):i(t)}).concat({buffer:a,escape:!1}),t=e,t=r?e.filter(function(e){return!!e}):e.map(function(e){return void 0===e?null:e});Visualforce.remoting.Manager.invokeAction.apply(Visualforce.remoting.Manager,t)})},B=function(e,t){var n,i;t.visualforce?(n=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===e.length?l.open(t.name,t.visualforce+"?id="+e[0]+"&start="+n+"&end="+i):l.open(t.name,t.visualforce+"?services="+e.join(",")+"&start="+n+"&end="+i)):m.callRemoteAction(RemoteActions.runCustomServiceAction,t.className,e,scheduler._min_date,scheduler._max_date).then(function(e){e&&a.addNotification(t.name,e,null,null)}).catch(function(e){return a.addNotification(t.name,e.message,null,null)})},H=function(e,t){switch(t){case"service":n.recentlyUsed[e]=!0,s.open(e);break;case"liveposition":case"resource":r.open(e);break;default:a.openSObjectLink(e)}},U=function(e){e.map(function(e){n.flagged[e]=!0,scheduler.updateEvent(e)})},M=function(){var e;y.reactMapInitialize?(e={filteredServices:V(),type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_FILTER},b(e)):setTimeout(function(){R(!1)},5e3)},x=function e(){var t;y.reactMapInitialize?(t={relevantStms:z(),type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_VIEW},b(t)):setTimeout(function(){e()},5e3)},O=function e(){var t;y.reactMapInitialize?(t={livePositions:E(),type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_LIVE_POSITION},b(t)):setTimeout(function(){e(servicesToUpdate,deletedServicesIds,clearServices)},5e3)},e=(g.register("positions",function(e){O()}),_.debounce(M,300,{maxWait:1e3})),g=_.debounce(x,300,{maxWait:1e3}),V=function(){for(var e={},t=0;t<n.filteredServices.servicesArray.length;t++)e[n.filteredServices.servicesArray[t].id]=!0;return e},P=function(e){var t={fields:{}};t.latitude=e.latitude,t.longitude=e.longitude,t.pinned=e.pinned,t.statusCategory=e.statusCategory,t.resourceId=e.resourceId,t.id=e.id,t.Status=e.Status,t.AppointmentNumber=e.AppointmentNumber,t.dragData=e.isScheduled()?null:a.getRelevantDataForDraggingService(e),window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||(t.dragData=null),t.icons=e.icons,window.paletteViewActive&&e.ganttPaletteColor?t.color=e.ganttPaletteColor.color:e.ganttColor?t.color=e.ganttColor:t.color=a.getColorHexByCategory(e.statusCategory);for(var n=0;n<y.serviceFields.length;n++){var i,s,r=void 0;void 0!==e.fields[y.serviceFields[n].APIName]&&(i=e.fields[y.serviceFields[n].APIName],s=e.fields[y.serviceFields[n].FullAPIName],r=y.serviceFields[n].APIName!==y.serviceFields[n].FullAPIName?{Value:i,Id:s}:{Value:i}),t.fields[y.serviceFields[n].APIName]=r}return t},z=function(){var e,t=scheduler.getState().min_date,n=scheduler.getState().max_date,i={},s=c.resourcesByPrimariesAndRelocations();for(e in s){var r,o=s[e];for(r in o){var a=o[r];isIntersect(t,n,a.effectiveStartDate,a.effectiveEndDate)&&(i[a.id]=a)}}return i},E=function(){var e,t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=c.resourcesAndTerritories(),s={},r={};for(e in s=window.customPermissions.Hide_Live_Locations_Gantt_Map_Layer?s:d.lastKnownPositions()){var o,a=i[e];for(o in a){var l=a[o];isIntersect(t,n,l.effectiveStartDate,l.effectiveEndDate)&&(r[s[e].id]={latitude:s[e].latitude,longitude:s[e].longitude,resource:l.serviceResource__r,lastKnowLocation:s[e]})}}return r},j=function(){var t=p.GetUserSettingsProperty("locations"),n=u.territories();return Object.keys(n).filter(function(e){return t.includes(e)}).reduce(function(e,t){return e[t]=n[t],e},{})};return{showServiceOnMap:function(e,t,n){y.showServiceOnMap=!0,y.showServiceOnMapId=e,"map"===n||t||i.$broadcast("changeWorkingState","map"),y.reactMapInitialize?setTimeout(function(){var e={serviceId:y.showServiceOnMapId,type:S.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};b(e),y.showServiceOnMap=!1,y.showServiceOnMapId=void 0},150):R(!1)},initializeGanttMap:R,updateGanttMapServices:F,updateGanttMapFilter:e,updateGanttMapView:g,IFRAME_SEND_MESSAGES_TYPES:S.IFRAME_SEND_MESSAGES_TYPES,reactDomain:y.reactDomain}}e.$inject=["$rootScope","$q","TimePhasedDataService","LastKnownPositionService","utils","servicesService","ServiceAppointmentLightboxService","ResourceLightboxService","bulkScheduleService","FieldSetFieldsService","GeneralLightbox","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","SERVICE_STATUS","RegisterService"],angular.module("serviceExpert").factory("MapService",e)}(),!function(){function e(s,r,o,a,l,e,c,d){for(var u=null,t=[],n=0;n<60;n++)t.push(n);function p(){l.setLightBoxStatus(!1),u.$destroy()}function m(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function h(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function g(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function v(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function f(){var e,t,n,i,s=[],r=void 0;for(i in u.selectedLocations)u.selectedLocations[i]&&s.push(i);0===s.length?alert(customLabels.noLocationWasSelected):(e=u.actionStart,(r=u.actionFinish).setDate(r.getDate()+1),t="noFilter"===u.optimizeSelectedFilter?null:u.optimizeSelectedFilter,n="all"===u.optimizeAllServices,l.setBulkActionRunning(),d.callRemoteAction(RemoteActions.runOptimization,e,r,s,n,u.orphanServices,u.selectedPolicy.Id,t).then(function(e){e?d.callRemoteAction(RemoteActions.getRequestObject,e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?c.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){c.openSObjectLink("../"+e)},e.Id):c.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){c.openSObjectLink("../"+e)},e.Id)}):c.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e),c.addNotification(customLabels.Optimization_Failed,e.message)}).finally(function(){l.setBulkActionRunning(!1)}),u.closeLightbox())}function S(){return u.selectedPolicy[fieldNames.SchedulingPolicy.DailyOptimization]}return{open:function(){(u=r.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=a.GetUserSettingsProperty("locations");u.filteredLocations=e.map(function(e){return o.territories()[e]}),u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=m,u.dateSelectStartWidget=h,u.validateDatesStart=g,u.validateDatesEnd=v,u.optimizeAllServices="all",u.runOptimizion=f,u.selectedLocations={},u.checkBoxFields=c.checkBoxFields,u.optimizeSelectedFilter="noFilter",u.orphanServices=!1,u.isInDayPolicy=S,u.policyOptions=l.policies,u.selectedPolicy=u.policyOptions[0];for(var t=0;t<l.policies.length;t++)if(l.policies[t].Id===l.selectedPolicyId){u.selectedPolicy=l.policies[t];break}e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n\t\t\t\t\t\t\t\t<option value="all">'+customLabels.All+'</option>\n\t\t\t\t\t\t\t\t<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n\t\t\t\t\t\t\t</select>"),n='<div id="PolicyInOptimize">'+customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" title="{{selectedPolicy.Name}}" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n\t\t\t\t\t\t\t\t \t<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields()" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n\t\t\t\t\t\t\t\t \t<option value="noFilter">'+customLabels.None+"</option>\n\t\t\t\t\t\t\t\t </select>")+"</div>";var n,i=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div id="BulkActionsLightbox" class="LightboxContainer OptimizationLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.Optimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SelectServicesOptimize+'</p>\n\n                            <div class="selectedTargetLocations">\n                                <label for="bulkRadioSelectedIds">'+customLabels.ChooseLocationsLB+'</label>\n                            </div>\n\n\n                            <div id="bulkLocationNames">\n                                <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                    <input ng-model="selectedLocations[location.id]" type="checkbox" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                    <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                </div>\n\n                                <div>\n                                    <input ng-model="orphanServices" type="checkbox" name="orphanLocationsOptimize" id="orphanLocationsOptimize" />\n                                    <label for="orphanLocationsOptimize">'+customLabels.IncludeServicesNoLocations+'</label>\n                                </div>\n                            </div>\n\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+"\n                                "+n+'\n                                <div class="inday-policy-selected" ng-show="isInDayPolicy()">'+customLabels.In_Day_Policy_Selected+'</div>\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</button>\n                        </div>\n\n\n                    </div>\n                </div>\n            ");i.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(i),u.closeLightbox=p,u.$on("$destroy",function(){return i.remove()}),s(i)(u),i.show(),l.setLightBoxStatus(),i.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("optimizeLightboxService",e)}(),!function(){function e(r,o,a,e,l,t,c,d){var u=null;function p(){l.setLightBoxStatus(!1),u.$destroy()}function m(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function h(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function g(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function v(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function f(){var e,t,n,i,s=void 0,r=u.actionStart;(s=u.actionFinish).setDate(s.getDate()+1),t=u.optimizeSelectedFilter,e=u.optimizeCalloutSelectedFilter,n=!u.optimizeOnlyUnscheduledServices,i={optimizeOnlyUnscheduledServices:u.optimizeOnlyUnscheduledServices,scheduleOnlyResourceFutureJobs:u.scheduleOnlyResourceFutureJobs,selectedPolicy:u.selectedPolicy,optimizeSelectedFilter:u.optimizeSelectedFilter,optimizeCalloutSelectedFilter:u.optimizeCalloutSelectedFilter},localStorage.setItem(sfdcUser+"_RSO",JSON.stringify(i)),l.setBulkActionRunning(),d.callRemoteAction(RemoteActions.runRDOptimization,u.resource.id,r,s,n,u.scheduleOnlyResourceFutureJobs,u.selectedPolicy.Id,t,e).then(function(e){e?d.callRemoteAction(RemoteActions.getRequestObject,e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?c.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){c.openSObjectLink("../"+e)},e.Id):c.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){c.openSObjectLink("../"+e)},e.Id)}):c.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e),c.addNotification(customLabels.Optimization_Failed,e.message)}).finally(function(){l.setBulkActionRunning(!1)}),u.closeLightbox()}return{open:function(e){(u=o.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),u.resource=a.getResources()[e];var e=JSON.parse(localStorage.getItem(sfdcUser+"_RSO"))||{},t=l.selectedPolicyId;e.selectedPolicy&&(t=e.selectedPolicy.Id),u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=m,u.dateSelectStartWidget=h,u.validateDatesStart=g,u.validateDatesEnd=v,"all"===e.optimizeAllServices?e.optimizeOnlyUnscheduledServices=!1:"unscheduled"===e.optimizeAllServices&&(e.optimizeOnlyUnscheduledServices=!0),u.optimizeOnlyUnscheduledServices=e.optimizeOnlyUnscheduledServices||!1,u.runOptimizion=f,u.checkBoxFields=c.checkBoxFields(),u.optimizeSelectedFilter=e.optimizeSelectedFilter||Object.keys(u.checkBoxFields)[0],u.optimizeCalloutSelectedFilter=e.optimizeCalloutSelectedFilter||Object.keys(u.checkBoxFields)[0],u.scheduleOnlyResourceFutureJobs=null==e.scheduleOnlyResourceFutureJobs||e.scheduleOnlyResourceFutureJobs,u.policyOptions=l.policies;for(var n=0;n<l.policies.length;n++)if(l.policies[n].Id===t){u.selectedPolicy=l.policies[n];break}e='<div id="ResourceToOptimize">'+customLabels.OptimizeTheFollowingResourceDay.replace("$0",'<span class="rdoResourceName">{{resource.name}}</span>').replace("$1",'<button id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></button>').replace("$2",'<button id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></button>')+"</div>",i=customLabels.OptimizeOnlySAsAssignedTo.replace("$0",'<span class="rdoResourceName" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">{{resource.name}}</span>');var i,s=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer rso-lb" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.RDOptimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+'\n                            </div>\n   \n                            <div class="bulkOptimizeOptionsContainer">\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.Only_optimize_unscheduled_appointments+"\n                                        <cs-tooltip>"+customLabels.Only_optimize_unscheduled_appointments_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="optimizeOnlyUnscheduledServices" type="checkbox" name="optimizeAllServices" id="optimizeAllServices" />\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.SchedulingPolicyName+"\n                                        <cs-tooltip>"+customLabels.rso_scheduling_policy_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions">\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeFilterText+"\n                                        <cs-tooltip>"+customLabels.rso_filter_services_by_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeKeepTheFollowingSAsScheduled+"\n                                        <cs-tooltip>"+customLabels.OptimizeKeepTheFollowingSAsScheduled_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeCalloutSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                         </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">\n                                        '+i+"\n                                        <cs-tooltip>"+customLabels.OptimizeOnlySAsAssignedTo_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="scheduleOnlyResourceFutureJobs" type="checkbox" name="scheduleOnlyResourceFutureSa" id="scheduleOnlyResourceFutureSa" />\n                                    </div>\n                                </div>\n\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</button>\n                        </div>\n\n\n                    </div>\n                </div>\n            ");s.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(s),u.closeLightbox=p,u.$on("$destroy",function(){return s.remove()}),r(s)(u),s.show(),l.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("rdOptimizeLightboxService",e)}(),!function(){function e(n,i){return{register:function(e,t){n.register(e,t),i.register(e,t)},unRegister:function(e,t){n.unRegister(e,t),i.unRegister(e,t)}}}e.$inject=["DeltaService","StreamingAPIService"],angular.module("serviceExpert").factory("RegisterService",e)}(),angular.module("serviceExpert").factory("ResourceCapacitiesService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(c,d,e,u,p){var m={};return e.$on("gotNewTimePhasedObjects",function(e,t){if(p.areContractorsSupported()&&t.resourcesAndTerritories&&Object.keys(t.resourcesAndTerritories).length)for(var n=t.start,i=t.finish,s=new Date(n),r=null;s<i;){var o=u.formatDayToString(s);if(!m[o]){m[o]=!0,r=r||function(){for(var e=[],t=d.resourcesAndTerritories(),n=c.getCapacityBasedResources(),i=0;i<=n.length;i++){var s,r=n[i],o=t[r];for(s in o){var a=o[s];e.push(u.generateResourceId(r,a.serviceTerritory))}}return e}();var a=new Date(s);a.setDate(a.getDate()+1);for(var l=0;l<=r.length;l++)!function(e,t,n){if(e.getTime()!==t.getTime()){var i,s={};for(i in scheduler.matrix)s[i]=[n];scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:s,css:"capacityPattern"})}}(new Date(s),new Date(a),r[l])}s.setDate(s.getDate()+1)}}),{reset:function(){m={}}}}]),angular.module("serviceExpert").factory("ResourceCrewsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,d,t,x,u){var p={};function O(e,t,n,i,s,r){var o=n.territoriesByType[s];if(void 0!==o&&(showSecondarySTMs||"R"===s))for(var a=0;a<o.length;a++){var l,c,d=o[a],u=useLocationTimezone?d.operatingHours.TimeZone:userTimeZone,p=useLocationTimezone?(l=E(d.start,d.operatingHours.TimeZone,u),E(d.finish,d.operatingHours.TimeZone,u)):(l=d.start,d.finish),p=x.intersectDates({start:l,finish:p},{start:e,finish:t}).intersection;null!==p&&(c=E(n.member.startDate,"GMT",u),u=E(n.member.endDate,"GMT",u),null!==(p=x.intersectDates({start:p.start,finish:p.finish},{start:c,finish:u}).intersection)&&P(p.start,p.finish,d.sectionsToDraw,"crewMember",i,"crewLabelStyle",r))}}function P(e,t,n,i,s,r,o){o="background: "+(o=o||"#a99be8")+"90; box-shadow: 0 0 0 1px "+o;scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:n.daily,css:i,html:'<div class="'+r+'" title="'+escapeHTML(s)+'" style="'+o+'">\n                            <svg aria-hidden="true" class="slds-icon relocationIcon">\n                                <use xlink:href='+lsdIcons.crewMember+'"></use>\n                            </svg>\n                            '+escapeHTML(s)+"\n                          </div>"}),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:n.monthly,html:'<div class="crewUtilizBox" title="'+escapeHTML(s)+'" style="'+o+'">\n                    <svg aria-hidden="true" class="slds-icon relocationIcon">\n                    <use xlink:href="'+lsdIcons.crewMember+'"></use>\n                    </svg></div>',css:"crewmember_monthly"})}function E(e,t,n){return x.convertDateBetweenTimeZones(e,t,n)}return t.$on("gotNewTimePhasedObjects",function(e,t){if(u.areCrewsSupported()&&t.serviceCrewMembers&&Object.keys(t.serviceCrewMembers).length)for(var n=t.start,i=t.finish,s=t,r=new Date(n),o=void 0;r<i;){var a=x.formatDayToString(r);if(!p[a]){void 0===o&&(o=function(e){var t,n={},i=d.resourcesAndTerritories();for(t in e){void 0===n[t]&&(n[t]={},n[t].territoriesByType={},n[t].member=e[t]);var s,r=i[e[t].serviceResource];for(s in r){var o=r[s],a=x.generateResourceId(e[t].serviceResource,o.serviceTerritory);void 0===n[t].territoriesByType[o.serviceTerritoryType]&&(n[t].territoriesByType[o.serviceTerritoryType]=[]),n[t].territoriesByType[o.serviceTerritoryType].push({start:o.effectiveStartDate,finish:o.effectiveEndDate,serviceTerritory:o.serviceTerritory,operatingHours:o.serviceTerritory__r.OperatingHours,type:o.serviceTerritoryType,id:o.id,section:a,sectionsToDraw:function(e){var t,n={monthly:{},daily:{}};for(t in scheduler.matrix)"MonthlyView"===t||"MTDView"===t||"LongView"===t?n.monthly[t]=[e]:n.daily[t]=[e];return n}(a)})}void 0!==n[t].territoriesByType.P&&n[t].territoriesByType.P.sort(x.sortByTime),void 0!==n[t].territoriesByType.R&&n[t].territoriesByType.R.sort(x.sortByTime),void 0!==n[t].territoriesByType.S&&n[t].territoriesByType.S.sort(x.sortByTime)}return n}(s.serviceCrewMembers)),p[a]=!0;var l,c=new Date(r);for(l in c.setDate(c.getDate()+1),o)!function(e,t,n){var i,s;if(e.getTime()!==t.getTime()){i=n.member.ganttLabel?n.member.ganttLabel.encodeHTML():customLabels.XCrewMember.replaceAll(n.member.serviceCrew__r.Name.encodeHTML()),s=n.member&&n.member.ganttColor||null,O(e,t,n,i,"S",s),O(e,t,n,i,"R",s);var r=e,o=t,a=n,l=i,c=s,d=a.territoriesByType.P,u=a.territoriesByType.R;if(void 0===u){var p=r;var m=o;var h=a;var g=l;var v=c;var f=h.territoriesByType.P;if(void 0!==f)for(var S=0;S<f.length;S++){var y=f[S],b=useLocationTimezone?y.operatingHours.TimeZone:userTimeZone,_=E(h.member.startDate,"GMT",b),b=E(h.member.endDate,"GMT",b),_=x.intersectDates({start:p,finish:m},{start:_,finish:b}).intersection;null===_||null!==(b=x.intersectDates({start:y.start,finish:y.finish},{start:_.start,finish:_.finish}).intersection)&&P(b.start,b.finish,y.sectionsToDraw,"crewMember",g,"crewLabelStyle",v)}}else if(void 0!==d)for(var w=0;w<d.length;w++){var T=!1,L=d[w],A=useLocationTimezone?L.operatingHours.TimeZone:userTimeZone,C=E(a.member.startDate,"GMT",A),D=E(a.member.endDate,"GMT",A),C=x.intersectDates({start:C,finish:D},{start:r,finish:o}).intersection;if(null!==C){var I=x.intersectDates({start:L.start,finish:L.finish},{start:C.start,finish:C.finish}).intersection;if(null!==I){for(var k=0;k<u.length;k++){var R=u[k],F=useLocationTimezone?R.operatingHours.TimeZone:userTimeZone,M=E(R.start,F,A),R=E(R.finish,F,A),F=x.intersectDates({start:M,finish:R},{start:r,finish:o}).intersection;null!==F&&null!==(M=x.intersectDates({start:F.start,finish:F.finish},{start:I.start,finish:I.finish}).intersection)&&(function(e,t,n,i,s){t.start.getTime()<e.start.getTime()&&P(t.start,e.start,n,"crewMember",i,"crewLabelStyle",s);e.finish.getTime()<t.finish.getTime()&&P(e.finish,t.finish,n,"crewMember",i,"crewLabelStyle",s)}(M,I,L.sectionsToDraw,l,c),T=!0)}T||null===I||P(I.start,I.finish,L.sectionsToDraw,"crewMember",l,"crewLabelStyle",c)}}}}}(new Date(r),new Date(c),o[l])}r.setDate(r.getDate()+1)}}),{reset:function(){p={}}}}]),angular.module("serviceExpert").factory("resourceFilterHelper",["$q","sfdcService","$sce","userSettingsManager",function(e,n,t,i){var s={sortBy:customLabels.name,asc:!0,showWorkingResource:!1,booleanFields:{},picklistField:"select_a_field",picklistOptions:[],picklistOptionsModel:[],picklistNullValues:!1,crewsOption:customLabels.showAll},r=JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c"))||s,o=null,a=null,l={selectedPicklist:r.picklistField,resourceFilteringOptions:r.booleanFields,picklistOptionsModel:r.picklistOptionsModel,picklistOptions:r.picklistOptions,picklistNullValues:r.picklistNullValues,crewsSelectionOptions:{selectedPicklist:r.crewsOption,crewFilteringOptions:[customLabels.showAll,customLabels.hideCrewMembers,customLabels.showCrewsAndCrewMembers,customLabels.showOnlyCrews,customLabels.hideCrewsAndCrewMembers]}};function c(e){var t,n="",i="",s=customLabels.SelectAfieldToResourceFilter,r=(e&&(n="<b>"+customLabels.CurrentlyWorking+"</b>"),l.picklistOptions.map(function(e){return e&&e.encodeHTML()}));for(t in o)"BOOLEAN"===o[t][1]&&l.resourceFilteringOptions[o[t][2]]?""===n?n="<b>"+o[t][0].encodeHTML()+"</b>":n+=" and <b>"+o[t][0].encodeHTML()+"</b>":"PICKLIST"===o[t][1]&&l.selectedPicklist===o[t][2]&&(0<(i=r.join("</b> "+customLabels.or+" <b>")).length&&(i="<b>"+o[t][0].encodeHTML()+"</b> is <b>"+i+"</b>"),l.picklistNullValues&&(""===i?i="<b>"+customLabels.None+"</b>":i+=" "+customLabels.or+" <b>"+customLabels.None+"</b>"));return""!==n&&""!==i?s=customLabels.Resources_That_Are_x_and_y.replaceAll(n,i):""===n&&""!==i?s=customLabels.Resources_That_Are_x.replaceAll(i):""!==n&&""==i&&(s=customLabels.Resources_That_Are_x.replaceAll(n)),s}return n.callRemoteAction(RemoteActions.getResourceFieldSetFields).then(function(e){for(var t in(o=e).Name=["Name","STRING","Name"],o)"BOOLEAN"===o[t][1]&&(l.resourceFilteringOptions[t]=r.booleanFields[t]);monthlyViewSettings.isMonthlyAvailable&&(o.__Utilization__=[customLabels.AggregatedUtilization,"UTILIZATION","__Utilization__"])}).then(function(){var e,t=[];for(e in o)"PICKLIST"===o[e][1]&&t.push(e);n.callRemoteAction(RemoteActions.getResourcePicklistValues,t).then(function(e){a=e,$("#resourceExplainCrap").html(c(r.showWorkingResource))})}),{getResourceFieldset:function(){return o},getCrewFilteringOptions:function(){return l.crewsSelectionOptions.crewFilteringOptions},getPicklistNames:function(){return a},selectionInfo:l,updateSelectedPicklist:function(e,t){var n=l.picklistOptions.indexOf(e);-1===n?l.picklistOptions.push(e):l.picklistOptions.splice(n,1)},resetFilter:function(){for(var e in l.selectedPicklist="select_a_field",l.length=0,l.picklistOptions.length=0,l.picklistNullValues=!1,l.resourceFilteringOptions)l.resourceFilteringOptions[e]=!1},setAll:function(){for(var e in l.resourceFilteringOptions)l.resourceFilteringOptions[e]=!0},generateFilterExplanation:c,isResourceFilterApplied:function(){if(l.selectedPicklist&&(l.picklistOptions.length||l.picklistNullValues))return!0;for(var e in l.resourceFilteringOptions)if(l.resourceFilteringOptions[e])return!0;return!1},resourceFieldToSortyBy:r.sortBy,resourceCrewFilter:l.crewsSelectionOptions.selectedPicklist,resourceCrewDefaultFilter:customLabels.showAll,descending:r.asc,showWorkingResource:r.showWorkingResource}}]),!function(){function e(o,p,a,l,m,c,h,d,e,u,g,v,f,S){var y=null;function b(){y.killWatch&&y.killWatch(),c.setLightBoxStatus(!1),y.$destroy(),y=null}function _(e){if(e.ganttColor)return e.ganttColor;switch(e.statusCategory){case u.NONE:return"#a5e2d6";case u.SCHEDULED:return"#F9D058";case u.DISPATCHED:return"#8DD8FA";case u.IN_PROGRESS:return"#D68EF9";case u.COMPLETED:return"#95D055";case u.COULD_NOT_COMPLETE:return"#f58556";case u.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}function w(e){e!==y.selectedTab&&(y.selectedTab=e)}function T(e){y.currentlyShowingOnMap=e.id;e=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);y.map.setCenter(e),y.map.setZoom(13)}function L(){y.bounds.isEmpty()||y.map.fitBounds(y.bounds),y.currentlyShowingOnMap=null}function A(){$("#mapCarouselWrapper").slideToggle("slow",function(){}),y.showSideRoute=!y.showSideRoute}function C(e){var t=Math.floor(e/60/60),e=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+e+customLabels.kpi_m}function D(){return(y.isDaily?customLabels.KPIsAreCalculatedFrom:customLabels.KPIsAreCalculatedFromTo).replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll"))}function I(e){return e?moment(e).format("LT"):null}function k(e,t){return""===e||""===t?"":customLabels.Between_x_and_y.replaceAll(moment(e).format("ll"),moment(t).format("ll"))}function R(e){y.resourceSLRPath={stroke:{weight:2,color:"#16325C"},path:[],geodesic:!0,toggle:!0},y.polyLinePath={path:[],geodesic:y.resourceSLRPath.geodesic,strokeColor:y.resourceSLRPath.stroke.color,strokeWeight:y.resourceSLRPath.stroke.weight,strokeOpacity:1},y.markersArray=[],y.bounds=new google.maps.LatLngBounds;var t=function(){var e,t=y.resourceServicesDate,n=new Date(t),i=(n.setHours(24,0,0,0),h.resourcesAndTerritories());for(e in i){var s,r=i[e];for(s in r){var o=r[s];if(-1<y.terMemberKey.indexOf(m.generateResourceId(o.serviceResource,o.serviceTerritory))&&isIntersect(t,n,o.effectiveStartDate,o.effectiveEndDate))return o}}return null}(),n=(y.resourceServices=(n=y.resourceServicesDate,(i=new Date(n)).setHours(24,0,0,0),scheduler.getEvents(n,i).filter(function(e){return-1<e.resourceId.indexOf(y.terMemberKey)&&e.latitude&&("service"===e.type||y.showAbsencesOnMap&&"na"===e.type)}).sort(function(e,t){return e.start.getTime()-t.start.getTime()})),{}),i=(t&&(t.latitude?n={latitude:t.latitude,longitude:t.longitude}:(i=p.territories()[t.serviceTerritory]).latitude&&(n={latitude:i.latitude,longitude:i.longitude})),null);n.latitude?(y.markersArray.push({id:t.serviceResource,type:"resource",coords:n,markerOptions:{icon:staticResources.homebase_png},resourceName:y.lightboxResource.name}),i=new google.maps.LatLng(n.latitude,n.longitude),y.polyLinePath.path.push(i),y.bounds.extend(i)):y.noHomeBase=!0;for(var s=0;s<y.resourceServices.length;s++){var r,o=y.resourceServices[s];o.latitude&&(y.showServices&&(r="service"===o.type?staticResources.service_png:staticResources.resource_absence_icon,r={id:o.id,type:o.type,coords:{latitude:o.latitude,longitude:o.longitude},markerOptions:{icon:r,labelContent:"<span>"+(s+1)+"</span>"+moment(o.start).format("LT"),labelClass:"ResourceMapServiceMarkerLabel",zIndex:200},item:o},y.markersArray.push(r)),r=new google.maps.LatLng(o.latitude,o.longitude),y.bounds.extend(r),y.resourceSLRPath.path.push({location:r,stopover:!0}),y.polyLinePath.path.push(r))}n.latitude&&y.polyLinePath.path.push(i),e||(y.showRoute?allowStreetLevelRouting&&0<y.resourceSLRPath.path.length?(new google.maps.DirectionsService).route({origin:i||y.resourceSLRPath.path[0].location,destination:i||y.resourceSLRPath.path[y.resourceSLRPath.path.length-1].location,waypoints:y.resourceSLRPath.path,travelMode:google.maps.TravelMode.DRIVING,avoidTolls:!0},function(e,t){t===google.maps.DirectionsStatus.OK?(y.polyLineGoogleObj&&(y.polyLineGoogleObj.setMap(null),y.polyLineGoogleObj=null),y.directionsDisplay||(y.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0})),y.directionsDisplay.setMap(y.map),y.directionsDisplay.setDirections(e)):(window.alert("Directions request failed due to "+t),F())}):F():y.polyLineGoogleObj?y.polyLineGoogleObj.setMap(null):y.directionsDisplay&&y.directionsDisplay.setMap(null),t=new google.maps.LatLng(37.794024,-122.394837),y.bounds.isEmpty()?y.map.setCenter(t):y.map.fitBounds(y.bounds));var a,l=y.lightboxResource.id,c=g.lastKnownPositions();for(a in c)if(l===a){d=void 0;u=void 0;d=void 0;var d=c[a];var u=p.getResources()[d.id],d={id:d.id+"_position",markerOptions:{icon:staticResources.livepos_png},type:"lastKnownPosition",resourceId:d.id,coords:{latitude:d.latitude,longitude:d.longitude},item:angular.extend(angular.copy(d),{resourceName:u.name})};"lastKnownPosition"===d.type&&window.customPermissions.Hide_Live_Locations_Resource_Map_Layer||y.markersArray.push(d)}}function F(){y.directionsDisplay&&(y.directionsDisplay.setMap(null),y.directionsDisplay=null),y.polyLineGoogleObj&&y.polyLineGoogleObj.setMap(null),y.polyLineGoogleObj=new google.maps.Polyline(y.polyLinePath),y.polyLineGoogleObj.setMap(y.map)}function M(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"resourceServicesDateStart",date:new Date(y.resourceServicesDate),navigation:!0,handler:function(e,t){y.$apply(function(){y.resourceServicesDate=e,y.generateMarkersAndRoute(),window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||f.callRemoteAction(RemoteActions.getResourceActualRoute,y.lightboxResource.id,e).then(O)}),scheduler.destroyCalendar()}})}function x(e){y.resourceServicesDate.setDate(y.resourceServicesDate.getDate()+e),y.generateMarkersAndRoute(),window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||f.callRemoteAction(RemoteActions.getResourceActualRoute,y.lightboxResource.id,y.resourceServicesDate).then(O)}function O(e){y.actualRoute&&(y.actualRoute.visible=!1,y.actualRoute.setMap(y.map));var t,n={},i=[];for(t in e.forEach(function(e){"LastKnownLatitude"!==e.Field&&"LastKnownLongitude"!==e.Field||(n[e.CreatedDate]=n[e.CreatedDate]||{},n[e.CreatedDate][-1<e.Field.indexOf("Long")?"lng":"lat"]=e.NewValue,n[e.CreatedDate].date=e.CreatedDate)}),n)n[t].lng&&n[t].lat&&i.push(n[t]);y.actualRoute=new google.maps.Polyline({path:i,geodesic:!0,strokeColor:"#ff73bf",strokeOpacity:1,strokeWeight:3}),function(){if(window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map)return;return y.showActual}()&&y.actualRoute.setMap(y.map)}function P(){window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||y.actualRoute&&(y.actualRoute.visible=y.showActual,y.actualRoute.setMap(y.map))}function E(e){for(var t,n=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=[],s=[],r=0;r<n.length;r++)n[r].resource==e&&"contractorcapacity"==n[r].type&&("Week"==n[r].timePeriod&&i.push(n[r]),"Month"==n[r].timePeriod&&s.push(n[r]));y.donutCharts=(t={segmentShowStroke:!1,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:75,animation:!0,animationSteps:100,animationEasing:"easeOutSine",animateRotate:!0,animateScale:!1,showTooltips:!0},{labels:[customLabels.Hours_Used,customLabels.Hours_Available],weekly:{data:[],percentage:"",start:"",end:"",show:!1,options:t},monthly:{data:[],percentage:"",start:"",end:"",show:!1,options:t}}),setTimeout(function(){var e,t=i[0],n=s[0];t?((e=t.hoursPerTimePeriod-t.hoursInUse)<0&&(e=0),y.donutCharts.weekly.data=[t.hoursInUse,e],y.donutCharts.weekly.percentage=N(t.hoursInUse,t.hoursPerTimePeriod)+"%",y.donutCharts.weekly.start=t.start_date,y.donutCharts.weekly.end=t.end_date,y.donutCharts.weekly.show=!0):(y.donutCharts.weekly.data=[0,10],y.donutCharts.weekly.show=!1,y.donutCharts.weekly.options.showTooltips=!1,y.donutCharts.weekly.start=y.kpiStart,y.donutCharts.weekly.end=y.kpiEnd),n?((e=n.hoursPerTimePeriod-n.hoursInUse)<0&&(e=0),y.donutCharts.monthly.data=[n.hoursInUse,e],y.donutCharts.monthly.percentage=N(n.hoursInUse,n.hoursPerTimePeriod)+"%",y.donutCharts.monthly.start=n.start_date,y.donutCharts.monthly.end=n.end_date,y.donutCharts.monthly.show=!0):(y.donutCharts.monthly.data=[0,10],y.donutCharts.monthly.show=!1,y.donutCharts.monthly.options.showTooltips=!1,y.donutCharts.monthly.start=scheduler.getState().min_date,y.donutCharts.monthly.end=scheduler.getState().max_date)},1e3)}function N(e,t){return parseFloat((e/t*100).toFixed(2))}function G(){d(function(){y.actualRoute&&y.actualRoute.setMap(y.map)},500)}return{open:function(e,t){if(!y){(y=o.$new(!0)).lightboxResource=p.getResources()[e],y.terMemberKey=t||h.getResoruceGanttIdByDate(e,scheduler.getState().min_date),y.selectedTab="details";var t="vf079_ResourceCalendar?id=",n=(__gantt.communityNetworkId&&""!==__gantt.communityNetworkId&&fslNamespace&&""!==fslNamespace&&(t=fslNamespace+"__vf079_ResourceCalendar?id="),y.urls={related:a.trustAsResourceUrl(customResourceRelatedListLightboxPage+"?id="+e).toString(),chatter:a.trustAsResourceUrl(customResourceChatter+"?id="+e).toString(),details:a.trustAsResourceUrl(customResourceLightboxPage+"?id="+e).toString(),calendar:a.trustAsResourceUrl(t+e).toString()},y.urls.custom1=CustomResourceTab1?a.trustAsResourceUrl(CustomResourceTab1+"?id="+e).toString():null,y.urls.custom2=CustomResourceTab2?a.trustAsResourceUrl(CustomResourceTab2+"?id="+e).toString():null,y.changeTab=w,y.closeLightbox=b,y.chatterAvailable=fieldTrackingEnabled.resource,y.formatTravel=C,y.openConsoleTab=m.openConsoleTab,y.formatKpitText=D,y.formatDateToTime=I,y.formatCapacityKpitText=k,y.getContractorCapacityStatus=E,y.isMapEnabled=c.isMapEnabled(),y.contractorSupport=c.areContractorsSupported(),y.isDaily="ZoomLevel3"==scheduler._mode,y.actualRoute=null,y.showActual=!0,y.toggleShowRoute=P,y.toggleActualVisibilityWhenMapTabClicked=G,y.boundOnCaruselItem=T,y.showSideRoute=!0,y.zoomOutToFitAll=L,y.slideToggle=A,y.currentlyShowingOnMap=null,y.changeDate=x,y.getColorByStatus=_,y.showAbsencesOnMap=window.showAbsencesOnMap,y.hideActulRoute=window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map,Chart.defaults.global.colours=["#16325c","#DCDCDC","#F7464A","#46BFBD","#FDB45C","#949FB1","#4D5360"],y.donutCharts=null,y.haveItemsToShowOnSideRoute=function(e){for(var t=0;t<e.length;t++)if("na"===e[t].type||"service"===e[t].type)return!0;return!1},y.isMapEnabled&&(y.getServiceInfoRowClass=m.getServiceInfoRowClass,y.firstMapShow=!0,y.showRoute=!0,y.showTrafficLayer=!1,y.showServices=!0,y.mapControl={},y.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER},fullscreenControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},y.serviceInfoWindow={show:!1},y.livePosInfoWindow={show:!1},y.resourceInfoWindow={show:!1},y.absenceInfoWindow={show:!1},y.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},absence:{pixelOffset:new google.maps.Size(0,-38)}},y.resourceServicesDate=scheduler.getState().min_date,y.markersArray=[],v.fieldsSetFields().then(function(e){y.serviceFields=e.MapInfo}),y.killWatch=y.$watch("selectedTab",function(e){"map"==e&&d(function(){var e,t;y.map=y.mapControl.getGMap(),google.maps.event.trigger(y.map,"resize"),y.firstMapShow&&(y.firstMapShow=!1,e=y.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}},e.setOptions(t),y.firstMapShow=!1,y.generateMarkersAndRoute())},0)}),y.generateMarkersAndRoute=R,y.openDatePicker=M,y.routeToggled=function(){y.generateMarkersAndRoute();var e=y.showRoute?y.map:null;y.polyLineGoogleObj&&y.polyLineGoogleObj.setMap(e),y.directionsDisplay&&y.directionsDisplay.setMap(e)},y.markerClicked=function(e,t,n){var i=n.type;switch(y.serviceInfoWindow.show=!1,y.absenceInfoWindow.show=!1,y.livePosInfoWindow.show=!1,y.resourceInfoWindow.show=!1,y.currentMarker=n,i){case"service":y.serviceInfoWindow.show=!0;break;case"lastKnownPosition":y.livePosInfoWindow.show=!0;break;case"resource":y.resourceInfoWindow.show=!0;break;case"na":case"break":y.absenceInfoWindow.show=!0}d(function(){y.$apply(),m.setMapCloseButtonPosition()},0)},y.markerCloseClicked=function(){y.serviceInfoWindow.show=!1,y.livePosInfoWindow.show=!1,y.absenceInfoWindow={show:!1},y.resourceInfoWindow.show=!1,y.$apply()},y.openFieldSetLink=function(e,t){m.openLink(e,t)},y.openLink=function(e){m.openSObjectLink(e)}),e),i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date);y.resourceKpi={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};for(var s=0;s<i.length;s++)i[s].resource==n&&("na"===i[s].type&&(y.resourceKpi.avgTravelTime+=i[s].travelTo+i[s].travelFrom),"service"===i[s].type&&(y.resourceKpi.total++,i[s].statusCategory==u.COMPLETED&&y.resourceKpi.completed++,i[s].violations&&y.resourceKpi.violations++,i[s].jeopardy&&y.resourceKpi.jeopardy++,y.resourceKpi.avgTravelTime+=i[s].travelTo+i[s].travelFrom,i[s].start_date&&i[s].end_date&&(y.resourceKpi.totalScheduledDuration+=(i[s].finish-i[s].start)/1e3)));0<i.length&&0<y.resourceKpi.total?y.resourceKpi.avgTravelTime=Math.floor(y.resourceKpi.avgTravelTime/60/y.resourceKpi.total):y.resourceKpi.avgTravelTime=0,E(e);var r=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="ResourceLightboxHeader">\n                            <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <img ng-show="lightboxResource.pictureLink" class="resourcePhotoLightbox" ng-src="{{ lightboxResource.pictureLink }}" alt="{{ lightboxResource.name }}" />\n                            <div ng-show="!lightboxResource.pictureLink" alt="{{ lightboxResource.name }}" class="ResourcePhotoIcon resourcePhotoLightbox"></div>\n\n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="lightboxResource.name"></h1>\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'relatedLists\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedLists\'}">\n                                '+customLabels.Related+'\n                            </button>\n\n                            <button ng-show="chatterAvailable" fsl-tab-switch role="tab" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </button>\n\n                            <button ng-if="isMapEnabled" fsl-tab-switch role="tab" ng-click="changeTab(\'map\'); " ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                                '+customLabels.Map+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'calendar\')" ng-class="{lightboxSelectedTab: selectedTab == \'calendar\'}">\n                                '+customLabels.Calendar+'\n                            </button>\n                            \n                            <button ng-show="urls.custom1" fsl-tab-switch role="tab" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                                '+customLabels.CustomResourceTab1+'\n                            </button>\n                            \n                            <button ng-show="urls.custom2" fsl-tab-switch role="tab" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                                '+customLabels.CustomResourceTab2+'\n                            </button>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxResource.id)" target="_blank" href="../{{ lightboxResource.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <section ng-if="isMapEnabled" id="resourceLightboxMap" ng-show ="selectedTab == \'map\'">\n                            <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                                <ui-gmap-markers click="markerClicked" models="markersArray" idKey="id" coords="\'coords\'" options="\'markerOptions\'"">\n                                </ui-gmap-markers>\n\n                                <ui-gmap-window show="serviceInfoWindow.show" ng-show="currentMarket.type === \'service\'" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" src="'+staticResources.wo_icon_png+'"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="resourceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.resource">\n                                    <div class="googleMapInfoWindowHomebase">\n                                        <svg aria-hidden="true" class="slds-icon homebaseTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.home+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ "'+customLabels.homebase_of+'" | replaceLabels : currentMarker.resourceName }}</span></h1>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                                \n                                \n                                \n                                <ui-gmap-window show="absenceInfoWindow.show && showAbsencesOnMap" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.absence">\n                                    <div class="googleMapInfoWindowAbsence">\n                                        <svg aria-hidden="true" class="slds-icon absenceeTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.absence+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ $parent.$parent.currentMarker.item.name }}</span></h1>\n                                        <div>'+customLabels.Start_time+": {{ $parent.$parent.currentMarker.item.start | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Finish_time+": {{ $parent.$parent.currentMarker.item.end | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Reason+': {{ $parent.$parent.currentMarker.item.reason }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                               \n                                <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                    <div class="googleMapInfoWindowLivePos">\n                                        <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                        \u2028\t<use xlink:href="'+lsdIcons.user+'"></use>\n                                    \u2028\t</svg>\n                                        <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                        <div>'+customLabels.Last_seen+' {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.resourceId)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-layer type="TrafficLayer" show=\'showTrafficLayer\'></ui-gmap-layer>\n                                \n                            </ui-gmap-google-map>\n                            <div id="ResourceMapOptions">\n                                <div id="ResourceMapOptionsWrapper">\n                                    <input ng-model="$parent.showServices" ng-change="generateMarkersAndRoute(true)" type="checkbox" id="ResourceServicesFilter"></input>\n                                    <label for="ResourceServicesFilter">'+customLabels.Show_services_for+'</label>\n                                    <div class="resourceMapDateArrow" fsl-key-press tabindex="0" ng-click="changeDate(-1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronleft+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <u id="resourceServicesDateStart" class="bulkDatePicker" fsl-key-press tabindex="0" ng-click ="openDatePicker()" >{{resourceServicesDate | amDateFormat:\'L\'}}</u>\n                                    <div class="resourceMapDateArrow" fsl-key-press tabindex="0" ng-click="changeDate(1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronright+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showRoute" ng-change="routeToggled()" type="checkbox" id="RouteFilter"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="RouteFilter">'+customLabels.Route+'</label>\n                                    <input ng-hide="hideActulRoute || (lightboxResource.isCapacityBased && contractorSupport)" ng-model="$parent.showActual" ng-change="toggleShowRoute()" type="checkbox" id="actualToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="hideActulRoute || (lightboxResource.isCapacityBased && contractorSupport)" for="actualToggle">'+customLabels.ActualRoute+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="showTrafficLayer" type="checkbox" id="trafficToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="trafficToggle">'+customLabels.Traffic+'</label>\n                                    <div fsl-key-press tabindex="0" class="truncate" id="toggleResourceMapServiceCarousel" ng-click="slideToggle()">\n                                        {{showSideRoute ? "'+customLabels.HideDetailedRoute+'" : "'+customLabels.ToggleDetailedRoute+'"}}\n                                    </div>\n                                </div>\n                            </div>\n                            <div id="ResourceMapCarousel" ng-show="resourceServices.length > 0">\n\n                                <div id="mapCarouselWrapper">\n                                    <div class="carouselArrow crouselLeft">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronleft+'"></use>\u2028</svg>\n                                    </div>\n                                    <div class="carouselArrow crouselRight">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronright+'"></use>\u2028</svg>                                \n                                    </div>\n                                    \n                                    \n                                    <div class="resource-map-no-route" ng-hide="haveItemsToShowOnSideRoute(markersArray)">\n                                        There are no services or absences to show\n                                    </div>\n                                    \n                                    <div ng-repeat="marker in markersArray" class="carouselItem" ng-if=" marker.type === \'na\' || marker.type == \'service\'">\n                                    \n                                        <div ng-if="marker.type === \'na\'">\n                                            <span class="numberingOnMapRouteSide numberingOnMapRouteSideNA" fsl-key-press tabindex="0" title="'+customLabels.CenterOnMapp+'" ng-click="boundOnCaruselItem(marker)">{{noHomeBase && $index+1 || $index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.name}}</span>\n  \n                                            <div class="appointment-rows">\n                                                <div>'+customLabels.Start_time+": {{ marker.item.start | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Finish_time+": {{ marker.item.end | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Reason+': {{ marker.item.reason }}</div>\n                                            </div>\n                                        </div>\n                                    \n                                    \n                                        <div ng-if="marker.type == \'service\'">\n                                            <span class="numberingOnMapRouteSide" title="'+customLabels.CenterOnMapp+'" fsl-key-press tabindex="0" ng-click="boundOnCaruselItem(marker)" ng-style="{\'background-color\': getColorByStatus(marker.item)}">{{ noHomeBase && $index+1 || $index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.AppointmentNumber}}</span>\n                                            \x3c!-- <div class="boundOnMarker globalBlueButton" ng-click="boundOnCaruselItem(marker)" ng-hide="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.checkin+'"></use>\u2028</svg>                                            \n                                            </div>\n                                            <div class="boundOnMarker globalBlueButton" ng-click="zoomOutToFitAll()" ng-show="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.location+'"></use>\u2028</svg>                                            \n                                            </div>--\x3e\n                                            <div class="appointment-rows">\n                                                <span ng-repeat="field in serviceFields" class="">\n                                                    <div ng-show="marker.item[field.JsAPIName]">{{field.Label}}: <span ng-click="openFieldSetLink(marker.item, field)" ng-class="getServiceInfoRowClass(field)">{{marker.item | displayFieldSetField : field}}</span></div>                                            \n                                                </span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </section>\n\n                        <div class="capacitiesDonuts" ng-show="selectedTab == \'details\' && lightboxResource.isCapacityBased && contractorSupport">\n                            <div id="weeklyCapacity">\n                                <div id="weeklyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.weekly.show" ng-bind="donutCharts.weekly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.weekly.show">'+customLabels.No_Weekly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.weekly.show" title="'+customLabels.Weekly_Capacity+'">'+customLabels.Weekly_Capacity+'</div>\n                                </div>\n                                <canvas id="weeklyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.weekly.options"\n                                        chart-data="donutCharts.weekly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.weekly.start, donutCharts.weekly.end)}}</div>\n                            </div>\n\n                            <div id="monthlyCapacity">\n                                <div id="monthlyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.monthly.show" ng-bind="donutCharts.monthly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.monthly.show">'+customLabels.No_Monthly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.monthly.show" title="'+customLabels.Monthly_Capacity+'">'+customLabels.Monthly_Capacity+'</div> \n                                </div>\n                                <canvas id="monthlyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.monthly.options"\n                                        chart-data="donutCharts.monthly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.monthly.start, donutCharts.monthly.end)}}</div>\n                            </div>\n                        </div>\n\n                        <div id="KPIforResource" ng-show="selectedTab == \'details\'" ng-class="{KPIforResourceWithCapacity: (lightboxResource.isCapacityBased && contractorSupport)}">\n                            <div class="kpiIndicator" ng-show="!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport)">\n                                <div class="kpiResourceValue" >\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.totalScheduledDuration) }}\n                                </div>\n\n                                '+customLabels.Total_Scheduled+'\n                            </div>\n\n                            <div class="kpiIndicator" ng-show="isMapEnabled && (!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport))">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIconTravel"><use xlink:href="'+lsdIcons.car+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.avgTravelTime * 60) }}\n                                </div>\n\n                                '+customLabels.Average_Travel+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\u2028</svg>\n                                    {{ resourceKpi.violations }}\n                                </div>\n\n                                '+customLabels.Violations+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.jeopardy+'"></use>\u2028</svg>\n                                    {{ resourceKpi.jeopardy }}\n                                </div>\n                                 '+customLabels.In_Jeopardy+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\u2028</svg>\n                                    {{ resourceKpi.completed }}/{{ resourceKpi.total }}\n                                </div>\n\n                                '+customLabels.Completed+'\n                            </div>\n\n                            <div class="KpiRange">{{formatKpitText()}}</div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.details }}" id="detailsIframeResource" ng-class="{detailsIframeResourceContractor: lightboxResource.isCapacityBased && contractorSupport}" ng-show="selectedTab == \'details\'"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.related }}" id="relatedListIframeResource" ng-show="selectedTab == \'relatedLists\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable" id="chatterIframeResource" ng-show="selectedTab == \'chatter\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.calendar }}" id="calendarIframeResource" ng-show="selectedTab == \'calendar\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}" class="resourceLightboxIframe"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");r.find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),angular.element("body").append(r),c.setLightBoxStatus(),y.$on("$destroy",function(){return r.remove()}),y.$on("keypress",function(e,t){27==t.which&&y.$evalAsync(y.closeLightbox)}),l(r)(y),m.safeApply(y),window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||f.callRemoteAction(RemoteActions.getResourceActualRoute,y.lightboxResource.id,scheduler.getState().min_date).then(function(e){S.promise(1).then(function(){y.map=y.mapControl.getGMap(),O(e)})})}}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$sce","$compile","utils","StateService","TimePhasedDataService","$timeout","SERVICE_STATUS","SERVICE_CATEGORY","LastKnownPositionService","FieldSetFieldsService","sfdcService","uiGmapIsReady"],angular.module("serviceExpert").factory("ResourceLightboxService",e)}(),!function(){function e(s,r,o,l,e,c,d,u,p,t,a){var m=null,h=[];function g(){m.$destroy()}function v(){e.open(m.resourceId,m.section)}function f(t){var e,n,i,s,r=void 0,r=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),o=d.selectedPolicyId,a={FillInSchedule:{FunctionName:c.runFillInSchedule,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.Fill_in_Schedule),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.Fill_in_Schedule,m.menuResource.name.encodeHTML(),moment(r).format("L"))},FixOverlaps:{FunctionName:c.runFixOverlaps,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.FixOverlaps),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.FixOverlaps,m.menuResource.name.encodeHTML(),moment(r).format("L"))}};useLocationTimezone&&(n=addDaysToDate(e=r,1),i=p.getIntersectingSrstOffset({start_date:e,end_date:n},m.resourceId),s=l.getUserOffset(e),l.getUserOffset(n),r.setMinutes(e.getMinutes()+s-i)),(0,a[t].FunctionName)(r,m.resourceId,o).then(function(e){e?(e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?l.addNotification(a[t].NotificationHeaderText,a[t].NotificationText,function(e){l.openSObjectLink("../"+e)},e.Id):l.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){l.openSObjectLink("../"+e)},e.Id),u.updateOptimizationRequest(e)):l.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).then(function(){}).catch(function(e){console.warn(t+" failed :("),console.log(e),l.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){}),g()}function S(){var e,t=r.getResources(),n=p.currentCrewToShow,n={},i=p.crewToServiceCrewMembers()[m.menuResource.serviceCrew];for(e in n[m.resourceId]=m.menuResource,i)n[i[e].serviceResource]=t[i[e].serviceResource],void 0===n[i[e].serviceResource].members&&(n[i[e].serviceResource].members={}),n[i[e].serviceResource].members[e]=i[e];p.currentCrewToShow=n,s.currentCrewToShow=n,g(),s.$broadcast("moveToCrewView")}function y(){t.open(m.resourceId)}function b(t){var e,n,i,s=null,r=window.__lastResourceClicked.key.split("_")[1],o=p.resourcesAndTerritories()[m.resourceId];for(e in o)o[e].serviceTerritory===r&&(s=e);if(t.visualforce)return n=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),a.open(t.name,t.visualforce+"?id="+m.resourceId+"&stm="+s+"&start="+n+"&end="+i),void g();c.callRemoteAction(RemoteActions.runCustomResourceAction,t.className,m.resourceId,s,scheduler._min_date,scheduler._max_date).then(function(e){return l.addNotification(t.name,e,null,null)}).catch(function(e){return l.addNotification(t.name,e.message,null,null)}),g()}return l.customActionsPromise.then(function(){var e=l.getCustomActions("resource");h.push.apply(h,_toConsumableArray(e))}),{open:function(e,t,n){(m=s.$new(!0)).menuResource=r.getResources()[e],m.resourceId=e,m.section=t,m.openResourceLightbox=v,m.runDynamicGanttFunction=f,m.hasCustomPermission=l.hasCustomPermission,m.showCrew=S,m.openResourceDayOptimizationLightbox=y,m.isCrew=!1,m.customActions=h,m.runCustomResourceAction=b,void 0!==r.getCrewResources()[e]&&(m.isCrew=!0);var i=angular.element('\n                    <div id="resourceMenu" class="resourceMenuContainer">\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceLightbox()" title="'+customLabels.Details+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Details+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceDayOptimizationLightbox()" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Resource_Schedule_Optimization\')" title="'+customLabels.RDOptimize+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.magicwand+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.RDOptimize+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FixOverlaps\')" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Fix_Overlaps\')" title="'+customLabels.FixOverlaps+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.crossfilter+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.FixOverlaps+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FillInSchedule\')" ng-hide="!hasCustomPermission(\'Fill_in\')" title="'+customLabels.Fill_in_Schedule+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.summarydetail+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Fill_in_Schedule+'\n                        </div>\n                        <div class="truncate resMenuSingleAction" ng-click="showCrew()" ng-show="isCrew" title="'+customLabels.showCrewAndHisMemebers+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon crew-icon-menu">\n                                    <use xlink:href="'+lsdIcons.crew+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.showCrew+'\n                        </div>                    \n                        \n                        <div ng-repeat="action in customActions" class="truncate resMenuSingleAction" ng-click="runCustomResourceAction(action)" title="{{action.name}}">\n                        \n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon customResourceAction" ng-show="action.icon">\n                                    <use xlink:href="{{action.icon}}"></use>\n                                \u2028</svg>\n                            </div>\n                        \n                            {{action.name}}\n                        </div>\n                    </div>\n                '),e=(t=$($(n).closest(".resourceMenuBtn"))).offset(),n=$(window).width()-(e.left+t.outerWidth());angular.element("body").append(i),$(".resourceMenuContainer").css({top:e.top}),d.isRtlDirection()?$(".resourceMenuContainer").css({right:n}):$(".resourceMenuContainer").css({left:e.left}),m.$on("$destroy",function(){return i.remove()}),angular.element("body").on("mousedown",function(e){for(var t=["resMenuSingleAction"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;g(),e.stopPropagation(),angular.element("body").off("mousedown")}),o(i)(m),l.safeApply(m)}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$compile","utils","ResourceLightboxService","sfdcService","StateService","DeltaService","TimePhasedDataService","rdOptimizeLightboxService","GeneralLightbox"],angular.module("serviceExpert").factory("ResourceSmallMenu",e)}(),!function(){function e(e,t){var s={territories:e.defer(),resources:e.defer(),operatingHours:e.defer()},r={},o={},a={},l=[],c={},d={},u={};function n(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,i=e.defer();return t.GetResourcesAndTerritories().then(function(e){n&&n(),i.resolve();var t=e.withoutSharingTerritories.reduce(function(e,t){return e[t.Id]=t,e},{});e.territories.forEach(function(e){e.IsActive&&(r[e.Id]=new ServiceTerritory(e),r[e.Id].hasSharing=!t[e.Id]),o[e.Id]=new ServiceTerritory(e)}),e.resources.forEach(function(e){a[e.Id]=new ServiceResource(e),a[e.Id].isCapacityBased&&l.push(e.Id),a[e.Id].serviceCrew&&(d[e.Id]=e,u[a[e.Id].serviceCrew]=e)}),e.operatingHours.forEach(function(e){c[e.Id]=new OperatingHours(e)}),s.territories.resolve(r),s.resources.resolve(a),s.operatingHours.resolve(c),window.setSplashScreenTabDone("loading-territories")}).catch(function(e){i.reject(e),s.resources.reject(),s.territories.reject(),s.operatingHours.reject(),console.warn("GetResourcesAndTeritorries: unable to load resources, territories, or operating hours"),bootstrap.handleError(e)}),i.promise}return n(),{promises:{territories:function(){return s.territories.promise},resources:function(){return s.resources.promise},operatingHours:function(){return s.operatingHours.promise}},territories:function(){return r},allTerritories:o,getResources:function(){return a},operatingHours:c,getOperatingHours:function(){return c},getCapacityBasedResources:function(){return l},getCrewResources:function(){return d},getCrewToResources:function(){return u},contractorResources:function(){return l},crewResources:function(){return d},crewToResources:function(){return u},getResourceAndTerritories:n,reset:function(){r={},a={},c={},l=[],d={},u={}}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("ResourcesAndTerritoriesService",e)}(),!function(){function e(n,i,s,o,a,l,c,d,u,p,m,h,e,g){var v=null;function f(){switch(v.selectedTab){case"account":return v.lightboxService.accountId||v.lightboxService.id;case"wo":return v.lightboxService.parentRecord||v.lightboxService.id;default:return v.lightboxService.id}}function S(e){return!("wo"!==e||"WorkOrder"!==v.lightboxService.parentRecordType||!fieldTrackingEnabled.workorder)||(!("wo"!==e||"WorkOrderLineItem"!==v.lightboxService.parentRecordType||!fieldTrackingEnabled.woli)||!("service"!==e||!fieldTrackingEnabled.service))}function y(e){return e===l.LINEITEM||e===l.WORKORDER}function b(){c.setLightBoxStatus(!1),v.killWatch&&v.killWatch(),v.$destroy()}function _(e){e!==v.selectedTab&&(v.selectedTab=e)}return{open:function(e){var r,t;(v=n.$new(!0)).lightboxService=i.serviceAppointments()[e],v.selectedTab="service",v.urls={service:s.trustAsResourceUrl(customLightboxPage+"?id="+e).toString()},v.lightboxService&&(v.lightboxService.accountId&&(v.urls.account=s.trustAsResourceUrl(customAccountLightbox+"?id="+v.lightboxService.accountId).toString()),v.urls.service_chatter=s.trustAsResourceUrl(customServiceChatterLightbox+"?id="+v.lightboxService.id).toString(),v.lightboxService.parentRecordType===l.WORKORDER?(v.urls.wo=s.trustAsResourceUrl(customWoLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.wo_chatter=s.trustAsResourceUrl(customWoChatterLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.related=s.trustAsResourceUrl(customWoRelatedLightbox+"?id="+v.lightboxService.parentRecord).toString(),(v.lightboxService.isBundle||v.lightboxService.isBundleMember)&&(v.urls.bundle=s.trustAsResourceUrl("vf0008_bundlerdetailslightbox?id="+v.lightboxService.id).toString())):v.lightboxService.parentRecordType===l.LINEITEM?(v.urls.wo=s.trustAsResourceUrl(customWoliLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.wo_chatter=s.trustAsResourceUrl(customWoliChatterLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.related=s.trustAsResourceUrl(customWoliRelatedLightbox+"?id="+v.lightboxService.parentRecord).toString()):v.lightboxService.parentRecordType===l.ACCOUNT?(v.urls.related=null,v.urls.account=s.trustAsResourceUrl(customAccountLightbox+"?id="+v.lightboxService.parentRecord).toString()):v.urls.related=null,v.urls.custom1=CustomServiceTab1?s.trustAsResourceUrl(CustomServiceTab1+"?id="+v.lightboxService.id).toString():null,v.urls.custom2=CustomServiceTab2?s.trustAsResourceUrl(CustomServiceTab2+"?id="+v.lightboxService.id).toString():null,v.changeTab=_,v.isChatterAvailable=S,v.closeLightbox=b,v.chatterAvailable=fieldTrackingEnabled.service,v.openConsoleTab=a.openConsoleTab,v.isMapEnabled=c.isMapEnabled(),v.selectedSubTabWo="details",v.selectedSubTabService="details",v.showWOTab=y,v.getIdOfObjectInActiveTab=f,v.isMapEnabled&&(v.serviceIcon=staticResources.wo_icon_png,v.resourceIcon=lsdIcons.user,v.lastSeenLabel=customLabels.Last_seen,v.getServiceInfoRowClass=a.getServiceInfoRowClass,v.currentMarker={},v.map=null,v.mapControl={zoom:19,center:{latitude:0,longitude:0}},v.allMarkersArray=[],v.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},v.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},v.serviceInfoWindow={show:!1},v.livePosInfoWindow={show:!1},p.fieldsSetFields().then(function(e){v.serviceFields=e.MapInfo}),null!=v.lightboxService.latitude&&null!=v.lightboxService.longitude&&(r=u(function(){if(!v.mapControl||v.mapControl.getGMap){u.cancel(r),v.map=v.mapControl.getGMap();var e=staticResources.service_png;v.lightboxService.statusCategory==g.COMPLETED&&(e=staticResources.service_completed_png),v.allMarkersArray.push({id:v.lightboxService.id,icon:e,type:"service",coords:{latitude:v.lightboxService.latitude,longitude:v.lightboxService.longitude},item:v.lightboxService});var t,n=m.lastKnownPositions();for(t in n){i=void 0;s=void 0;i=void 0;var i=n[t];var s=h.getResources()[i.id],i={id:i.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:i.id,coords:{latitude:i.latitude,longitude:i.longitude},item:angular.extend(angular.copy(i),{resourceName:s.name})};v.allMarkersArray.push(i)}e=new google.maps.LatLng(v.lightboxService.latitude,v.lightboxService.longitude);v.map.setCenter(e)}},500)),v.openLink=function(e,t){a.openLink(e,t)},v.markerCloseClicked=function(){v.serviceInfoWindow.show=!1,v.livePosInfoWindow.show=!1,v.$apply()},v.markerClicked=function(e,t,n){var i=n.type;switch(v.serviceInfoWindow.show=!1,v.livePosInfoWindow.show=!1,v.currentMarker=n,i){case"service":v.serviceInfoWindow.show=!0;break;case"lastKnownPosition":v.livePosInfoWindow.show=!0}d(function(){v.$apply(),a.setMapCloseButtonPosition()},0)},v.killWatch=v.$watch("selectedTab",function(e){"map"==e&&d(function(){google.maps.event.trigger(v.map,"resize")},0)})),v.$on("$destroy",function(){return t.remove()}),v.$on("keypress",function(e,t){27==t.which&&v.$evalAsync(v.closeLightbox)}),(t=angular.element('<div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="ServiceLightbox">\n\n                    <div class="lightboxHeaderContainer" id="ServiceLightboxHeader">\n\n                        <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                        <h1 class="lightboxHeader">{{lightboxService.name}}</h1>\n\n                        <button fsl-tab-switch role="tab" ng-click="changeTab(\'service\')" ng-class="{lightboxSelectedTab: selectedTab == \'service\'}">\n                            '+customLabels.Service+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.bundle" ng-click="changeTab(\'bundle\')" ng-class="{lightboxSelectedTab: selectedTab == \'bundle\'}">\n                            '+customLabels.Bundle+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-click="changeTab(\'wo\')" ng-class="{lightboxSelectedTab: selectedTab == \'wo\'}">\n                            <div ng-show="lightboxService.parentRecordType === \'WorkOrder\'">'+customLabels.WorkOrder+"</div>\n                            <div ng-show=\"lightboxService.parentRecordType === 'WorkOrderLineItem'\">"+customLabels.Woli+'</div>\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.related" ng-click="changeTab(\'relatedList\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedList\'}">\n                            '+customLabels.Related+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-if="isMapEnabled" ng-show="lightboxService.latitude && lightboxService.longitude" ng-click="changeTab(\'map\')" ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                            '+customLabels.Map+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.account" ng-click="changeTab(\'account\')" ng-class="{lightboxSelectedTab: selectedTab == \'account\'}">\n                            '+customLabels.Account+'\n                        </button>\n                        \n                        <button fsl-tab-switch role="tab" ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                            '+customLabels.CustomServiceTab1+'\n                        </button>\n                        \n                        <button fsl-tab-switch role="tab" ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                            '+customLabels.CustomServiceTab2+'\n                        </button>\n\n                        <div class="ExtendedForm">\n                            <a ng-click="openConsoleTab($event,getIdOfObjectInActiveTab())" target="_blank" href="../{{ getIdOfObjectInActiveTab() }}" title="'+customLabels.ExtandedForm+'">\n                                <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                \u2028</svg>\n                            </a>\n                        </div>\n\n                    </div>\n                   \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'service\') && selectedTab == \'service\'">\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabService == \'details\'}" ng-click="selectedSubTabService=\'details\'"}">'+customLabels.Details+'</button>\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabService == \'feed\'}" ng-click="selectedSubTabService=\'feed\'">'+customLabels.Feed+'</button>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'wo\') && selectedTab == \'wo\'">\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabWo == \'details\'}" ng-click="selectedSubTabWo=\'details\'"}">'+customLabels.Details+'</button>\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabWo == \'feed\'}" ng-click="selectedSubTabWo=\'feed\'">'+customLabels.Feed+'</button>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'relatedList\' && urls.related" ng-src="{{ urls.related }}"></iframe>  \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'account\' && urls.account" ng-src="{{ urls.account }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'bundle\' && urls.bundle" ng-src="{{ urls.bundle }}"></iframe>\n\n\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}"></iframe>\n                    \n                    \n                    \n                    <div id="lightbox-loading-cover">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.loading+'\n                    </div>\n                    \n                 \n                    <section ng-if="isMapEnabled" id="serviceLightboxMap" ng-show ="selectedTab == \'map\'">\n                        <ui-gmap-google-map pan="false" control="mapControl" center="mapControl.center" options="mapOptions" zoom="mapControl.zoom" class="map-canvas">\n                            <ui-gmap-markers click="markerClicked" models="allMarkersArray" idKey="id" coords="\'coords\'" icon="\'icon\'">\n                            </ui-gmap-markers>\n\n                            <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" ng-src="{{serviceIcon}}"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                            </ui-gmap-window>\n\n                            <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                <div class="googleMapInfoWindowLivePos">\n                                    <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                    \u2028\t<use xlink:href="{{resourceIcon}}"></use>\n                                \u2028\t</svg>\n                                    <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                    <div>{{lastSeenLabel}} {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                </div>\n                            </ui-gmap-window>\n                        </ui-gmap-google-map>\n                    </section>\n\n                </div>\n            </div>')).find("#ServiceLightbox").draggable({containment:"document",handle:"#ServiceLightboxHeader"}),c.setLightBoxStatus(),o(t)(v),a.safeApply(v,function(){angular.element("body").append(t)}))}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","PARENT_RECORD_TYPE","StateService","$timeout","$interval","FieldSetFieldsService","LastKnownPositionService","ResourcesAndTerritoriesService","SERVICE_STATUS","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("ServiceAppointmentLightboxService",e)}(),!function(){function e(r,e,n,t,i,s,o){var a={},l=e.filter,c=[],d={};function u(e,t,n,i){var s=i&&i[t.selectedFilter]&&i[t.selectedFilter].old;return useNewFilters&&!s?r("servicesListFilterNew")(e,t,n):r("servicesListFilter")(e,t,n,i)}function p(){for(var e in a)a[e]=!1}return i.register("services",function(e){e.deleted&&e.deleted.forEach(function(e){return delete a[e]})}),o.fieldsSetFields().then(function(e){c=e.ListColumns}),{SelectedServices:a,unselectAll:p,selectAll:function(){d=u(n.serviceAppointments(),l,c,s.getFilterMap());for(var e=0;e<d.length;e++)a[d[e].id]=!0},selectViolations:function(){p();var e=angular.copy(l);e.selectedFilter="Violating","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=u(n.serviceAppointments(),l,c,s.getFilterMap()),d=u(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].violations&&(a[d[t].id]=!0)},selectInJeopardy:function(){p();var e=angular.copy(l);e.selectedFilter="inJeopardy","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=u(n.serviceAppointments(),l,c,s.getFilterMap()),d=u(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].jeopardy&&(a[d[t].id]=!0)},selectUnscheduled:function(){p();var e=angular.copy(l);e.selectedFilter="Unscheduled","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=u(n.serviceAppointments(),l,c,s.getFilterMap()),d=u(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].isScheduled&&!d[t].isScheduled()&&(a[d[t].id]=!0)},countSelectedServices:function(){var e,t=0;for(e in a)a[e]&&t++;return t},getSelected:function(){var e,t=[];for(e in a)a[e]&&t.push(e);return t}}}e.$inject=["$filter","servicesService","TimePhasedDataService","sfdcService","RegisterService","GanttFilterService","FieldSetFieldsService"],angular.module("serviceExpert").factory("ServiceSelectorService",e)}(),!function(){function e(e,n,d){var i=[],s={skills:e.defer()};return{getSkills:function(){return i},doesHaveSkills:function(e,t){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,s=d.getResources()[e],r=0,o=(t=Array.isArray(t)?t:[t]).length;r<o;r++){var a=s.skills[t[r]];if(!a)return!1;if(Array.isArray(a)){for(var l=!1,c=0;c<a.length;c++)n&&i&&isIntersect(n,i,a[c].effectiveStartDate,a[c].effectiveEndDate)&&(l=!0);if(!l)return!1}else if(n&&i&&!isIntersect(n,i,a.effectiveStartDate,a.effectiveEndDate))return!1}return!0},doesHaveSomeSkills:function(e,t){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,s=d.getResources()[e],r=0,o=(t=Array.isArray(t)?t:[t]).length;r<o;r++){var a=s.skills[t[r]];if(a){if(Array.isArray(a))for(var l=0;l<a.length;l++)if(n&&i&&isIntersect(n,i,a[l].effectiveStartDate,a[l].effectiveEndDate))return!0;if(n&&i&&isIntersect(n,i,s.skills[t[r]].effectiveStartDate,s.skills[t[r]].effectiveEndDate))return!0}}return!1},getSkillsFromSfdc:function(){var t=e.defer();return n.callRemoteAction(RemoteActions.getSkills).then(function(e){i=e,t.resolve(t),s.skills.resolve(i)}).catch(function(e){t.reject(t),s.skills.reject(e),console.log(e),console.warn("unable to get skill list")}),t.promise},promises:{skills:function(){return s.skills.promise}}}}e.$inject=["$q","sfdcService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("SkillsService",e)}(),!function(){function e(e,t,n){var i={},s=0,r=!1;if(n.GetUserSettingsProperty("Toggled_Territories__c"))try{var o,a=JSON.parse(n.GetUserSettingsProperty("Toggled_Territories__c"));for(o in a)i[o]=a[o]}catch(e){console.warn("could not parse JSON - Toggled_Territories__c")}var l={policies:e.defer()};var n=userLocale?userLocale.split("_")[0]:"en",c=[];var d=!1;t.callRemoteAction(RemoteActions.getPolicies).then(function(e){c.push.apply(c,_toConsumableArray(e)),0<c.length?l.policies.resolve(c):l.policies.reject("no policies found")}).catch(function(e){l.policies.reject(e)});var u=!1;var p=!1;function m(){return p}var h,g={minDate:null,maxDate:null};return document.addEventListener("mousemove",function(){return s=0}),window.Worker&&((h=new Worker(window.__gantt.InactivityMonitorWorker)).onmessage=function(e){(s+=10)>=window.__gantt.maxSecondsOfInactivity&&!r&&(r=!0,console.warn("Dispatcher Console: User is inactive, disconnecting."),p&&$.cometd.disconnect(),h.terminate())}),{isOptimizationEnabled:isOptimizationEnabled,lang:n,isOSX:function(){return-1!=window.navigator.userAgent.indexOf("Mac OS X")},isRtlDirection:function(){return"rtl"===document.querySelector("html").getAttribute("dir")},isInConsole:function(){return"undefined"!=typeof sforce?sforce.console.isInConsole():null},policies:c,selectedPolicyId:null,areContractorsSupported:function(){return contractorSupport},isMapEnabled:function(){return mapMode},setLightBoxStatus:function(){u=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isLightboxOpened:function(){return u},setBulkActionRunning:function(){d=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isBulkActionRunning:function(){return d},schedulingRunningFor:{},isScheduleRunning:!1,ganttOpenedTerritories:i,areCrewsSupported:function(){return!0},getStreamingActiveState:m,setStreamingActiveState:function(e){p=e},setDeltaDates:function(e,t){e=[moment(e),moment(t)],g.minDate&&(e.push(moment(g.minDate)),e.push(moment(g.maxDate))),g.minDate=moment.min(e).toDate(),g.maxDate=moment.max(e).toDate()},getDeltaDates:function(){return null!==g.minDate&&null!==g.maxDate?{minDate:g.minDate.getTime(),maxDate:g.maxDate.getTime()}:{minDate:null,maxDate:null}},isUserIdle:function(){return r},promises:{policies:function(){return l.policies.promise}}}}e.$inject=["$q","sfdcService","userSettingsManager"],angular.module("serviceExpert").factory("StateService",e)}(),!function(){function e(o,a,e,l,c,d,u){var p={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]},m=!1,h=new Set,g=new Set,v=new Set,f=new Set,S=new Set,y=new Set,b=new Set,_=new Set,w=new Set,T=new Set;return{HandleNotification:function(e){if(m||(m=!0,setTimeout(function(){(e={}).deletedAbsencesArray=Array.from(h),e.updatedAbsencesArray=Array.from(g),e.deletedGanttServicesArray=Array.from(v),e.updatedGanttServicesArray=Array.from(f),e.deletedCapacitiesArray=Array.from(S),e.updatedCapacitiesArray=Array.from(y),e.resourcesIdsArray=Array.from(b),e.updatedAssignResourceArray=Array.from(_),e.updatedOptimizationRequestArray=Array.from(w),e.deletedTimeDependencyArray=Array.from(T);m=!1,h.clear(),g.clear(),v.clear(),f.clear(),S.clear(),y.clear(),b.clear(),_.clear(),w.clear(),T.clear();var t,n,e,i=[];{var s,r;0!=e.updatedOptimizationRequestArray.length&&i.push(function(e){var n=o.defer();return a.getOptimiztionRequestsUpdate(e).then(function(t){d.isOptimizationEnabled&&t&&0<t.length&&p.optimizationRequests.forEach(function(e){return e(t)}),n.resolve()}),n.promise}(e.updatedOptimizationRequestArray)),0!=e.updatedAssignResourceArray.length&&i.push(function(e){var i=o.defer();return a.getGanttServiceOnAssignedResourceUpdate(e).then(function(e){var t,n=[];e&&0<e.length&&(t={},0<e.length&&(t.updated=l.updateTimePhaseData(e,"service").services,n.push.apply(n,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(t.updated))))),t.updated&&p.services.forEach(function(e){return e(t)})),i.resolve(n)}),i.promise}(e.updatedAssignResourceArray)),0!=e.resourcesIdsArray.length&&i.push(function(e){var n=o.defer();return a.getLivePositionsStreaming(e).then(function(e){var t=c.updatePositions(e);t.isUpdated&&p.positions.forEach(function(e){return e(t.dic)}),n.resolve()}),n.promise}(e.resourcesIdsArray)),0!=e.updatedCapacitiesArray.length&&i.push(function(e){var n=o.defer();return a.getUpdatedResourceCapacities(e).then(function(e){var t;e&&0<e.length&&((t={}).updated=l.updateTimePhaseData(e,"capacity").capacities,t.updated&&p.capacities.forEach(function(e){return e(t)})),n.resolve()}),n.promise}(e.updatedCapacitiesArray)),0==e.updatedGanttServicesArray.length&&0==e.deletedTimeDependencyArray.length||i.push(function(e,t){var i=o.defer();return a.getUpdatedServices(e,t).then(function(e){var t,n=[];e&&0<e.length&&(t={},0<e.length&&(t.updated=l.updateTimePhaseData(e,"service").services,n.push.apply(n,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(t.updated))))),t.updated&&p.services.forEach(function(e){return e(t)})),i.resolve(n)}),i.promise}(e.updatedGanttServicesArray,e.deletedTimeDependencyArray)),0!=e.updatedAbsencesArray.length&&i.push(function(e){var i=o.defer();return a.getUpdatedAbsences(e).then(function(e){var t=[],n={};0<e.length&&(e=l.updateTimePhaseData(e,"na"),n.updated=e.absences,n.deleted=e.notApprovedAbsencesIds,e=n.updated.map(function(e){return e.resource}).join(","),t.push.apply(t,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(n.updated),e))),t.push.apply(t,_toConsumableArray(u.getRelatedServices(n.deleted))),(n.updated||n.deleted)&&p.absences.forEach(function(e){return e(n)})),i.resolve(t)}),i.promise}(e.updatedAbsencesArray)),0!=e.deletedAbsencesArray.length&&i.push(function(e){var i=o.defer();return a.getDeletedAbsences(e).then(function(e){var t=[],n={};0<e.length&&(n.deleted=l.deleteTimePhaseData(e,"na").absences,t.push.apply(t,_toConsumableArray(u.getRelatedServices(n.deleted))),(n.updated||n.deleted)&&p.absences.forEach(function(e){return e(n)})),i.resolve(t)}),i.promise}(e.deletedAbsencesArray)),0!=e.deletedGanttServicesArray.length&&(s=e.deletedGanttServicesArray,r=[],s&&0<s.length&&((t={}).deleted=l.deleteTimePhaseData(s,"service").services,r.push.apply(r,_toConsumableArray(u.getRelatedServices(t.deleted))),t.deleted&&p.services.forEach(function(e){return e(t)}),0<r.length&&p.rules.forEach(function(e){return e(r)})))}0!=e.deletedCapacitiesArray.length&&(s=e.deletedCapacitiesArray)&&0<s.length&&((n={}).deleted=l.deleteTimePhaseData(s,"capacity").capacities,n.deleted&&p.capacities.forEach(function(e){return e(n)}));0!=i.length&&o.all(i).then(function(e){e.forEach(function(e){var t;(t=e)&&0<t.length&&p.rules.forEach(function(e){return e(t,window.__gantt.checkRulesAfterDelta)})})})},0)),-1<e.channel.indexOf("AbsencesTopic"))try{return void("deleted"==e.data.event.type?h:g).add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("ServicesTopic"))try{return void("deleted"==e.data.event.type?v.add(e.data.sobject):f.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("CapacitiesTopic"))try{return void("deleted"==e.data.event.type?S.add(e.data.sobject):y.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("LivePositionsTopic"))try{return void b.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("AssignedResourcesTopic"))try{return void _.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("OptReqTopic"))try{return void w.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("TimeDependencyTopic"))try{return void("deleted"==e.data.event.type?T.add(e.data.sobject.Id):(f.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment1]),f.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment2])))}catch(e){console.log("Streaming API failure : "+e)}},register:function(e,t){return p[e]&&p[e].push(t)},unRegister:function(e,t){p[e].splice(p[e].indexOf(t),1)}}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils"],angular.module("serviceExpert").factory("StreamingAPIService",e)}(),!function(){function e(e,n,t,i,s){var r=["ServicesTopic","AbsencesTopic","AssignedResourcesTopic","LivePositionsTopic","CapacitiesTopic","OptReqTopic","TimeDependencyTopic"];function o(){$.cometd.addListener("/meta/handshake",function(e){if(e.successful){console.log("Handshake successful!");try{for(var t=0;t<r.length;t++)$.cometd.getExtension(r[t])||!function(e){var t="/topic/"+e,n=new cometdReplayExtension;n.setChannel(t),n.setReplay(-1),$.cometd.registerExtension(e,n)}(r[t]),$.cometd.subscribe("/topic/"+r[t],n.HandleNotification)}catch(e){console.log(e)}i.setStreamingActiveState(!0)}else i.setStreamingActiveState(!1),console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful?i.setStreamingActiveState(!0):(console.warn("disconnected! error: "+e.error),i.setStreamingActiveState(!1))}),t.connectToPush()}return{initStreaming:function(){try{1==i.getStreamingActiveState()?o():t.connectToPush()}catch(e){console.log(e)}}}}e.$inject=["$q","StreamingAPIService","MstResolver","StateService","DeltaService"],angular.module("serviceExpert").factory("StreamingClientResolverService",e)}(),!function(){function e(c,T,L,A,C){var D={initialPhasedData:c.defer(),initialStmsPhasedData:c.defer()},I={},k={},R={},F={},M={},x={},O={},P={},E={},N={},G={},t={},B={},d=!1,u=!0,H=!0,U=!0;function i(t,n){var i=c.defer(),e=("LongView"!==scheduler._mode&&(t.setDate(t.getDate()-window.daysToLoadOnGanttInit),n.setDate(n.getDate()+window.daysToLoadOnGanttInit)),0===t.getMinutes()&&0===t.getHours()||(t.setHours(0),t.setMinutes(0)),0===n.getMinutes()&&0===n.getHours()||(n.setHours(0),n.setMinutes(0),n.setDate(n.getDate()+1)),"LongView"===scheduler._mode);if("LongView"!==scheduler._mode)for(var s=new Date(t);s<n;s.setDate(s.getDate()+1))if(!G[A.formatDayToString(s)]){e=!0;break}if(!e)return i.resolve(),i.promise;var r=c.defer(),o=c.defer(),a=[],l=c.defer();return u?L.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,n,window.bootstrap.loadedUserSettings.locations).then(function(e){e?(d=!0,$("#FirstTimeLoading").remove(),C.get("LeftSideLocationFilteringService").open()):l.resolve(),window.splunkLoggingFinestFlagEnabled&&L.callRemoteAction(RemoteActions.sendDataToSplunk,"rowsOnGantt",t,n,window.bootstrap.loadedUserSettings.locations,null,null)}):l.resolve(),l.promise.then(function(){V(o,t,n,!1,!1,null,null,null),V(r,t,n,!0,!1,null,null,null,a),V(o,t,n,!1,!0,null,null,null),u?u=!1:L.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,n,window.bootstrap.loadedUserSettings.locations).then(function(e){e&&A.addNotification(customLabels.MaxedRowsReachedOnGanttNotificationTitle,customLabels.MaxedRowsReachedOnGanttNotificationBody)})}),c.all([o.promise,r.promise]).then(function(e){0<Object.keys(a).length&&"Always"===window.__gantt.checkRulesMode&&T.$broadcast("timePhasedObjectsCheckRules",a),i.resolve(e)}),i.promise}function V(f,S,y,b,_,e,t,n,w){e=[S,y,b,_,e,t,n];"LongView"===scheduler._mode&&e.push(window.__currentViewOptions.minServiceDuration,window.__currentViewOptions.minNaDuration,window.__currentViewOptions.showMdt),L.GetTimePhasedObjects.apply(L,e).then(function(e){var t,n=f,i=b,s=_,r=S,o=y,a=w,l=C.get("monthlyViewHelperService"),c=C.get("GanttPalettesService"),d={resourcesAndTerritories:{},resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},resourcesAndShifts:{},serviceCrewMembers:{},operatingHoursAndHolidays:{},start:r,finish:o},u={};if("LongView"===scheduler._mode&&(i?(window.__gantt.reachedMaxNumberOfServicesInLongView=!!e.maxServicesInLongTermExceeded,window.splunkLoggingFinestFlagEnabled&&H&&(L.callRemoteAction(RemoteActions.sendDataToSplunk,"servicesInLongTermView",r,o,A.getFilteredLocations(),window.__currentViewOptions.minServiceDuration,window.__currentViewOptions.showMdt),H=!1)):s&&(window.__gantt.reachedMaxNumberOfAbsencesInLongView=!!e.maxAbsencesInLongTermExceeded,window.splunkLoggingFinestFlagEnabled&&U&&(L.callRemoteAction(RemoteActions.sendDataToSplunk,"absencesInLongTermView",r,o,A.getFilteredLocations(),window.__currentViewOptions.minNaDuration,null),U=!1)),updateViewDebounced()),"LongView"!==scheduler._mode)for(var p=new Date(r);p<o;p.setDate(p.getDate()+1))G[A.formatDayToString(p)]=!0;if(0===D.initialPhasedData.promise.$$state.status&&D.initialPhasedData.resolve(),e.resourcesAndTerritories.forEach(function(e){e=new ResourcesAndTerritories(e);I[e.serviceResource]=I[e.serviceResource]||{},I[e.serviceResource][e.id]=e,d.resourcesAndTerritories[e.serviceResource]=d.resourcesAndTerritories[e.serviceResource]||{},"S"!==(d.resourcesAndTerritories[e.serviceResource][e.id]=e).serviceTerritoryType&&(k[e.serviceResource]=k[e.serviceResource]||{},k[e.serviceResource][e.id]=e,d.resourcesByPrimariesAndRelocations[e.serviceResource]=d.resourcesByPrimariesAndRelocations[e.serviceResource]||{},d.resourcesByPrimariesAndRelocations[e.serviceResource][e.id]=e),"P"!==e.serviceTerritoryType&&(u[e.serviceResource]=u[e.serviceResource]||{},u[e.serviceResource][e.id]=e)}),0<Object.keys(u).length){var m,h,g={},v={};for(m in R)u[R[m].resource]&&0<Object.keys(u[R[m].resource]).length&&(g[m]=R[m]);for(h in F)u[F[h].resource]&&0<Object.keys(u[F[h].resource]).length&&(v[h]=F[h]);T.$broadcast("gotNewTimePhasedObjects",{start:r,finish:o,serviceAppointments:g,resourceAbsences:v})}e.shifts.forEach(function(e){var t=new Shift(e);x[e.ServiceResourceId]||(x[e.ServiceResourceId]={}),x[e.ServiceResourceId][A.formatDayToString(t.startTime)]||(x[e.ServiceResourceId][A.formatDayToString(t.startTime)]=[]),x[e.ServiceResourceId][A.formatDayToString(t.startTime)].push(t)}),e.holidays.forEach(function(e){var n=new Holiday(e);(e.OperatingHoursHolidays||[]).forEach(function(e){var t,e=e.OperatingHoursId;e&&(B[e]||(B[e]={}),t=A.formatDayToString(n.date),B[e][t]||(B[e][t]=[]),B[e][t].push(n))})}),e.services.forEach(function(e){var t=new GanttService(e);c.updateGanttServicePaletteColor(t),(!R[t.id]||R[t.id].isChanged(t)||R[t.id].isChainChanged(t)||R[t.id].isGotNewSTM(t))&&(R[e.Id]=t,d.serviceAppointments[e.Id]=t,a.push(t.id),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&l.updateMonthlyCapacity(t))}),e.resourceAbsences.forEach(function(e){F[e.Id]&&e.LastModifiedDate===F[e.Id].lastModifiedDate||(F[e.Id]=new ResourceAbsence(e),d.resourceAbsences[e.Id]=F[e.Id],l.updateMonthlyCapacity(F[e.Id]))}),e.resourceCapacities.forEach(function(e){M[e.Id]&&e.LastModifiedDate===M[e.Id].lastModifiedDate||(M[e.Id]=new ResourceCapacity(e),useLocationTimezone||z(M[e.Id]),d.resourceCapacities[e.Id]=M[e.Id])}),e.serviceCrewMembers.forEach(function(e){if(O[e.Id]=new ServiceCrewMember(e),P[O[e.Id].serviceResource]||(P[O[e.Id].serviceResource]={}),E[O[e.Id].serviceCrew]||(E[O[e.Id].serviceCrew]={}),E[O[e.Id].serviceCrew][e.Id]=O[e.Id],P[O[e.Id].serviceResource][e.Id]=O[e.Id],d.serviceCrewMembers[e.Id]=O[e.Id],T.crewViewActive){var t,n;for(n in N=T.currentCrewToShow)if(N[n].serviceCrew){t=N[n].serviceCrew;break}e.ServiceCrewId===t&&(N[e.ServiceResourceId]||(N[e.ServiceResourceId]=ResourcesAndTerritoriesService.getResources()[e.ServiceResourceId]),void 0===N[e.ServiceResourceId].members&&(N[e.ServiceResourceId].members={}),N[e.ServiceResourceId].members[e.Id]=O[e.Id])}}),T.$broadcast("gotNewTimePhasedObjects",d),i&&e.services.length===maxServicesToLoadEachBulkInGantt?(t=e.services[e.services.length-1].Id,V(n,r,o,i,s,t,null,null,a)):s&&e.resourceAbsences.length===maxAbsencesToLoadEachBulkInGantt?(t=e.resourceAbsences[e.resourceAbsences.length-1].Id,V(n,r,o,i,s,null,t,null)):!i&&!s&&e.shifts.length>=maxShiftsToLoadEachBulkInGantt?(t=e.shifts[e.shifts.length-1].Id,V(n,r,o,i,s,null,null,t)):!i&&!s&&e.shifts.length<maxShiftsToLoadEachBulkInGantt?T.$broadcast("gotNewTimePhasedSTMsAndShifts",d):n.resolve(),b||(window.setSplashScreenTabDone("loading-timephased"),D.initialStmsPhasedData.resolve())}).catch(function(e){0===D.initialPhasedData.promise.$$state.status&&D.initialPhasedData.reject(e),console.warn("GetTimePhasedObjects: something went wrong "+e.message),A.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),0===numberOfAllowedRecoveries?console.log("maximum allowed times to recover reached"):(numberOfAllowedRecoveries--,b?(maxServicesToLoadEachBulkInGantt=Math.round(maxServicesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxServicesToLoadEachBulkInGantt+" SERVICES","background: #222; color: #bada55")):_?(maxAbsencesToLoadEachBulkInGantt=Math.round(maxAbsencesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxAbsencesToLoadEachBulkInGantt+" ABSENCES","background: #222; color: #bada55")):b||(maxShiftsToLoadEachBulkInGantt=Math.round(maxShiftsToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxShiftsToLoadEachBulkInGantt+" SHIFTS","background: #222; color: #bada55")),i(S,y))})}function z(e){var t=A.getUserOffset(e.start_date),n=A.getUserOffset(e.end_date),i=s(e,e.resource);e.start_date=e.start_date.setMinutes(e.start_date.getMinutes()+t-i),e.end_date=e.end_date.setMinutes(e.end_date.getMinutes()+n-i)}function n(t,n){Object.keys(t).forEach(function(e){n&&e===n||delete t[e]})}function s(e,t){var n,i=I[t],s=null;for(n in i){var r=i[n];if(isIntersect(r.effectiveStartDate,r.effectiveEndDate,e.start_date,e.end_date)&&"R"===(s=r).serviceTerritoryType)break}t=s&&s.timezone?s.timezone:"GMT";return-moment.tz.zone(t).utcOffset(A.convertDtToMomentDt(e.start_date,t).valueOf())}return{resourcesAndTerritories:function(){return I},resourcesByPrimariesAndRelocations:function(){return k},serviceAppointments:function(){return R},resourceAbsences:function(){return F},resourceCapacities:function(){return M},resourceToServiceCrewMembers:function(){return P},resourcesAndShifts:function(){return x},crewToServiceCrewMembers:function(){return E},serviceCrewMembers:function(){return O},operatingHoursAndHolidays:function(){return B},getlongVistedDates:function(){return t},getGanttSectionsIdsByTerritory:function(e,t){var n,i={};for(n in I)for(var s in I[n]){s=I[n][s];e[s.serviceTerritory]&&s.effectiveStartDate<=t&&t<=s.effectiveEndDate&&(i[s.serviceTerritory]||(i[s.serviceTerritory]={tz:s.timezone,resources:{}}),i[s.serviceTerritory].resources[n]=!0)}return i},getRelevantSTMToGanttService:function(e){if(e.resourceId){var t,n=e.resourceId.split("_")[0],i=(e.resourceId.split("_")[1],I[n]);for(t in i){var s=i[t];if(isIntersect(s.effectiveStartDate,s.effectiveEndDate,e.start_date,e.end_date))return s}}return null},getTimePhasedObjects:i,updateTimePhaseData:function(e,n){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],s=C.get("monthlyViewHelperService"),r=C.get("GanttPalettesService"),o={absences:[],notApprovedAbsencesIds:[],services:[],capacities:[]};return(e=Array.isArray(e)?e:[e]).forEach(function(e){if("na"===n){if(i||F[e.Id]&&e.LastModifiedDate===F[e.Id].lastModifiedDate)return;var t=new ResourceAbsence(e);window.isApprovedAbsencesSupported&&!t.approved&&"break"!==t.type?(F[e.Id]&&(F[e.Id].isDeleted=!0,s.updateMonthlyCapacity(F[e.Id]),delete F[e.Id]),o.notApprovedAbsencesIds.push(e.Id)):(F[e.Id]=t,o.absences.push(F[e.Id]),s.updateMonthlyCapacity(F[e.Id]))}if("service"===n&&(t=new GanttService(e),r.updateGanttServicePaletteColor(t),(i||!R[t.id]||R[t.id].isChanged(t)||R[t.id].isChainChanged(t))&&(R[e.Id]=t,o.services.push(t),scheduler._events[t.id]&&scheduler._events[t.id].violations&&t.isScheduled()&&(t.violations=scheduler._events[t.id].violations),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&s.updateMonthlyCapacity(t))),"capacity"===n){if(M[e.Id]&&e.LastModifiedDate===M[e.Id].lastModifiedDate)return;M[e.Id]=new ResourceCapacity(e),useLocationTimezone||z(M[e.Id]),o.capacities.push(M[e.Id])}"stm"===n&&(t=new ResourcesAndTerritories(e),I[t.serviceResource]=I[t.serviceResource]||{},"S"!==(I[t.serviceResource][t.id]=t).serviceTerritoryType&&(k[t.serviceResource]=k[t.serviceResource]||{},k[t.serviceResource][t.id]=t))}),T.$broadcast("updateTimePhaseData",o.services),o},deleteTimePhaseData:function(e,t){var n=C.get("monthlyViewHelperService"),i={absences:[],services:[],capacities:[]};return(e=Array.isArray(e)?e:[e]).forEach(function(e){"na"===t?(F[e.Id]&&(F[e.Id].isDeleted=!0),F[e.Id]&&n.updateMonthlyCapacity(F[e.Id]),delete F[e.Id],i.absences.push(e.Id)):"service"===t?(R[e.Id]&&(R[e.Id].isDeleted=!0),n.updateMonthlyCapacity(R[e.Id]),delete R[e.Id],i.services.push(e.Id)):"capacity"===t&&(delete M[e.Id],i.capacities.push(e.Id))}),T.$broadcast("deleteTimePhaseData",i.services),i},reset:function(e){n(I),n(k),n(R,e),n(F),n(M),n(O),n(x),n(N),n(P),n(E),n(G),n(t),n(B)},getResoruceGanttIdByDate:function(e,t){for(var n in I[e]){n=I[e][n];if(n.effectiveStartDate<=t&&t<=n.effectiveEndDate&&"R"===n.serviceTerritoryType)return A.generateResourceId(e,n.serviceTerritory)}var i,s=[];for(i in I[e]){var r=I[e][i];if(!showSecondarySTMs&&r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&"P"===r.serviceTerritoryType)return A.generateResourceId(e,r.serviceTerritory);r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&s.push(r.serviceTerritory)}return 0<s.length?A.generateResourceId(e,s):null},getResoruceGanttIdByDateAndTerritory:function(e,t,n){for(var i in I[e]){i=I[e][i];if(i.effectiveStartDate<=t&&t<=i.effectiveEndDate&&"R"===i.serviceTerritoryType)return A.generateResourceId(e,i.serviceTerritory)}var s,r=null,o=null;for(s in I[e]){var a=I[e][s];a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&"P"===a.serviceTerritoryType&&(o=a.serviceTerritory),a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&a.serviceTerritory===n&&(r=a.serviceTerritory)}return r?A.generateResourceId(e,r):A.generateResourceId(e,o)},getIntersectingSrstOffset:s,isTimephaseAvailable:function(e,t){var n,i=!1;for(n in I[e]){var s=I[e][n];isIntersect(t,t,s.effectiveStartDate,s.effectiveEndDate)&&(i=!0)}return i},isResourceRelocated:function(e,t){var n,i=e.split("_")[0],s=e.split("_")[1],r=I[i]||{};for(n in r){var o=r[n];if(o.serviceTerritory!==s&&"R"===o.serviceTerritoryType&&isIntersect(o.effectiveStartDate,o.effectiveEndDate,t,t))return!0}return!1},isResourceSecondary:function(e,t){var n,i=e.split("_")[0],s=e.split("_")[1],r=I[i]||{};for(n in r){var o=r[n];if(o.serviceTerritory===s&&"S"===o.serviceTerritoryType&&isIntersect(o.effectiveStartDate,o.effectiveEndDate,t,t))return!0}return!1},isResourceCrewMembers:function(e,t){var n,i=e.split("_")[0],s=(e.split("_")[1],P[i]||{});for(n in s){var r=s[n];if(isIntersect(r.startDate,r.endDate,t,t))return!0}return!1},isCrewViewActive:!1,currentCrewToShow:N,reachedMaxRows:function(){return d},resetReachedMaxRows:function(e){return d=!1},promises:{initialPhasedData:D.initialPhasedData.promise,initialStmsPhasedData:D.initialStmsPhasedData.promise}}}e.$inject=["$q","$rootScope","sfdcService","utils","$injector","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("TimePhasedDataService",e)}(),!function(){function e(m,h,g){var v={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};return{calculateKpis:function(){var e,t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),n=0;for(e in v)v[e]=0;for(var i=g.GetUserSettingsProperty("locations"),s=0;s<t.length;s++){var r,o,a=t[s],l=!0;if(showSecondarySTMs&&-1<t[s].resourceId.indexOf(",")){for(var c=t[s].resourceId.split(","),d=null,u=0;u<c.length;u++){var p=c[u].split("_")[1];if(-1<i.indexOf(p)){d=p;break}}if(!d)continue}else if(-1===i.indexOf(t[s].resourceId.split("_")[1]))continue;"na"===a.type&&(v.avgTravelTime+=a.travelTo+a.travelFrom),"service"===a.type&&(m.areContractorsSupported()&&a.resourceContractor?l=!1:n++,v.total++,a.statusCategory===h.COMPLETED&&v.completed++,a.violations&&v.violations++,a.jeopardy&&v.jeopardy++,l&&(a.isMDT?(r=0,a.mdtTimes.travel.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(r+=e.Finish-e.Start)}),v.avgTravelTime+=r/1e3):v.avgTravelTime+=a.travelTo+a.travelFrom),a.isMDT?(o=0,a.mdtTimes.working.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(o+=e.Finish-e.Start)}),v.totalScheduledDuration+=o/1e3):v.totalScheduledDuration+=(a.finish-a.start)/1e3)}0<t.length&&0<v.total&&0<n?m.areContractorsSupported()?v.avgTravelTime=Math.floor(v.avgTravelTime/60/n):v.avgTravelTime=Math.floor(v.avgTravelTime/60/v.total):v.avgTravelTime=0},kpis:v}}e.$inject=["StateService","SERVICE_CATEGORY","userSettingsManager"],angular.module("serviceExpert").factory("kpiCalculationsService",e)}(),!function(){function e(u,n,t,i,l,s,a,e,r){var p={regular:0,overtime:0},m={},h={},g={services:!0,na:!0,travel:!0,breaks:!0,overtime:!0},c=r.isRtlDirection();if(e.GetUserSettingsProperty("Utilization_Properties__c")){var o,d=JSON.parse(e.GetUserSettingsProperty("Utilization_Properties__c"));for(o in d)g[o]=d[o]}function v(e){if(-1<e.resourceId.indexOf(","))for(var t=e.resourceId.split(","),n=0;n<t.length;n++)m[t[n]]=m[t[n]]||{};else m[e.resourceId]=m[e.resourceId]||{};var i={start:new Date(e.start_date),finish:new Date(e.start)},s={start:new Date(e.start),finish:new Date(e.finish)},r={start:new Date(e.finish),finish:new Date(e.end_date)};return{travelBeforeSum:e.isMDT?f(e.mdtTimes.travel):f(i.start,i.finish),scheduledObjectSum:e.isMDT?f(e.mdtTimes.working):f(s.start,s.finish),travelAfterSum:e.isMDT?{}:f(r.start,r.finish)}}function f(e,i){var s={};if(!i)return e.forEach(function(e){i=new Date(e.Finish);for(var t=new Date(e.Start);t<i;t=y(t)){var n=y(t),n=i<n?i:n;s[S(t)]?s[S(t)]+=Math.round((n.getTime()-t.getTime())/1e3/60):s[S(t)]=Math.round((n.getTime()-t.getTime())/1e3/60)}}),s;for(var t=new Date(e);t<i;t=y(t)){var n=y(t),n=i<n?i:n;s[S(t)]=Math.round((n.getTime()-t.getTime())/1e3/60)}return s}function S(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function y(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,0,0)}function b(e,t,n,i,s){for(var r,o=!(4<arguments.length&&void 0!==s)||s,a=t.split(","),l=0;l<a.length;l++)for(var c in t=a[l],n)m[t]=m[t]||{},void 0===m[t][c]&&(m[t][c]=new w),o?(m[t][c][i]+=n[c],-1===m[t][c].events.indexOf(e)&&m[t][c].events.push(e)):(m[t][c][i]-=n[c],-1<(r=m[t][c].events.indexOf(e))&&m[t][c].events.splice(r,1))}function w(){this.break=0,this.na=0,this.service=0,this.travel=0,this.capacity=-1,this.overtime=0,this.events=[]}function T(e,t){for(var n=new w,i=S(t),s=n.capacity=0;s<e.length;s++){var r,o=null,a=e[s].key;contractorSupport&&e[s].contractor||l.isResourceRelocated(a,t)||l.isResourceCrewMembers(a,t)||l.isResourceSecondary(a,t)||(m[a]||(m[a]={}),(o=m[a][i]?m[a][i]:o)||(m[a][i]=new w,o=m[a][i]),o.capacity,r=p,u.resourceToWorkingDates[a]&&u.resourceToWorkingDates[a][i]&&(r=u.resourceToWorkingDates[a][i]),o&&(n.break+=o.break,n.na+=o.na>r.regular?r.regular:o.na,n.service+=o.service,n.travel+=o.travel,n.capacity+=-1<r.regular?r.regular:0,n.overtime+=r.overtime))}return n}function L(e){var t=e%60;return{hours:Math.floor(e/60),minutes:t=t<10?"0"+t:t}}function A(e){return e.hours+"h "+e.minutes+"m"}function C(e,t,n){var i,n=2<arguments.length&&void 0!==n?n:p;e.service&&(i=L(e.service),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalScheduled+"</div>\n                    </div>"),e.travel&&(i=L(e.travel),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalTravel+"</div>\n                    </div>"),e.na&&(i=L(e.na),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.na+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalNAs+"</div>\n                    </div>"),e.break&&(i=L(e.break),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.coffee+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalBreaks+"</div>\n                    </div>"),e.capacity,e.overtime;return n.regular&&(i=L(n.regular),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.bucket+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalCapacity+"</div>\n                    </div>"),n.overtime&&(e=L(n.overtime),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_overtime_icon"><use xlink:href="'+lsdIcons.overtime+'"></use></svg>\n                        '+A(e)+"\n                        <div>"+customLabels.TotalOvertime+"</div>\n                    </div>"),t}return scheduler.attachEvent("onSchedulerReady",function(){scheduler.attachEvent("onXScaleClick",function(e,t,n){"MonthlyView"===scheduler._mode&&scheduler.setCurrentView(t,"ZoomLevel3")}),scheduler.templates.MonthlyView_scalex_class=function(e){return"monthlyXScale"},scheduler.templates.MonthlyView_cell_value=function(e,t){var n=t.key;if(!contractorSupport||!t.contractor){if(t.children)return l=T(t.children,e),h[t.key]||(h[t.key]={}),l=h[t.key][S(e)]=l,i=t.key,s=t.name,o=S(e),a=0,g.services&&(a+=l.service),g.breaks&&(a+=l.break),g.na&&(a+=l.na),g.travel&&(a+=l.travel),0<(c=g.overtime?l.capacity+l.overtime:l.capacity)?(a=a/c,a=Math.round(100*a),d="",d=a<=monthlyViewSettings.high?"style='box-shadow: inset 0 -2px 0 rgb(24, 165, 146)'":a>monthlyViewSettings.high&&a<=monthlyViewSettings.critical?"style='box-shadow: inset 0 -2px 0 #FFEB3B'":"style='box-shadow: inset 0 -2px 0 rgb(236, 95, 84)'",r="",l.travel/c>monthlyViewSettings.highTravel/100&&(r='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),"<div "+d+' onmouseout="removeMonthlyLocationTooltip()" onmouseover="createLocationMonthlyTooltip(event,\''+i+"', '"+s.encodeHTML()+"', '"+o+"')\">"+r+'<div class="monthlyViewHoursContainer">'+a+"%</div></div>"):"";if(m[n]&&m[t.key][S(e)]){var i,s,r,o,a,l=0,c=m[n][S(e)],d=p;if(u.resourceToWorkingDates[n]&&(d=u.resourceToWorkingDates[n][S(e)]||p),g.services&&(l+=c.service),g.breaks&&(l+=c.break),g.na&&(i=c.na,l+=i=c.na>d.regular?d.regular:i),g.travel&&(l+=c.travel),0===l);else return s=void 0,o=void 0,r=g.overtime?d.regular+d.overtime:d.regular,0<r?(o=Math.round(100*(o=l/r)),a="",c.travel/r>monthlyViewSettings.highTravel/100&&(a='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),s="",s=o<=monthlyViewSettings.high?"rgba(125, 195, 125, "+o/100+")":o>monthlyViewSettings.high&&o<=monthlyViewSettings.critical?"rgba(242, 207, 91, "+(.11+o/100*.65)+")":"rgba(239, 110, 100, "+(.11+o/100*.65)+")",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+n+"', '"+S(e)+'\')" style="background: '+s+'">'+a+'<div class="monthlyViewHoursContainer">'+o+"%</div></div>"):(s="rgba(239, 110, 100, 1)",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+n+"', '"+S(e)+'\')" style="background: '+s+'"><div class="monthlyViewHoursContainer"><i class="fa fa-ban"></i></div></div>')}}}}),window.createLocationMonthlyTooltip=function(e,t,n,i){$("#MonthlyLocationViewTooltip").remove(),$("#MonthlyViewTooltip").remove();var t=h[t][i],t=C(t,"",{regular:t.capacity,overtime:t.overtime}),i=i.split("_"),i=new Date(i[2],i[1],i[0],0,0,0,0),s=(i=moment(i).format("ll"),window.innerHeight),r=window.innerWidth,r=e.clientX+340<=r?e.clientX:e.clientX-340,n=($('<div id="MonthlyLocationViewTooltip">\n                    <h1>'+_.escape(n)+" - "+_.escape(i)+'</h1>\n                    <div id="CapacityIconsContainer">'+t+"</div>\n               </div>").css("left",r+"px").css("top",e.clientY+5+"px").appendTo("body"),$("#MonthlyViewTooltip")),i=n.height();i+e.clientY>s&&n.css("top",e.clientY-i-20+"px"),c&&$("#MonthlyLocationViewTooltip").addClass("rtlDirection")},window.removeMonthlyLocationTooltip=function(){$("#MonthlyLocationViewTooltip").remove()},window.createMonthlyTooltip=function(e,t,n){e.stopPropagation(),$("#MonthlyViewTooltip").remove(),$("#MonthlyLocationViewTooltip").remove();var i=a.getResources()[t.split("_")[0]].name,s=m[t][n],r=p,r=(t=C(s,"",r=u.resourceToWorkingDates[t]&&u.resourceToWorkingDates[t][n]?u.resourceToWorkingDates[t][n]:r),s.events.sort(function(e,t){return scheduler._events[e].start_date.getTime()>scheduler._events[t].start_date.getTime()?-1:scheduler._events[e].start_date.getTime()<scheduler._events[t].start_date.getTime()?1:0}).map(function(e){var t="",n="",i=(scheduler._events[e]&&"service"===scheduler._events[e].type?(t="__monthlyViewFunctions.service('"+e+"')",n="<div onclick=\"__monthlyViewFunctions.flag(event, '"+e+'\')" class="monthlyViewFlag truncate">'+(flaggedServices[e]?customLabels.Unflag:customLabels.Flag)+"</div>"):t="__monthlyViewFunctions.absence('"+e+"')"," "),s=(i=(i+=scheduler._events[e]&&scheduler._events[e].jeopardy?"monthlyView_JeopardyTooltip":"")+(scheduler._events[e]&&scheduler._events[e].violations&&!scheduler._events[e].jeopardy?"monthlyView_ViolationsTooltip":""),""),r=(scheduler._events[e]&&"break"!==scheduler._events[e].type&&(s=""+A(L(s=Math.floor((scheduler._events[e].travelTo+scheduler._events[e].travelFrom)/60))),s='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg> '+s),Math.floor((scheduler._events[e].finish-scheduler._events[e].start)/1e3/60)),r=""+A(L(r)),o=(r='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg> '+r,""===s?"mytooltip_breakfix":"");return'\n                        <div class="'+i+' monthlyView_TooltipEventRow" title="'+(i=scheduler._events[e],customLabels.Start+": "+moment(i.start).format("llll")+"\n"+customLabels.Finish+": "+moment(i.finish).format("llll"))+'">\n                            <div class="monthlyView_EventName" onclick="'+t+'">'+scheduler._events[e].name+'</div>\n                            <div class="monthlyView_EventDate"><span class="mytooltip_duration '+o+'">'+r+'</span><span class="mytooltip_travel">'+s+"</span>"+n+"</div>\n                        </div>"})),s=n.split("_"),s=new Date(s[2],s[1],s[0],0,0,0,0),n=(s=moment(s).format("ll"),window.innerHeight),o=window.innerWidth,o=e.clientX+340<=o?e.clientX:e.clientX-340,i=($('<div id="MonthlyViewTooltip">\n                    <h1>\n                        '+_.escape(i)+" - "+s+'\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.close+'"></use></svg>\n                    </h1>\n                    <div id="CapacityIconsContainer">'+t+'</div>\n                    <div id="MonthlyTooltipListContainer">'+r.join("")+"</div>\n               </div>").css("left",o+"px").css("top",e.clientY+5+"px").appendTo("body"),$("#MonthlyViewTooltip")),s=i.height();s+e.clientY>n&&i.css("top",e.clientY-s-20+"px"),c&&$("#MonthlyViewTooltip").addClass("rtlDirection")},$("body").on("click",function(){$("#MonthlyViewTooltip").remove()}),window.__monthlyViewFunctions={service:function(e){i.open(e)},absence:function(e){t.open(e)},flag:function(e,t){e.currentTarget.innerHTML=e.currentTarget.innerHTML===customLabels.Flag?customLabels.Unflag:customLabels.Flag,e.stopPropagation(),n.$broadcast("flagService",t),n.$apply()}},{updateMonthlyCapacity:function(e){var t,n,i;e&&(e.setGanttResource(l.resourcesAndTerritories(),s.generateResourceId),i=scheduler._events[e.id],t=null,!e.resourceId&&!i||e.isMDT&&!e.mdtTimes||(i&&(n=v(i.eventBeforeDrag||i),i.eventBeforeDrag&&(i.eventBeforeDrag=null),"service"===e.type||"na"===e.type?(t=i.resourceName===e.resourceName?e.resourceId:i.resourceBeforeDrag||i.resourceId,i.resourceBeforeDrag=null):"break"===e.type&&(t=i.resourceId),b(i.id,t,n.travelBeforeSum,"travel",!1),b(i.id,t,n.scheduledObjectSum,i.type,!1),b(i.id,t,n.travelAfterSum,"travel",!1)),!e.resourceId||e.isDeleted||e.locationRemovedMe?e.locationRemovedMe&&(e.locationRemovedMe=!1):(i=v(e),b(e.id,e.resourceId,i.travelBeforeSum,"travel"),b(e.id,e.resourceId,i.scheduledObjectSum,e.type),b(e.id,e.resourceId,i.travelAfterSum,"travel"))))},capacityCalculationFields:g,workingTimesByLocation:h,calculateLocation:T,calculateLocationUtilization:function(e){var t=0;return g.services&&(t+=e.service),g.breaks&&(t+=e.break),g.na&&(t+=e.na),g.travel&&(t+=e.travel),0<(e=g.overtime?e.capacity+e.overtime:e.capacity)?(t=t/e,Math.round(100*t)):null},calculateDailyResourceCapacity:function(e,t){var n=new w,i=null,s=S(t),r=e.key;return n.capacity=0,contractorSupport&&e.contractor||l.isResourceRelocated(r,t)||l.isResourceCrewMembers(r,t)||l.isResourceSecondary(r,t)||(m[r]||(m[r]={}),(i=m[r][s]?m[r][s]:i)||(m[r][s]=new w,i=m[r][s]),e=p,u.resourceToWorkingDates[r]&&u.resourceToWorkingDates[r][s]&&(e=u.resourceToWorkingDates[r][s]),i&&(n.break+=i.break,n.na+=i.na>e.regular?e.regular:i.na,n.service+=i.service,n.travel+=i.travel,n.capacity+=-1<e.regular?e.regular:0,n.overtime+=e.overtime)),n},reset:function(){m={},h={}}}}e.$inject=["calendarsService","$rootScope","AbsenceLightboxService","ServiceAppointmentLightboxService","TimePhasedDataService","utils","ResourcesAndTerritoriesService","userSettingsManager","StateService"],angular.module("serviceExpert").factory("monthlyViewHelperService",e)}(),!function(){var c=7500;angular.module("MstResolver",[]).provider("MstResolver",function(){var l={fslOperationRemoteAction:null,getAsyncApexJobRemoteAction:null,apiVersion:"41.0",fieldNames:{Initiator:"Initiator__c",Request_Type:"Request_Type__c",ResultText:"ResultText__c"},autoConnect:!0};this.setConfig=function(e){return l=e},this.$get=function(e){var t=e,r=l,o={},n={},i=-1;function s(){$.cometd.addListener("/meta/handshake",function(e){var t;e.successful?(console.log("Handshake successful!"),null==$.cometd.getExtension("myReplayExtensionName")&&((t=new cometdReplayExtension).setChannel("/topic/MstCompletedChannel"),t.setReplay(i),$.cometd.registerExtension("myReplayExtensionName",t)),$.cometd.subscribe("/topic/MstCompletedChannel",a)):console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful||console.warn("disconnected! msg: "+e)});$.cometd.init({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/"+r.apiVersion+"/",requestHeaders:{Authorization:"OAuth "+sessionId}})}function a(e){var t;"deleted"!==e.data.event.type&&(console.info("message from stream, type: "+e.data.event.type+", replayId: "+e.data.event.replayId+", fslOp: "+e.data.sobject.Id),i=e.data.event.replayId,n[e.data.sobject.Id]=e,(t=o[e.data.sobject.Id])&&t.deferred.resolve(e))}try{r.autoConnect&&s()}catch(e){console.log(e)}return{getUpdates:function(e){o[e]={time:(new Date).getTime()-3e3,deferred:t.defer(),mstPromise:t.defer(),asyncMethodCheckerTimeout:null,gotReply:!1};var s=o[e];return o[e].deferred.promise.then(function(e){r.fslOperationRemoteAction&&Visualforce.remoting.Manager.invokeAction(r.fslOperationRemoteAction,s.time,e.data.sobject.Id,function(e,t){if(t.status&&!e.fslOperation.fslOperation[r.fieldNames.ResultText]){if(e.fslOperation.result&&(e.fslOperation.result=JSON.parse(e.fslOperation.result)),"Get Candidates"===e.fslOperation.fslOperation[r.fieldNames.Request_Type]){var n,i=e.fslOperation.result.ResourceIDToScheduleData;for(n in i)i[n].SchedulingOptions.forEach(function(e){for(var t in e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf(),e.MSTOptions)e.MSTOptions[t].Interval.Start=moment(e.MSTOptions[t].Interval.Start).valueOf(),e.MSTOptions[t].Interval.Finish=moment(e.MSTOptions[t].Interval.Finish).valueOf()})}"Appointment Booking"===e.fslOperation.fslOperation[r.fieldNames.Request_Type]&&e.fslOperation.result.Slots.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf()}),s.mstPromise.resolve(e)}else e&&e.fslOperation&&e.fslOperation.fslOperation?s.mstPromise.reject(e.fslOperation.fslOperation[r.fieldNames.ResultText]):s.mstPromise.reject(t);s.gotReply=!0},{buffer:!1,escape:!1,timeout:12e4})}),n[e]&&(s.deferred.resolve(n[e]),delete n[e]),o[e].asyncMethodCheckerTimeout=setInterval(function(){var n,i;i=o[n=e],Visualforce.remoting.Manager.invokeAction(r.getAsyncApexJobRemoteAction,n,function(e,t){if(!e)return clearInterval(i.asyncMethodCheckerTimeout),void(t.status||(t.xhr&&"communication failure"===t.xhr.statusText?i.mstPromise.reject({message:t.message}):i.mstPromise.reject({message:customLabels.wentWrongContactSysAdmin}),console.log(t)));"Aborted"!==e.Status&&"Failed"!==e.Status||(i.gotReply||i.mstPromise.reject({message:e.ExtendedStatus}),clearInterval(i.asyncMethodCheckerTimeout)),"Completed"===e.Status&&(i.deferred.resolve({data:{sobject:{Id:n}}}),clearInterval(i.asyncMethodCheckerTimeout))})},c),o[e].mstPromise.promise},connectToPush:s,handleCometdConnection:a}},this.$get.$inject=["$q"]})}(),GanttService.prototype.setSchedulerProperties=function(){var e,t={schedStartTime:"start",schedEndTime:"finish",dueDate:"dueDate",earliestStartTime:"earlyStart",arrivalWindowStartTime:"appStart",arrivalWindowEndTime:"appEnd",actualStartTime:"actualStartTime",actualEndTime:"actualEndTime",ganttDisplay:"ganttDisplay"};for(e in t)this[t[e]]=__setTimeZoneOffsetToDateField(this[e]);this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null,this.text=this.ganttLabel?this.ganttLabel.encodeHTML():this.name},GanttService.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var n,i=e[this.resource],s=[];for(n in this.resourceId=null,this.start_date=__setTimeZoneOffsetToDateField(this.schedStartTime),this.end_date=__setTimeZoneOffsetToDateField(this.schedEndTime),i){var r=i[n];"R"===r.serviceTerritoryType&&(isIntersectIncludeLimits(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}if(0===s.length)for(var o in i){o=i[o];isIntersectIncludeLimits(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.start_date)&&s.push(o.serviceTerritory)}else if(showSecondarySTMs)for(var a in i){a=i[a];"S"===a.serviceTerritoryType&&isIntersectIncludeLimits(a.effectiveStartDate,a.effectiveEndDate,this.start_date,this.end_date)&&s.push(a.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttService.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60))))},GanttService.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttService.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId&&this.resourceId.substr(0,18)},GanttService.prototype.getGanttTerritory=function(){return this.resourceId&&this.resourceId.substr(19,37)},GanttService.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttService.prototype.isGotNewSTM=function(e){return""===this.resourceId&&e.resource},GanttService.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttService.prototype.minPriority=1e6,GanttService.copy=function(e){var t=new GanttService(null,!0);return angular.merge(t,e),t},GanttService.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var i=1e3*(new Date).getTimezoneOffset()*60,s={travel:[],working:[]};this.mdtTimes.forEach(function(e){var t=moment.tz(e.Start,userTimeZone),n=moment.tz(e.Finish,userTimeZone),t=new Date(t.valueOf()+60*t._offset*1e3+i),n=new Date(n.valueOf()+60*n._offset*1e3+i);e.Start=t,e.Finish=n,"OperationalSlot"===e.Type?s.working.push(e):"Travel"===e.Type&&s.travel.push(e)}),this.mdtTimes=s}catch(e){this.mdtTimes={travel:[],working:[]}}},window.Holiday=function(e){this.id=e.Id,this.holidayId=e.Id,this.name=e[fieldNames.Holiday.Name],this.description=e[fieldNames.Holiday.Description],this.activityDate=e[fieldNames.Holiday.ActivityDate],this.nextOccurrenceDate=e[fieldNames.Holiday.NextOccurrenceDate],this.isAllDay=e[fieldNames.Holiday.IsAllDay],this.isRecurrence=e[fieldNames.Holiday.IsRecurrence],this.startTimeInMinutes=e[fieldNames.Holiday.StartTimeInMinutes],this.endTimeInMinutes=e[fieldNames.Holiday.EndTimeInMinutes],this.recurrenceType=e[fieldNames.Holiday.RecurrenceType],this.recurrenceInterval=e[fieldNames.Holiday.RecurrenceInterval],this.recurrenceStartDate=e[fieldNames.Holiday.RecurrenceStartDate],this.recurrenceEndDateOnly=e[fieldNames.Holiday.RecurrenceEndDateOnly],this.recurrenceDayOfMonth=e[fieldNames.Holiday.RecurrenceDayOfMonth],this.recurrenceDayOfWeekMask=e[fieldNames.Holiday.RecurrenceDayOfWeekMask],this.recurrenceMonthOfYear=e[fieldNames.Holiday.RecurrenceMonthOfYear],this.isRecurrence?this.date=new Date(this.nextOccurrenceDate):(e=60*(new Date).getTimezoneOffset()*1e3,this.date=new Date(this.activityDate+e))},!function(e){var o={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};e.TimeSlot=function(e){this.startHour=Math.floor(e[fieldNames.TimeSlot.StartTime]/1e3/60/60),this.startMinute=Math.ceil(e[fieldNames.TimeSlot.StartTime]/1e3/60/60%1*60),this.endHour=Math.floor(e[fieldNames.TimeSlot.EndTime]/1e3/60/60),this.endMinute=Math.ceil(e[fieldNames.TimeSlot.EndTime]/1e3/60/60%1*60),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.OperatingHours=function(e){this.id=e.Id,this.name=e.Name,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};for(var t=(t=e[fieldNames.OperatingHours.Time_Slots__r])||[],n=0;n<t.length;n++){var i=t[n],s=i[fieldNames.TimeSlot.DayOfWeek],r=this.slots[s=o[s]];r||(this.slots[s]=r=[]),r.push(new TimeSlot(i))}}}(window),ResourceAbsence.prototype.setSchedulerProperties=function(){this.start=__setTimeZoneOffsetToDateField(this.start),this.finish=__setTimeZoneOffsetToDateField(this.end),this.end=__setTimeZoneOffsetToDateField(this.end)},ResourceAbsence.prototype.setGanttResource=function(e,t){var n=e[this.resource],i=[];if(this.resourceId=null,this.isScheduled()){this.start_date=this.start?new Date(this.start.getTime()):null,this.end_date=this.finish?new Date(this.finish.getTime()):null;var s,r=!1;for(s in n){var o=n[s],r=!1;"R"===o.serviceTerritoryType&&(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&((this.end_date>o.effectiveEndDate&&this.start_date<o.effectiveEndDate||this.start_date<o.effectiveStartDate&&this.end_date>o.effectiveStartDate)&&(r=!0),i.includes(o.serviceTerritory)||i.push(o.serviceTerritory))}if(0===i.length||r)for(var a in n){a=n[a];!(isIntersect(a.effectiveStartDate,a.effectiveEndDate,this.start_date,this.end_date)||!a.effectiveEndDate&&a.effectiveStartDate<this.end_date)||i.includes(a.serviceTerritory)||i.push(a.serviceTerritory)}else if(showSecondarySTMs)for(var l in n){l=n[l];"S"!==l.serviceTerritoryType||!(isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.end_date)||!l.effectiveEndDate&&l.effectiveStartDate<this.end_date)||i.includes(l.serviceTerritory)||i.push(l.serviceTerritory)}this.resourceId=t(this.resource,i),this.isScheduled()&&this.updateDatesBasedOnTravel()}},ResourceAbsence.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60))))},ResourceAbsence.prototype.isScheduled=function(){return!!this.resource},ResourceAbsence.prototype.getGanttResource=function(){return this.resourceId&&this.resourceId.substr(0,18)},ResourceCapacity.prototype.setSchedulerProperties=function(){switch(this.start_date=__setTimeZoneOffsetToDateField(this.start),this.end_date=__setTimeZoneOffsetToDateField(this.end),this.timePeriod){case"Day":this.end_date=addDaysToDate(this.start_date,1);break;case"Week":this.end_date=addDaysToDate(this.start_date,7);break;case"Month":this.end_date=addDaysToDate(this.end_date,1)}0<this.hoursPerTimePeriod?this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.hoursInUse,this.hoursPerTimePeriod)+"%")+"</b> (<b>"+customLabels.x_Hours_scheduled_out_of_y.replaceAll(this.hoursInUse,this.hoursPerTimePeriod)+"</b>)":0<this.workItemsPerTimePeriod&&(this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.workItemsAllocated,this.workItemsPerTimePeriod)+"%")+"</b> (<b>"+customLabels.NumServicesScheduled.replaceAll(this.workItemsAllocated,this.workItemsPerTimePeriod)+"</b>)"),this.type="contractorcapacity"},ResourceCapacity.prototype.setGanttResource=function(e,t){var n,i=e[this.resource],s=[];for(n in i){var r=i[n];(isIntersect(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}this.resourceId=t(this.resource,s)},ResourceCapacity.prototype.isScheduled=function(){return!!this.resource},ResourceCapacity.prototype.getGanttResource=function(){return this.resourceId&&this.resourceId.substr(0,18)},!function(e){e.Shift=function(e){this.id=e.Id,this.name=e[fieldNames.Shift.ShiftNumber],this.label=e[fieldNames.Shift.Label]||"",this.serviceResourceId=e[fieldNames.Shift.ServiceResourceId]||null,this.serviceTerritoryId=e[fieldNames.Shift.ServiceTerritoryId]||null,this.status=e[fieldNames.Shift.Status],this.statusCategory=e[fieldNames.Shift.StatusCategory],this.timeSlotType=e[fieldNames.Shift.TimeSlotType],this.startTime=e[fieldNames.Shift.StartTime],this.endTime=e[fieldNames.Shift.EndTime],this.backgroundColor=e[fieldNames.Shift.BackgroundColor],isHolidayEnabled&&(this.isHolidayShift=e.IsHolidayShift);var e=void 0,t=void 0;this.startTime&&(e=60*new Date(this.startTime).getTimezoneOffset()*1e3),this.endTime&&(t=60*new Date(this.endTime).getTimezoneOffset()*1e3),this.startTime=new Date(this.startTime+e),this.endTime=new Date(this.endTime+t)},e.ShiftSlot=function(e){this.startTime=e.startTime,this.endTime=e.endTime,this.type=e.timeSlotType}}(window);var bootstrap={};function setSplashScreenTabDone(e){var t;setSplashScreenTabDone.doneElements[e]||(t=$("#"+e))&&(t.addClass("loading-task-done"),setSplashScreenTabDone.doneElements[e]=!0)}function handleTabSettingAndRecordTypesPermissions(l){return new Promise(function(e,t){var n=JSON.parse(l.Admin.replace(/&quot;/g,'"')),i=JSON.parse(l.Agent.replace(/&quot;/g,'"')),s=JSON.parse(l.Community.replace(/&quot;/g,'"')),r=JSON.parse(l.CommunityDispatcher.replace(/&quot;/g,'"')),o=JSON.parse(l.Dispatcher.replace(/&quot;/g,'"')),a=JSON.parse(l.Resource.replace(/&quot;/g,'"'));Promise.all([createTabAndRecordTypePermission("FSL_Admin","Field Service Admin",n.tabSettings,n.recordTypeVisibilities,n.apexClasses),createTabAndRecordTypePermission("FSL_Agent","Field Service Agent",i.tabSettings,i.recordTypeVisibilities,i.apexClasses),createTabAndRecordTypePermission("FSL_Dispatcher","Field Service Dispatcher",o.tabSettings,o.recordTypeVisibilities,o.apexClasses),createTabAndRecordTypePermission("FSL_Community_Self_Service","Field Service Self Service",s.tabSettings,s.recordTypeVisibilities,s.apexClasses),createTabAndRecordTypePermission("FSL_Community_Dispatcher","Field Service Community Dispatcher",r.tabSettings,r.recordTypeVisibilities,r.apexClasses),createTabAndRecordTypePermission("FSL_Resource","Field Service Resource",a.tabSettings,a.recordTypeVisibilities,a.apexClasses)]).then(function(){e()},function(){e()})})}function createTabAndRecordTypePermission(a,l,c,d,u){new Promise(function(i,e){for(var t=window.location.origin,n='<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:met="http://soap.sforce.com/2006/04/metadata"><soapenv:Header><met:SessionHeader><met:sessionId>'+sessionId+'</met:sessionId></met:SessionHeader></soapenv:Header><soapenv:Body><met:updateMetadata><met:metadata xsi:type="met:PermissionSet"><fullName>'+a+"_Permissions</fullName><label>"+l+" Permissions</label>",s=0;s<c.length;s++)n+="<tabSettings><tab>"+c[s].tab+"</tab><visibility>"+c[s].visibility+"</visibility></tabSettings>";for(var r=0;r<d.length;r++)n+="<recordTypeVisibilities><recordType>"+d[r].recordType+"</recordType><visible>"+d[r].visible+"</visible></recordTypeVisibilities>";for(var o=0;o<u.length;o++)n+="<classAccesses><apexClass>"+u[o].apexClass+"</apexClass><enabled>"+u[o].enabled+"</enabled></classAccesses>";n+="</met:metadata></met:updateMetadata></soapenv:Body></soapenv:Envelope>",window.$.ajax({url:t+"/services/Soap/m/38.0",type:"POST",dataType:"xml",data:n,beforeSend:function(e){e.setRequestHeader("Content-Type","text/xml"),e.setRequestHeader("SOAPAction",'""')}}).then(function(e,t,n){i()},function(e,t,n){console.log("Failed to update permissions on load of VF"),i()})})}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}bootstrap.loadUserSettings=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.getUserSettings,function(e,t){t.status?(setSplashScreenTabDone("loading-user-setttings"),bootstrap.loadedUserSettings=JSON.parse(e.userSettings),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"]),e.isUserSettingsExist||($("#loading-timephased").remove(),$("#loading-finishing").remove())):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4})},bootstrap.Start=function(){bootstrap.UpdatePermissionSets()},bootstrap.UpdatePermissionSets=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.updatePermissionSets,function(e,t){if(e)try{handleTabSettingAndRecordTypesPermissions(e).then(function(){setSplashScreenTabDone("loading-permissions"),bootstrap.loadUserSettings()})}catch(e){console.log(e),bootstrap.loadUserSettings()}else setSplashScreenTabDone("loading-permissions"),bootstrap.loadUserSettings()})},setSplashScreenTabDone.doneElements={},bootstrap.handleError=function(e){var t,n=!1;for(t in{no_dispatcher_license_found:!0,Apex_CPU_time_limit_exceeded:!0})customLabels[t]===e.message&&(n=!0);-1<e.message.toLowerCase().indexOf("dml")?cantLoadGantt(customLabels.no_dispatcher_permissions_found.replace("{0}",'<a href="vf066_settings#page=0&tab=1" target="_blank">').replace("{1}","</a>")):cantLoadGantt(n?e.message:customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+e.message+"</div>")},bootstrap.UpdatePermissionSetsBootstrap=function(n,i){Visualforce.remoting.Manager.invokeAction(sharedRemoteActions.updatePermissionSets,function(e,t){if(e)try{handleTabSettingAndRecordTypesPermissions(e).then(function(){setSplashScreenTabDone("loading-permissions"),angular.bootstrap(document.getElementById(n),[i])})}catch(e){console.log(e),angular.bootstrap(document.getElementById(n),[i])}else setSplashScreenTabDone("loading-permissions"),angular.bootstrap(document.getElementById(n),[i])})},moment.defineLocale("en_NZ",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(e){var t=e%10;return e+(1==~~(e%100/10)?"th":1==t?"st":2==t?"nd":3==t?"rd":"th")},week:{dow:1,doy:4}});var globalStatuses={},globalCategories={},flaggedServices={},contextShown=!1,snapTo=!1,globalSelectedGanttServices={},capacityDurationFilter="Day",cachedDomElements={},violationDelimiter="&lt;br/&gt;",minHourToDisplay=0,maxHourToDisplay=24,includeWeekends=!1,gameOn=!1,ctrlPressed=!1,paletteViewActive=!1,showCandidates={on:!1,id:null},folderJustToggled=!1;function setHoursToDisplay(e,t,n){minHourToDisplay=e,maxHourToDisplay=t,includeWeekends=n}function updateTimesToSnapIn(){var e,t;void 0!==cachedDomElements&&void 0!==cachedDomElements.timesDragFix&&(t=null,0!==(e=cachedDomElements.timesDragFix.html()).indexOf(customLabels.SchedulingTimesGantSnap)||ctrlPressed?0!==e.indexOf(customLabels.SchedulingTimesGantSnap)&&ctrlPressed&&(t=customLabels.SchedulingTimesGantSnap+" "+e.substr(customLabels.SchedulingTimesGant.length,e.length),cachedDomElements.timesDragFix.html(t)):(t=customLabels.SchedulingTimesGant+" "+e.substr(customLabels.SchedulingTimesGantSnap.length,e.length),cachedDomElements.timesDragFix.html(t)))}function showTimesWhenDragging(e,t){cachedDomElements.timesDragFix=cachedDomElements.timesDragFix||$("#timesDragFix");var n,i=(t.start_date.getMinutes()+t.travelTo/60)%60,s=i%serviceJumpsOnGantt,i=serviceJumpsOnGantt-i%serviceJumpsOnGantt;scheduler.getState().drag_id!==t.id?scheduler.getState().drag_id||cachedDomElements.timesDragFix.hide():(n=t.finish-t.start,(e=new Date(e)).setSeconds(0),t.travelTo&&e.setSeconds(e.getSeconds()+t.travelTo),e=i<s?new Date(e.getTime()+60*i*1e3):new Date(e.getTime()-60*s*1e3),t=new Date(e.getTime()+n),i=moment(e).format("lll"),s=moment(t).format("lll"),n=customLabels.SchedulingTimesGant+"<br/>"+i+" - "+s,ctrlPressed&&(n=customLabels.SchedulingTimesGantSnap+"<br/>"+i+" - "+s),cachedDomElements.timesDragFix.html(n).show())}function generateBreakEventHtml(e,t,n){var i="",e=("ZoomLevel2"!=scheduler._mode&&"ZoomLevel3"!=scheduler._mode&&"ZoomLevel4"!=scheduler._mode&&(i='style="display:none;'),e.ganttLabel?'title="'+e.ganttLabel+'"':"");return n?'<div class="ServiceEvent" style="'+t+'" '+e+'>\n                    <div class="ServiceEventPadding">\n                        <img '+i+' src="'+lsdIcons.breakImg+'" class="breakIcon" draggable="false"/>     \n                    </div>\n                </div>':'<div class="ServiceEventPadding" style="'+t+'" '+e+">\n                <img "+i+' src="'+lsdIcons.breakImg+'" class="breakIcon" draggable="false"/>\n            </div>'}function generateCapacityHtml(e){var t="",n="fa-battery-empty",i=0;return 0<e.hoursPerTimePeriod?i=e.hoursInUse/e.hoursPerTimePeriod*100:0<e.workItemsPerTimePeriod&&(i=e.workItemsAllocated/e.workItemsPerTimePeriod*100),n=i<=25?"fa-battery-empty":i<=50?"fa-battery-quarter":i<=75?"fa-battery-half":i<=90?"fa-battery-three-quarters":"fa-battery-full",t+='<span class="contractorCapacityHoursUsed " style="width:calc('+(i=100<i?100:i)+'% - 5px);"></span>',e.text&&("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode?t+='<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+n+'"></i>'+e.text.split(" ")[0]+"</span></div>":"MonthlyView"===scheduler._mode||"LongView"===scheduler._mode?t+='<div class="ServiceEventPadding"><span class="Capacity_Label Capacity_Label_LongView">'+e.text.split(" ")[0]+"</span></div>":t+='<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+n+'"></i>'+e.text+"</span></div>"),t}function generateNAhtml(e,t,n){e=e.ganttLabel||e.reason||"";return n?'<div class="ServiceEvent" style="'+t+'">\n                    <div class="ServiceEventPadding">\n                        <svg aria-hidden="true" class="slds-icon naIcon">\n                            <use xlink:href="'+lsdIcons.na+'"></use>\n                        </svg>\n                        <span class="NA_Label">\n                            '+e.encodeHTML()+"\n                        </span>\n                    </div>\n                </div>":'<div class="ServiceEventPadding" style="'+t+'">\n                <svg aria-hidden="true" class="slds-icon naIcon">\n                    <use xlink:href="'+lsdIcons.na+'"></use>\n                </svg>\n                <span class="NA_Label">\n                    '+e.encodeHTML()+"\n                </span>\n            </div>"}function generateIconsHtmlForService(e){var t,n="";return e.violations&&(n="<div class='violationsOnService'><i class='fa fa-warning'></i></div>"),e.isBundleMember&&(n="<div class='violationsOnService'>"+e.RelatedBundle+"</div>"),e.jeopardy&&(n='<div class="jeopardyOnService"><img src="'+lsdIcons.jeopardyImg+'"></div>'),e.icons&&(t="",e.icons.forEach(function(e){t+='<div class="customIconOnService"><img src="'+e+'"></div>'}),n+=t),e.emergency&&(n+='<svg aria-hidden="true" class="slds-icon emergencyOnService"><use xlink:href="'+lsdIcons.emergency+'"></use></svg>'),e.pinned&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.pin+'"></use></svg>'),e.isBundle&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.bundleIcons+'#ad_set"></use></svg>'),flaggedServices[e.id]&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.flag+'"></use></svg>'),(e.relatedFather||e.relatedTo||e.isServiceInChain)&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.related+'"></use></svg>'),e.isMDT&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>'+('<svg aria-hidden="true" class="slds-icon onServiceIcon forwardIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>')),n}function generateServiceColorAndFont(e){var t,n="";return"na"===e.type&&e.ganttColor&&e.travelTo&&(n+="margin-right:-6px;"),!e.ganttPaletteColor&&!e.ganttColor||globalSelectedGanttServices[e.id]||(t=e.ganttColor,(t=paletteViewActive&&e.ganttPaletteColor?e.ganttPaletteColor.color:t)&&(n+="color:#"+generateGanttTextColor(t.substr(1,7))+";background:"+t+";")),"ZoomLevel3"!==scheduler._mode&&"ZoomLevel2"!==scheduler._mode&&(n+="font-size:10px;"),n}$(function(){$("body").keydown(function(e){ctrlPressed=e.ctrlKey,updateTimesToSnapIn()}).keyup(function(e){ctrlPressed=!1,updateTimesToSnapIn()})});var __lockedServicesIds={};function attchDatalessSchedulerEvents(){scheduler.date.ZoomLevel1_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.date.ZoomLevel2_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.templates.event_bar_text=function(e,t,n){var i=void 0,s=void 0,r=m(),o=n.finish-n.start,a=new Date(e);if(a.setSeconds(0),n.travelTo&&a.setSeconds(a.getSeconds()+n.travelTo),o=new Date(a.getTime()+o),showTimesWhenDragging(e,n),"contractorcapacity"===n.type)return generateCapacityHtml(n);var l=generateIconsHtmlForService(n),c=generateServiceColorAndFont(n),d=!0,u=new Date(scheduler._min_date),p=new Date(scheduler._max_date);if(u.setHours(r.min),p.setHours(r.max),(d=isIntersect(a,o,u,p)||"ZoomLevel2"===scheduler._mode?d:!1)&&(n.travelTo||n.travelFrom))return i=getXPositionOfEvent({start_date:a,end_date:o},!1,scheduler.matrix[scheduler._mode]),c+="width:"+(s=(s=getXPositionOfEvent({start_date:a,end_date:o},!0,scheduler.matrix[scheduler._mode])-i+12)<=2?3:s)+"px;",n.travelTo&&(r=new Date(e),u="rtl"===document.querySelector("html").getAttribute("dir"),r.setMinutes(r.getMinutes()+n.travelTo/60),p=getXPositionOfEvent({start_date:n.start_date,end_date:r},!1,scheduler.matrix[scheduler._mode]),c+=(u?"margin-right:":"margin-left:")+(getXPositionOfEvent({start_date:n.start_date,end_date:r},!0,scheduler.matrix[scheduler._mode])-p+7)+"px;"),"na"===n.type?generateNAhtml(n,c,!0):"break"===n.type?generateBreakEventHtml(n,c,!0):'<div class="ServiceEvent" territory_id="'+n.getGanttTerritory()+'" style="'+c+'");"><div class="ServiceEventPadding">'+l+n.text+"</div></div>";if("na"===n.type)return generateNAhtml(n,c,!1);if("break"===n.type)return generateBreakEventHtml(n,c,!1);a=l+n.text;return'<div class="ServiceEventPadding" style="'+c+'">'+(a=d||n.isDummy?a:"")+"</div>"},scheduler.templates.event_class=function(e,t,n){var i="";return"break"===n.type&&window.__servicesInFilter&&window.__servicesInFilter.applied?i="NA_Break service-faded":"break"===n.type&&(i="NA_Break "),n.showEventPopupEffect&&(i+=" ShowEventEffect "),window.__servicesInFilter&&window.__servicesInFilter.applied&&!window.__servicesInFilter[n.id]&&!n.isDummy&&(i+=" service-faded "),"na"===n.type&&(i+=" NA_Absence "),"na"===n.type&&n.ganttColor&&!n.travelTo&&(i+=" na_with_color_no_travel_to "),"na"===n.type&&n.ganttColor&&n.travelTo&&(i+=" na_with_color "),"contractorcapacity"===n.type?(i+=" eventContractorCapacity","LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||(i+=" eventContractorCapacity_LongView"),0<n.hoursPerTimePeriod?0<n.hoursInUse&&n.hoursInUse>n.hoursPerTimePeriod&&(i+=" overCapacityPattern"):0<n.workItemsPerTimePeriod&&0<n.workItemsAllocated&&n.workItemsAllocated>n.workItemsPerTimePeriod&&(i+=" overCapacityPattern"),showCandidates.on&&(i+=" fadedSlot")):("service"===n.type&&(i+=getClassByStatus(n.statusCategory),(n.isDummy||__lockedServicesIds[n.id])&&(i+=" savingDummyService ")),n.isMDT&&(i+=" mdtEvent"),showCandidates.on&&n.id!==showCandidates.id&&(i+=" fadedSlot"),n.hiddenTravelFrom&&(i+=" dhx_long_travel_from_time_background"),n.hiddenTravelTo&&(i+=" dhx_long_travel_to_time_background"),n.travelTo&&n.travelFrom?i+=" dhx_travelToFrom dhx_travel_time_background":n.travelTo&&!n.travelFrom?i+=" dhx_travelTo dhx_travel_time_background":!n.travelTo&&n.travelFrom?i+=" dhx_travelFrom dhx_travel_time_background":"na"===n.type?i+=" NA_Absence_NoTravel":i+=" dhx_noTravel","service"===n.type&&(globalSelectedGanttServices[n.id]&&(n.travelTo||n.travelFrom)?i+=" selectedEvent":globalSelectedGanttServices[n.id]?i+=" selectedEventNoTravel":n.id===scheduler._select_id&&(n.travelTo||n.travelFrom)?i+=" selectedEvent":n.id===scheduler._select_id&&(i+=" selectedEventNoTravel")),n.status&&(i+=" GanttCustomStatus_"+n.status.split(" ").join(""))),i};var t=!(scheduler.templates.tooltip_text=function(e,t,n){if(contextShown)return!1;var i=void 0,s='<div class="tooltipBody">',r=getLocationdIdByResource(n.resourceId),e=utils.getLocationOffset(e,r)-utils.getUserOffset(e),o=new Date(n.start),a=0,l=0,c=new Date(n.finish);if(!r)return!1;if(o.setMinutes(o.getMinutes()+e),c.setMinutes(c.getMinutes()+e),"contractorcapacity"===n.type)return i="fa-battery-empty",0<n.hoursPerTimePeriod?(a=n.hoursInUse/n.hoursPerTimePeriod*100,l=Math.floor(n.hoursInUse/n.hoursPerTimePeriod*100*100)/100):0<n.workItemsPerTimePeriod&&(a=n.workItemsAllocated/n.workItemsPerTimePeriod*100,l=Math.floor(n.workItemsAllocated/n.workItemsPerTimePeriod*100*100)/100),s+='<div class="tooltipLine"><b style="font-size:15px"><i class="fa '+(i=a<=25?"fa-battery-empty":a<=50?"fa-battery-quarter":a<=75?"fa-battery-half":a<=90?"fa-battery-three-quarters":"fa-battery-full")+'"></i> '+n.resourceName.encodeHTML()+"</b> ("+l+"%)</div>",n.workItemsPerTimePeriod&&(s+='<div class="tooltipLine">'+customLabels.NumServicesScheduled.replaceAll(n.workItemsAllocated,n.workItemsPerTimePeriod)+"</div>"),n.hoursPerTimePeriod&&(s+='<div class="tooltipLine">'+customLabels.NumHoursScheduled.replace("{0}",n.hoursInUse).replace("{1}",n.hoursPerTimePeriod)+"</div>"),s=(s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(n.start_date).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(n.end_date).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Duration_Type+"</span> "+n.timePeriod+"</div>"),0<n.workItemsAllocated&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.NumberOfServices+"</span> "+n.workItemsAllocated+"</div>"),s+="</div>";if("service"!==n.type)return i=absenceTypeIcon(n.type),n.ganttLabel?s+='<div class="tooltipLine"><b>'+i+'<span class="tooltipName">'+n.ganttLabel.encodeHTML()+"</span> </b> </div>":s+='<div class="tooltipLine"><b>'+i+'<span class="tooltipName">'+n.name+"</span> </b> </div>",s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(n.start).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(n.finish).format("llll")+"</div>"),e&&!useLocationTimezone&&(s=(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>")+'<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),n.travelTo&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.travelTo/60)+"</div>"),n.travelFrom&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.travelFrom/60)+"</div>"),(n.reason||n.comment)&&(s+='<div class="tooltipHR"></div>'),n.reason&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Reason+"</span> "+n.reason.encodeHTML()+"</div>"),s+="</div>";var r="",a=n.ganttColor,l='<svg aria-hidden="true" class="slds-icon tooltipJeopardyIcon">\n                                <use xlink:href="'+lsdIcons.jeopardy+'"></use>\n                            </svg>',i='<svg aria-hidden="true" class="slds-icon tooltipMDTIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',d='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>',u='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.emergency+'"></use>\n                            </svg>',p=((a=paletteViewActive&&n.ganttPaletteColor?n.ganttPaletteColor.color:a)&&(r='style="background:'+a+'"'),n.ganttLabel?s+='<div class="tooltipLine"><div '+r+' class="tooltipStatus '+getClassByStatus(n.statusCategory)+'"></div><b style="font-size:15px">'+n.name+" / "+n.ganttLabel.encodeHTML()+"</b> ("+statusTranslations[n.status]+")</div>":s+='<div class="tooltipLine"><div '+r+' class="tooltipStatus '+getClassByStatus(n.statusCategory)+'"></div><b style="font-size:15px">'+n.name+"</b> ("+statusTranslations[n.status]+")</div>",n.jeopardy&&n.jeopardyReason&&(s+='<div class="tooltipJeopardy">'+l+"<span>"+customLabels.JeopardyTooltip+" "+n.jeopardyReason.encodeHTML()+"</span></div>"),n.emergency?s+='<div class="tooltipJEmergency">'+u+"<span>"+customLabels.ScheduledWithEmergency+"</span></div>":n.jeopardy&&(s+='<div class="tooltipJeopardy">'+l+"<span>"+customLabels.JeopardyTooltipLong+"</span></div>"),n.pinned&&(s+='<div class="tooltipLine tooltipPinned"><i>'+customLabels.Pinned_Tooltip+"</i></div>"),GanttService.prototype.allFieldSets.GanttToolTip);if(p)for(var m=0;m<p.length;m++){var h=n[p[m].APIName];!h||"STRING"!==p[m].Type&&"TEXTAREA"!==p[m].Type&&"REFERENCE"!==p[m].Type&&"PICKLIST"!==p[m].Type||(h=h.encodeHTML()),"Status"===p[m].APIName?h=statusTranslations[n.status]:"DATETIME"===p[m].Type&&h?h=moment(h).format("llll"):"DATE"===p[m].Type&&h?h=moment(h).format("L"):"BOOLEAN"===p[m].Type&&(h=h?customLabels.True:customLabels.False),!h&&"BOOLEAN"!==p[m].Type||(s+='<div class="tooltipLine"><b>'+p[m].Label.encodeHTML()+": </b> "+h+"</div>")}if(s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Start+"</span> "+moment(n.start).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Finish+"</span> "+moment(n.finish).format("llll")+"</div>"),!e&&!alwaysShowLocalTimeTooltip||useLocationTimezone||(s=(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>")+'<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),n.hiddenTravelTo?s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.hiddenTravelTo.hiddenTravel/60)+"</div>":n.travelTo&&(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.travelTo/60)+"</div>"),n.hiddenTravelFrom?s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.hiddenTravelFrom.hiddenTravel/60)+"</div>":n.travelFrom&&(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.travelFrom/60)+"</div>"),n.tooltipText&&(s=(s+='<div class="tooltipHR"></div>')+'<div class="tooltipLine tooltipTitle">'+customLabels.Custom_Tooltip_Field+'</div><div class="tooltipLine">'+n.tooltipText.encodeHTML()+"</div>"),s+="</div>",(n.hiddenTravelTo||n.hiddenTravelFrom||n.isMDT)&&(s+='<div class="tooltipTravel">',(n.hiddenTravelTo||n.hiddenTravelFrom)&&(s=(s+='<div class="tooltipLine tooltipTitle"><i class="fa fa-car"></i>'+customLabels.Travel_time+"</div><div>")+customLabels.Travel_time_too_long.replace("{0}",maxTravelTimeInSeconds/60/60)+'<div class="travelExplain">'+customLabels.To_change_maximum_travel_hours+"</div></div>"),n.isMDT&&(s=(s+='<div class="tooltipLine tooltipTitle">'+i+d+customLabels.Multi_Day_Service+"</div><div>")+customLabels.This_service_spans_across_more_than_one_day+"</div>"),s+="</div>"),n.violations){for(var s=(s+='<div class="tooltipViolation">')+('<div class="tooltipLine tooltipTitle"><i class="fa fa-warning"></i>'+customLabels.Rule_violations_Tooltip+"</div><div>"),g=0;g<n.violations.length;g++)-1!=n.violations[g].ViolationString.indexOf(violationDelimiter)?s=(s=(s+=n.violations[g].RuleName+" - ")+n.violations[g].ViolationString.substring(0,n.violations[g].ViolationString.indexOf(violationDelimiter))+"<br/>")+n.violations[g].ViolationString.substring(n.violations[g].ViolationString.indexOf(violationDelimiter)+violationDelimiter.length)+"<br/>":s+=n.violations[g].RuleName+" - "+n.violations[g].ViolationString+"<br/>";s+="</div>"}return s});function s(e){if(window.__currentViewOptions.highlightWeekeneds)return 6===(e=e.getDay())||0===e&&1===window.firstDayOfTheWeek||5===e&&0===window.firstDayOfTheWeek?"color-weekends-date":void 0}function n(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=[],i=s(e);return i&&n.push(i),(t&&hasHolidayInScaleX(e,1,"day")||hasHolidayInScaleX(e,scheduler.getView().x_step,scheduler.getView().x_unit))&&n.push("color-holiday-date"),n.join(" ")}function e(e){if(a(e))return!0;var t=m();return!(e.getHours()>=t.min&&e.getHours()<t.max)}function a(e){if("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode||"MonthlyView"===scheduler._mode||"MTDView"===scheduler._mode||"LongView"===scheduler._mode){var t=0===firstDayOfTheWeek?6:0,n=0===firstDayOfTheWeek?5:6;if(!includeWeekends&&(e.getDay()===n||e.getDay()===t))return!0}return!1}function m(){var e=scheduler.getState().mode,t=minHourToDisplay,n=maxHourToDisplay,i=null;switch(e){case"ZoomLevel4":i=2;break;case"ZoomLevel5":i=4;break;case"ZoomLevel6":case"ZoomLevel7":i=6}return null!=i&&(t-=t%i,(e=i-n%i)!=i&&(n+=e)),{min:t,max:n}}function i(e,t){if(gameOn)return!1;var n=function(e){var t=m();if(a(e.start_date)&&a(e.end_date)&&(i=e.start_date,(e.end_date.getTime()/1e3/60/60-i.getTime()/1e3/60/60)/24<5))return!1;var n=[];if("ZoomLevel2"===scheduler._mode)n.push({start:scheduler._min_date.getTime(),finish:scheduler._max_date.getTime()});else for(var i=scheduler._min_date.getTime(),s=scheduler._max_date.getTime(),r=i;r<s;r+=864e5){var o={start:r+1e3*t.min*60*60,finish:r+1e3*t.max*60*60};n.push(o)}return isMultipleIntersection({start:e.start_date.getTime(),finish:e.end_date.getTime()},n)}(t),i=!0;return contractorSupport&&(t.resourceContractor&&(i=!1),"contractorcapacity"===t.type&&t.timePeriod!=capacityDurationFilter&&(i=!1)),n&&i}return dhtmlxEvent(scheduler._obj,"mouseleave",function(e){scheduler.getState().drag_id&&(t=!0,scheduler._on_mouse_up(e),cachedDomElements.timesDragFix.hide(),window.getSelection().removeAllRanges())}),scheduler.attachEvent("onBeforeEventChanged",function(){return!t||(t=!1)}),scheduler._hover=null,scheduler.attachEvent("onMouseMove",function(e,t){var n,i;e?scheduler._events[e]&&(scheduler._events[e].relatedTo||scheduler._events[e].relatedFather)&&(i=null,0===(n=$(scheduler.getRenderedEvent(e)).find(".ServiceEvent")).length&&(n=$(scheduler.getRenderedEvent(e))),scheduler._events[e].relatedFather?0===(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)).find(".ServiceEvent")).length&&(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather))):0===(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)).find(".ServiceEvent")).length&&(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo))),scheduler._hover=e,n&&i&&($(n).hasClass("hoverRelated")||($(n).addClass("hoverRelated"),$(i).addClass("hoverRelated")))):scheduler._hover&&($(".dhx_cal_event_line, .ServiceEvent").removeClass("hoverRelated"),scheduler._hover=null)}),scheduler.templates.ZoomLevel2_scale_date=function(e){var t=e.getHours(),e=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+":"+e+" AM":12===t?formatNumberToLocaleString(12)+":"+e+" PM":12<t?formatNumberToLocaleString(t-12)+":"+e+" PM":formatNumberToLocaleString(t)+":"+e+" AM":formatNumberToLocaleString(t)+":"+e},scheduler.templates.ZoomLevel3_scale_date=function(e){var t=e.getHours(),n=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+" AM":12==t?formatNumberToLocaleString(12)+" PM":12<t?formatNumberToLocaleString(t-12)+" PM":formatNumberToLocaleString(t)+" AM":(e.getHours()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getHours()):formatNumberToLocaleString(e.getHours()))+":"+n},scheduler.templates.ZoomLevel4_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel5_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel6_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel7_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel4_cell_class=function(e,t,n){var i="",t=(!n.children&&shouldSeparateCell(t)&&(i+="BorderForDayChange "),t.getDay());return!n.children&&window.__currentViewOptions.highlightWeekeneds&&(6===t||0===t&&1===window.firstDayOfTheWeek||5===t&&0===window.firstDayOfTheWeek)&&(i+=" color-weekends"),i},scheduler.templates.ZoomLevel2_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel3_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel5_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel6_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel7_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.MTDView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.LongView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel4_second_scalex_class=function(e){return n(e,!0)},scheduler.templates.ZoomLevel2_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel3_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel5_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel6_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel7_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel2_scalex_class=n,scheduler.templates.ZoomLevel3_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel4_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel5_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel6_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel7_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.MTDView_scalex_class=s,scheduler.templates.LongView_scalex_class=scheduler.templates.MTDView_scalex_class,scheduler.templates.MonthlyView_scalex_class=scheduler.templates.MTDView_scalex_class,scheduler.filter_ZoomLevel1=i,scheduler.filter_ZoomLevel2=i,scheduler.filter_ZoomLevel3=i,scheduler.filter_ZoomLevel4=i,scheduler.filter_ZoomLevel5=i,scheduler.filter_ZoomLevel6=i,scheduler.filter_ZoomLevel7=i,scheduler.filter_LongView=function(e,t){if(t instanceof ResourceCapacity&&t.timePeriod===capacityDurationFilter)return!0;if((!(2<arguments.length&&void 0!==arguments[2])||arguments[2])&&contractorSupport&&t.resourceContractor)return!1;if(window.__gantt.shouldShowLongTermError())return!1;if("break"===t.type)return!1;var n,i=(t.finish-t.start)/1e3/60/60;return window.__currentViewOptions.showMdt?(n=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField,"na"===t.type&&i>=window.__currentViewOptions.minNaDuration||"service"===t.type&&i>=window.__currentViewOptions.minServiceDuration&&t.fields[n]):"na"===t.type&&i>=window.__currentViewOptions.minNaDuration||"service"===t.type&&i>=window.__currentViewOptions.minServiceDuration},scheduler.filter_MonthlyView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter},scheduler.filter_MTDView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter||t.isMDT||"na"===t.type},scheduler.ignore_ZoomLevel3=e,scheduler.ignore_ZoomLevel4=e,scheduler.ignore_ZoomLevel5=e,scheduler.ignore_ZoomLevel6=e,scheduler.ignore_ZoomLevel7=e,scheduler.ignore_MonthlyView=a,scheduler.ignore_LongView=scheduler.ignore_MonthlyView,scheduler.ignore_MTDView=scheduler.ignore_MonthlyView,{isDateInsideWeekend:a}}function shouldSeparateCell(e){var t=getMinAndMaxHoursToDisplay();switch(scheduler._mode){case"ZoomLevel4":t.max-=2;break;case"ZoomLevel5":t.max-=4;break;case"ZoomLevel6":case"ZoomLevel7":t.max-=6}if("ZoomLevel2"===scheduler._mode&&23===e.getHours()&&30===e.getMinutes())return!0;if(e.getHours()===t.max){e=new Date(e);if(e.setHours(e.getHours()+24),e<=scheduler._max_date)return!0}return!1}function getXPositionOfEvent(e,t,n){var i=0,s=n._step,r=n.round_position,o=0,e=t?e.end_date:e.start_date,a=(e=e.valueOf()>scheduler._max_date.valueOf()?scheduler._max_date:e)-scheduler._min_date_timeline;if(0<a){var l=scheduler._get_date_index(n,e);scheduler._ignores[l]&&(r=!0);for(var c=0;c<l;c++)i+=scheduler._cols[c];var d=scheduler.date.add(scheduler._min_date_timeline,scheduler.matrix[scheduler._mode].x_step*l,scheduler.matrix[scheduler._mode].x_unit);r?+d<+e&&t&&(o=scheduler._cols[l]):(a=e-d,n.first_hour||n.last_hour?((a-=n._start_correction)<0&&(a=0),(o=Math.round(a/s))>scheduler._cols[l]&&(o=scheduler._cols[l])):o=Math.round(a/s))}return i+=t?0===a||r?o-14:o-12:o+1}function getResourceEventsIds(e,t,n){var i,s=[];for(i in scheduler._events)"service"==scheduler._events[i].type&&scheduler._events[i].start_date>=e&&scheduler._events[i].end_date<=t&&scheduler._events[i].resourceId==n&&(s.push(i),scheduler._events[i].relatedTo&&s.push(scheduler._events[i].relatedTo),scheduler._events[i].relatedFather&&s.push(scheduler._events[i].relatedFather));return s}function setCapacityFilter(e,t){contractorSupport&&(capacityDurationFilter=e,t&&scheduler._is_initialized()&&updateViewDebounced())}function cantLoadGantt(e){$(".keypressEvents")&&($(".bodyDiv").css("background","#fff"),$(".keypressEvents").remove(),$("#ErrorLoadingGantt").show()),$("#ErrorContainer").append(e),-1<e.toUpperCase().indexOf("CPU TIME")?($("#OpenTerritoryButton").show(),$("#OpenTerritoryMessage").show(),$("#OpenTerritoryButton").click(function(){__openLocationFilteringAndReload()})):($("#OpenTerritoryButton").hide(),$("#OpenTerritoryMessage").hide())}function getLocationdIdByResource(e){for(var t=scheduler.serverList("resources"),n=0;n<t.length;n++)for(var i=0;i<t[n].children.length;i++)if(e.split(",")[0]===t[n].children[i].key)return t[n].key;return null}function absenceTypeIcon(e){return"break"===e?'<svg aria-hidden="true" class="slds-icon tooltipBreakIcon">\n                    <use xlink:href="'+lsdIcons.break+'"></use>\n                </svg>':'<svg aria-hidden="true" class="slds-icon tooltipNAIcon">\n                <use xlink:href="'+lsdIcons.na+'"></use>\n            </svg>'}function getClassByStatus(e){switch(e){case globalCategories.NONE:return"eventStatusNew";case globalCategories.SCHEDULED:return"eventStatusAssigned";case globalCategories.DISPATCHED:return"eventStatusDispatched";case globalCategories.IN_PROGRESS:return"eventStatusTravel";case globalCategories.RUNNING_LONG:return"eventStatusOnSite";case globalCategories.COMPLETED:return"eventStatusCompleted";case globalCategories.MISSED:return"eventStatusIncomplete";case globalCategories.COULD_NOT_COMPLETE:return"eventStatusCouldntComplete";case globalCategories.CANCELED:return"eventStatusCancelled";default:return"eventCustomStatus"}}function getMinAndMaxHoursToDisplay(){var e,t=minHourToDisplay,n=maxHourToDisplay,i=null;switch(scheduler._mode){case"ZoomLevel4":i=2;break;case"ZoomLevel5":i=4;break;case"ZoomLevel6":case"ZoomLevel7":i=6}return null!==i&&(t-=t%i,(e=i-n%i)!==i&&(n+=e)),{min:t,max:n}}function isIntersect(e,t,n,i){return e<i&&n<t}function isIntersectIncludeLimits(e,t,n,i){return e<=i&&n<=t}function isMultipleIntersection(e,t){for(var n=0;n<t.length;n++)if(isIntersect(e.start,e.finish,t[n].start,t[n].finish))return!0;return!1}function generateGanttTextColor(e){return parseInt("0x888888",16)<parseInt("0x"+e,16)?"000000":"ffffff"}function formatNumberToLocaleString(e){try{return e.toLocaleString(jsUserLocale)}catch(e){console.warn("Something wrong with your locale settings: "+jsUserLocale)}return e}function formatDateByLocaleWithDayOfTheWeek(e){var t=utils.formatDateWithDayOfWeek(e);if(t)return t;return-1!==["en_US"].indexOf(userLocale)?moment(e).format("ddd, MMM D YYYY"):moment(e).format("LL")}function generateHoursMinutes(e){if(e<60)return customLabels.MinutesGanttTooltip.replace("$0",e);var t=e%60,e=Math.floor(e/60);return customLabels.MinutesHoursGanttTooltip.replace("$0",e).replace("$1",t)}function removeLightboxLoading(){$("#lightbox-loading-cover").remove()}function __setTimeZoneOffsetToDateField(e){var t,n,i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],s=arguments[2];return e?(t=60*new Date(e).getTimezoneOffset()*1e3,n=60*new Date(e+t).getTimezoneOffset()*1e3,new Date(e+t-(t!=n?t-n:0))):i?null:s?new Date(0):new Date(24e11)}function generateSecondScaleContent(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=e.toISOString(),t=t(e),e="<span>"+t+"</span>";return'<div class="second-scale-content slds">\n                '+(e=matchHolidays(i)?n?generateHolidayButton(i)+e:generateHolidayLink(i,t):e)+"\n            </div>"}function generateHolidayButton(e){return'<button class="slds-button slds-button__icon holiday-toggle holiday-button-icon" data-date="'+e+'" onClick="toggleHolidayPopover(event)">\n                <svg class="slds-button__icon holiday-icon" aria-hidden="true">\n                    <use xlink:href="'+lsdIcons.holiday+'"></use>\n                </svg>\n                <span class="slds-assistive-text">'+customLabels.HolidayOpenPopover+"</span>\n            </button>"}function generateHolidayLink(e,t){return'<a class="holiday-toggle" data-date="'+e+'" onClick="toggleHolidayPopover(event)">'+t+"</a>"}function generateHolidayPopover(e){var t=sortHolidays(e);return'<div aria-label="Holiday" class="slds holiday-popover-wrapper" data-date="'+e+'">\n                <div class="slds-popover slds-nubbin--top holiday-popover">\n                    <div class="holiday-scroll">\n                        <button class="slds-button slds-button__icon slds-float--right slds-popover__close holiday-popover-close" onClick="closeHolidayPopover(event)">\n                            <svg class="slds-button__icon" aria-hidden="true">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <span class="slds-assistive-text">'+customLabels.HolidayClosePopover+"</span>\n                        </button>\n                        <div>\n                            "+generateHolidaySections(t)+"\n                        </div>\n                    <div>\n                </div>\n            </div>"}function generateHolidaySections(e){return e&&'<div class="holiday-sections">'+Object.values(e).map(function(e){return""+generateHolidaySection(e)}).join("")+"</div>"}function generateHolidaySection(e){var t=moment(e.date).format("dddd, LL"),n=(e.isAllDay||(t=moment(e.date).startOf("day").add(e.startTimeInMinutes,"minute").format("LLLL")+" - "+moment(e.date).startOf("day").add(e.endTimeInMinutes,"minute").format("LT")),Object.values(e.territories).map(function(e){return e.name}).sort().join(", "));return'<div class="holiday-section">\n                <header class="holiday-header">\n                    <div class="slds-media slds-media--small slds-media--center slds-has-flexi-truncate">\n                        <div class="slds-media__figure holiday-figure">\n                            <span class="slds-icon_container" title="holiday">\n                                <svg class="slds-icon slds-icon--small slds-icon-text-default" aria-hidden="true">\n                                    <use xlink:href="'+lsdIcons.holiday+'"></use>\n                                </svg>\n                                <span class="slds-assistive-text">holiday</span>\n                            </span>\n                        </div>\n                        <div class="slds-media__body">\n                            <h3 class="slds-text-body--regular"><strong>'+e.name+'</strong></h3>\n                        </div>\n                    </div>\n                    <div class="slds-text-body--small">'+t+'</div>\n                </header>\n                <div>\n                    <div class="slds-text-body--regular">'+customLabels.HolidayObservingTerritories+':</div>\n                    <div class="slds-text-body--regular">'+n+"</div>\n                </div>\n            </div>"}function matchHolidays(e){return(scheduler.serverList("holidays")[0]||{})[e]}function sortHolidays(e){e=Object.values(matchHolidays(e)||{});return e.sort(function(e,t){return Object.values(t.territories).length-Object.values(e.territories).length||e.name.localeCompare(t.name)}),e}function toggleHolidayPopover(e){var e=findOrCreateHolidayPopover($(e.target).closest(".holiday-toggle")),t=e.is(":visible");closeAllHolidayPopovers(),t||togglePopoverInstance(e)}function findOrCreateHolidayPopover(e){var t='.holiday-popover-wrapper[data-date="'+e.data("date")+'"]',n=$(t);n.length||($("body").append(generateHolidayPopover(e.data("date"))),n=$(t));return $(e).data("popper")||(t=Popper.createPopper(e[0],n[0],{modifiers:[{name:"offset",options:{offset:[0,15]}}]}),e.data("popper",t)),n}function closeHolidayPopover(e){togglePopoverInstance($(e.target).closest(".holiday-popover-wrapper"),!0)}function closeAllHolidayPopovers(){$(".holiday-popover-wrapper").each(function(e,t){return togglePopoverInstance($(t),!0)})}function togglePopoverInstance(e){1<arguments.length&&void 0!==arguments[1]&&arguments[1]||e.is(":visible")?e.hide():e.show();var t=e.data("date"),t=$(".holiday-toggle[data-date='"+t+"'").data("popper");t&&t.setOptions({modifiers:[].concat(_toConsumableArray(t.state.options.modifiers),[{name:"eventListeners",enabled:!e.is(":hidden")}])})}function removeAllHolidayPopovers(){var t=this;$(".holiday-toggle").each(function(){var e=$(t).data("popper");e&&(e.destroy(),$(t).removeData("popper"))}),$(".holiday-popover-wrapper").remove()}function hasHolidayInScaleX(n,e){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"minute",i=moment(n).startOf("day").toDate().toISOString(),s=moment(n).add(e,t).toDate();return((scheduler.serverList("holidays")[1]||{})[i]||[]).some(function(e){var t=e.start;return!(e.finish<=n||s<=t)})}$(function(){moment.locale(userLocale)}),$(function(){svg4everybody(),"function"==typeof srcUp&&$("body").css("margin","0")}),scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.ZoomLevel1_second_scale_date=function(e){return generateSecondScaleContent(e,formatDateByLocaleWithDayOfTheWeek)},scheduler.templates.MonthlyView_second_scale_date=function(e){return moment(e).format("MMM")},scheduler.templates.MTDView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.LongView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.ZoomLevel2_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel3_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel4_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel5_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel6_second_scale_date=function(e){return generateSecondScaleContent(e,function(e){return moment(e).format("ddd,  D")})},scheduler.templates.ZoomLevel7_second_scale_date=function(e){return generateSecondScaleContent(e,function(e){return moment(e).format("ddd,  D")},!1)},scheduler.templates.ZoomLevel2_date=function(e,t){return e.getDate()!==t.getDate()?formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t):formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel3_date=function(e,t){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel4_date=function(e,t){t=new Date(t);return t.setDate(t.getDate()-1),formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t)},scheduler.templates.ZoomLevel5_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel6_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel7_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MTDView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.LongView_date=scheduler.templates.ZoomLevel4_date}),$(function(){-1<window.navigator.userAgent.indexOf("Edge")&&(document.body.className+=" EdgeBrowser")}),$(function(){$(document).click(function(e){$(e.target).closest(".holiday-toggle, .holiday-popover-wrapper").length||closeAllHolidayPopovers()})});var BrickBreaker=($.fn.visible=function(e){var t=$(this),n=$(window),i=n.scrollTop(),n=i+n.height(),s=t.offset().top,t=s+t.height();return(!0===e?s:t)<=n&&i<=(!0===e?t:s)},{play:function(){var o=function(){for(var e={scheduled:"#F9D058",new:"#A5E2D6",dispatched:"#8DD8FA",inprogress:"#D68EF9",completed:"#95D055",incomplete:"#EA8288",default:"#B7C9EA"},t=[],n=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=0;i<n.length;i++){var s=n[i],r=void 0,o=void 0,a=$(scheduler.getRenderedEvent(s.id));a.visible()&&(o=$(a.children()[0]).width(),"service"==s.type?r=e[s.Status.toLowerCase().replace(" ","")]:"break"==s.type?(r="#5e698f",o=a.width()):"na"==s.type&&(r="#d7dfe7"),t.push({color:r,top:a.offset().top-264,left:a.offset().left-$("#LeftSideContainer").width()+8,width:o,height:scheduler.matrix.ZoomLevel3.event_dy-2,name:s.name,status:1}))}return t}();gameOn=!0,updateViewDebounced(),$("#GanttContainer").append('<div id="bricks-overlay" style="position:absolute; top:100px; z-index:100">\n                                            <canvas id="brick-canvas"></canvas>\n                                        </div>');var a=(e=$(".dhx_cal_data")).width(),e=e.height(),l=document.getElementById("brick-canvas"),c=(l.width=a,l.height=e,l.getContext("2d")),d=15,u=l.width/2,p=l.height-30,m=5,h=-5,g=15,v=95,f=($("body").width()-v)/2,S=0,y=3;function t(e){e=e.clientX-l.offsetLeft;0<e&&e<l.width&&(f=e-v/2)}function b(){gameOn=!1,document.removeEventListener("mousemove",t),updateViewDebounced(),$("#bricks-overlay").remove()}return 15<$(".item").length||$(".item").length,document.addEventListener("mousemove",t,!1),function e(){c.clearRect(0,0,l.width,l.height);for(var t,n,i,s,r=0;r<o.length;r++)0!=o[r].status&&(t=o[r].left,n=o[r].top,i=o[r].width,s=o[r].height,c.beginPath(),c.rect(t,n,i,s),c.fillStyle=o[r].color,c.fill(),40<=i&&(c.font="10px Salesforce Sans",c.fillStyle="#000",c.fillText(o[r].name,t+5,n+10)),c.closePath());if(c.beginPath(),c.arc(u,p,d,0,2*Math.PI),c.fillStyle="#0095DD",c.fill(),c.closePath(),c.beginPath(),c.rect(f,l.height-g,v,g),c.fillStyle="#0095DD",c.fill(),c.closePath(),function(){for(var e=0;e<o.length;e++){var t=o[e];if(1==t.status&&u>=t.left&&u<=t.left+t.width&&p>=t.top&&p<=t.top+t.height&&(h=-h,t.status=0,(S+=10)/10==o.length))return alert("You win, great... \\_()_/. back to work"),b()}}(),c.font="16px Salesforce Sans",c.fillStyle="#0095DD",c.fillText("Score: "+S+", Lives: "+y,a/2,25),(u+m>l.width-d||u+m<d)&&(m=-m),p+h<d)h=-h;else if(p+h>l.height-d)if(f<u&&u<f+v)h=-h;else{if(!--y)return alert("GAME OVER - back to work"),void b();u=l.width/2,p=l.height-30,h=-(m=5),f=(l.width-v)/2}u+=m,p+=h,requestAnimationFrame(e)}(),"GAME ON!"}}),schedulerConfig=(setTimeout(function e(){postMessage(10),setTimeout(e,1e4)},1e4),function(){var e={dateTitleFormat:"%D, %F %d",dateFormat:"%g:%i%A",resourceCellSize:170,locationCellHeight:44,rowHeight:46,eventHeight:42,sort:t};function t(e,t){var n=new Date(e.start_date),i=new Date(e.end_date),s=new Date(t.start_date),r=new Date(t.end_date);return"na"===e.type&&"na"!==t.type?(r<n||i<s)&&+s<+n?1:-1:"na"===t.type&&"na"!==e.type?!(i<s||r<n)||+s<+n?1:-1:+s<+n?1:-1}return{timelineConfigs:e,configTimelines:function(){scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel2",x_unit:"minute",x_date:e.dateFormat,x_step:30,x_size:16,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel3",x_unit:"minute",x_date:e.dateFormat,x_step:60,x_size:24,x_start:0,x_length:24,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel4",x_unit:"minute",x_date:e.dateFormat,x_step:120,x_size:24,x_start:0,x_length:12,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel5",x_unit:"minute",x_date:e.dateFormat,x_step:240,x_size:18,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel6",x_unit:"minute",x_date:e.dateFormat,x_step:360,x_size:28,x_start:0,x_length:4,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel7",x_unit:"minute",x_date:e.dateFormat,x_step:720,x_size:28,x_start:0,x_length:2,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MonthlyView",x_unit:"day",x_date:"%d",x_step:1,x_size:14,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MTDView",x_unit:"day",x_date:"%d",x_step:1,x_size:35,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"LongView",x_unit:"day",x_date:"%d",x_step:1,x_size:20,x_start:0,x_length:7,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort})},setRowHeights:function(e,t){var n=32;switch(e){case"xsmall":n=27;break;case"small":n=32;break;case"normal":n=39;break;case"large":n=46;break;default:n=39}if(scheduler.matrix.ZoomLevel3.dy!==n){for(var i in scheduler.matrix)scheduler.matrix[i].dy=n,scheduler.matrix[i].event_dy=n-4,scheduler.matrix[i].folder_dy=n+2;t&&scheduler._is_initialized()&&scheduler.setCurrentView()}},setReadOnly:function(e){scheduler.config.readonly=e},setConfigurations:function(){var e="rtl"===document.querySelector("html").getAttribute("dir");scheduler.config.drag_resize=!1,scheduler.config.multisection=!0,scheduler.config.multisection_shift_all=!1,scheduler.config.limit_drag_out=!1,scheduler.config.dblclick_create=!1,scheduler.config.mark_now=!1,scheduler.config.time_step=1,scheduler.dhtmlXTooltip.config.className="dhtmlXTooltip tooltip expertTooltip",scheduler.dhtmlXTooltip.config.timeout_to_display=375,scheduler.dhtmlXTooltip.config.delta_x=10,scheduler.dhtmlXTooltip.config.delta_y=0,scheduler.config.minicalendar.mark_events=!1,scheduler.config.preserve_length=!1,scheduler.config.rtl=e,scheduler.config.touch=!1},sortEvents:t}}());scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.calendar_month=function(e){return-1!=["en_US","en_GB"].indexOf(userLocale)?moment(e).format("MMMM YYYY"):moment(e).format("LL")},scheduler.templates.calendar_date=function(e){return moment(e).format("DD")},scheduler.templates.calendar_scale_date=function(e){return moment(e).format("ddd")},scheduler.templates.calendar_time=function(e){return moment(e).format("l")}});