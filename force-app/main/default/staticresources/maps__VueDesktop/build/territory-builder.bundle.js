"use strict";(globalThis.webpackChunkmaps_desktop=globalThis.webpackChunkmaps_desktop||[]).push([[318],{1275:(e,t,s)=>{s.r(t),s.d(t,{default:()=>x});var a=s(9048),r=s(4461),i=s(9974),l=s(9486),o=s(1515);const d={components:{TextInput:o.oi},props:{layer:{type:Object,required:!0},validator:{type:Object,required:!0},invalidEmailAddressLabel:{type:String,default:()=>(void 0).$Labels.MA_Invalid_Email_Address},requiredEmailAddressLabel:{type:String,default:()=>(void 0).$Labels.MA_Field_Req},requiredNameLabel:{type:String,default:()=>(void 0).$Labels.MA_Field_Req}},methods:{getValidationMessages(e){const t=[];return"Name"===e&&this.$props.validator.Name.$dirty?this.$props.validator.Name.required||t.push(this.requiredNameLabel):"EmailOnAggregationSuccess__c"===e&&this.$props.validator.EmailOnAggregationSuccess__c.$dirty&&(this.$props.validator.EmailOnAggregationSuccess__c.email?this.$props.validator.EmailOnAggregationSuccess__c.required||t.push(this.requiredEmailAddressLabel):t.push(this.invalidEmailAddressLabel)),t}}};var n=s(1900);const c=(0,n.Z)(d,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"slds-grid slds-p-around_small"},[s("div",{staticClass:"slds-col slds-size_4-of-12"},[s("div",{staticClass:"slds-form slds-form_stacked"},[s("div",{staticClass:"slds-form-element"},[s("TextInput",{attrs:{required:!0,errors:e.getValidationMessages("Name"),labels:{name:e.$Labels.MA_Name,placeholder:e.$Labels.Layers_Territory_Modal_Name_Placeholder_Text,required:e.$Labels.MA_Required}},on:{changed:e.validator.Name.$touch},model:{value:e.layer.Name,callback:function(t){e.$set(e.layer,"Name",t)},expression:"layer.Name"}})],1),e._v(" "),s("div",{staticClass:"slds-form-element"},[s("TextInput",{attrs:{required:!0,errors:e.getValidationMessages("EmailOnAggregationSuccess__c"),labels:{name:e.$Labels.Layers_Territory_Modal_Email_Prompt_Text,placeholder:e.$Labels.Layers_Territory_Modal_Email_Placeholder_Text}},on:{changed:e.validator.EmailOnAggregationSuccess__c.$touch},model:{value:e.layer.EmailOnAggregationSuccess__c,callback:function(t){e.$set(e.layer,"EmailOnAggregationSuccess__c",t)},expression:"layer.EmailOnAggregationSuccess__c"}})],1)])])])}),[],!1,null,null,null).exports;var g=s(4922),_=s(7318),u=s(5947);const m={components:{TreeViewer:g.Z},props:{initialState:{type:Object,default:()=>{}}},data(){return{treeData:new _.Z(this.initialState),valid:!0,shapeLayerError:!1,nodeNameError:!1,isValidated:!1}},watch:{initialState(e){this.treeData=new _.Z(e)}},created(){this.$bus.$on("give-me-tree",(e=>{e(this.treeData)})),this.$bus.$on("give-me-hierarchy-validation",(e=>{this.valid=!this.isTreeInvalid(this.treeData),this.isValidated=!0,e(this.valid)}))},destroyed(){this.$bus.$off("give-me-tree"),this.$bus.$off("give-me-hierarchy-validation")},methods:{isTreeInvalid(e){let t=!1;return e.valid=!0,e.nameValid=!0,this.shapeLayerError=!1,this.nodeNameError=!1,e.record.Name&&""!==e.record.Name.trim()||(e.nameValid=!1,this.valid=!1,this.nodeNameError=!0,t=!0),e.children.length||e.record.ShapeLayer__c||(e.valid=!1,this.shapeLayerError=!0,t=!0),e.children.forEach((e=>{const s=this.isTreeInvalid(e);s&&(t=s)})),t},deselectAll(){(0,u.kR)(this.treeData)}}},h=(0,n.Z)(m,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"tree-wrapper"},[s("div",{staticClass:"slds-p-vertical_small slds-text-body_small"},[e._v("\n        "+e._s(e.$Labels.Layers_Territory_Modal_Hierarchy_Header)+"\n    ")]),e._v(" "),s("div",{staticClass:"slds-card"},[s("div",{staticClass:"slds-border_bottom slds-p-vertical_x-small slds-p-left_medium slds-grid territory-card-header"},[s("h4",{staticClass:"slds-text-title_caps"},[s("span",{staticClass:"ma-icon ma-icon-check"}),e._v("\n                "+e._s(e.$Labels.Layers_Territory_Modal_Hierarchy_Table_Header_Visible_By_Default)+"\n            ")])]),e._v(" "),s("div",{staticClass:"ma-territory-tree-container"},[s("TreeViewer",{attrs:{maxDepth:20,model:e.treeData,expandAll:""}})],1)])])}),[],!1,null,"592202c4",null).exports;var y=s(2072),v=s(379);const{MAToastMessages:b}=window,L={components:{Picklist:o.Gp,Spinner:o.$j,TextInput:o.oi},props:{aggregation:{type:Object,required:!0},validator:{type:Object,required:!0}},validations:{aggregation:{record:{Name:{required:v.C1},ValueField__c:{required:v.C1}}}},data(){return{searchTerm:"",searches:[{options:this.getMarkerLayers}],valueFields:[],showValueFieldPicklist:!1,isLoading:!1}},computed:{isEdit(){return this.aggregation.record.Id},isCreate(){return!this.isEdit}},watch:{recordForEdit:{handler(e){this.aggregation.record=e}},immediate:!0},methods:{getValidationMessages:(0,y.ed)({required:window.MASystem.Labels.MA_This_Field_Is_Required}),selected(e){this.aggregation.record.MarkerLayer__r={Id:e.Id,Name:e.label},this.renderValueFields(e.name)},valueFieldChanged(e){this.aggregation.valueFieldLabel=e.label,this.$emit("add",this.aggregation)},clearMarkerLayer(){this.searchTerm="",this.aggregation.record.ValueField__c="",this.valueFields=[]},async renderValueFields(e){this.isLoading=!0;try{const t=await(0,r.wX)(this.$Remoting.Territory.fetchNumberFieldsBySObjectName,[e]);t?(this.valueFields=t.fields,this.showValueFieldPicklist=!0):b.showError({message:this.$Labels.MA_Error,subMessage:"Error fetching data.",timeOut:0,extendedTimeOut:0,closeButton:!0})}catch(e){b.showError({message:this.$Labels.MA_Error,subMessage:"Error fetching data.",timeOut:0,extendedTimeOut:0,closeButton:!0})}this.isLoading=!1},getMarkerLayers(e){return new Promise(((t,s)=>{e&&""!==e||s(new Error("Missing Required Param: searchTerm")),(0,r.wX)(this.$Remoting.Territory.getTerritoryMarkerLayersBySearchTerm,[e],{buffer:!1}).then((({success:e=!1,data:a={},error:r=""})=>{if(e){const e=Object.entries(a).map((([e,{label:t,name:s,folder:a,isDisabled:r}])=>({Id:e,label:t,name:s,folder:a,isDisabled:r})));t(e)}else b.showError({message:this.$Labels.MA_Error,subMessage:"Error fetching data.",timeOut:0,extendedTimeOut:0,closeButton:!0}),s(new Error(r))}))}))}}},p={components:{Aggregation:(0,n.Z)(L,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("li",{staticClass:"slds-expression__row"},[s("fieldset",[e.isLoading?s("Spinner",{attrs:{loadingLabel:e.$Labels.MA_Loading}}):e._e(),e._v(" "),s("legend",{staticClass:"slds-expression__legend"}),e._v(" "),s("div",{staticClass:"slds-grid slds-gutters_xx-small"},[s("div",{staticClass:"slds-col slds-size_1-of-4"},[s("div",{staticClass:"slds-form-element"},[s("TextInput",{attrs:{required:"",labels:{name:e.$Labels.MA_Name,required:e.$Labels.MA_Required},errors:e.getValidationMessages(e.$v.aggregation.record.Name)},model:{value:e.$v.aggregation.record.Name.$model,callback:function(t){e.$set(e.$v.aggregation.record.Name,"$model",t)},expression:"$v.aggregation.record.Name.$model"}})],1)]),e._v(" "),s("div",{staticClass:"slds-col slds-size_1-of-4"},[s("div",{staticClass:"slds-form-element"},[e.isCreate?s("Picklist",{attrs:{filterable:"",options:e.searches,labels:{name:e.$Labels.Layers_Territory_Modal_Aggregations_Marker_Layer_Text,search:e.$Labels.MA_Search_for+"...",noSearchResults:e.$Labels.MA_NO_RESULTS_FOUND},idKey:"Id",titleKey:"label"},on:{clear:e.clearMarkerLayer,"selected-option":e.selected},scopedSlots:e._u([{key:"result",fn:function(t){return s("span",{staticClass:"slds-listbox__option-text_entity slds-listbox__option slds-listbox__option_plain"},[s("div",[s("div",{staticClass:"slds-text-body_small"},[e._v(e._s(e._f("decode")(t.result.label)))]),e._v(" "),s("div",{staticClass:"slds-grid slds-grid_vertical-align-center"},[t.result.folder?s("span",{staticClass:"ma-icon ma-icon-folder ma-icon-small slds-m-right_x-small"}):e._e(),e._v(" "),s("span",{staticClass:"slds-text-color_weak slds-text-body_small"},[e._v(e._s(e._f("decode")(t.result.folder)))])])])])}}],null,!1,287910314),model:{value:e.searchTerm,callback:function(t){e.searchTerm=t},expression:"searchTerm"}}):s("div",[s("div",{staticClass:"slds-form-element__control"},[s("TextInput",{attrs:{value:e._f("decode")(e.aggregation.record.MarkerLayer__r.Name),readonly:"",labels:{name:"Name"}}})],1)])],1)]),e._v(" "),s("div",{staticClass:"slds-col slds-size_1-of-4"},[s("div",{staticClass:"slds-form-element"},[e.isCreate?[s("Picklist",{attrs:{options:e.valueFields,required:"",helpText:e.$Labels.Layers_Territory_Modal_Aggregations_Numeric_Fields,labels:{name:e.$Labels.Layers_Territory_Modal_Aggregations_Value_Field,required:e.$Labels.MA_Required,clear:e.$Labels.MA_Clear,noSearchResults:e.$Labels.MA_NO_RESULTS_FOUND},errors:e.getValidationMessages(e.$v.aggregation.record.ValueField__c),idKey:"api",titleKey:"label"},on:{changed:e.valueFieldChanged},model:{value:e.$v.aggregation.record.ValueField__c.$model,callback:function(t){e.$set(e.$v.aggregation.record.ValueField__c,"$model",t)},expression:"$v.aggregation.record.ValueField__c.$model"}})]:s("div",[s("label",{staticClass:"slds-form-element__label slds-align-middle"},[e._v("\n                            "+e._s(e.$Labels.Layers_Territory_Modal_Aggregations_Value_Field)+"\n                        ")]),e._v(" "),s("div",{staticClass:"slds-form-element__control"},[s("input",{staticClass:"slds-input",attrs:{readonly:"",type:"text"},domProps:{value:e.aggregation.valueFieldLabel}})])])],2)]),e._v(" "),s("div",{staticClass:"slds-col slds-grow-none"},[s("span",{staticClass:"slds-form-element__label"},[e._v("Â ")]),e._v(" "),s("div",{staticClass:"slds-form-element__control"},[s("button",{staticClass:"slds-button slds-button_icon-container slds-button_icon-border-filled aggregation-delete",on:{click:function(t){return e.$emit("delete",e.aggregation)}}},[s("span",{staticClass:"slds-button__icon ma-icon ma-icon-delete"})])])])])],1)])}),[],!1,null,"31549f2a",null).exports,Button:o.zx,Tooltip:o.u},props:{aggregations:{type:Array,required:!0},validator:{type:Object,required:!0}},data:()=>({showAggregationComponent:!1}),mounted(){0===this.aggregations.length&&this.add()},methods:{deleteAggregation(e){this.$emit("deleteAggregation",e),this.validator.$reset()},add(){this.aggregations.push({valueFieldLabel:"",guid:(0,r.x$)(),record:{Id:"",Name:"",MarkerLayer__r:{Id:"",Name:""},ValueField__c:"",TerritoryLayer__c:""}}),this.showAggregationComponent=!1,this.validator.$reset()}}},$=(0,n.Z)(p,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"aggregate slds-expression"},[s("ul",{class:{"allow-aggregate-delete":e.aggregations.length>1}},e._l(e.aggregations,(function(t,a){return s("Aggregation",{key:t.guid,attrs:{aggregation:t,validator:e.validator.$each[a]},on:{delete:e.deleteAggregation}})})),1),e._v(" "),s("div",{staticClass:"slds-expression__buttons"},[s("Tooltip",{staticClass:"ma-feature-tooltip"},[s("Button",{staticClass:"slds-m-bottom_small",attrs:{slot:"source",label:e.$Labels.Layers_Territory_Modal_Manage_Add_Aggregation_Button,variant:"neutral",iconCategory:"utility",iconName:"new",iconPosition:"left"},on:{click:e.add},slot:"source"}),e._v(" "),s("div",{staticClass:"slds-media"},[s("div",{staticClass:"slds-media__body"},[s("h2",{staticClass:"slds-text-heading_small"},[e._v(" "+e._s(e.$Labels.Layers_Territory_Modal_Aggregations_Data_Selection))]),e._v(" "),s("p",[e._v(e._s(e.$Labels.Layers_Territory_Modal_Aggregations_Field_Association))])])])],1)],1)])}),[],!1,null,"e11fc2c4",null).exports,{MAToastMessages:f}=window,A={components:{Spinner:o.$j},props:{territoryLayerId:{type:String,required:!0},aggregations:{type:Array,required:!0},territoryNodes:{type:Object,required:!0}},data:()=>({isLoading:!1,metadata:null,status:"Loading"}),computed:{statusLabel(){switch(this.status.toLowerCase()){case"running":return this.$Labels.Layers_Territory_Modal_Manage_Aggregation_Status_Running;case"failed":return this.$Labels.Layers_Territory_Modal_Manage_Aggregation_Status_Failed;case"canceled":return this.$Labels.Layers_Territory_Modal_Manage_Aggregation_Status_Canceled;default:return this.$Labels.Layers_Territory_Modal_Manage_Aggregation_Status_None}}},created(){this.getStatus()},methods:{async startAggregation(){this.metadata=null,this.isLoading=!0;try{const{success:e,response:t}=await(0,r.wX)(this.$Remoting.Territory.startAggregationById,[this.territoryLayerId]);e&&t.success?(this.metadata=t.request,await this.getStatus()):(console.error(t),f.showError({message:this.$Labels.MA_Error,subMessage:"Error during start of the aggregation process",timeOut:0,extendedTimeOut:0,closeButton:!0}))}catch(e){console.error(e),f.showError({message:this.$Labels.MA_Error,subMessage:"Aggregation could not be started",timeOut:0,extendedTimeOut:0,closeButton:!0})}this.isLoading=!1},async getStatus(){const e={method:"get",action:"aggregation",subType:"core/territory",version:"status"},t={territoryLayerId:this.territoryLayerId};this.isLoading=!0;try{const s=await(0,r.wX)(this.$Remoting.MapAnythingIORequest,[e,t]);if(s.success)if("completed"===s.data.status){const e=await(0,r.wX)("maps.TerritoryRemoteFunctions.doesTerritoryHaveAggregation",[this.territoryLayerId]);e.success&&!e.hasAggregations?this.status="Invalidated, please start aggregation again":this.status=s.data.status}else this.status=s.data.status;else this.status="Error retrieving status, click Refresh Status button.",f.showError({message:this.$Labels.MA_Error,subMessage:"Error during retrival of status",timeOut:0,extendedTimeOut:0,closeButton:!0})}catch(e){f.showError({message:this.$Labels.MA_Error,subMessage:"Error during retrival of status",timeOut:0,extendedTimeOut:0,closeButton:!0})}this.isLoading=!1},async abortAggregation(){const e={method:"get",action:"aggregation",subType:"core/territory",version:"cancel"},t={territoryLayerId:this.territoryLayerId};this.isLoading=!0;try{(await(0,r.wX)(this.$Remoting.MapAnythingIORequest,[e,t])).success?await this.getStatus():f.showError({message:this.$Labels.MA_Error,subMessage:"Error during the cancelation of aggregation process",timeOut:0,extendedTimeOut:0,closeButton:!0})}catch(e){f.showError({message:this.$Labels.MA_Error,subMessage:"Error cancelling the aggregation",timeOut:0,extendedTimeOut:0,closeButton:!0})}this.isLoading=!1}}},M=(0,n.Z)(A,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[e.isLoading?s("Spinner",{attrs:{loadingLabel:e.$Labels.MA_Loading}}):e._e(),e._v(" "),s("div",{staticClass:"slds-m-bottom_small"},[s("div",{staticClass:"slds-text-title_caps slds-text-title"},[e._v(" "+e._s(e.$Labels.Layers_Territory_Modal_Manage_Aggregation_Status)),s("span",{staticClass:"slds-text-title_bold"},[e._v(e._s(e.statusLabel))])])]),e._v(" "),s("ul",{staticClass:"slds-button-group-row slds-m-bottom_small"},[s("li",{staticClass:"slds-button-group-item"},[s("button",{staticClass:"slds-button slds-button_brand",attrs:{disabled:"running"===e.status},on:{click:e.startAggregation}},[e._v("\n                "+e._s(e.$Labels.Layers_Territory_Modal_Manage_Start_Aggregation_Button)+"\n            ")])]),e._v(" "),s("li",{staticClass:"slds-button-group-item"},[s("button",{staticClass:"slds-button slds-button_destructive",attrs:{disabled:"running"!==e.status},on:{click:e.abortAggregation}},[e._v("\n                "+e._s(e.$Labels.Layers_Territory_Modal_Manage_Start_Abort_Button)+"\n            ")])]),e._v(" "),s("li",{staticClass:"slds-button-group-item"},[s("button",{staticClass:"slds-button slds-button_neutral",attrs:{disabled:"none"===e.status},on:{click:e.getStatus}},[e._v("\n                "+e._s(e.$Labels.Layers_Territory_Modal_Manage_Start_Refresh_Button)+"\n            ")])])]),e._v(" "),s("div",{staticClass:"slds-grid"},[s("div",{staticClass:"slds-col slds-size_1-of-1 slds-medium-size_7-of-12"},[null!=e.metadata?s("table",{staticClass:"slds-table slds-table_bordered slds-no-row-hover slds-table_striped"},[e._m(0),e._v(" "),s("tbody",[s("tr",{staticClass:"slds-hint-parent"},[e._m(1),e._v(" "),s("td",{attrs:{"data-label":"Close Date"}},[s("div",{staticClass:"slds-truncate",attrs:{title:e.metadata.territoryNodes.length}},[e._v("\n                                "+e._s(e.metadata.territoryNodes.length)+"\n                            ")])])]),e._v(" "),s("tr",{staticClass:"slds-hint-parent"},[e._m(2),e._v(" "),s("td",{attrs:{"data-label":"Close Date"}},[s("div",{staticClass:"slds-truncate",attrs:{title:e.metadata.territoryNodes.length}},[e._v("\n                                "+e._s(e.metadata.territoryNodes.length)+"\n                            ")])])]),e._v(" "),s("tr",{staticClass:"slds-hint-parent"},[e._m(3),e._v(" "),s("td",{attrs:{"data-label":"Close Date"}},[s("div",{staticClass:"slds-truncate",attrs:{title:e.metadata.aggregations.length}},[e._v("\n                                "+e._s(e.metadata.aggregations.length)+"\n                            ")])])]),e._v(" "),s("tr",{staticClass:"slds-hint-parent"},[e._m(4),e._v(" "),s("td",{attrs:{"data-label":"Close Date"}},[s("div",{staticClass:"slds-truncate",attrs:{title:e.metadata.territoryLayerId}},[e._v("\n                                "+e._s(e.metadata.territoryLayerId)+"\n                            ")])])])])]):e._e()])])],1)}),[function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("thead",{staticClass:"slds-assistive-text"},[s("tr",{staticClass:"slds-line-height_reset"},[s("th",{attrs:{scope:"col"}},[s("div",{staticClass:"slds-truncate",attrs:{title:"Aggregation Label"}},[e._v("\n                                Aggregation item\n                            ")])]),e._v(" "),s("th",{attrs:{scope:"col"}},[s("div",{staticClass:"slds-truncate",attrs:{title:"Value"}},[e._v("\n                                Value\n                            ")])])])])},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("td",{attrs:{"data-label":"Account Name"}},[s("div",{staticClass:"slds-truncate",attrs:{title:"Number of Territory Nodes"}},[e._v("\n                                Number of Territory Nodes\n                            ")])])},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("td",{attrs:{"data-label":"Account Name"}},[s("div",{staticClass:"slds-truncate",attrs:{title:"Number of Shape Layers"}},[e._v("\n                                Number of Shape Layers\n                            ")])])},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("td",{attrs:{"data-label":"Account Name"}},[s("div",{staticClass:"slds-truncate",attrs:{title:"Number of Configured Aggregations"}},[e._v("\n                                Number of Configured Aggregations\n                            ")])])},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("td",{attrs:{"data-label":"Account Name"}},[s("div",{staticClass:"slds-truncate",attrs:{title:"Territory Id"}},[e._v("\n                                Territory Id\n                            ")])])}],!1,null,null,null).exports,{MAToastMessages:T}=window,C=()=>{const e={territory:{Id:null,User__c:null,EmailOnAggregationSuccess__c:window.MASystem.User.Email,Name:"",Type__c:"Territory",Folder__c:null,Options__c:"{}"},root:{},removedNodes:[],aggregations:[],aggregationIdsForDelete:[]},{currentFolder:t}=window.MALayers||{},s="PersonalRoot"===t||"RoleUserFolder"===t;return s?e.territory.User__c=window.MASystem.User.Id:("CorporateRoot"!==t||s)&&(e.territory.Folder__c=t),e},E={name:"TerritoryLayerBuilder",components:{Modal:o.u_,Tabs:o.mQ,Tab:o.OK,TerritoryDetails:c,TreeBuilder:h,Aggregations:$,Manage:M,Spinner:o.$j},provide(){return{addToDelete:e=>{this.model.removedNodes.push(e)}}},props:{layer:{type:Object,default:()=>({})}},data:()=>({model:C(),isEdit:!1,showError:!1,hierarchyValid:!0,isLoading:!1}),validations:{model:{territory:{Name:{required:l.required},EmailOnAggregationSuccess__c:{email:l.email,required:l.required}},aggregations:{required:l.required,noAggregationDuplicates:e=>{const t=new Set;for(let s=0;s<e.length;s++){const a=e[s],r=`${a.record.MarkerLayer__r.Id}/${a.record.ValueField__c}`;if(t.has(r))return!1;t.add(r)}return!0},$each:{record:{Name:{required:l.required},ValueField__c:{required:l.required}}}}},hierarchyValid:e=>e},created(){this.model.territory.EmailOnAggregationSuccess__c=this.$User.Email,this.layer.id&&this.getTerritoryLayer()},methods:{getGUID:r.x$,deleteAggregation({record:e,guid:t}){e.Id&&this.model.aggregationIdsForDelete.push(e.Id),this.model.aggregations=this.model.aggregations.filter((e=>e.guid!==t))},duplicateWithoutParent(e){if(!e)return;const t={};if(e.children){const s=[];e.children.forEach((e=>{const t=this.duplicateWithoutParent(e);s.push(t)})),t.children=s}return Object.keys(e).reduce(((s,a)=>("parent"!==a&&"children"!==a&&"id"!==a&&"selected"!==a&&"valid"!==a&&"nameValid"!==a&&(t[a]=e[a]),t))),t},getThatDataToSave(){return new Promise((e=>{this.$bus.$emit("give-me-tree",(t=>{this.model.root=this.duplicateWithoutParent(t),this.isEdit&&!this.model.territory.Id&&(this.model.territory.Id=this.model.root?this.model.root.record.TerritoryLayer__c:this.model.aggregation.record.TerritoryLayer__c),e()}))}))},isInvalid(){return new Promise((e=>{this.$bus.$emit("give-me-hierarchy-validation",(t=>{this.hierarchyValid=t,this.$v.$touch(),e(!t)}))}))},async save(e,t){try{if(this.isLoading=!0,await this.isInvalid()||this.$v.$invalid)return void(this.isLoading=!1);await this.getThatDataToSave();const{record:e}=await this.saveLayerToServer();if(t){const{success:t,response:s}=await(0,r.wX)(this.$Remoting.Territory.startAggregationById,[e.Id]);t&&s.success?(document.createElement("div").innerHTML="Your Territory Layer Aggregate Data is being processed.<br />You'll receive an email when it's ready to be viewed on the map.",this.$bus.$emit("show-generic-modal",{title:this.$Labels.Layers_Territory_Layer_Modal_Title_Aggregation_Started,message:this.$Labels.Layers_Territory_Layer_Modal_Message_Aggregation_Started})):(console.error(s),T.showError({message:this.$Labels.MA_Error,subMessage:"Could not start the aggregation process. Please edit the territory layer and use the Manage tab to try to start the aggregation again.",timeOut:0,extendedTimeOut:0,closeButton:!0}))}this.$emit("close")}catch(e){let t=e.message;e instanceof i.Z&&(t=e.event.message),T.showError({message:this.$Labels.MA_Error,subMessage:t,timeOut:0,extendedTimeOut:0,closeButton:!0}),this.isLoading=!1}},async saveLayerToServer(){const e={...this.model,aggregations:this.model.aggregations.map((e=>e.record))},{success:t=!1,data:s={}}=await(0,r.wX)(this.$Remoting.Territory.save,[e]);if(t)return T.showSuccess({message:this.$Labels.MA_Success,subMessage:s.Name}),this.$bus.$emit("refresh-folder"),{record:s};let a=s;throw/maximum number of territory layers/.test(s)&&(a=this.$Labels.MA_Territory_Reached_Max),new Error(a)},async getTerritoryLayer(){this.isEdit=!0,this.isLoading=!0;try{const e=await(0,r.wX)(this.$Remoting.Territory.getTerritoryLayerById,[this.layer.id]);e.success&&e.data?((0,a.a)(e.data,"maps__"),this.model={...this.model,...e.data},e.data.aggregations.forEach(((t,s)=>{this.$set(this.model.aggregations,s,{valueFieldLabel:e.data.valueFieldMap[t.Id],guid:(0,r.x$)(),record:{Id:t.Id,Name:t.Name,MarkerLayer__r:{Id:t.MarkerLayer__r.Id,Name:t.MarkerLayer__r.Name},ValueField__c:t.ValueField__c,TerritoryLayer__c:t.TerritoryLayer__c}})})),this.model.removedNodes=[],this.model.aggregationIdsForDelete=[]):T.showError({message:this.$Labels.MA_Error,subMessage:"Error in call to retrieve territory layer",timeOut:0,extendedTimeOut:0,closeButton:!0})}catch(e){T.showError({message:this.$Labels.MA_Error,subMessage:"Error during retrival of territory layer",timeOut:0,extendedTimeOut:0,closeButton:!0})}this.isLoading=!1}}},w={components:{TerritoryLayer:(0,n.Z)(E,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("Modal",{staticClass:"territory-builder-modal",attrs:{title:e.$Labels.MA_Territory_Layer_Builder,isLoading:e.isLoading,labels:{close:e.$Labels.MA_Close},size:"large"},on:{close:function(t){return e.$emit("close")}}},[s("div",{staticClass:"territory-builder-content",attrs:{slot:"content"},slot:"content"},[e.isLoading?s("Spinner",{attrs:{loadingLabel:e.$Labels.MA_Loading}}):e._e(),e._v(" "),s("Tabs",{staticClass:"content",attrs:{isVertical:""}},[s("Tab",{attrs:{id:e.getGUID(),renderImmediately:"",isValid:!e.$v.model.territory.$error,title:e.$Labels.MA_DETAILS}},[s("TerritoryDetails",{attrs:{layer:e.model.territory,validator:e.$v.model.territory,invalidEmailAddressLabel:e.$Labels.MA_Invalid_Email_Address,requiredEmailAddressLabel:e.$Labels.MA_Field_Req,requiredNameLabel:e.$Labels.MA_Field_Req},on:{"update:layer":function(t){return e.$set(e.model,"territory",t)}}})],1),e._v(" "),s("Tab",{attrs:{id:e.getGUID(),renderImmediately:"",isValid:e.hierarchyValid,title:e.$Labels.MA_Hierarchy}},[s("TreeBuilder",{attrs:{initialState:e.model.root}})],1),e._v(" "),s("Tab",{attrs:{id:e.getGUID(),renderImmediately:"",isValid:!e.$v.model.aggregations.$error,title:e.$Labels.MA_Aggregations}},[s("Aggregations",{attrs:{aggregations:e.model.aggregations,validator:e.$v.model.aggregations},on:{deleteAggregation:e.deleteAggregation}}),e._v(" "),e.$v.$dirty&&!e.$v.model.aggregations.noAggregationDuplicates?s("div",[e._v(e._s(e.$Labels.MA_Territory_No_Duplicate_Aggregations))]):e._e(),e._v(" "),e.$v.$dirty&&!e.$v.model.aggregations.required?s("div",{staticClass:"slds-notify_container slds-notify_container--inline slds-is-relative slds-p-around_large"},[s("div",{staticClass:"slds-notify slds-notify--alert slds-theme--error slds-theme--alert-texture slds-banner"},[s("h2",{staticClass:"slds-grid slds-grid_vertical-align-center"},[s("span",{staticClass:"ma-icon ma-icon-medium ma-icon-ban slds-icon slds-icon--x-small slds-m-right--x-small"}),e._v(" "),s("span",{staticClass:"slds-text-body_regular"},[e._v(e._s(e.$Labels.MA_Territory_Missing_Aggregation))])])])]):e._e()],1),e._v(" "),null!=e.model.territory.Id?s("Tab",{attrs:{id:e.getGUID(),title:e.$Labels.MA_Manage}},[s("Manage",{attrs:{territoryLayerId:e.model.territory.Id,aggregations:e.model.aggregations,territoryNodes:e.model.root}})],1):e._e()],1)],1),e._v(" "),s("div",{attrs:{slot:"footer"},slot:"footer"},[s("button",{staticClass:"slds-button slds-button_neutral",on:{click:function(t){return e.$emit("close")}}},[e._v("\n            "+e._s(e.$Labels.MA_Cancel)+"\n        ")]),e._v(" "),s("button",{staticClass:"slds-button slds-button_brand",on:{click:e.save}},[e._v("\n            "+e._s(e.$Labels.MA_Save)+"\n        ")]),e._v(" "),s("button",{staticClass:"slds-button slds-button_brand",on:{click:function(t){return e.save(t,!0)}}},[e._v("\n            "+e._s(e.$Labels.MA_Save_Start_Aggregation)+"\n        ")])])])}),[],!1,null,"2cd98bbc",null).exports},data:()=>({doRender:!1,layer:{}}),created(){this.$bus.$on("render-territory-builder",(e=>{this.doRender=!0,this.layer=e}))},destroyed(){this.$bus.$off("render-territory-builder")}},x=(0,n.Z)(w,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return e.doRender?s("TerritoryLayer",{attrs:{layer:e.layer},on:{close:function(t){e.doRender=!1}}}):e._e()}),[],!1,null,null,null).exports}}]);