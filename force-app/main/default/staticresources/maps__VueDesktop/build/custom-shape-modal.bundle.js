"use strict";(globalThis.webpackChunkmaps_desktop=globalThis.webpackChunkmaps_desktop||[]).push([[913],{7570:(e,t,o)=>{o.r(t),o.d(t,{default:()=>c});var s=o(257),l=o(1515),i=o(4023),a=o(7102);const{jQuery:r}=window,n={components:{Spinner:l.$j,Modal:l.u_,Tabs:l.mQ,Tab:l.OK,ChromePicker:i.Chrome,Picklist:l.Gp,Checkbox:l.XZ,TextInput:l.oi},directives:{"click-outside":a.Z},props:{modalOptions:{type:Object,default:()=>{}}},data:()=>({isLoading:!1,infoDisabled:!1,folderDisabled:!1,optionsDisabled:!1,selectedColor:{hex:"#ffffff"},territory:{Id:null,Name:"",maps__Description__c:"",maps__User__c:null,maps__Folder__c:null},shapeOptions:{advancedOptions:{calculateTerritoryAggregates:!1,dissolveGeometry:!0},colorOptions:{fillColor:{hex:"#3083D3"},borderColor:{hex:"#16325C"},fillOpacity:"0.2",labelEnabled:!1,labelOverride:"",labelJustification:"center",labelFontSize:"10px",labelFontColor:{hex:"#FFFFFF"},labelBGColor:{hex:"#000000"},labelBGOpacity:"0.3"},country:"USA"},colorPickerVisible:!1,activeColorLocation:"fill",opacityOptions:[{label:"10%",value:"0.1"},{label:"20%",value:"0.2"},{label:"30%",value:"0.3"},{label:"40%",value:"0.4"},{label:"50%",value:"0.5"},{label:"60%",value:"0.6"},{label:"70%",value:"0.7"},{label:"80%",value:"0.8"},{label:"90%",value:"0.9"},{label:"100%",value:"1"}],justificationOptions:[{label:"Left",value:"left"},{label:"Center",value:"center"},{label:"Right",value:"right"}],fontOptions:[{label:"8px",value:"8px"},{label:"9px",value:"9px"},{label:"10px",value:"10px"},{label:"11px",value:"11px"},{label:"12px",value:"12px"},{label:"13px",value:"13px"},{label:"14px",value:"14px"},{label:"15px",value:"15px"},{label:"16px",value:"16px"},{label:"17px",value:"17px"},{label:"18px",value:"18px"}],shapeData:[],shapeType:"",isClone:!1,isSavedLayer:!1,isPlotted:!1}),computed:{clickOutsideOptions(){return{active:!0,handler:this.closeColorPicker}},saveButtonText(){return this.isPlotted?this.$Labels.MA_SAVE_AND_REFRESH:this.$Labels.MA_SAVE_AND_PLOT}},async created(){const{isKML:e=!1,shape:t=null,id:o=null,isClone:s=!1,isPlotted:l=!1}=this.modalOptions;if(this.isClone=s,this.isPlotted=l,e?(this.optionsDisabled=!0,this.shapeData=[{isCustom:!0,id:this.modalOptions.kmlId,proximityType:"KML",kmlResourceType:this.modalOptions.kmlResourceType}]):t&&this.buildShapeData(t),o){this.isSavedLayer=!s,this.folderDisabled=!s,this.isLoading=!0;try{const e=await this.getSavedShapeInfo(o);this.parseSavedData(e)}catch(e){this.showError(e.message)}this.isLoading=!1}},mounted(){const e=this;r("#SaveShapeTree").jstree({json_data:{data:"",ajax:{url:window.MA.resources.TreeXML,data:e=>({id:e.attr?e.attr("id"):0,rand:(new Date).getTime(),type:e.attr?e.attr("NodeType"):0,types:"Folder"})}},core:{animation:10,strings:{loading:"Loading...",new_node:"New Folder"}},plugins:["themes","json_data","ui","crrm","types"]}).on("load_node.jstree load_node_json.jstree",(()=>{r("#SaveShapeTree li").each(((t,o)=>{const s=r(o),l=s.attr("nodetype"),i=!!s.attr("create");(window.MASystem.User.IsCorporateAdmin||("CorporateRoot"!==l||i)&&("CorporateFolder"!==l||i))&&"RoleRoot"!==l&&"RoleNameFolder"!==l||s.addClass("disabled").find("> a > .jstree-checkbox").addClass("copyto-disabled"),e.territory.Id===s.attr("id")&&s.addClass("selected")}))})).bind("select_node.jstree",((e,t)=>{const o=t.rslt.obj;r("#SaveShapeTree li").removeClass("selected"),o.addClass("selected")})),this.$nextTick((()=>{this.setInputColors(),this.optionsDisabled&&this.disableTab("Options"),this.folderDisabled&&this.disableTab("Folder")}))},methods:{close(){this.$emit("close")},toggleColorPicker(e){if(this.colorPickerVisible&&this.activeColorLocation!==e)return void this.closeColorPicker();let t;this.activeColorLocation=e,this.colorPickerVisible=!this.colorPickerVisible,"fill"===e?t=this.shapeOptions.colorOptions.fillColor:"border"===e?t=this.shapeOptions.colorOptions.borderColor:"font"===e?t=this.shapeOptions.colorOptions.labelFontColor:"font_background"===e&&(t=this.shapeOptions.colorOptions.labelBGColor),this.selectedColor=t,this.$nextTick(this.setInputBackgroundColor.bind(this,e,t.hex))},setInputBackgroundColor(e,t){this.checkColorOffScreen(e),document.querySelector(`.dynamicBackground.${e} input`)&&(document.querySelector(`.dynamicBackground.${e} input`).style.backgroundColor=t)},disableTab(e){document.querySelector(`#CustomShapePopup .slds-tabs_default__item[title="${e}"]`).classList.add("tab-disabled")},checkColorOffScreen(e){const t=this.$refs[e];let o;t&&t.$el&&(o=t.$el.getBoundingClientRect().top+50);const s=Math.max(document.documentElement.clientHeight,window.innerHeight||0),l=this.$refs.colorPicker;if(l){const{$el:e}=l;e.style.top=`${o}px`;const t=e.getBoundingClientRect(),{bottom:i}=t;i>s&&(e.style.bottom="0",e.style.top="inherit"),e.style.left="30px"}},closeColorPicker(){switch(this.activeColorLocation){case"fill":this.shapeOptions.colorOptions.fillColor=this.selectedColor;break;case"border":this.shapeOptions.colorOptions.borderColor=this.selectedColor;break;case"font":this.shapeOptions.colorOptions.labelFontColor=this.selectedColor;break;case"font_background":this.shapeOptions.colorOptions.labelBGColor=this.selectedColor}this.$nextTick((()=>{this.setInputBackgroundColor(this.activeColorLocation,this.selectedColor.hex)})),this.colorPickerVisible=!1},saveShape(e){let t,o,l;if(this.isLoading=!0,this.isSavedLayer)l=this.territory.Id,o=this.territory.maps__Folder__c;else{const e=document.querySelector("#CustomShapePopup #SaveShapeTree .selected");if(!e)return this.showError("Please select a folder."),void(this.isLoading=!1);const s=e.getAttribute("nodetype"),l=window.MASystem.User.IsCorporateAdmin;if("PersonalRoot"===s)t=window.MA.CurrentUser.Id;else if("CorporateRoot"===s){if(!l)return this.showError("You do not have permissions to save to this folder"),void(this.isLoading=!1)}else if("CorporateFolder"===s){const t="true"===e.getAttribute("create");if(!l&&!t)return this.showError("You do not have permissions to save to this folder"),void(this.isLoading=!1);o=e.getAttribute("id")}else o=e.getAttribute("id")}if(""===this.territory.Name)return this.showError("Please enter a name."),void(this.isLoading=!1);const{colorOptions:i}=this.shapeOptions,a={advancedOptions:{calculateTerritoryAggregates:!1,dissolveGeometry:!0},colorOptions:{fillColor:i.fillColor.hex,borderColor:i.borderColor.hex,fillOpacity:i.fillOpacity,labelEnabled:i.labelEnabled,labelOverride:i.labelOverride,labelJustification:i.labelJustification,labelFontSize:i.labelFontSize,labelFontColor:i.labelFontColor.hex,labelBGColor:i.labelBGColor.hex,labelBGOpacity:i.labelBGOpacity},country:"USA"},r=[];for(let e=0;e<this.shapeData.length;e++){const t=this.shapeData[e];r.push({Name:`${this.territory.Name}-geometry${e}`,maps__Geometry__c:JSON.stringify(t)})}const n={ajaxResource:"TerritoryAJAXResources",action:"saveBoundaryInfoV2",serializedTerritory:JSON.stringify({Id:l,Name:this.territory.Name,maps__Description__c:this.territory.maps__Description__c||"",maps__User__c:t,maps__Folder__c:o,maps__Options__c:JSON.stringify(a),maps__CustomGeometry__c:!0}),serializedGeometry:JSON.stringify(r)};(new s.Z).setAction("maps.RemoteFunctions.processAJAXRequest").setErrorHandler((e=>{console.warn(e),this.showError("Unable to save shape layer."),this.isLoading=!1})).invoke([n],(t=>{const{success:o=!1,data:s={}}=t;if(o){if(e){let e;e=this.isPlotted?document.querySelector(`.PlottedShapeLayer[qid="${this.modalOptions.qid}"]`):this.modalOptions.isClone?document.querySelector(`.proximity.layer[qid="${this.modalOptions.qid}"]`):document.querySelector(`.proximity.layer[qid="${this.modalOptions.shape.qid}"]`),e&&e.querySelector(".btn-remove").click(),window.MACustomShapes.drawV2({id:s.Id})}this.$bus.$emit("refresh-folder"),this.close()}else console.warn(t),this.showError("Unable to save shape layer.");this.isLoading=!1}),{buffer:!1,escape:!1})},getSavedShapeInfo:e=>new Promise(((t,o)=>{const l={ajaxResource:"TerritoryAJAXResources",action:"getTerritory",id:e};(new s.Z).setAction("maps.RemoteFunctions.processAJAXRequest").setErrorHandler((()=>{o(new Error("Unable to get shape layer info"))})).invoke([l],(e=>{const{success:s=!1,data:l={}}=e;s?t(l):o(new Error("Unable to get shape layer info"))}),{buffer:!1,escape:!1})})),parseSavedData(e){const{territory:t={}}=e,{maps__Options__c:o="{}"}=t;let s;try{s=JSON.parse(o);const{colorOptions:e={}}=s;e.fillColor={hex:e.fillColor},e.borderColor={hex:e.borderColor},e.labelFontColor={hex:e.labelFontColor},e.labelBGColor={hex:e.labelBGColor}}catch(e){this.showError("Error grabbing previously saved options. Manual updates will be needed.")}this.shapeOptions=s;const l={...this.territory,...t};this.territory=l,this.$nextTick((()=>{this.setInputColors()}));const i=t.maps__ShapeLayerGeometries__r.records||[];this.shapeData=[];for(let e=0;e<i.length;e++){const t=i[e];"KML"===JSON.parse(t.maps__Geometry__c).proximityType&&(this.optionsDisabled=!0,this.disableTab("Options")),this.shapeData.push(JSON.parse(t.maps__Geometry__c))}this.isClone&&(this.territory.Name=`Copy of ${this.territory.Name}`)},setInputColors(){this.setInputBackgroundColor("fill",this.shapeOptions.colorOptions.fillColor.hex),this.setInputBackgroundColor("border",this.shapeOptions.colorOptions.borderColor.hex),this.setInputBackgroundColor("font",this.shapeOptions.colorOptions.labelFontColor.hex),this.setInputBackgroundColor("font_background",this.shapeOptions.colorOptions.labelBGColor.hex)},showError(e){window.MAToastMessages.showError({message:e,timeout:7e3})},buildShapeData(e){if("function"==typeof e.getCenter){this.shapeType="circle";const t=e.getCenter();this.shapeData=[{proximityType:"Circle",center:{lat:t.lat(),lng:t.lng()},radius:e.getRadius(),isCustom:!0}]}else if(e.isTravelGeom)this.shapeData=[e.saveData]||0;else if("function"==typeof e.getPath){this.shapeType="polygon";let t={proximityType:"Polygon",points:[],isCustom:!0};const o=e.getPath();for(let e=0;e<o.getLength();e++){const s=o.getAt(e);t.points.push({lat:s.lat(),lng:s.lng()})}this.shapeData=[t],t=null}else if("function"==typeof e.getBounds){this.shapeType="rectangle";let t={proximityType:"Rectangle",bounds:{},isCustom:!0};const o=e.getBounds(),s=o.getNorthEast(),l=o.getSouthWest();t.bounds={NE:{lat:s.lat(),lng:s.lng()},SW:{lat:l.lat(),lng:l.lng()}},this.shapeData=[t],t=null}}}},c=(0,o(1900).Z)(n,(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("Modal",{staticClass:"slds-modal_medium",attrs:{id:"CustomShapePopup",title:"Create/Edit Custom Shape Layer",labels:{close:e.$Labels.MA_Close}},on:{close:e.close}},[o("div",{attrs:{slot:"content"},slot:"content"},[o("Spinner",{directives:[{name:"show",rawName:"v-show",value:e.isLoading,expression:"isLoading"}]}),e._v(" "),o("Tabs",{staticClass:"ma-advanced-tabs"},[o("Tab",{attrs:{id:"info",disabled:e.infoDisabled,renderImmediately:"",title:"Info"}},[o("TextInput",{staticClass:"slds-p-vertical_xx-small",attrs:{required:"",labels:{name:e.$Labels.MA_Name}},model:{value:e.territory.Name,callback:function(t){e.$set(e.territory,"Name",t)},expression:"territory.Name"}}),e._v(" "),o("TextInput",{staticClass:"slds-p-vertical_xx-small",attrs:{labels:{name:e.$Labels.MA_Description},useTextArea:""},model:{value:e.territory.maps__Description__c,callback:function(t){e.$set(e.territory,"maps__Description__c",t)},expression:"territory.maps__Description__c"}})],1),e._v(" "),o("Tab",{staticClass:"test",attrs:{id:"folder",disabled:e.folderDisabled,renderImmediately:"",title:"Folder"}},[o("div",{staticClass:"demo",staticStyle:{"padding-top":"3px"},attrs:{id:"SaveShapeTree"}})]),e._v(" "),o("Tab",{attrs:{id:"options",disabled:e.optionsDisabled,renderImmediately:"",title:"Options"}},[o("h2",{staticClass:"slds-text-heading_small"},[e._v(e._s(e.$Labels.TerritoryBuilder_Color_Selection))]),e._v(" "),o("div",{staticClass:"slds-m-left_x-small"},[o("TextInput",{ref:"fill",staticClass:"dynamicBackground fill slds-form-element_inverse",attrs:{labels:{name:e.$Labels.TerritoryBuilder_Fill_Color,required:e.$Labels.MA_Required}},on:{click:function(t){return e.toggleColorPicker("fill")}},model:{value:e.shapeOptions.colorOptions.fillColor.hex,callback:function(t){e.$set(e.shapeOptions.colorOptions.fillColor,"hex",t)},expression:"shapeOptions.colorOptions.fillColor.hex"}}),e._v(" "),o("TextInput",{ref:"border",staticClass:"dynamicBackground border slds-form-element_inverse",attrs:{labels:{name:e.$Labels.TerritoryBuilder_Border_Color,required:e.$Labels.MA_Required}},on:{click:function(t){return e.toggleColorPicker("border")}},model:{value:e.shapeOptions.colorOptions.borderColor.hex,callback:function(t){e.$set(e.shapeOptions.colorOptions.borderColor,"hex",t)},expression:"shapeOptions.colorOptions.borderColor.hex"}}),e._v(" "),o("Picklist",{staticClass:"slds-m-bottom_small",attrs:{options:e.opacityOptions,labels:{name:e.$Labels.MA_OPACITY},idKey:"value",titleKey:"label"},model:{value:e.shapeOptions.colorOptions.fillOpacity,callback:function(t){e.$set(e.shapeOptions.colorOptions,"fillOpacity",t)},expression:"shapeOptions.colorOptions.fillOpacity"}})],1),e._v(" "),o("h2",{staticClass:"slds-text-heading_small"},[e._v(e._s(e.$Labels.TerritoryBuilder_Label_Options))]),e._v(" "),o("div",{staticClass:"slds-m-left_x-small"},[o("Checkbox",{staticClass:"flex-row slds-form-element",attrs:{labels:{name:e.$Labels.TerritoryBuilder_Label_Enable}},model:{value:e.shapeOptions.colorOptions.labelEnabled,callback:function(t){e.$set(e.shapeOptions.colorOptions,"labelEnabled",t)},expression:"shapeOptions.colorOptions.labelEnabled"}}),e._v(" "),o("TextInput",{attrs:{labels:{name:e.$Labels.TerritoryBuilder_Label_TextOverride}},model:{value:e.shapeOptions.colorOptions.labelOverride,callback:function(t){e.$set(e.shapeOptions.colorOptions,"labelOverride",t)},expression:"shapeOptions.colorOptions.labelOverride"}}),e._v(" "),o("Picklist",{staticClass:"slds-m-bottom_small",attrs:{options:e.justificationOptions,labels:{name:e.$Labels.TerritoryBuilder_Label_Justification},idKey:"value",titleKey:"label"},model:{value:e.shapeOptions.colorOptions.labelJustification,callback:function(t){e.$set(e.shapeOptions.colorOptions,"labelJustification",t)},expression:"shapeOptions.colorOptions.labelJustification"}}),e._v(" "),o("Picklist",{staticClass:"slds-m-bottom_small",attrs:{options:e.fontOptions,labels:{name:e.$Labels.TerritoryBuilder_Label_FontSize},idKey:"value",titleKey:"label"},model:{value:e.shapeOptions.colorOptions.labelFontSize,callback:function(t){e.$set(e.shapeOptions.colorOptions,"labelFontSize",t)},expression:"shapeOptions.colorOptions.labelFontSize"}}),e._v(" "),o("TextInput",{ref:"font",staticClass:"dynamicBackground font slds-form-element_inverse",attrs:{labels:{name:e.$Labels.TerritoryBuilder_Label_FontColor}},on:{click:function(t){return e.toggleColorPicker("font")}},model:{value:e.shapeOptions.colorOptions.labelFontColor.hex,callback:function(t){e.$set(e.shapeOptions.colorOptions.labelFontColor,"hex",t)},expression:"shapeOptions.colorOptions.labelFontColor.hex"}}),e._v(" "),o("TextInput",{ref:"font_background",staticClass:"dynamicBackground font_background slds-form-element_inverse",attrs:{labels:{name:e.$Labels.TerritoryBuilder_Label_BGColor}},on:{click:function(t){return e.toggleColorPicker("font_background")}},model:{value:e.shapeOptions.colorOptions.labelBGColor.hex,callback:function(t){e.$set(e.shapeOptions.colorOptions.labelBGColor,"hex",t)},expression:"shapeOptions.colorOptions.labelBGColor.hex"}})],1),e._v(" "),e.colorPickerVisible?o("ChromePicker",{directives:[{name:"click-outside",rawName:"v-click-outside:[clickOutsideOptions]",arg:e.clickOutsideOptions}],ref:"colorPicker",staticClass:"color-picker",attrs:{value:e.selectedColor.hex,disableAlpha:!0},model:{value:e.selectedColor,callback:function(t){e.selectedColor=t},expression:"selectedColor"}}):e._e()],1)],1)],1),e._v(" "),o("div",{attrs:{slot:"footer"},slot:"footer"},[o("button",{staticClass:"slds-button slds-button_brand",attrs:{disabled:e.isLoading},on:{click:function(t){return e.saveShape(!1)}}},[e._v("\n            "+e._s(e.$Labels.MA_Save)+"\n        ")]),e._v(" "),o("button",{staticClass:"slds-button slds-button_brand",attrs:{disabled:e.isLoading},on:{click:function(t){return e.saveShape(!0)}}},[e._v("\n            "+e._s(e.saveButtonText)+"\n        ")]),e._v(" "),o("button",{staticClass:"slds-button slds-button_neutral",attrs:{disabled:e.isLoading},on:{click:e.close}},[e._v("\n            "+e._s(e.$Labels.MA_Close)+"\n        ")])])])}),[],!1,null,"afbd8bd8",null).exports}}]);