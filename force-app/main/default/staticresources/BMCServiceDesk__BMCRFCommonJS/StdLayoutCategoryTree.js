var categoryId="";var categoryName="";var divHeight;var errorMsg="";var tree;var node;var dataSeparator="Ñ„";var selectedFilterOption=categoryFilter;var searchFlag=true;var nodeLoading=false;var showAllRec=false;var loadingContent='<div style="width:150px"><img src="'+loadingImgSrc+'" style="padding-right:5px;"/>'+loadingText+"</div>";function changeGrouping(){var a=Ext.getCmp("groupoptions");node=Ext.getCmp("groupoptions").getValue();reloadTree()}function pageRefresh(){searchText="";Ext.getCmp("searchTxt").setValue();reloadTree()}function setPanelHeight(){var a=95;if(idValStr!=null&&idValStr!=""){a=100}if(Ext.isIE){return document.documentElement.offsetHeight-a}else{return window.innerHeight-a}}Ext.onReady(function(){Ext.QuickTips.init();document.title=labelSelCategory;divHeight=setPanelHeight();document.getElementById("categoryTreeView").height=divHeight;setCategoryFilter();createToolbar();createCategoryTree();document.getElementById("buttonpanel").style.visibility="visible";tree=Ext.getCmp("categoryTree");Ext.getCmp("categoryRefresh").getEl().on("keydown",function(b,a){if(b.getKey()==9){tree.getSelectionModel().select(tree.getRootNode())}});treeKeyNavigation()});function treeKeyNavigation(){new Ext.KeyMap("categoryTree",{key:Ext.EventObject.ENTER,fn:function(){selectCategory()}});new Ext.KeyMap("categoryTree",{key:Ext.EventObject.SPACE,fn:function(){selectCategory()}});new Ext.KeyMap("categoryTree",{key:109,fn:function(){var a=Ext.getCmp("categoryTree").getSelectionModel().getSelectedNode();if(a.isLeaf()){a.parentNode.collapse();tree.getSelectionModel().select(a.parentNode)}else{a.collapse();tree.getSelectionModel().select(a)}}});new Ext.KeyMap("categoryTree",{key:107,fn:function(){var a=Ext.getCmp("categoryTree").getSelectionModel().getSelectedNode();a.expand();tree.getSelectionModel().select(a)}});new Ext.KeyMap("categoryTree",{key:106,fn:function(){var a=Ext.getCmp("categoryTree").getSelectionModel().getSelectedNode();a.expand();a.expandChildNodes();tree.getSelectionModel().select(a)}});new Ext.KeyMap("categoryTree",{key:8,fn:function(){var a=Ext.getCmp("categoryTree").getSelectionModel().getSelectedNode();if(a.parentNode!=null){tree.getSelectionModel().select(a.parentNode)}}})}function selectCategory(){var a=Ext.getCmp("categoryTree").getSelectionModel().getSelectedNode();categoryName=a.text;categoryId=a.id;validateRecordState()}function createToolbar(){var b=new Ext.form.TextField({id:"searchTxt",name:"searchTxt",cls:(isLightningUI=="true")?"rf-input":"",width:350,value:searchText,fieldLabel:labelSearch,allowBlank:true,emptyText:labelSearch,enableKeyEvents:true});var g=new Ext.Panel({title:"",tbar:[{scale:"medium",iconCls:"bmcView1",tooltipType:"title",id:"filterMenuId",menu:{cls:(isLightningUI=="true")?"rf-menu":"",items:[{xtype:"radio",name:"IncSRCategory",boxLabel:incidentCategories,checked:isIncidentPopup(),iconCls:"emptyIcon",inputValue:"IncidentCat",handler:filterCategory},{xtype:"radio",name:"IncSRCategory",boxLabel:serviceRequestCategories,checked:isServiceRequestPopup(),iconCls:"emptyIcon",inputValue:"SRCat",handler:filterCategory},{text:applyLabel,iconCls:"mnuList",handler:applyFilter}]}}]});var a=new Ext.Spacer({width:10});var d;if(isLightningUI=="true"){d=new Ext.Toolbar({renderTo:"btntoolbar",items:[" "," "," ",b,{iconCls:"bmcSearch",tooltip:labelSearch,tooltipType:"title",id:"categorySearch",handler:textSearch}," ",{scale:"medium",iconCls:"bmcRefresh",tooltip:labelClear,tooltipType:"title",style:{align:"left"},id:"categoryRefresh",handler:pageRefresh},"->",g]});var c=document.getElementById("searchTxt");if(c!=null&&c!=undefined){c.setAttribute("value",searchText)}}else{if(popupId!=null&&popupId!="null"&&(isIncidentPopup()||isServiceRequestPopup())){d=new Ext.Toolbar({renderTo:"btntoolbar",items:[g," "," ","  "," ",b,a,{xtype:"spacer",width:Ext.isIE?20:5},{iconCls:"bmcSearch",tooltip:labelSearch,tooltipType:"title",id:"categorySearch",handler:textSearch}," "," "," ",{scale:"medium",iconCls:"bmcRefresh",tooltip:labelClear,tooltipType:"title",style:{align:"left"},id:"categoryRefresh",handler:pageRefresh}]})}else{d=new Ext.Toolbar({renderTo:"btntoolbar",items:[" "," ","  "," ",b,{xtype:"spacer",width:Ext.isIE?20:5},{iconCls:"bmcSearch",tooltip:labelSearch,tooltipType:"title",id:"categorySearch",handler:textSearch}," "," "," ",{scale:"medium",iconCls:"bmcRefresh",tooltip:labelClear,tooltipType:"title",style:{align:"left"},id:"categoryRefresh",handler:pageRefresh}]})}}var f=function(i,h){if(h.getKey()!=h.ENTER){searchFlag=true}};b.on("keyup",f);var e=function(i,h){if(h.getKey()==h.ENTER){textSearch()}};b.on("specialkey",e)}function selectedCatDBClk(c,b,d){var a=frames.categoryListFrame.grid.store.getAt(b).get("Name");categoryId=d;saveSelectedCategory(categoryId)}function selectedCatSingleClk(c,b,d){var a=frames.categoryListFrame.grid.store.getAt(b).get("Name");categoryId=d}function select_node(a){if((a.childNodes.length!=undefined)&&(a.childNodes.length>0)){a.childNodes[0].select()}tree.un("expandnode",select_node)}function createCategoryTree(){root=new Ext.tree.AsyncTreeNode({expanded:true,id:"0",text:labelCatByDesc,loader:new Ext.tree.TreeLoader({url:page_CMDBJsonGenerator+getParams(),requestMethod:"GET"})});new Ext.Panel({renderTo:"categoryTreeView",height:divHeight,autoScroll:true,items:[{xtype:"treepanel",cls:(isLightningUI=="true")?"rf-lightning-tree":"",autoWidth:true,margins:"0 10 0 0",autoScroll:true,useArrows:true,split:true,id:"categoryTree",border:false,margins:"0 5 0 0",cmargins:"0 5 0 0",animate:true,titleCollapse:true,root:root,containerScroll:true,listeners:{afterrender:function(a){},click:function(a){if(a==this.getRootNode()){return}categoryId=a.id;categoryName=a.text},dblclick:function(a){if(a==this.getRootNode()){return}categoryId=a.id;categoryName=a.text;if(!a.leaf&&a.isLoading()){nodeLoading=true}validateRecordState()},load:function(a){if(nodeLoading&&FormTag!="closepage"){window.close()}}}}]});tree=Ext.getCmp("categoryTree");tree.getRootNode().expand();tree.bwrap.addListener("mouseover",showDescTooltip,this,{buffer:200});tree.on("expandnode",select_node)}function isCJKChar(c){var b=/[\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/;var a=b.test(c);return(a)}function textSearch(){if(searchFlag==true){searchText=Ext.getCmp("searchTxt").getValue();if((searchText.trim().length<2&&!isCJKChar(searchText))||document.getElementById("searchTxt").value==labelSearch){Ext.MessageBox.show({msg:minCharsForSearchlabel,cls:(isLightningUI=="true")?"rf-message":"",title:warningTitleSearchLabel,buttons:Ext.MessageBox.OK,width:300,icon:Ext.MessageBox.WARNING});return}reloadTree();searchFlag=false}searchText=""}function isServiceRequestPopup(){if(popupId!=null&&popupId!="null"&&popupId!=""&&popupId=="incident"&&isServiceRequest=="true"){return true}else{return false}}function isIncidentPopup(){if(popupId!=null&&popupId!="null"&&popupId!=""&&popupId=="incident"&&isServiceRequest=="false"){return true}else{return false}}function isSSIncidentPopup(){if(popupId!=null&&popupId!="null"&&popupId!=""&&popupId=="incident"&&categoryFilter=="SSINC"){return true}else{return false}}function filterCategory(b,a){if(a){selectedFilterOption=b.inputValue}}function applyFilter(){if(selectedFilterOption=="IncidentCat"){categoryFilter="INC"}else{categoryFilter="SR"}reloadTree()}function setCategoryFilter(){if(isIncidentPopup()){categoryFilter="INC"}else{if(isServiceRequestPopup()){categoryFilter="SR"}else{if(isSSIncidentPopup()){categoryFilter="SSINC"}else{categoryFilter=""}}}}function getParams(){var a="?type=getCategoryTree&popupId="+popupId+"&searchText="+encodeURIComponent(searchText)+"&filter="+categoryFilter+"&forSR="+forSR+"&idValStr="+idValStr;if(showAllRec){a+="&isAll=true"}else{a+="&isAll=false"}if(window.parent&&window.parent.parent&&window.parent.parent.parent&&window.parent.parent.parent.MultiPageLayoutEnabled=="true"){a+="&recType="+encodeURIComponent(layoutId)}return a}var enableToggleLink=function(){var b=document.getElementById("showfilter");var a=document.getElementById("showall");if(showAllRec&&b!=null&&b!=undefined){b.style.display="block"}else{if(!showAllRec&&a!=null&&a!=undefined){a.style.display="block"}}};function reloadTree(){tree=Ext.getCmp("categoryTree");tree.loader.url=page_CMDBJsonGenerator+getParams();tree.loader.load(tree.getRootNode(),enableToggleLink);tree.getRootNode().expand()}function validateRecordState(){if(typeof(state)!=undefined&&(state=="true"||state=="1")){if(categoryId!=null&&categoryId!="null"&&categoryId!=""){try{if(typeof(isServiceRequest)!="undefined"&&isServiceRequest=="false"&&typeof(window.opener)!="undefined"){if(typeof(window.opener.isAutoClassificationEnable)!="undefined"&&window.opener.isAutoClassificationEnable){if(typeof(window.opener.modifiedCategorizationMode)!="undefined"){window.opener.modifiedCategorizationMode=""}}}}catch(a){}if(typeof(FormTag)!="undefined"&&FormTag!=""){closeWindowAfterSave()}else{saveSelectedCategory(categoryId)}}else{showErrorMessage(selectCategoryLabel)}}else{showErrorMessage(getRecordClosedLabel())}}function getRecordClosedLabel(){if(popupId=="incident"){return incidentClosedLabel}else{if(popupId=="task"){return taskClosedLabel}}if(popupId=="changerequest"){return changeRequestClosedLabel}if(popupId=="problem"){return problemClosedLabel}if(popupId=="release"){return releaseClosedLabel}if(popupId=="broadcast"){return broadcastClosedLabel}}function closeWindowAfterSave(){if(errorMsg==null||errorMsg==""||errorMsg=="null"){categoryName=Ext.util.Format.htmlDecode(categoryName);if(typeof(FormTag)!="undefined"&&FormTag!=""){if(FormTag=="catDtlFrm"){window.opener.categoryfields(categoryId,categoryName,true,TextBox)}else{if(FormTag=="changelookupValues"&&typeof(window.opener)!="undefined"){window.opener.changelookupValues(categoryId,categoryName)}else{if(isCalledFromConsole=="true"&&typeof(window.opener)!="undefined"){window.opener.setLookUpField(FormTag,categoryId,categoryName)}else{if(FormTag=="closepage"){window.opener.setPopUpValue(categoryId,categoryName);window.close();return}else{if(FormTag=="catRDFrm"){window.parent.setCategoryfields(categoryId,categoryName);closeWindow();return}else{if(forSR=="true"){var a=categoryId+dataSeparator+categoryName;window.opener.lookupValue(a)}else{if(typeof(window.opener.categoryfields)=="function"){window.opener.categoryfields(categoryId,categoryName,false,TextBox)}window.opener.lookupPick2(FormTag,TextBox+"_lkid",TextBox,categoryId,categoryName,false)}}}}}}}else{if(stdForm=="false"){getOpener().location.href="/"+recordId}else{getOpener().refreshRecord()}}if(!nodeLoading){window.close()}}else{showErrorMessage(errorMsg);errorMsg=null}}function showErrorMessage(a){Ext.MessageBox.show({msg:a,cls:(isLightningUI=="true")?"rf-message":"",width:300,buttons:Ext.MessageBox.OK})}function showDescTooltip(g,j){var b=Ext.fly(j).up("li.x-tree-node");if(b){var i=Ext.getDom(b);var c=i.getElementsByTagName("DIV")[0];var f=c.getAttribute("ext:tree-node-id");var h=Ext.getCmp("categoryTree").getNodeById(f);var a=h.attributes.hasDesc;if(f!="0"&&h&&typeof(a)=="undefined"||a==1){var d=createNodeTip(c,loadingContent);Visualforce.remoting.Manager.invokeAction(_RemoteActionGetCatDesc,f,function(e,k){if(k.status){e=e.split("\n").join("<br />");d.destroy();h.attributes.hasDesc=0;d=createNodeTip(c,e)}},{escape:true})}}}function createNodeTip(b,a){if(typeof(b)!="undefined"&&b!=null&&a!=""){return new Ext.ToolTip({target:b,html:a,cls:(isLightningUI=="true")?"rf-tooltip":"",constrainPosition:true,trackMouse:true})}}Ext.override(Ext.ToolTip,{onMouseMove:function(c){var a=c.getTarget(this.delegate);if(a){this.targetXY=c.getXY();if(a===this.triggerElement){if(!this.hidden&&this.trackMouse){var b=this.getTargetXY();if(this.constrainPosition){b=this.el.adjustForConstraints(b);b[1]=b[1]-10}this.setPagePosition(b)}}else{this.onTargetOver(c)}}else{if(!this.closable&&this.isVisible()){this.hide()}}}});function toggleFilter(a){showAllRec=a;if(a){document.getElementById("showall").style.display="none"}else{document.getElementById("showfilter").style.display="none"}reloadTree()}function closeWindow(){if(isCalledFromRD&&modalType&&isCalledFromRD=="true"){window.parent.rfPopUpClose(modalType)}else{window.close()}};