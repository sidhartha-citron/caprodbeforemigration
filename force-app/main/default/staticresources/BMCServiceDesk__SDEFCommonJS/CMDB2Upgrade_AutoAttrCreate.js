if(typeof(console)=="undefined"||console==null){console={log:function(){}}}var selectedRowSize=0;var error_count=0;function xmlToObj(a){var b;if(window.DOMParser){parser=new DOMParser();b=parser.parseFromString(a,"text/xml")}else{b=new ActiveXObject("Microsoft.XMLDOM");b.async=false;b.loadXML(a)}return xmlToJson(b)}function xmlToJson(c){var h={};if(c.nodeType==1){if(c.attributes.length>0){h["@attributes"]={};for(var b=0;b<c.attributes.length;b++){var g=c.attributes.item(b);h["@attributes"][g.nodeName]=g.nodeValue}}}else{if(c.nodeType==3){h=c.nodeValue}}if(c.hasChildNodes()){for(var d=0;d<c.childNodes.length;d++){var f=c.childNodes.item(d);var k=f.nodeName;if(typeof(h[k])=="undefined"){h[k]=xmlToJson(f)}else{if(typeof(h[k].push)=="undefined"){var a=h[k];h[k]=[];h[k].push(a)}h[k].push(xmlToJson(f))}}}return h}function showStatus(){ListViewStore.loadRawData(customAttributesData)}function createAttr(a,b){showStatus();Visualforce.remoting.Manager.invokeAction(_remote_createAttr,end_point,a.fullName,a.info.classApiName,a.info.fieldApiName,function(c,d){if(d.status){console.log(c);b(c.response,a)}else{if(d.type==="exception"){console.log(d.message)}}},{escape:false})}var TARGET_OBJECT_NAME=BEName;var attr_queue=[];var attr_all=[];var waitTime=100;function createAttributesComplete(){console.log("Creating Attributes complete");Ext.Msg.show({msg:label_completed_adding_items,buttons:Ext.Msg.OK,fn:function(a){if(error_count!=selectedRowSize){window.opener.scanDisable()}if(error_count==0){window.close()}}})}function checkStatus(b,a){Visualforce.remoting.Manager.invokeAction(_remote_checkStatus,end_point,b,function(c,d){if(d.status){a(c)}else{if(d.type==="exception"){console.log(d.message)}}},{escape:false})}function processAttributes(i,c){showStatus();if(i==null){if(attr_queue.length>0){var f=attr_queue.shift();createAttr(f,processAttributes);f.status="submitted"}else{createAttributesComplete()}}else{var j=null;var b=null;try{b=xmlToObj(i);j=b["soapenv:Envelope"]["soapenv:Body"].createResponse.result}catch(d){console.log("Error while parsing response XML response (1) ",d,b);try{var g=b["soapenv:Envelope"]["soapenv:Body"]["soapenv:Fault"];console.log(g.faultcode["#text"]);console.log(g.faultstring["#text"])}catch(h){}j=null;b=null}if(j!=null){var a=j.id["#text"];checkStatus(a,function(o){var l=false;var m=null;var k;try{k=xmlToObj(o);m=k["soapenv:Envelope"]["soapenv:Body"].checkStatusResponse.result}catch(q){console.log("Error while parsing response XML response (2) ",q,k);try{var p=k["soapenv:Envelope"]["soapenv:Body"]["soapenv:Fault"];console.log(p.faultcode["#text"]);console.log(p.faultstring["#text"])}catch(n){}m=null}l=(m.done["#text"].toLowerCase()=="true");try{c.StatusResultMessage=m.message["#text"];c.StatusResultState=m.state["#text"];if(c.StatusResultState.toLowerCase()=="error"){error_count++}}catch(q){}if(l){c.status="completed";processAttributes(null,null);waitTime=100}else{setTimeout(function(){c.poll_count++;processAttributes(i,c);waitTime=waitTime*2;if(waitTime>3000){waitTime=3000}},waitTime)}})}}}function createAttributes(){attr_queue=[];attr_all=[];var c=ListViewGrid.getSelectionModel().getSelection();selectedRowSize=c.length;if(c.length==0){noFieldSelected()}else{for(var b=0;b<c.length;b++){var d=c[b];var a=customAttributesDataMap[d.raw.internal_id];a.status="queued";attr_all.push(a);attr_queue.push(a)}processAttributes(null)}}function noFieldSelected(){Ext.Msg.show({msg:label_no_field_selected,buttons:Ext.Msg.OK})}var customAttributesData=[];var customAttributesDataMap={};var json_customization_data=[];var lookups_within_cmdb_suggested_names=[];try{json_customization_data=JSON.parse(json_customization_string)}catch(e){}try{lookups_within_cmdb_suggested_names=JSON.parse(LookupsWithinCMDB_JSON)}catch(e){}var lookup_count=0;function createDataArray(){lookup_count=0;for(var b=0;b<json_customization_data.length;b++){if(BEName==json_customization_data[b].classApiName){continue}var f="_int_id__"+b;var d=json_customization_data[b].suggestedFieldApiName;d=d.split("*").join("");json_customization_data[b].suggestedFieldApiName=d;var a={internal_id:f,info:json_customization_data[b],status:"-",poll_count:0,fullName:TARGET_OBJECT_NAME+"."+d+"__c",StatusResultMessage:null,StatusResultState:null,isRollupSummary:false,isMasterDetail:false};if(a.info.fieldType.toLowerCase()==label_master_detail.toLowerCase()){a.isMasterDetail=true;a.StatusResultMessage=label_fieldtype_not_supported}if(a.info.fieldType.toLowerCase()==label_rollupsummary.toLowerCase()){a.isRollupSummary=true;a.StatusResultMessage=label_fieldtype_not_supported}if(BEFields.indexOf(d.toLowerCase()+"__c")>=0){a.StatusResultMessage=label_field_exists}if(lookups_within_cmdb_suggested_names.indexOf(d.toLowerCase())>=0){a.StatusResultMessage=label_lookup_within_cmdb}if(a.info.isAutoNumber.toLowerCase()=="true"){a.StatusResultMessage=label_change_display_format}console.log(a);var c=(a.info.referenceTo!=null&&a.info.referenceTo.toLowerCase()!="na"&&a.info.referenceTo.toLowerCase()!="");a.info.size="";if(!c){if(a.info.length.toLowerCase()!="na"&&a.info.length.toLowerCase()!=""){a.info.size=a.info.length;if(a.info.scale.toLowerCase()!="na"&&a.info.scale.toLowerCase()!=""){a.info.size+=","+a.info.scale}}}if(c&&(BEFields.indexOf(d.toLowerCase()+"__c")<0)){lookup_count++}customAttributesDataMap[f]=a;customAttributesData.push(a)}}createDataArray();Ext.require(["Ext.grid.*","Ext.data.*","Ext.util.*","Ext.state.*"]);function calcStatus(d,a,b){var c=null;if(d=="submitted"){c="loading.gif"}else{if(d=="completed"){if(b.raw.StatusResultState&&b.raw.StatusResultState.toLowerCase()=="error"){c="exclamation.gif"}else{c="accept.png"}}else{if(d=="queued"){c="up2.gif"}}}if(c!=null){return'<img src ="'+(base_img_path+"/"+c)+'" />'}else{return null}}function isDisabledRow(a){var b=a.data.info.suggestedFieldApiName.toLowerCase();return(BEFields.indexOf(b+"__c")>=0||lookups_within_cmdb_suggested_names.indexOf(b)>=0||a.data.isMasterDetail||a.data.isRollupSummary)}Ext.onReady(function(){Ext.QuickTips.init();var a=[];if(customAttributesData.length>0){var c=customAttributesData[0];for(var b in c){a.push(b)}c=customAttributesData[0].info;for(var b in c){a.push("info."+b)}}ListViewStore=Ext.create("Ext.data.JsonStore",{fields:a,data:customAttributesData,proxy:{type:"memory",reader:{idProperty:"Id",type:"json"}}});ListViewGrid=Ext.create("Ext.grid.Panel",{id:"listViewGridPanelId",stripeRows:true,height:600,renderTo:"grid-div",selModel:Ext.create("Ext.selection.CheckboxModel",{checkOnly:true}),store:ListViewStore,viewConfig:{getRowClass:function(d,f){if(ListViewStore.getCount()>499){return"disabled-row"}else{if(isDisabledRow(d)){return"disabled-row"}}}},listeners:{beforeselect:function(g,d,f){if(ListViewStore.getCount()>499){return false}else{if(isDisabledRow(d)){return false}}},selectionchange:function(f,d){if(d.length>0){Ext.Array.each(d,function(g){if(isDisabledRow(g)){f.deselect(g,true)}})}}},tbar:[{xtype:"button",id:"addButton",text:label_add_selections_to_be,tooltip:label_add_selections_to_be,handler:function(){createAttributes()}}],autoScroll:true,columns:[{header:label_col_source_class,dataIndex:"info.classLabel",sortable:false},{header:label_col_field,dataIndex:"info.fieldLabel",sortable:false},{header:label_col_suggest_api,dataIndex:"info.suggestedFieldApiName",sortable:false},{header:label_col_data_type_details,dataIndex:"info.fieldType",sortable:false},{header:label_col_size,dataIndex:"info.size",sortable:false},{header:label_col_status,renderer:calcStatus,dataIndex:"status",sortable:false},{header:label_col_message,dataIndex:"StatusResultMessage",sortable:false,renderer:function(f,d){if(f!=null&&f!="null"&&f!="undefined"&&f!=""){f=Ext.String.htmlEncode(f);d.tdAttr='data-qtip="'+Ext.String.htmlEncode(f)+'"'}return f}}],enableColumnHide:false,autoExpandColumn:"StatusResultMessage",forceFit:true});setTimeout(function(){if(lookup_count>5){Ext.Msg.show({msg:label_lookups_high,buttons:Ext.Msg.OK})}if(customAttributesData.length>500){Ext.Msg.show({msg:label_too_many_fields,buttons:Ext.Msg.OK});Ext.getCmp("addButton").setDisabled(true)}},300)});