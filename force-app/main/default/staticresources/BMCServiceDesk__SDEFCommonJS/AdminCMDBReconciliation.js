var selectedClassId;var rowCount=0;var rowIdCount=0;var fieldArray=[];var logicalStmt=getFilterLogic().value;var isDirty=false;Ext.onReady(function(){createTopToolbar();if(isCIManagementEnabled&&isAssetManagementEnabled){createClassTypeComboBox()}else{document.getElementById("ClassTypeTableRow").style.display="none"}createClassNameComboBox();LoadFieldData()});function createClassTypeComboBox(){var b=Ext.create("Ext.data.Store",{fields:["value","name"],data:[{value:"CI",name:CI},{value:"Asset",name:Asset},{value:"CI and Asset",name:CIandAsset}]});var a=Ext.create("Ext.form.ComboBox",{id:"classType",store:b,queryMode:"local",hiddenName:"classTypeCombo",displayField:"name",valueField:"value",value:CMDBClassTypeCombo,forceSelection:true,selectOnFocus:true,width:280,renderTo:"CMDBClassType",listeners:{change:function(g,f,c){var e=Ext.getCmp("className");if(e){e.clearValue();selectedClassId="";markAsDirty();var d=Ext.getCmp("className").store;d.clearFilter(true);d.filter(namespacePrefix+"CMDBClassType__c",f)}}}})}function createClassNameComboBox(){var a=Ext.create("Ext.data.Store",{fields:["Id",namespacePrefix+"ClassName__c",namespacePrefix+"Activate__c",namespacePrefix+"Class_Label__c",namespacePrefix+"CMDBClassType__c",namespacePrefix+"FKCMDB_Class__r",namespacePrefix+"ShortDescription__c"],sorters:[{property:namespacePrefix+"Class_Label__c",direction:"ASC"}],data:classStoreData,listeners:{load:function(d){var g=d.queryBy(function(j,k){return(j.get(namespacePrefix+"CMDBClassType__c")=="Asset"&&j.get(namespacePrefix+"Activate__c"))});for(i=0;i<g.length;i++){var c=g.get(i);var h=c.get(namespacePrefix+"ShortDescription__c");if(!h){h=NoClassRulesDefined}var e=c.get(namespacePrefix+"FKCMDB_Class__r");var f="\t"+RuleBasedAsset+"\n"+BasedonCIClass+" : "+e[namespacePrefix+"Class__c"]+"\n"+CMDBAssetRule+" : "+h;c.set(namespacePrefix+"ShortDescription__c",f)}}}});var b=Ext.create("Ext.form.ComboBox",{id:"className",store:a,queryMode:"local",hiddenName:"classNameCombo",displayField:namespacePrefix+"Class_Label__c",valueField:namespacePrefix+"ClassName__c",value:CMDBClassNameCombo,forceSelection:true,selectOnFocus:true,width:280,typeAhead:true,typeAheadDelay:500,renderTo:"CMDBClassName",listConfig:{tpl:'<tpl for="."><div class="x-boundlist-item">{'+namespacePrefix+'Class_Label__c:htmlEncode}<tpl if="('+namespacePrefix+"Activate__c == true && "+namespacePrefix+'CMDBClassType__c == \'Asset\')"><img id="RBATooltip" title="{'+namespacePrefix+'ShortDescription__c}" src="'+SDEFStylesResource+'/SDEFicons/url.png" style="float: right;margin-top: -1px;"/></tpl></div></tpl>'},listeners:{change:function(e,d,c){if(d&&d!=c){fetchClassFields(d);selectedClassId=e.valueModels[0].raw.Id;markAsDirty()}},afterrender:function(c){if(isCIManagementEnabled&&isAssetManagementEnabled){if(!CMDBClassTypeCombo){Ext.getCmp("classType").setValue("CI")}else{c.store.clearFilter(true);c.store.filter(namespacePrefix+"CMDBClassType__c",CMDBClassTypeCombo)}if(CMDBClassId){selectedClassId=CMDBClassId}}}}})}function createTopToolbar(){Ext.create("Ext.toolbar.Toolbar",{cls:"toolSpCls",height:35,id:"rf-recon-tbar",renderTo:"btnToolbar",items:[{xtype:"button",scale:"medium",iconCls:"bmcNew",tooltipType:"title",tooltip:tooltipNew,scope:this,id:"newId",handler:function(){window.parent.addTab("AdminCMDBReconciliation",headerWinTab,headerWinTab)}},{scale:"medium",iconCls:"bmcSave",tooltipType:"title",id:"saveId",scope:this,tooltip:tooltipSave,handler:SaveBtnHandler},{scale:"medium",tooltipType:"title",tooltip:tooltipCopy,iconCls:"bmcCopy",scope:this,id:"copyId",handler:function(){window.parent.addTab("AdminCMDBReconciliation?copyId="+recordId+"",headerWinTab,headerWinTab)}},{xtype:"tbseparator",id:"tbseparatorId"},{scale:"medium",iconCls:"bmcDelete",tooltipType:"title",tooltip:tooltipDelete,scope:this,id:"deleteId",handler:DeleteBtnHandler},{scale:"medium",iconCls:"bmcRefreshDasboard",tooltipType:"title",tooltip:tooltipRefresh,id:"resetId",handler:RefreshBtnHandler},new Ext.toolbar.Fill(),{id:"idInactive",xtype:"checkbox",width:75,color:"#004376",align:"top",checked:false,boxLabel:inactiveLabel},{xtype:"tbspacer",width:10}]});if(Inactive){Ext.getCmp("idInactive").setValue(Inactive)}if(recordId==null||recordId==""){buttonValidator(true,"bmcDeleteDisable");Ext.getCmp("saveId").setDisabled(!isCreateable)}else{buttonValidator(false,"bmcDelete");Ext.getCmp("saveId").setDisabled(!isEditable)}}var SaveBtnHandler=function(){var b=getRuleName().value;if(!b||(isCIManagementEnabled&&isAssetManagementEnabled&&!selectedClassId)){showExtMsg(RequiredFieldsEntry,true);return}reconCriteria="";for(i=0;i<fieldArray.length;i++){if(fieldArray[i]){reconCriteria+=fieldArray[i]+"¬"}}if(reconCriteria){logicalStmt=getFilterLogic().value;if(isValidLogicalStatement(logicalStmt)&&checkAllFieldIndexesInLogic()){var a=Ext.getCmp("idInactive").getValue();saveRule(b,selectedClassId,reconCriteria,a)}}else{showExtMsg(RequiredFieldsEntry,true)}};function postSaveAction(){if(errorMsg){showExtMsg(errorMsg,true)}else{showExtMsg(SavedSuccessfully,false);window.parent.handleSave(wid,recordId);isDirty=false;window.parent.registerSave(wid);window.parent.changeTitle(wid,getRuleName().value,headerWinTab);buttonValidator(false,"bmcDelete");window.parent.refreshList()}}function buttonValidator(b,a){if(isDeletable){Ext.getCmp("deleteId").setDisabled(b)}else{Ext.getCmp("deleteId").setDisabled(true)}Ext.getCmp("deleteId").setIconCls(a);if(isCreateable){Ext.getCmp("copyId").setDisabled(b)}else{Ext.getCmp("copyId").setDisabled(true);Ext.getCmp("newId").setDisabled(true)}Ext.getCmp("resetId").setDisabled(b)}var DeleteBtnHandler=function(){Ext.Msg.show({title:tooltipDelete,msg:delCnfrmMsg,minWidth:300,maxWidth:360,minHeight:110,buttons:Ext.Msg.YESNO,buttonText:{yes:YesLabel,no:NoLabel},icon:Ext.MessageBox.WARNING,fn:function(a){if(a=="yes"){DeleteRule()}}})};function postDeleteAction(){window.parent.refreshList();window.parent.closeTab(wid)}var RefreshBtnHandler=function(){if(isDirty){Ext.Msg.show({title:tooltipRefresh,msg:refreshCnfrmMsg,minWidth:300,maxWidth:360,minHeight:110,buttons:Ext.Msg.YESNO,buttonText:{yes:YesLabel,no:NoLabel},icon:Ext.MessageBox.WARNING,fn:function(a){if(a=="yes"){window.parent.registerSave(wid);RefreshRule()}}})}};function AddRow(h){var l=document.getElementById("FilterCriteria");rowCount++;rowIdCount++;var d=document.createElement("TR");d.setAttribute("id","RowId"+rowIdCount);l.appendChild(d);var g=document.createElement("TD");g.setAttribute("valign","top");g.setAttribute("style","width:12.5%; text-align:center");d.appendChild(g);var f=document.createElement("div");f.id="NumberDivId"+rowIdCount;var a=document.createTextNode(rowCount);f.className="NumberDivCls";f.appendChild(a);g.appendChild(f);var k=document.createElement("TD");k.setAttribute("valign","top");k.setAttribute("style","width:75%");d.appendChild(k);var c=document.createElement("div");c.setAttribute("style","padding:3px;");var e="FieldDivOfRow"+rowIdCount;c.id=e;k.appendChild(c);var b=createFieldCombox(rowIdCount);b.render(c);var j=document.createElement("TD");j.setAttribute("style","width:12.5%; text-align: center;");j.setAttribute("valign","middle");d.appendChild(j);var m=document.createElement("INPUT");m.type="BUTTON";m.id=rowIdCount;m.title=labelDeleteRow;m.className="rowDltIcon";m.setAttribute("onclick","DeleteRow(this.id);");j.appendChild(m);if(h){b.setValue(h)}else{m.style.visibility="hidden"}}function createFieldCombox(a){var c=Ext.create("Ext.data.Store",{fields:["label","fieldPath"],sorters:[{property:"label",direction:"ASC"}],data:fieldsStoreData});var b=Ext.create("Ext.form.field.ComboBox",{store:c,editable:true,typeAhead:true,emptyText:EmptyFieldLabel,queryMode:"local",displayField:"label",forceSelection:true,valueField:"fieldPath",id:"fieldsId"+a,width:380,tpl:'<tpl for="."><div class="x-boundlist-item" >{label:htmlEncode} </div></tpl>',listeners:{select:function(j,h,g){var e=h[0].get("fieldPath");if(fieldArray.indexOf(e)!=-1){showExtMsg(FieldAlreadySelected,true);j.clearValue()}else{var d=document.getElementById("NumberDivId"+a).textContent;d=parseInt(d);fieldArray.splice(d-1,1,e);markAsDirty();var f=document.getElementById(a);if(f&&f.style.visibility=="hidden"){setLogicalStatement("newfield",d);f.style.visibility="visible";if(rowCount<ConditionLimit){AddRow(false)}}}}}});return b}function ReloadFieldStore(){var b=Ext.getCmp("fieldsId1");if(b!=null){b.store.removeAll();b.store.loadData(fieldsStoreData)}var a=document.getElementById("FilterCriteria");while(a.children.length>0){a.removeChild(a.lastChild)}rowCount=0;rowIdCount=0;AddRow(false);getFilterLogic().value="";logicalStmt="";fieldArray=[]}function DeleteRow(a){var g=document.getElementById("FilterCriteria");a=parseInt(a);var k=document.getElementById("RowId"+a);var j=document.getElementById("NumberDivId"+a).textContent;j=parseInt(j);g.removeChild(k);var f=rowIdCount;var b=j;for(var c=j;c<f;c++){var e=parseInt(c+1);var d=document.getElementById("NumberDivId"+e);if(d){if(d.textContent==parseInt(b+1)){d.textContent=b;b++}}}fieldArray.splice(j-1,1);rowCount--;setLogicalStatement("removefield",j);markAsDirty();var h=document.getElementById(f+"");if(ConditionLimit==b&&(h==null||h.style.visibility!="hidden")){AddRow(false)}}function setLogicalStatement(b,a){if(b=="newfield"){if(rowCount>1){logicalStmt+=" AND "+a}else{logicalStmt=a}}else{if(b=="removefield"){var c;if(logicalStmt.search(a)==0){c=new RegExp(a+" (AND|OR) ");logicalStmt=logicalStmt.replace(c,"")}else{c=new RegExp(" (AND|OR) "+a,"gi");logicalStmt=logicalStmt.replace(c,"")}for(i=a;i<=rowCount;i++){var d=parseInt(i)+1;logicalStmt=logicalStmt.replace(d,i)}}else{logicalStmt+=rowCount}}if(logicalStmt.length>255){showExtMsg(charactersoverlimit,true);return}getFilterLogic().value=logicalStmt}function showExtMsg(b,c){var a=Ext.Msg.show({msg:b,minWidth:300,maxWidth:360,minHeight:110,buttons:Ext.Msg.OK,buttonText:{ok:OkLabel},icon:Ext.MessageBox.WARNING});if(!c){a.setIcon("")}}function isValidLogicalStatement(c){temporaryArray=[];temporaryArray=c.match(/(-?\d[\d\.\*]*)/g);if(temporaryArray!=null&&temporaryArray.length>0){for(i=0;i<temporaryArray.length;i++){if(temporaryArray[i]>rowCount||temporaryArray[i]<=0){showExtMsg(FilterLogicValidation,true);return false}}}if(c!=null&&c.trim().length==1&&parseInt(c.trim())==1){return true}var a=/\(\s*[+-]?\d+(?:(?:\s+AND\s+[+-]?\d+)+|(?:\s+OR\s+[+-]?\d+)+)\s*\)/ig;var b=/^\s*[+-]?\d+(?:(?:\s+AND\s+[+-]?\d+)+|(?:\s+OR\s+[+-]?\d+)+)\s*$/ig;while(c.search(a)!==-1){c=c.replace(a,"0")}if(c.search(b)===0){return true}else{showExtMsg(FilterLogicValidation,true)}return false}function checkAllFieldIndexesInLogic(){var a=" "+logicalStmt+" ";for(i=1;i<rowCount;i++){if(a.indexOf(" "+i+" ")==-1&&a.indexOf("("+i+" ")==-1&&a.indexOf(" "+i+")")==-1){showExtMsg(FilterLogicValidation,true);return false}}return true}function LoadFieldData(){var b=0;if(reconCriteria){fieldArray=reconCriteria.split("¬");var a=fieldArray.length;if(a>0){for(i=0;i<(a);i++){if(fieldArray[i]){AddRow(fieldArray[i]);b++}}}}if(b<ConditionLimit){AddRow(false)}}function updateFilterLogic(){logicalStmt=getFilterLogic().value}function markAsDirty(){isDirty=true;window.parent.registerChange(wid)};