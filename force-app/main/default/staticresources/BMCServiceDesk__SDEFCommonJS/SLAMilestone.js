var grid,store,actionData,selectedRowIndex,actionIndex,percentSpinner,daySpinner,hourSpinner,minuteSpinner,conditionListValue,actionListValue,emailListValue,data,percent,day,hour,min,milestoneId,errormsg,actionRec,milestoneWindow,milestoneOncompletefunction,clickedOnce=false,isMilestoneCreatable;Ext.onReady(function(){Ext.QuickTips.init();var b=new Ext.Toolbar({renderTo:"milestoneToolBar",cls:"toolSpCls",id:"SLToolbar",items:[{scale:"medium",iconCls:"bmcSave",tooltipType:"title",tooltip:labelSave,id:"mileSaveId",handler:SaveBtnHandler},"",{scale:"medium",iconCls:"bmcReset",tooltipType:"title",tooltip:labelReset,id:"mileResetId",handler:ResetBtnHandler}]});percentSpinner=new Ext.ux.form.SpinnerField({id:"percentSpinner",value:percent,minValue:0,maxValue:100,width:50,renderTo:"percentSpinnerDiv",enableKeyEvents:true,maxLength:3,allowDecimals:false,autoCreate:{tag:"input",type:"text",autocomplete:"off",maxlength:"3"},listeners:{keydown:function(d,c){if(c.getKey()==109){c.stopEvent()}},keyup:function(d,c){validateSpinnerField(d,c)}}});daySpinner=new Ext.ux.form.SpinnerField({id:"daySpinner",value:day,minValue:0,maxValue:99,width:50,renderTo:"daySpinnerDiv",enableKeyEvents:true,maxLength:2,allowDecimals:false,autoCreate:{tag:"input",type:"text",autocomplete:"off",maxlength:"2"},listeners:{keydown:function(d,c){if(c.getKey()==109){c.stopEvent()}},keyup:function(d,c){validateSpinnerField(d,c);var f=getSelectedId().value.toLowerCase();if(f=="time remaining"){reSetHourMin()}},spin:function(){var c=getSelectedId().value.toLowerCase();if(c=="time remaining"){reSetHourMin()}}}});hourSpinner=new Ext.ux.form.SpinnerField({id:"hourSpinner",value:hour,minValue:0,maxValue:23,width:50,renderTo:"hourSpinnerDiv",enableKeyEvents:true,maxLength:2,allowDecimals:false,autoCreate:{tag:"input",type:"text",autocomplete:"off",maxlength:"2"},listeners:{keydown:function(d,c){if(c.getKey()==109){c.stopEvent()}},keyup:function(d,c){validateSpinnerField(d,c);var f=getSelectedId().value.toLowerCase();if(f=="time remaining"){reSetMin()}},spin:function(){var c=getSelectedId().value.toLowerCase();if(c=="time remaining"){reSetMin()}}}});minuteSpinner=new Ext.ux.form.SpinnerField({id:"minuteSpinner",value:min,minValue:0,maxValue:59,width:50,renderTo:"minuteSpinnerDiv",enableKeyEvents:true,maxLength:2,allowDecimals:false,autoCreate:{tag:"input",type:"text",autocomplete:"off",maxlength:"2"},listeners:{keydown:function(d,c){if(c.getKey()==109){c.stopEvent()}},keyup:function(d,c){validateSpinnerField(d,c)}}});store=new Ext.data.SimpleStore({fields:[{name:"id",type:"string"},{name:"index",type:"string"},{name:"actionType",type:"string"},{name:"emailTemplateID",type:"string"},{name:"tofield",type:"string"},{name:"ccfield",type:"string"},{name:"actionValue",type:"string"},{name:"actionLabel",type:"string"}]});store.loadData(actionData);actionIndex=store.getCount();var a=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{id:"ActionData",dataIndex:"actionLabel",renderer:addToolTip}]});grid=new Ext.grid.GridPanel({id:"actionDataGrid",store:store,renderTo:"actionGrid",header:false,cm:a,stripeRows:true,selModel:new Ext.grid.RowSelectionModel({singleSelect:true}),height:236,width:395,border:false,autoWidth:true,viewConfig:{forceFit:true,scrollOffset:0},listeners:{rowclick:function(c,d,f){if(isMilestoneCreatable!=null&&isMilestoneCreatable!="false"){selectedRowIndex=d;actionRec=c.store.getAt(d);getActionListId().value=actionRec.get("actionType");getTemplateId().value=actionRec.get("emailTemplateID");getActionTo().value=actionRec.get("tofield");getActionCC().value=actionRec.get("ccfield");showUpdatebtn()}},render:function(c){c.getView().el.select(".x-grid3-header").setStyle("display","none")}}});getWaitbox();getBtnState();document.getElementById("equalId").style.display="none";document.getElementById("percentageId").style.display="none";document.getElementById("daysId").style.display="none";document.getElementById("updateDivId").style.display="none";document.getElementById("cancelDivId").style.display="none";getDuration();conditionListValue=getSelectedId().value;actionListValue=getActionListId().value;emailListValue=getTemplateId().value;handleElemEvent();milestoneWindow=window.parent.popUpWindow;milestoneWindow.pendingClose=false;milestoneOncompletefunction=window.parent.onCompleteFunction;milestoneWindow.on("beforeclose",function(){if(milestoneWindow.pendingClose==false){if(clickedOnce==true){window.parent.confirmClose(milestoneWindow);return false}}});isMilestoneCreatable=getIsMilestoneCreatable();if(isMilestoneCreatable!=null&&isMilestoneCreatable=="false"){Ext.getCmp("mileSaveId").setDisabled(true);Ext.getCmp("mileSaveId").setIconClass("bmcSaveDisable");Ext.getCmp("mileResetId").setDisabled(true);Ext.getCmp("mileResetId").setIconClass("bmcResetDisable")}});function getWaitbox(){var a=new Ext.Window({id:"waitMsggId",height:100,width:200,resizable:false,closable:false,header:false,frame:false,shadow:false,modal:true,items:[{xtype:"panel",height:100,modal:false,width:200,bodyStyle:"background-color:transparent;border:none;",html:'<div align="center"><img src="'+extJsResource+'/resources/images/default/shared/blue-loading.gif"/></div>'}]})}function showWaitbox(){if(Ext.getCmp("waitMsggId")!=null){Ext.getCmp("waitMsggId").show()}}function hideWaitbox(){if(Ext.getCmp("waitMsggId")!=null){Ext.getCmp("waitMsggId").hide()}}function addToolTip(e,a,b,f,d,c){a.attr='title="'+Ext.util.Format.htmlEncode(b.data.actionValue.replace(/;/gi,"; "))+'"';return e}function getBtnState(){milestoneId=getMilestoneId();if(milestoneId!=null&&milestoneId!=""){Ext.getCmp("mileResetId").setDisabled(false);Ext.getCmp("mileResetId").setIconClass("bmcReset")}else{Ext.getCmp("mileResetId").setDisabled(true);Ext.getCmp("mileResetId").setIconClass("bmcResetDisable")}}var SaveBtnHandler=function(b,d){beforeSave=true;var a=document.getElementById("percentageId").style.display;var c=document.getElementById("daysId").style.display;var e=0;if(a!="none"){e=percentSpinner.getValue()}else{if(c!="none"){e=(daySpinner.getValue()*24*60)+(hourSpinner.getValue()*60)+(minuteSpinner.getValue())}}conditionListValue=getSelectedId().value;selectedRowIndex=null;actionRec=null;save(e)};var ResetBtnHandler=function(a,b){beforeSave=true;beforeReset=true;getSelectedId().value=conditionListValue;selectedRowIndex=null;reset()};function showSpinner(){percent=0;day=0;hour=0;min=0;percentSpinner.maxValue=100;percentSpinner.setValue(percent);minuteSpinner.setValue(min);hourSpinner.setValue(hour);daySpinner.setValue(day);var a=getSelectedId().value.toLowerCase();document.getElementById("equalId").style.display="none";document.getElementById("percentageId").style.display="none";document.getElementById("daysId").style.display="none";if(a=="percentage of time elapsed"||a=="percentage of time remaining"){document.getElementById("equalId").style.display="inline-block";document.getElementById("percentageId").style.display="inline-block";if(a=="percentage of time remaining"){percentSpinner.maxValue=100}}else{if(a=="time elapsed"||a=="time remaining"){document.getElementById("equalId").style.display="inline-block";document.getElementById("daysId").style.display="inline-block";if(a=="time remaining"){setMaxLimit()}else{minuteSpinner.maxValue=59;hourSpinner.maxValue=23;daySpinner.maxValue=99}}}}function getDuration(){percent=0;day=0;hour=0;min=0;if(duration!=null&&duration!=""){var a=parseFloat(duration);var b=getSelectedId().value.toLowerCase();if(b=="percentage of time elapsed"||b=="percentage of time remaining"){percent=Math.floor(a);if(b=="percentage of time remaining"){percentSpinner.maxValue=99}}else{if(a!=0){day=Math.floor((a/(24*60)));hour=Math.floor((a/60)%24);min=Math.floor((a%(24*60))%60)}}}minuteSpinner.setValue(min);hourSpinner.setValue(hour);daySpinner.setValue(day);percentSpinner.setValue(percent);document.getElementById("equalId").style.display="none";document.getElementById("percentageId").style.display="none";document.getElementById("daysId").style.display="none";if(b=="percentage of time elapsed"||b=="percentage of time remaining"){document.getElementById("equalId").style.display="inline-block";document.getElementById("percentageId").style.display="inline-block"}else{if(b=="time elapsed"||b=="time remaining"){document.getElementById("equalId").style.display="inline-block";document.getElementById("daysId").style.display="inline-block";if(b=="time remaining"){setMaxLimit()}}}}function setMaxLimit(){if(maxDuration!=null&&maxDuration!=""){var b,c,a;b=c=a=0;var d=parseFloat(maxDuration);if(d!=0){b=Math.floor((d/(24*60)));c=Math.floor((d/60)%24);a=Math.floor((d%(24*60))%60);daySpinner.maxValue=b;hourSpinner.maxValue=c;minuteSpinner.maxValue=a;if(b!=null&&b>0){hourSpinner.maxValue=23;minuteSpinner.maxValue=59}if(c!=null&&c>0){minuteSpinner.maxValue=59}}}}function reSetHourMin(){if(daySpinner.getValue()<daySpinner.maxValue){hourSpinner.maxValue=((daySpinner.maxValue-daySpinner.getValue())*24>23)?23:(daySpinner.maxValue-daySpinner.getValue())*24;minuteSpinner.maxValue=((daySpinner.maxValue-daySpinner.getValue())*24*60>59)?59:(daySpinner.maxValue-daySpinner.getValue())*24*60}else{if(daySpinner.maxValue>0){hour=0;min=0;minuteSpinner.setValue(min);hourSpinner.setValue(hour);var a=parseFloat(maxDuration);if(a!=0){maxHour=Math.floor((a/60)%24);maxMinutes=Math.floor((a%(24*60))%60);hourSpinner.maxValue=maxHour;minuteSpinner.maxValue=maxMinutes}}}}function reSetMin(){if(hourSpinner.getValue()<hourSpinner.maxValue){minuteSpinner.maxValue=((hourSpinner.maxValue-hourSpinner.getValue())*60>59)?59:(daySpinner.maxValue-daySpinner.getValue())*60}else{if(hourSpinner.maxValue>0){if(daySpinner.getValue()==daySpinner.maxValue){min=0;minuteSpinner.setValue(min);var a=parseFloat(maxDuration);if(a!=0){maxMinutes=Math.floor((a%(24*60))%60);minuteSpinner.maxValue=maxMinutes}}}}}function clearActionFields(){if(isMilestoneCreatable!=null&&isMilestoneCreatable!="false"){getActionListId().value=actionListValue;getTemplateId().value=emailListValue;getActionTo().value="";getActionCC().value=""}}function addActionToGrid(){if(errormsg==null||errormsg==""||errormsg==labelSavedSuccessfully){var d=getActionListId().value;var b=getActionListId()[getActionListId().selectedIndex].innerText;var k=getTemplateId()[getTemplateId().selectedIndex].innerText;var f=getTemplateId().value;var i=getActionTo().value;var j=getActionCC().value;var h,e;if(j!=null&&j!=""){h=b+' "'+k+'" to '+i+","+j}else{h=b+' "'+k+'" to '+i}if(h.length>80){e=h.substring(0,80)+"..."}else{e=h}if(actionRec!=null&&typeof(actionRec)!="undefined"){actionRec.set("actionType",d);actionRec.set("emailTemplateID",f);actionRec.set("tofield",i);actionRec.set("ccfield",j);actionRec.set("actionValue",h);actionRec.set("actionLabel",e);actionRec.commit();grid.getSelectionModel().deselectRow(selectedRowIndex);selectedRowIndex=null;actionRec=null}else{var c=actionIndex+1;++actionIndex;var g={id:null,index:c,actionType:d,emailTemplateID:f,tofield:i,ccfield:j,actionValue:h,actionLabel:e};var a=new store.recordType(g);store.add(a)}showAddbtn();clearActionFields()}}function addActionHandler(){if(isMilestoneCreatable!=null&&isMilestoneCreatable!="false"){showWaitbox();if(actionRec!=null&&typeof(actionRec)!="undefined"){addAction(actionRec.get("index"))}else{var a=actionIndex+1;addAction(a)}}}function removeActionFromGrid(b,c){if(b=="ok"){if(selectedRowIndex!=null&&typeof(selectedRowIndex)!="undefined"){var a=Ext.getCmp("actionDataGrid").getStore().getAt(selectedRowIndex);var e=a.get("id");var d=a.get("index");Ext.getCmp("actionDataGrid").getStore().remove(a);showWaitbox();showAddbtn();if(e!=null&&e!=""&&e!="undefined"){deleteAction(e,d)}else{removeActionfromList(d)}selectedRowIndex=null;actionRec=null}}else{if(b=="cancel"){return}}}function removeActionHandler(a,b){if(isMilestoneCreatable!=null&&isMilestoneCreatable!="false"){if(selectedRowIndex!=null&&typeof(selectedRowIndex)!="undefined"){Ext.Msg.show({cls:"messagePopup",title:labelRemoveAction,msg:DeleteMessage,buttons:Ext.Msg.OKCANCEL,fn:removeActionFromGrid,width:300,icon:Ext.MessageBox.WARNING,frame:false})}else{Ext.Msg.show({cls:"messagePopup",title:labelRemoveAction,msg:selectRowMsg,buttons:Ext.Msg.OKCANCEL,width:300,icon:Ext.MessageBox.WARNING,frame:false})}}}function showAddbtn(){document.getElementById("addDivId").style.display="inline";document.getElementById("clearDivId").style.display="inline";document.getElementById("updateDivId").style.display="none";document.getElementById("cancelDivId").style.display="none"}function showUpdatebtn(){document.getElementById("addDivId").style.display="none";document.getElementById("clearDivId").style.display="none";document.getElementById("updateDivId").style.display="inline";document.getElementById("cancelDivId").style.display="inline"}function refreshParent(){}var enabledButtonNameVal;function openSelectEmailRecipient(a){if(a=="toButtonIdMilestonePage"){enabledButtonNameVal="to"}else{if(a=="ccButtonIdMilestonePage"){enabledButtonNameVal="cc"}}window.parent.toEmailRecipientAddress=getActionTo().value;window.parent.ccEmailRecipientAddress=getActionCC().value;var b="SLAMileStoneEmailRecipients?enabledButtonName="+enabledButtonNameVal+"&appliesTo="+appliesTo+"&slaId="+window.parent.getSLAId()+"&businessServiceId="+window.parent.businessServiceId;window.parent.openPopupWithTitle(b,populateAddressFields,labelSelectEmailRecipients,580,755)}function populateAddressFields(b){var a=b.split(DZHE);if(a!=null&&a!=""&&a!=DZHE){getActionTo().value=a[0];getActionCC().value=a[1]}}function cancelAction(){showAddbtn();clearActionFields();grid.getSelectionModel().deselectRow(selectedRowIndex);selectedRowIndex=null;actionRec=null}function handleResetChange(){if(clickedOnce){clickedOnce=false}}function handleChange(a){if(!clickedOnce){clickedOnce=true}}function setReturnValue(){window.parent.setOnCompleteFunction(milestoneOncompletefunction);window.parent.setPopUpVar("dummy")};