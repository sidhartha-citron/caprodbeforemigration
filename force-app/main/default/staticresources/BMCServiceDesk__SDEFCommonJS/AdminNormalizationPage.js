var waitMask,FieldNameStore,FieldNameCombo,popUpWindow,MappingViewStore,listViewMask,ObjectNameCombo,RuleTypeCombo;var rowCount;var selectedFieldLabel="";Ext.onReady(function(){handleElemEvent();waitMask=new Ext.LoadMask(Ext.getBody(),{msg:_ServerLabels.WaitMaskMsg});listViewMask=new Ext.LoadMask("Normalization_List",{msg:_ServerLabels.WaitMaskMsg});createFieldCombo();createMappingGrid();var a=document.getElementById(mainFormId);if(a!=null&&a!=undefined){a.style.display="inline"}enableBtn();disableObjectAndFields(false);refreshRulePage();Ext.define("Ext.override.dom.Element",{override:"Ext.dom.Element",focus:function(i,h){var d=this,g,b;h=h||d.dom;b=(h.ownerDocument||DOC).body||DOC.body;try{if(Number(i)){Ext.defer(d.focus,i,d,[null,h])}else{if(h.offsetHeight>Ext.dom.Element.getViewHeight()){g=b.scrollTop}var c=h.id;if(c.indexOf("gridview")==-1){h.focus()}if(g!==undefined){b.scrollTop=g}}}catch(f){}return d}})});function createMappingGrid(){Ext.define("MappingModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"string"},{name:"FieldName",type:"string"},{name:"FieldLabel",type:"string"},{name:"operator",type:"string"},{name:"visibleOperator",type:"string"},{name:"mappedValue",type:"string"},{name:"childRuleId",type:"string"}]});MappingViewStore=Ext.create("Ext.data.Store",{model:"MappingModel",data:mappingGridData,proxy:{type:"memory",reader:{idProperty:"Id",type:"json",root:"attributes"}}});mappingGrid=Ext.create("Ext.grid.Panel",{id:"mappingGrid",renderTo:"mappingGrid",stripeRows:true,forceFit:true,store:MappingViewStore,height:334,forceFit:true,autoScroll:true,columns:[{id:"RecordId",width:1,text:"Id",hidden:true,menuDisabled:true,dataIndex:"Id"},{id:"FieldNameId",width:1,text:_ServerLabels.FieldName,hidden:true,menuDisabled:true,renderer:"htmlEncode",dataIndex:"FieldName"},{id:"FieldLabelId",flex:0.2,text:_ServerLabels.FieldName,menuDisabled:true,dataIndex:"FieldLabel"},{id:"operatorId",width:1,text:_ServerLabels.Operator,hidden:true,menuDisabled:true,renderer:"htmlEncode",dataIndex:"operator"},{id:"operatorLabelId",flex:0.2,text:_ServerLabels.Operator,menuDisabled:true,dataIndex:"visibleOperator"},{id:"mappedValueId",flex:0.6,text:_ServerLabels.MappedAlias,menuDisabled:true,renderer:"htmlEncode",dataIndex:"mappedValue"},{id:"childRulesId",width:1,text:"childRuleId",hidden:true,menuDisabled:true,dataIndex:"childRuleId"}],listeners:{itemclick:function(b,a,c,e,d){showAddUpdate(false);showSelectedRowValue(a)}}});rowCount=Ext.getCmp("mappingGrid").store.data.length}function enableAddCancel(){var c=document.getElementById("RfText").value;var a=document.getElementById("AddBtnId");var b=document.getElementById("CancelButtonId");var d=document.getElementById("UpdateBtnId");if(selectedFieldLabel!=""){if(typeof(c)!="undefined"&&c!=""&&c.trim().length!=0){a.disabled=false;b.disabled=false;d.disabled=false}else{a.disabled=true;b.disabled=true;d.disabled=true}}}function showAddUpdate(d){var a=document.getElementById("AddBtnId");var e=document.getElementById("UpdateBtnId");var b=document.getElementById("CancelButtonId");var c=document.getElementById("DeleteBtnId");if(d){e.style.display="none";a.style.display="inline";selectedRecord="";Ext.getCmp("mappingGrid").getSelectionModel().deselectAll();a.disabled=true;c.disabled=true;b.disabled=true}else{c.removeAttribute("disabled");a.style.display="none";e.style.display="inline";b.disabled=false;e.disabled=false}}function validateBeforeAdd(){var b="";var a=document.getElementById("RfText");if(selectedFieldLabel!=""){if(a==null||typeof(a)=="undefined"||a.value=="undefined"||a.value==null||a.value==""){b=SpecifyValueMsg}}else{b=selectFieldMsg}if(b!=""){Ext.Msg.show({msg:b,buttons:Ext.Msg.OK,icon:Ext.Msg.WARNING})}else{addRecordToDataGrid()}}function addRecordToDataGrid(){var a=Ext.getCmp("mappingGrid").store;selectedRecord=Ext.getCmp("mappingGrid").getView().getSelectionModel().getSelection()[0];var b=getOperateId();var c=document.getElementById("RfText");b=b[b.selectedIndex];if(b!=null&&b!=undefined&&c!=null&&c!=undefined){c=document.getElementById("RfText").value;if(selectedRecord==null||selectedRecord==undefined||selectedRecord==""){rowCount++;a.add(new MappingModel({Id:"NewRecord",FieldName:selectedFieldAPIName,FieldLabel:selectedFieldLabel,visibleOperator:b.label,operator:b.value,mappedValue:c}));ClearSelectedRowValue()}else{selectedRecord.set("operator",b.value);selectedRecord.set("visibleOperator",b.label);selectedRecord.set("mappedValue",c);selectedRecord.commit();showAddUpdate(true);ClearSelectedRowValue()}}}function showSelectedRowValue(a){var b=getOperateId();if(b!=null&&b!=undefined){b.value=a.data.operator}b=document.getElementById("RfText");if(b!=null&&b!=undefined){b.value=a.data.mappedValue}}function ClearSelectedRowValue(){var a=getOperateId();if(a!=null&&a!=undefined){a.value="="}a=document.getElementById("RfText");if(a!=null&&a!=undefined){a.value=""}enableAddCancel()}function getParameterGridData(){var a="";var b=0;gridStore=Ext.getCmp("mappingGrid").store;while(gridStore.data.length>b){a=a+gridStore.getAt(b).get("Id")+nonPrint+gridStore.getAt(b).get("FieldName")+nonPrint+gridStore.getAt(b).get("operator")+nonPrint+gridStore.getAt(b).get("mappedValue")+nonPrint+gridStore.getAt(b).get("childRuleId")+PE;b++}return a}function deleteRecordOfGrid(){var a=Ext.getCmp("mappingGrid").getSelectionModel().getSelection()[0];if(a!=null&&typeof(a)!="undefined"){if(a){if(a.data.childRuleId!=""){deletedConditions+=a.data.childRuleId+PE}Ext.getCmp("mappingGrid").store.remove(a);rowCount--}var b=document.getElementById("DeleteBtnId");b.setAttribute("disabled","disabled");showAddUpdate(true);ClearSelectedRowValue()}}function showVariationPanel(){var a=document.getElementById("imgCollapseId");var b=Ext.getCmp("mappingGrid");if(a.className=="panelUpImg"){a.className="panelDownImg";document.getElementById("Normalization_List").style.display="block";if(b){b.setHeight(130)}}else{a.className="panelUpImg";document.getElementById("Normalization_List").style.display="none";if(b){b.setHeight(390)}}}function ReloadCondtionStore(){var selectedRuleGridStore=Ext.getCmp("mappingGrid").getStore();selectedRuleGridStore.removeAll();mappingGridData=eval(mappingGridData);selectedRuleGridStore.loadData(mappingGridData);showAddUpdate(true);ClearSelectedRowValue();deletedConditions=""}function LoadNRule(a){showWaitMask();LoadExistingRule(a)}function SaveRule(){showWaitMask();ParameterVal=getParameterGridData();var a;var c=FieldNameCombo.getValue();var b=FieldNameStore.findRecord("apiname",c);if(b!=null&&b!=undefined){a=b.get("fieldtype")}saveRecord(ParameterVal,deletedConditions,a,ObjectNameCombo.getValue(),RuleTypeCombo.getValue())}function showWaitMask(){waitMask.show()}function hideWaitMask(){waitMask.hide()}function showListViewMask(){listViewMask.show()}hideListViewMask=function(){listViewMask.hide()};function DeleteRule(){Ext.Msg.show({title:_ServerLabels.Delete,msg:_ServerLabels.DeleteConfirmMessage,minWidth:300,maxWidth:360,minHeight:110,buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.WARNING,fn:function(a){if(a=="yes"){DeleteRecord();window.parent.refreshList();window.parent.closeTab(wid)}}})}function afterSave(a){hideWaitMask();if(isSavedSuccessfully){updateTitle(a,true);enableBtn();enableDelBtn();disableObjectAndFields(false);ShowInlineMessage("SaveMessageDiv","NormRule_toolbar",-25);if(window.parent!=undefined&&window.parent!=null){window.parent.handleSave(wid,nRuleId);window.parent.registerSave(wid);clickedOnce=false}if(newRecordId==null||newRecordId==""){refreshRulePage()}}}function afterDelete(){window.parent.refreshList();window.parent.closeTab(wid)}function NewRule(){window.parent.addTab("AdminNormalizationPage",_ServerLabels.winTitle,_ServerLabels.winTitle)}function createFieldCombo(){var a=Ext.create("Ext.data.Store",{fields:["apiname","label"],data:objectArray,sorters:[{property:"label",direction:"ASC"}]});ObjectNameCombo=Ext.create("Ext.form.ComboBox",{store:a,typeAhead:true,id:"ObjectNameComboId",queryMode:"local",displayField:"label",valueField:"apiname",value:selectedobject,renderTo:"ObjectName",tpl:new Ext.XTemplate('<tpl for="."><div title="{label}"  class="x-boundlist-item">{label:this.ellipsify}</div></tpl>',{ellipsify:function(c){return Ext.util.Format.ellipsis(c,25)}}),width:190,forceSelection:true,listeners:{select:function(e,d,c){UpdateFieldNames();handleChange()}}});var b=Ext.create("Ext.data.Store",{fields:["name","label"],data:ruleTypeArr});RuleTypeCombo=Ext.create("Ext.form.ComboBox",{store:b,typeAhead:true,id:"RuleTypeCombo",queryMode:"local",displayField:"label",valueField:"name",value:selectedType,renderTo:"RuleType",width:190,listeners:{select:function(e,d,c){UpdateNormalizationForm(e.getValue());refreshRulePage();handleChange()}}});FieldNameStore=Ext.create("Ext.data.Store",{fields:["label","apiname","fieldtype"],data:FieldNames,sorters:[{property:"label",direction:"ASC"}]});FieldNameCombo=Ext.create("Ext.form.ComboBox",{store:FieldNameStore,typeAhead:true,id:"FieldNameCombo",queryMode:"local",displayField:"label",valueField:"apiname",value:selectedFieldAPIName,renderTo:"FieldName",tpl:new Ext.XTemplate('<tpl for="."><div title="{label:htmlEncode}"  class="x-boundlist-item">{label:this.ellipsify}</div></tpl>',{ellipsify:function(c){return Ext.util.Format.htmlEncode(Ext.util.Format.ellipsis(c,25))}}),width:190,forceSelection:true,listeners:{select:function(e,d,c){setFieldValue(this.getValue());selectedFieldLabel=this.getRawValue();selectedFieldAPIName=this.getValue();enableAddCancel();refreshRulePage();handleChange()}}});enableAddCancel();selectedFieldLabel=FieldNameCombo.getRawValue()}function hideCheckbox(){if(RuleTypeCombo.getValue()=="Ignored Value Rule"){document.getElementById(appMethodId).style.display="none"}}function UpdateNormalizationForm(b){var a;if(typeof(normValLabel)!="undefined"&&normValLabel!=null){a=document.getElementById(normValLabel)}if(b=="Ignored Value Rule"){if(typeof(a.innerText)!="undefined"){a.innerText=IgnoredVal}else{a.textContent=IgnoredVal}document.getElementById("mappingDiv").style.display="none";document.getElementById("mappingGrid").style.display="none";document.getElementById("LabelTd").style.display="none";document.getElementById(appMethodId).style.display="none";document.getElementById("GenerateLabel").style.display="none"}else{if(typeof(a.innerText)!="undefined"){a.innerText=NormalizationRule}else{a.textContent=NormalizationRule}document.getElementById("mappingDiv").style.display="block";document.getElementById("mappingGrid").style.display="block";document.getElementById("LabelTd").style.display="block";document.getElementById(appMethodId).style.display="block";document.getElementById("GenerateLabel").style.display="block";document.getElementById("GenerateLabel").style.paddingTop="14px"}}function UpdateFieldNames(){showWaitMask();getFieldValues(ObjectNameCombo.getValue());FieldNameCombo.setValue("");ClearSelectedRowValue();refreshRulePage()}function openLookup(d,c,a,b){popUpWindow=Ext.create("Ext.Window",{height:a,width:b,title:c,x:276,y:10,modal:true,resizable:false,bodyStyle:"background-color:#FFFFFF;",constrain:true,viewConfig:{forceFit:true},frame:true,html:'<iframe frameborder="0" src ="/apex/'+d+'" style="width:100%;height:100%;border:none"/>'});popUpWindow.show()}function openmasterlookup(){var c,f,b,a,e;b=ObjectNameCombo.getValue();if(b.indexOf(orgNamespace)!=-1){b=b.replace(orgNamespace,"")}e=FieldNameCombo.getValue();filterId="active_custom";var d="apex/SearchAndLink?txt=mastervalueinput&frm=&parentName=Normalization&childName=Model__c&filterId="+filterId+"&isCustomLookup=false&RulefilterField=Name";openLookup(d,MasterValLabel,600,1000)}function setMasterValue(a){var b=document.getElementById(MasterValEleID);if(typeof(b)!=null&&typeof(b)!="undefined"){b.value=a}popUpWindow.close()}function searchVariations(){var a=document.getElementById("txtsearch");if(a!=null&&a!=undefined&&a.disabled==false){searchString=a.value;if(searchString.trim().length<2){Ext.Msg.show({msg:_ServerLabels.ValidateMinimumCharsSearchPage,buttons:Ext.Msg.OK,icon:Ext.Msg.WARNING});return}showWaitMask();searchMapping(searchString)}}function reloadMappingGrid(){Ext.getCmp("mappingGrid").store.loadData(mappingGridData)}function resetMappingGrid(){var a=document.getElementById("txtsearch");if(a!=null&&a!=undefined&&a.disabled==false){showWaitMask();document.getElementById("txtsearch").value="";resetMapping()}}function searchOnEnter(a){if(a.keyCode==13){searchVariations();return false}}function nextRecord(){if(hasnext){showWaitMask();nextRec()}}function prevRecord(){if(hasPrevious){showWaitMask();prevRec()}}function enableBtn(){var b=document.getElementById("prevBtnId");var a=document.getElementById("nextBtnId");if(hasnext&&hasPrevious){b.disabled=false;b.style.opacity=1;a.disabled=false;a.style.opacity=1}else{if(!hasnext&&hasPrevious){a.disabled=true;a.style.opacity=0.5;b.disabled=false;b.style.opacity=1}else{if(!hasPrevious&&hasnext){b.disabled=true;b.style.opacity=0.5;a.disabled=false;a.style.opacity=1}else{if(!hasnext&&!hasPrevious){b.disabled=false;b.style.opacity=0.5;a.disabled=false;a.style.opacity=0.5}}}}}function updateTitle(e,g){var d=ObjectNameCombo.getRawValue();if(g){var a=FieldNameCombo.getRawValue();if(d!=null&&typeof(d)!="undefined"&&a!=null&&typeof(a)!="undefined"){var b=d+" ("+lblRuleField+": "+a+")";window.parent.changeTitle(wid,e,b);window.parent.refreshList()}}else{var f=window.frames.NRframe.grid;if(f!=null){var c=f.getSelectionModel().getSelected();var d=c.get("FKNormalization_Metadata__r_Object_Name__c");var a=c.get("FKNormalization_Metadata__r_Field_Name__c");var b=d+" ("+lblRuleField+": "+a+")";window.parent.changeTitle(wid,e,b);window.parent.refreshList()}}}function disableObjectAndFields(b){if((nRuleId!=null&&typeof(nRuleId)!="undefined"&&nRuleId!="")||b){FieldNameCombo.disable();FieldNameCombo.setFieldStyle("color:#808080;");ObjectNameCombo.disable();ObjectNameCombo.setFieldStyle("color:#808080;");RuleTypeCombo.disable();RuleTypeCombo.setFieldStyle("color:#808080;")}var a=document.getElementById("txtsearch");var c=document.getElementById("resetMapId");var d=document.getElementById("searchMapId");if(nRuleId!=null&&typeof(nRuleId)!="undefined"&&nRuleId!=""){a.value="";a.disabled=false;c.disabled=false;c.style.opacity=1;d.disabled=false;d.style.opacity=1}else{a.disabled=true;c.disabled=true;c.style.opacity=0.5;d.disabled=true;d.style.opacity=0.5}}function refreshRulePage(){var j,d,h,f,e,a,c;var g=document.getElementById("Normalization_List");if(g!=null&&g!=undefined&&g.style.display=="block"){showListViewMask()}if(RuleListIframeEle!=null&&RuleListIframeEle!=""){e="";if(FieldNameCombo!=null){e=FieldNameCombo.getRawValue();e=Ext.htmlDecode(e);a=FieldNameCombo.getValue()}d=ObjectNameCombo.getValue();c=RuleTypeCombo.getValue();h="Master_Rule__c = null AND Rule_Type__c='"+c+"' AND FKNormalization_Metadata__r.Object_Name__c='"+d+"' AND FKNormalization_Metadata__r.Field_Name__c='"+a+"'";j="apex/SearchPage?popupId=NormalizationRule&standardLayout=true&view=list&pgheight=500&referenceObjectName=Normalization_Rule__c&isFromRule=true&filterClause="+h;RuleListIframeEle.src=j;var i=document.getElementById(MasterValEleID);var b=document.getElementById("mslkpId");if((d==orgNamespace+"Model__c"&&a=="Name")||(d==orgNamespace+"BMC_BaseElement__c"&&a==orgNamespace+"Model__c")){i.disabled=true;if(nRuleId==null||nRuleId==""){i.value=""}if(b!=null&&b!=undefined){b.style.display="inline"}}else{i.disabled=false;if(b!=null&&b!=undefined){b.style.display="none"}}}}function LoadNewRule(){showWaitMask();createNewRule()}var clickedOnce=false;function handleChange(){if(!clickedOnce){clickedOnce=true;if(window.parent!=undefined&&window.parent!=null){window.parent.registerChange(wid)}}}function showWarningMessage(a){Ext.Msg.show({title:lblWarningMsgHeader,msg:lblWarningForGenerateException,buttons:Ext.Msg.OK,icon:Ext.Msg.WARNING})}function enableDelBtn(){document.getElementById("delRuleId").className=document.getElementById("delRuleId").className+"delRuleIdClass"};